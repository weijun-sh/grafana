(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8831],{"./public/app/plugins/datasource/cloudwatch/cloudwatch-sql/language.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{AND:()=>f,ASC:()=>c,BY:()=>l,COMPARISON_OPERATORS:()=>x,DESC:()=>u,EQUALS:()=>y,FROM:()=>i,GROUP:()=>a,KEYWORDS:()=>h,LIMIT:()=>d,LOGICAL_OPERATORS:()=>v,NOT_EQUALS:()=>b,ORDER:()=>o,SCHEMA:()=>m,SELECT:()=>n,STATISTICS:()=>g,WHERE:()=>s,WITH:()=>p,conf:()=>w,language:()=>S});const n="SELECT",i="FROM",s="WHERE",a="GROUP",o="ORDER",l="BY",u="DESC",c="ASC",d="LIMIT",p="WITH",m="SCHEMA",h=[n,i,s,a,o,l,u,c,d,p,m],g=["AVG","COUNT","MAX","MIN","SUM"],f="AND",v=[f],y="=",b="!=",x=[y,b],S={defaultToken:"",tokenPostfix:".sql",ignoreCase:!0,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"}],keywords:h,operators:v,builtinFunctions:g,tokenizer:{root:[[/\$[a-zA-Z0-9-_]+/,"variable"],{include:"@comments"},{include:"@whitespace"},{include:"@numbers"},{include:"@strings"},{include:"@complexIdentifiers"},[/[;,.]/,"delimiter"],[/[()]/,"@brackets"],[/[\w@#$]+/,{cases:{"@keywords":"keyword","@operators":"operator","@builtinFunctions":"predefined","@default":"identifier"}}],[/[=!%&+\-*/|~^]/,"operator"]],whitespace:[[/\s+/,"white"]],comments:[[/--+.*/,"comment"]],comment:[[/[^*/]+/,"comment"],[/./,"comment"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/N'/,{token:"string",next:"@string"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/[^']+/,"string"],[/''/,"string"],[/'/,{token:"string",next:"@pop"}]],string_double:[[/[^\\"]+/,"type"],[/"/,"type","@pop"]],complexIdentifiers:[[/\[/,{token:"identifier.quote",next:"@bracketedIdentifier"}],[/"/,{token:"identifier.quote",next:"@quotedIdentifier"}]],bracketedIdentifier:[[/[^\]]+/,"identifier"],[/]]/,"identifier"],[/]/,{token:"identifier.quote",next:"@pop"}]],quotedIdentifier:[[/[^"]+/,"identifier"],[/""/,"identifier"],[/"/,{token:"identifier.quote",next:"@pop"}]]}},w={comments:{lineComment:"--",blockComment:["/*","*/"]},brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]}},"./public/app/plugins/datasource/cloudwatch/metric-math/language.ts":(e,t,r)=>{"use strict";r.r(t),r.d(t,{METRIC_MATH_FNS:()=>n,METRIC_MATH_KEYWORDS:()=>s,METRIC_MATH_OPERATORS:()=>a,METRIC_MATH_PERIODS:()=>o,METRIC_MATH_STATISTIC_KEYWORD_STRINGS:()=>i,conf:()=>u,language:()=>l});const n=["ABS","ANOMALY_DETECTION_BAND","AVG","CEIL","DATAPOINT_COUNT","DIFF","DIFF_TIME","FILL","FIRST","LAST","FLOOR","IF","INSIGHT_RULE_METRIC","LOG","LOG10","MAX","METRIC_COUNT","METRICS","MIN","MINUTE","HOUR","DAY","DATE","MONTH","YEAR","EPOCH","PERIOD","RATE","REMOVE_EMPTY","RUNNING_SUM","SEARCH","SERVICE_QUOTA","SLICE","SORT","STDDEV","SUM","TIME_SERIES"],i=["Average","Maximum","Minimum","Sum","SampleCount"],s=["REPEAT","LINEAR","ASC","DSC"],a=["+","-","*","/","^","==","!=","<=",">=","<",">","AND","&&","OR","||"],o=[10,60,300,900,3e3,21600,86400],l={id:"metricMath",ignoreCase:!1,brackets:[{open:"[",close:"]",token:"delimiter.square"},{open:"(",close:")",token:"delimiter.parenthesis"},{open:"{",close:"}",token:"delimiter.curly"}],tokenizer:{root:[{include:"@nonNestableStates"},{include:"@strings"}],nonNestableStates:[{include:"@variables"},{include:"@whitespace"},{include:"@numbers"},{include:"@assignment"},{include:"@keywords"},{include:"@operators"},{include:"@builtInFunctions"},[/[;,.]/,"delimiter"],[/[(){}\[\]]/,"@brackets"]],keywords:[[s.map(c).join("|"),"keyword"]],operators:[[a.map(c).join("|"),"operator"]],builtInFunctions:[[n.map(c).join("|"),"predefined"]],variables:[[/\$[a-zA-Z0-9-_]+/,"variable"]],whitespace:[[/\s+/,"white"]],assignment:[[/=/,"tag"]],numbers:[[/0[xX][0-9a-fA-F]*/,"number"],[/[$][+-]*\d*(\.\d*)?/,"number"],[/((\d+(\.\d*)?)|(\.\d+))([eE][\-+]?\d+)?/,"number"]],strings:[[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],string:[[/{/,{token:"delimiter.curly",next:"@nestedCurly"}],[/\(/,{token:"delimiter.parenthesis",next:"@nestedParens"}],[/"/,{token:"type",next:"@string_double"}],[/'/,{token:"string",next:"@pop"}],{include:"@nonNestableStates"},[/[^']/,"string"]],string_double:[[/[^"]/,"type"],[/"/,{token:"type",next:"@pop"}]],nestedCurly:[[/}/,{token:"delimiter.curly",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]],nestedParens:[[/\)/,{token:"delimiter.parenthesis",next:"@pop"}],[/'/,{token:"string",next:"@string"}],[/"/,{token:"type",next:"@string_double"}]]}},u={brackets:[["{","}"],["[","]"],["(",")"]],autoClosingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}],surroundingPairs:[{open:"{",close:"}"},{open:"[",close:"]"},{open:"(",close:")"},{open:'"',close:'"'},{open:"'",close:"'"}]};function c(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}},"./public/app/plugins/datasource/cloudwatch/module.tsx":(e,t,r)=>{"use strict";r.r(t),r.d(t,{plugin:()=>an});var n,i,s=r("./packages/grafana-data/src/index.ts"),a=r("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),o=r("./.yarn/__virtual__/react-use-virtual-00326e70ba/0/cache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/useDebounce.js"),l=r("./.yarn/cache/@grafana-aws-sdk-npm-0.0.35-2945fc38a2-c286e5ccaa.zip/node_modules/@grafana/aws-sdk/index.js"),u=r("./packages/grafana-ui/src/index.ts"),c=r("./public/app/core/actions/index.ts"),d=r("./public/app/core/copy/appNotification.ts"),p=r("./public/app/features/plugins/datasource_srv.ts"),m=r("./public/app/store/store.ts"),h=r("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/0/cache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),g=r("./packages/grafana-runtime/src/index.ts"),f=r("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const v=e=>({infoText:h.css`
    padding-bottom: ${e.spacing(2)};
    color: ${e.colors.text.secondary};
  `}),y="grafana-x-ray-datasource";function b(e){let{datasourceUid:t,onChange:r}=e;const s=Boolean((0,p.ak)().getList({pluginId:y}).length),a=(0,u.useStyles2)(v);return(0,f.jsxs)(f.Fragment,{children:[n||(n=(0,f.jsx)("h3",{className:"page-heading",children:"X-ray trace link"})),(0,f.jsx)("div",{className:a.infoText,children:"Grafana will automatically create a link to a trace in X-ray data source if logs contain @xrayTraceId field"}),!s&&(i||(i=(0,f.jsx)(u.Alert,{title:"There is no X-ray datasource to link to. First add an X-ray data source and then link it to Cloud Watch. ",severity:"info"}))),(0,f.jsx)("div",{className:"gf-form-group",children:(0,f.jsx)(u.InlineField,{htmlFor:"data-source-picker",label:"Data source",labelWidth:28,tooltip:"X-ray data source containing traces",children:(0,f.jsx)(g.DataSourcePicker,{pluginId:y,onChange:e=>r(e.uid),current:t,noDefault:!0})})})]})}var x;var S,w,j=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),C=(S=["",""],w=["",""],Object.freeze(Object.defineProperties(S,{raw:{value:Object.freeze(w)}})));function T(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var I=function(){function e(){for(var t=this,r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return T(this,e),this.tag=function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return"function"==typeof e?t.interimTag.bind(t,e):"string"==typeof e?t.transformEndResult(e):(e=e.map(t.transformString.bind(t)),t.transformEndResult(e.reduce(t.processSubstitutions.bind(t,n))))},n.length>0&&Array.isArray(n[0])&&(n=n[0]),this.transformers=n.map((function(e){return"function"==typeof e?e():e})),this.tag}return j(e,[{key:"interimTag",value:function(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];return this.tag(C,e.apply(void 0,[t].concat(n)))}},{key:"processSubstitutions",value:function(e,t,r){var n=this.transformSubstitution(e.shift(),t);return"".concat(t,n,r)}},{key:"transformString",value:function(e){return this.transformers.reduce((function(e,t){return t.onString?t.onString(e):e}),e)}},{key:"transformSubstitution",value:function(e,t){return this.transformers.reduce((function(e,r){return r.onSubstitution?r.onSubstitution(e,t):e}),e)}},{key:"transformEndResult",value:function(e){return this.transformers.reduce((function(e,t){return t.onEndResult?t.onEndResult(e):e}),e)}}]),e}();const R=I;var A={separator:"",conjunction:"",serial:!1};const E=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:A;return{onSubstitution:function(t,r){if(Array.isArray(t)){var n=t.length,i=e.separator,s=e.conjunction,a=e.serial,o=r.match(/(\n?[^\S\n]+)$/);if(t=o?t.join(i+o[1]):t.join(i+" "),s&&n>1){var l=t.lastIndexOf(i);t=t.slice(0,l)+(a?i:"")+" "+s+t.slice(l+1)}}return t}}};function O(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}const F=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"initial";return{onEndResult:function(t){if("initial"===e){var r=t.match(/^[^\S\n]*(?=\S)/gm),n=r&&Math.min.apply(Math,O(r.map((function(e){return e.length}))));if(n){var i=new RegExp("^.{"+n+"}","gm");return t.replace(i,"")}return t}if("all"===e)return t.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+e)}}};const M=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return{onEndResult:function(t){if(""===e)return t.trim();if("start"===(e=e.toLowerCase())||"left"===e)return t.replace(/^\s*/,"");if("end"===e||"right"===e)return t.replace(/\s*$/,"");throw new Error("Side not supported: "+e)}}};new R(E({separator:","}),F,M);new R(E({separator:",",conjunction:"and"}),F,M);new R(E({separator:",",conjunction:"or"}),F,M);const k=function(e){return{onSubstitution:function(t,r){if(null==e||"string"!=typeof e)throw new Error("You need to specify a string character to split by.");return"string"==typeof t&&t.includes(e)&&(t=t.split(e)),t}}};var q=function(e){return null!=e&&!Number.isNaN(e)&&"boolean"!=typeof e};const N=function(){return{onSubstitution:function(e){return Array.isArray(e)?e.filter(q):q(e)?e:""}}};new R(k("\n"),N,E,F,M);const P=function(e,t){return{onSubstitution:function(r,n){if(null==e||null==t)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return null==r?r:r.toString().replace(e,t)}}};new R(k("\n"),E,F,M,P(/&/g,"&amp;"),P(/</g,"&lt;"),P(/>/g,"&gt;"),P(/"/g,"&quot;"),P(/'/g,"&#x27;"),P(/`/g,"&#x60;"));const D=function(e,t){return{onEndResult:function(r){if(null==e||null==t)throw new Error("replaceResultTransformer requires at least 2 arguments.");return r.replace(e,t)}}};new R(D(/(?:\n(?:\s*))+/g," "),M);new R(D(/(?:\n\s*)/g,""),M);new R(E({separator:","}),D(/(?:\s+)/g," "),M);new R(E({separator:",",conjunction:"or"}),D(/(?:\s+)/g," "),M);new R(E({separator:",",conjunction:"and"}),D(/(?:\s+)/g," "),M);new R(E,F,M);new R(E,D(/(?:\s+)/g," "),M);const L=new R(F,M);const K=new R(F("all"),M);var Q=r("./.yarn/cache/prismjs-npm-1.27.0-ca4e1667c6-85c7f4a3e9.zip/node_modules/prismjs/prism.js"),_=r.n(Q),V=r("./packages/grafana-ui/src/slate-plugins/slate-prism/index.ts");const G=[{label:"fields",documentation:"Retrieves the specified fields from log events"},{label:"display",documentation:"Specifies which fields to display in the query results"},{label:"filter",documentation:"Filters the results of a query based on one or more conditions"},{label:"stats",documentation:"Calculates aggregate statistics based on the values of log fields"},{label:"sort",documentation:"Sorts the retrieved log events"},{label:"limit",documentation:"Specifies the number of log events returned by the query"},{label:"parse",documentation:"Extracts data from a log field, creating one or more ephemeral fields that you can process further in the query"}],$=[{label:"abs",detail:"abs(a)",documentation:"Absolute value."},{label:"ceil",detail:"ceil(a)",documentation:"Round to ceiling (the smallest integer that is greater than the value of a)."},{label:"floor",detail:"floor(a)",documentation:"Round to floor (the largest integer that is smaller than the value of a)."},{label:"greatest",detail:"greatest(a,b, ... z)",documentation:"Returns the largest value."},{label:"least",detail:"least(a, b, ... z)",documentation:"Returns the smallest value."},{label:"log",detail:"log(a)",documentation:"Natural logarithm."},{label:"sqrt",detail:"sqrt(a)",documentation:"Square root."}],B=[{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"concat",detail:"concat(string1, string2, ... stringz)",documentation:"Concatenates the strings."},{label:"ltrim",detail:"ltrim(string) or ltrim(string1, string2)",documentation:"Remove white space from the left of the string. If the function has a second string argument, it removes the characters of string2 from the left of string1."},{label:"rtrim",detail:"rtrim(string) or rtrim(string1, string2)",documentation:"Remove white space from the right of the string. If the function has a second string argument, it removes the characters of string2 from the right of string1."},{label:"trim",detail:"trim(string) or trim(string1, string2)",documentation:"Remove white space from both ends of the string. If the function has a second string argument, it removes the characters of string2 from both sides of string1."},{label:"strlen",detail:"strlen(string)",documentation:"Returns the length of the string in Unicode code points."},{label:"toupper",detail:"toupper(string)",documentation:"Converts the string to uppercase."},{label:"tolower",detail:"tolower(string)",documentation:"Converts the string to lowercase."},{label:"substr",detail:"substr(string1, x), or substr(string1, x, y)",documentation:"Returns a substring from the index specified by the number argument to the end of the string. If the function has a second number argument, it contains the length of the substring to be retrieved."},{label:"replace",detail:"replace(string1, string2, string3)",documentation:"Replaces all instances of string2 in string1 with string3."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."}],W=[{label:"bin",detail:"bin(period)",documentation:"Rounds the value of @timestamp to the given period and then truncates."},{label:"datefloor",detail:"datefloor(a, period)",documentation:"Truncates the timestamp to the given period."},{label:"dateceil",detail:"dateceil(a, period)",documentation:"Rounds up the timestamp to the given period and then truncates."},{label:"fromMillis",detail:"fromMillis(fieldname)",documentation:"Interprets the input field as the number of milliseconds since the Unix epoch and converts it to a timestamp."},{label:"toMillis",detail:"toMillis(fieldname)",documentation:"Converts the timestamp found in the named field into a number representing the milliseconds since the Unix epoch."}],U=[{label:"isValidIp",detail:"isValidIp(fieldname)",documentation:"Returns true if the field is a valid v4 or v6 IP address."},{label:"isValidIpV4",detail:"isValidIpV4(fieldname)",documentation:"Returns true if the field is a valid v4 IP address."},{label:"isValidIpV6",detail:"isValidIpV6(fieldname)",documentation:"Returns true if the field is a valid v6 IP address."},{label:"isIpInSubnet",detail:"isIpInSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 or v6 IP address within the specified v4 or v6 subnet."},{label:"isIpv4InSubnet",detail:"isIpv4InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v4 IP address within the specified v4 subnet."},{label:"isIpv6InSubnet",detail:"isIpv6InSubnet(fieldname, string)",documentation:"Returns true if the field is a valid v6 IP address within the specified v6 subnet."}],z=[{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"isempty",detail:"isempty(fieldname)",documentation:"Returns true if the field is missing or is an empty string."},{label:"isblank",detail:"isblank(fieldname)",documentation:"Returns true if the field is missing, an empty string, or contains only white space."},{label:"strcontains",detail:"strcontains(string1, string2)",documentation:"Returns 1 if string1 contains string2 and 0 otherwise."},...U],H=[{label:"avg",detail:"avg(NumericFieldname)",documentation:"The average of the values in the specified field."},{label:"count",detail:"count(fieldname) or count(*)",documentation:"Counts the log records."},{label:"count_distinct",detail:"count_distinct(fieldname)",documentation:"Returns the number of unique values for the field."},{label:"max",detail:"max(fieldname)",documentation:"The maximum of the values for this log field in the queried logs."},{label:"min",detail:"min(fieldname)",documentation:"The minimum of the values for this log field in the queried logs."},{label:"pct",detail:"pct(fieldname, value)",documentation:"A percentile indicates the relative standing of a value in a datas."},{label:"stddev",detail:"stddev(NumericFieldname)",documentation:"The standard deviation of the values in the specified field."},{label:"sum",detail:"sum(NumericFieldname)",documentation:"The sum of the values in the specified field."}],X=[...H,{label:"earliest",detail:"earliest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the earliest time stamp in the queried logs."},{label:"latest",detail:"latest(fieldname)",documentation:"Returns the value of fieldName from the log event that has the latest time stamp in the queried logs."},{label:"sortsFirst",detail:"sortsFirst(fieldname)",documentation:"Returns the value of fieldName that sorts first in the queried logs."},{label:"sortsLast",detail:"sortsLast(fieldname)",documentation:"Returns the value of fieldName that sorts last in the queried logs."}],Y=[...$,{label:"ispresent",detail:"ispresent(fieldname)",documentation:"Returns true if the field exists."},{label:"coalesce",detail:"coalesce(fieldname1, fieldname2, ... fieldnamex)",documentation:"Returns the first non-null value from the list."},...B,...W,...U],J=[...Y,...X],Z={comment:{pattern:/^#.*/,greedy:!0},backticks:{pattern:/`.*?`/,alias:"string",greedy:!0},quote:{pattern:/".*?"/,alias:"string",greedy:!0},regex:{pattern:/\/.*?\/(?=\||\s*$|,)/,greedy:!0},"query-command":{pattern:new RegExp(`\\b(?:${G.map((e=>e.label)).join("|")})\\b`,"i"),alias:"function"},function:{pattern:new RegExp(`\\b(?:${J.map((e=>e.label)).join("|")})\\b`,"i")},keyword:{pattern:new RegExp(`(\\s+)(${["as","like","by","in","desc","asc"].join("|")})(?=\\s+)`,"i"),lookbehind:!0},"field-name":{pattern:/(@?[_a-zA-Z]+[_.0-9a-zA-Z]*)|(`((\\`)|([^`]))*?`)/,greedy:!0},number:/\b-?\d+((\.\d*)?([eE][+-]?\d+)?)?\b/,"command-separator":{pattern:/\|/,alias:"punctuation"},"comparison-operator":{pattern:/([<>]=?)|(!?=)/},punctuation:/[{}()`,.]/,whitespace:/\s+/};var ee,te;const re=[{category:"Lambda",examples:[{title:"View latency statistics for 5-minute intervals",expr:K`filter @type = "REPORT" |
                           stats avg(@duration), max(@duration), min(@duration) by bin(5m)`},{title:"Determine the amount of overprovisioned memory",expr:L`
        filter @type = "REPORT" |
        stats max(@memorySize / 1024 / 1024) as provisonedMemoryMB,
              min(@maxMemoryUsed / 1024 / 1024) as smallestMemoryRequestMB,
              avg(@maxMemoryUsed / 1024 / 1024) as avgMemoryUsedMB,
              max(@maxMemoryUsed / 1024 / 1024) as maxMemoryUsedMB,
              provisonedMemoryMB - maxMemoryUsedMB as overProvisionedMB`},{title:"Find the most expensive requests",expr:K`filter @type = "REPORT" |
                           fields @requestId, @billedDuration |
                           sort by @billedDuration desc`}]},{category:"VPC Flow Logs",examples:[{title:"Average, min, and max byte transfers by source and destination IP addresses",expr:"stats avg(bytes), min(bytes), max(bytes) by srcAddr, dstAddr"},{title:"IP addresses using UDP transfer protocol",expr:"filter protocol=17 | stats count(*) by srcAddr"},{title:"Top 10 byte transfers by source and destination IP addresses",expr:K`stats sum(bytes) as bytesTransferred by srcAddr, dstAddr |
                           sort bytesTransferred desc |
                           limit 10`},{title:"Top 20 source IP addresses with highest number of rejected requests",expr:K`filter action="REJECT" |
                           stats count(*) as numRejections by srcAddr |
                           sort numRejections desc |
                           limit 20`}]},{category:"CloudTrail",examples:[{title:"Number of log entries by service, event type, and region",expr:"stats count(*) by eventSource, eventName, awsRegion"},{title:"Number of log entries by region and EC2 event type",expr:K`filter eventSource="ec2.amazonaws.com" |
                           stats count(*) as eventCount by eventName, awsRegion |
                           sort eventCount desc`},{title:"Regions, usernames, and ARNs of newly created IAM users",expr:K`filter eventName="CreateUser" |
                           fields awsRegion, requestParameters.userName, responseElements.user.arn`}]},{category:"Common Queries",examples:[{title:"25 most recently added log events",expr:K`fields @timestamp, @message |
                           sort @timestamp desc |
                           limit 25`},{title:"Number of exceptions logged every 5 minutes",expr:K`filter @message like /Exception/ |
                           stats count(*) as exceptionCount by bin(5m) |
                           sort exceptionCount desc`},{title:"List of log events that are not exceptions",expr:"fields @message | filter @message not like /Exception/"}]},{category:"Route 53",examples:[{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) by queryType, bin(10m)"},{title:"Number of unsuccessful requests by domain",expr:'filter responseCode="SERVFAIL" | stats count(*) by queryName'},{title:"Number of requests received every 10  minutes by edge location",expr:"stats count(*) as numRequests by resolverIp | sort numRequests desc | limit 10"}]},{category:"AWS AppSync",examples:[{title:"Number of unique HTTP status codes",expr:K`fields ispresent(graphQLAPIId) as isApi |
                           filter isApi |
                           filter logType = "RequestSummary" |
                           stats count() as statusCount by statusCode |
                           sort statusCount desc`},{title:"Top 10 resolvers with maximum latency",expr:K`fields resolverArn, duration |
                           filter logType = "Tracing" |
                           sort duration desc |
                           limit 10`},{title:"Most frequently invoked resolvers",expr:K`fields ispresent(resolverArn) as isRes |
                           stats count() as invocationCount by resolverArn |
                           filter isRes |
                           filter logType = "Tracing" |
                           sort invocationCount desc |
                           limit 10`},{title:"Resolvers with most errors in mapping templates",expr:K`fields ispresent(resolverArn) as isRes |
                           stats count() as errorCount by resolverArn, logType |
                           filter isRes and (logType = "RequestMapping" or logType = "ResponseMapping") and fieldInError |
                           sort errorCount desc |
                           limit 10`},{title:"Field latency statistics",expr:K`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`},{title:"Resolver latency statistics",expr:K`fields ispresent(resolverArn) as isRes |
                           filter isRes |
                           filter logType = "Tracing" |
                           stats min(duration), max(duration), avg(duration) as avgDur by resolverArn |
                           sort avgDur desc |
                           limit 10`},{title:"Top 10 requests with maximum latency",expr:K`fields requestId, latency |
                           filter logType = "RequestSummary" |
                           sort latency desc |
                           limit 10`}]}];function ne(e,t){const r=Z,n=(0,V.a)(_().tokenize(e,r)).filter((e=>"string"!=typeof e)).map(((e,r)=>(0,f.jsx)("span",{className:`prism-token token ${e.types.join(" ")} ${e.aliases.join(" ")}`,children:e.content},`${t}-token-${r}`)));return(0,f.jsx)("div",{className:"slate-query-field",children:n})}const ie=h.css`
  margin-top: 5px;
`;class se extends a.PureComponent{onClickExample(e){this.props.onClickExample(e)}renderExpression(e,t){return(0,f.jsx)("div",{className:"cheat-sheet-item__example",onClick:()=>{var t,r;return this.onClickExample({refId:null!==(t=this.props.query.refId)&&void 0!==t?t:"A",expression:e,queryMode:"Logs",region:this.props.query.region,id:null!==(r=this.props.query.refId)&&void 0!==r?r:"A",logGroupNames:"logGroupNames"in this.props.query?this.props.query.logGroupNames:[]})},children:(0,f.jsx)("pre",{children:ne(e,t)})},e)}renderLogsCheatSheet(){return(0,f.jsxs)("div",{children:[ee||(ee=(0,f.jsx)("h2",{children:"CloudWatch Logs Cheat Sheet"})),re.map(((e,t)=>(0,f.jsxs)("div",{children:[(0,f.jsx)("div",{className:`cheat-sheet-item__title ${(0,h.cx)(ie)}`,children:e.category}),e.examples.map(((e,t)=>(0,f.jsxs)("div",{className:"cheat-sheet-item",children:[(0,f.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`${e.category}-${t}`)))]})}render(){return(0,f.jsxs)("div",{children:[te||(te=(0,f.jsx)("h3",{children:"CloudWatch Logs cheat sheet"})),re.map(((e,t)=>(0,f.jsxs)("div",{children:[(0,f.jsx)("div",{className:`cheat-sheet-item__title ${(0,h.cx)(ie)}`,children:e.category}),e.examples.map(((e,t)=>(0,f.jsxs)("div",{className:"cheat-sheet-item",children:[(0,f.jsx)("h4",{children:e.title}),this.renderExpression(e.expr,`item-${t}`)]},`item-${t}`)))]},`cat-${t}`)))]})}}var ae,oe=r("./.yarn/cache/lodash-npm-4.17.21-6382451519-eb835a2e51.zip/node_modules/lodash/lodash.js");const le=e=>"Logs"===e.queryMode,ue=e=>"Metrics"===e.queryMode||!e.hasOwnProperty("queryMode"),ce=e=>"Annotations"===e.queryMode;var de=r("./.yarn/__virtual__/@grafana-experimental-virtual-22e4fdfd25/0/cache/@grafana-experimental-npm-0.0.2-canary.30-71a280d204-b5b453b937.zip/node_modules/@grafana/experimental/index.js"),pe=r("./.yarn/__virtual__/react-use-virtual-00326e70ba/0/cache/react-use-npm-17.3.2-a032cbeb01-7379460f51.zip/node_modules/react-use/esm/useAsyncFn.js");const me=e=>({label:e,value:e}),he=(e,t)=>[...t,{label:"Template Variables",options:e.getVariables().map(me)}],ge={value:"*",label:"*"},fe=e=>{let{filter:t,metricStat:{region:r,namespace:n,metricName:i,dimensions:o},datasource:l,dimensionKeys:c,disableExpressions:d,onChange:p,onDelete:m}=e;const g=(0,a.useMemo)((()=>((e,t)=>Object.entries(null!=e?e:{}).reduce(((e,r)=>{let[n,i]=r;return n!==t?Object.assign({},e,{[n]:i}):e}),{}))(null!=o?o:{},t.key)),[o,t]),[v,y]=(0,pe.Z)((async()=>t.key?l.getDimensionValues(r,n,i,t.key,g).then((e=>(e.length&&!d&&e.unshift(ge),he(l,e)))):[]),[t.key,o]),b=(0,u.useTheme2)(),x=ve(b);return(0,f.jsx)("div",{"data-testid":"cloudwatch-dimensions-filter-item",children:(0,f.jsxs)(de.InputGroup,{children:[(0,f.jsx)(u.Select,{"aria-label":"Dimensions filter key",inputId:"cloudwatch-dimensions-filter-item-key",width:"auto",value:t.key?(0,s.toOption)(t.key):null,allowCustomValue:!0,options:c,onChange:e=>{e.label&&p({key:e.label,value:void 0})}}),(0,f.jsx)("span",{className:(0,h.cx)(x.root),children:"="}),(0,f.jsx)(u.Select,{"aria-label":"Dimensions filter value",inputId:"cloudwatch-dimensions-filter-item-value",onOpenMenu:y,width:"auto",value:t.value?(0,s.toOption)(t.value):null,allowCustomValue:!0,isLoading:v.loading,options:v.value,onChange:e=>{e.value&&p(Object.assign({},t,{value:e.value}))}}),(0,f.jsx)(de.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:m,type:"button"})]})})},ve=(0,u.stylesFactory)((e=>({root:(0,h.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),ye=e=>{let{metricStat:t,datasource:r,dimensionKeys:n,disableExpressions:i,onChange:s}=e;const o=(0,a.useMemo)((()=>{return e=t.dimensions,Object.entries(null!=e?e:{}).reduce(((e,t)=>{let[r,n]=t;if(n&&"string"==typeof n){const t={key:r,value:n,operator:"="};return[...e,t]}return e}),[]);var e}),[t.dimensions]),[l,u]=(0,a.useState)(o);return(0,f.jsx)(de.EditorList,{items:l,onChange:e=>{u(e);const r=e.reduce(((e,t)=>{let{key:r,value:n}=t;return r&&n?Object.assign({},e,{[r]:n}):e}),{});(0,oe.isEqual)(r,t.dimensions)||s(r)},renderItem:be(r,t,n,i)})};function be(e,t,r,n){return function(i,s,a){return(0,f.jsx)(fe,{filter:i,onChange:e=>s(e),datasource:e,metricStat:t,disableExpressions:n,dimensionKeys:r,onDelete:a})}}const xe=r("./.yarn/cache/jsurl-npm-0.1.5-9e17f93783-50b614908d.zip/node_modules/jsurl/index.js");function Se(e,t){return`https://${t}.console.aws.amazon.com/cloudwatch/home?region=${t}#logs-insights:queryDetail=${xe.stringify(e)}`}var we;class je extends a.Component{constructor(){var e,t,r;super(...arguments),r={href:""},(t="state")in(e=this)?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}async componentDidUpdate(e){const{panelData:t}=this.props,{panelData:r}=e;if(r!==t&&null!=t&&t.request){const e=this.getExternalLink();this.setState({href:e})}}getExternalLink(){var e,t,r;const{query:n,panelData:i,datasource:s}=this.props,a=null==i||null===(e=i.request)||void 0===e?void 0:e.range;if(!a)return"";const o=a.from.toISOString();return Se({end:a.to.toISOString(),start:o,timeType:"ABSOLUTE",tz:"UTC",editorString:null!==(t=n.expression)&&void 0!==t?t:"",isLiveTail:!1,source:null!==(r=n.logGroupNames)&&void 0!==r?r:[]},s.getActualRegion(n.region))}render(){const{href:e}=this.state;return(0,f.jsxs)("a",{href:e,target:"_blank",rel:"noopener noreferrer",children:[we||(we=(0,f.jsx)(u.Icon,{name:"share-alt"}))," CloudWatch Logs Insights"]})}}const Ce=/\s+by\s+/im,Te=/([\w$@().]+)(?:(\s+as\s+)([\w$]+))?\s*,?\s*/iy;function Ie(e){let t,r=[];if(t=e.match(Ce)){let n;for(Te.lastIndex=t.index+t[0].length;n=Te.exec(e);)r.push(n[2]?n[3]:n[1]),Te.lastIndex=n.index+n[0].length}return r}const Re=function(e,t,r){var n=(0,a.useRef)(void 0);n.current&&r(t,n.current)||(n.current=t),(0,a.useEffect)(e,n.current)};var Ae=r("./.yarn/cache/fast-deep-equal-npm-3.1.3-790edcfcf5-e21a9d8d84.zip/node_modules/fast-deep-equal/react.js");const Ee=r.n(Ae)();const Oe=function(e,t){Re(e,t,Ee)},Fe=e=>{const[t,r]=(0,a.useState)(!1),[n,i]=(0,a.useState)([{label:"default",value:"default"}]);return(0,a.useEffect)((()=>{r(!0);const t={label:"Template Variables",options:e.getVariables().map(s.toOption)};e.getRegions().then((e=>i([...e,t]))).finally((()=>r(!1)))}),[e]),[n,t]},Me=e=>{const[t,r]=(0,a.useState)([]);return(0,a.useEffect)((()=>{e.getNamespaces().then((t=>{r(he(e,t))}))}),[e]),t},ke=(e,t,r)=>{const[n,i]=(0,a.useState)([]);return(0,a.useEffect)((()=>{e.getMetrics(r,t).then((t=>{i(he(e,t))}))}),[e,t,r]),n},qe=(e,t,r,n,i)=>{const[s,o]=(0,a.useState)([]);return Oe((()=>{e.getDimensionKeys(r,t,i,n).then((t=>{o(he(e,t))}))}),[e,t,r,n,i]),s};var Ne,Pe=r("./public/app/plugins/datasource/cloudwatch/types.ts");const De=[{label:"Metric Search",value:Pe.$5.Search},{label:"Metric Query",value:Pe.$5.Query}],Le=[{label:"Builder",value:Pe.MQ.Builder},{label:"Code",value:Pe.MQ.Code}],Ke=e=>{let{query:t,sqlCodeEditorIsDirty:r,onChange:n,onRunQuery:i}=e;const{metricEditorMode:s,metricQueryType:o}=t,[l,c]=(0,a.useState)(!1),d=(0,a.useCallback)((e=>{r&&o===Pe.$5.Query&&s===Pe.MQ.Code?c(!0):n(Object.assign({},t,{metricEditorMode:e}))}),[c,n,r,t,s,o]);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(de.InlineSelect,{"aria-label":"Metric editor mode",value:De.find((e=>e.value===o)),options:De,onChange:e=>{let{value:r}=e;n(Object.assign({},t,{metricQueryType:r}))}}),Ne||(Ne=(0,f.jsx)(de.FlexItem,{grow:1})),(0,f.jsx)(u.RadioButtonGroup,{options:Le,size:"sm",value:s,onChange:d}),t.metricQueryType===Pe.$5.Query&&t.metricEditorMode===Pe.MQ.Code&&(0,f.jsx)(u.Button,{variant:"secondary",size:"sm",onClick:()=>i(),children:"Run query"}),(0,f.jsx)(u.ConfirmModal,{isOpen:l,title:"Are you sure?",body:"You will lose manual changes done to the query if you go back to the visual builder.",confirmText:"Yes, I am sure.",dismissText:"No, continue editing the query manually.",icon:"exclamation-triangle",onConfirm:()=>{c(!1),n(Object.assign({},t,{metricEditorMode:Pe.MQ.Builder}))},onDismiss:()=>c(!1)})]})},Qe=[{label:"CloudWatch Metrics",value:"Metrics"},{label:"CloudWatch Logs",value:"Logs"}],_e=e=>{let{query:t,sqlCodeEditorIsDirty:r,datasource:n,onChange:i,onRunQuery:a,onRegionChange:o}=e;const{queryMode:l,region:u}=t,[c,d]=Fe(n);return(0,f.jsxs)(de.EditorHeader,{children:[(0,f.jsx)(de.InlineSelect,{label:"Region",value:u,placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:r}=e;return r&&(async e=>{let{value:r}=e;o&&await o(null!=r?r:"default"),i(Object.assign({},t,{region:r}))})({value:r})},options:c,isLoading:d}),(0,f.jsx)(de.InlineSelect,{"aria-label":"Query mode",value:l,options:Qe,onChange:e=>{let{value:r}=e;if(r!==l){const e=(0,oe.pick)(t,"id","region","namespace","refId","hide","key","queryType","datasource");i(Object.assign({},e,{queryMode:r}))}}}),l===s.ExploreMode.Metrics&&(0,f.jsx)(Ke,{query:t,datasource:n,onChange:i,onRunQuery:a,sqlCodeEditorIsDirty:r})]})};function Ve(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Ge=h.css`
  flex-grow: 1;
  min-height: 35px;
`,$e=h.css`
  gap: 3px;
`;class Be extends a.PureComponent{constructor(e,t){var r,n;super(e,t),Ve(this,"state",{selectedLogGroups:null!==(r=null===(n=this.props.query.logGroupNames)||void 0===n?void 0:n.map((e=>({value:e,label:e}))))&&void 0!==r?r:[],availableLogGroups:[],invalidLogGroups:!1,loadingLogGroups:!1,hint:void 0}),Ve(this,"plugins",void 0),Ve(this,"fetchLogGroupOptions",(async(e,t)=>{try{return(await this.props.datasource.describeLogGroups({refId:this.props.query.refId,region:e,logGroupNamePrefix:t})).map((e=>({value:e,label:e})))}catch(e){let t="unknown error";if("string"!=typeof e)try{t=JSON.stringify(e)}catch(e){}else t=e;return(0,m.WI)((0,c.$l)((0,d.t_)(t))),[]}})),Ve(this,"onLogGroupSearch",((e,t,r)=>{if("input-change"!==r.action)return Promise.resolve();return/^[\.\-_/#A-Za-z0-9]+$/.test(e)?(this.setState({loadingLogGroups:!0}),this.fetchLogGroupOptions(t,e).then((e=>{this.setState((t=>({availableLogGroups:(0,oe.unionBy)(t.availableLogGroups,e,"value")})))})).finally((()=>{this.setState({loadingLogGroups:!1})}))):Promise.resolve()})),Ve(this,"onLogGroupSearchDebounced",(0,oe.debounce)(this.onLogGroupSearch,300)),Ve(this,"componentDidMount",(()=>{const{query:e,onChange:t}=this.props;this.setState({loadingLogGroups:!0}),e.region&&this.fetchLogGroupOptions(e.region).then((r=>{this.setState((n=>{const i=n.selectedLogGroups;if(t){const r=Object.assign({},e,{logGroupNames:i.map((e=>e.value))});t(r)}return{loadingLogGroups:!1,availableLogGroups:r,selectedLogGroups:i}}))}))})),Ve(this,"onChangeQuery",(e=>{const{query:t,onChange:r}=this.props,{selectedLogGroups:n}=this.state;if(r){var i;r(Object.assign({},t,{expression:e,logGroupNames:null!==(i=null==n?void 0:n.map((e=>e.value)))&&void 0!==i?i:[],statsGroups:Ie(e)}))}})),Ve(this,"setSelectedLogGroups",(e=>{var t;this.setState({selectedLogGroups:e});const{onChange:r,query:n}=this.props;null==r||r(Object.assign({},n,{logGroupNames:null!==(t=e.map((e=>e.value)))&&void 0!==t?t:[]}))})),Ve(this,"setCustomLogGroups",(e=>{const t={value:e,label:e},r=[...this.state.selectedLogGroups,t];this.setSelectedLogGroups(r)})),Ve(this,"onRegionChange",(async e=>{this.setState({loadingLogGroups:!0});const t=await this.fetchLogGroupOptions(e);this.setState((e=>{const r=(0,oe.intersectionBy)(e.selectedLogGroups,t,"value"),{onChange:n,query:i}=this.props;if(n){n(Object.assign({},i,{logGroupNames:r.map((e=>e.value))}))}return{availableLogGroups:t,selectedLogGroups:r,loadingLogGroups:!1}}))})),Ve(this,"onTypeahead",(async e=>{const{datasource:t,query:r}=this.props,{selectedLogGroups:n}=this.state;if(!t.languageProvider)return{suggestions:[]};const i=t.languageProvider,{history:s,absoluteRange:a}=this.props,{prefix:o,text:l,value:u,wrapperClasses:c,labelKey:d,editor:p}=e;return await i.provideCompletionItems({text:l,value:u,prefix:o,wrapperClasses:c,labelKey:d,editor:p},{history:s,absoluteRange:a,logGroupNames:n.map((e=>e.value)),region:r.region})})),Ve(this,"onQueryFieldClick",((e,t,r)=>{const{selectedLogGroups:n,loadingLogGroups:i}=this.state;(i||0===n.length)&&this.setState({invalidLogGroups:!0}),r()})),Ve(this,"onOpenLogGroupMenu",(()=>{this.setState({invalidLogGroups:!1})})),this.plugins=[(0,u.BracesPlugin)(),(0,u.SlatePrism)({onlyIn:e=>"block"===e.object&&"code_block"===e.type,getSyntax:e=>"cloudwatch"},Object.assign({},Q.languages,{cloudwatch:Z}))]}render(){var e,t;const{onRunQuery:r,onChange:n,ExtraFieldElement:i,data:s,query:a,datasource:o,allowCustomValue:l}=this.props,{selectedLogGroups:c,availableLogGroups:d,loadingLogGroups:p,hint:m,invalidLogGroups:h}=this.state,g=s&&s.error&&s.error.refId===a.refId,v=o.languageProvider?o.languageProvider.cleanText:void 0;return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(_e,{query:a,onRunQuery:r,datasource:o,onChange:n,sqlCodeEditorIsDirty:!1,onRegionChange:this.onRegionChange}),(0,f.jsx)("div",{className:`gf-form gf-form--grow flex-grow-1 ${$e}`,children:(0,f.jsx)(u.LegacyForms.FormField,{label:"Log Groups",labelWidth:6,className:"flex-grow-1",inputEl:(0,f.jsx)(u.MultiSelect,{"aria-label":"Log Groups",allowCustomValue:l,options:(0,oe.unionBy)(d,c,"value"),value:c,onChange:e=>{this.setSelectedLogGroups(e)},onCreateOption:e=>{this.setCustomLogGroups(e)},onBlur:this.props.onRunQuery,className:Ge,closeMenuOnSelect:!1,isClearable:!0,invalid:h,isOptionDisabled:()=>c.length>=20,placeholder:"Choose Log Groups",maxVisibleValues:4,noOptionsMessage:"No log groups available",isLoading:p,onOpenMenu:this.onOpenLogGroupMenu,onInputChange:(e,t)=>{this.onLogGroupSearchDebounced(e,a.region,t)}})})}),(0,f.jsxs)("div",{className:"gf-form-inline gf-form-inline--nowrap flex-grow-1",children:[(0,f.jsx)("div",{className:"gf-form gf-form--grow flex-shrink-1",children:(0,f.jsx)(u.QueryField,{additionalPlugins:this.plugins,query:null!==(e=a.expression)&&void 0!==e?e:"",onChange:this.onChangeQuery,onClick:this.onQueryFieldClick,onRunQuery:this.props.onRunQuery,onTypeahead:this.onTypeahead,cleanText:v,placeholder:"Enter a CloudWatch Logs Insights query (run with Shift+Enter)",portalOrigin:"cloudwatch",disabled:p||0===c.length})}),i]}),m&&(0,f.jsx)("div",{className:"query-row-break",children:(0,f.jsxs)("div",{className:"text-warning",children:[m.message,(0,f.jsx)("a",{className:"text-link muted",onClick:m.fix.action,children:m.fix.label})]})}),g?(0,f.jsx)("div",{className:"query-row-break",children:(0,f.jsx)("div",{className:"prom-query-field-info text-error",children:null==s||null===(t=s.error)||void 0===t?void 0:t.message})}):null]})}}const We=h.css`
  margin-left: 3px;
  flex-grow: 0;
`,Ue=(0,a.memo)((function(e){var t,r;const{query:n,data:i,datasource:s,onRunQuery:a,onChange:o,exploreId:l,allowCustomValue:c=!1}=e;let d;if(null!=i&&null!==(t=i.request)&&void 0!==t&&null!==(r=t.range)&&void 0!==r&&r.from){const{range:e}=i.request;d={from:e.from.valueOf(),to:e.to.valueOf()}}else d={from:Date.now()-1e4,to:Date.now()};return(0,f.jsx)(Be,{exploreId:l,datasource:s,query:n,onChange:o,onRunQuery:a,history:[],data:i,absoluteRange:d,allowCustomValue:c,ExtraFieldElement:(0,f.jsx)(u.InlineFormLabel,{className:`gf-form-label--btn ${We}`,width:"auto",tooltip:"Link to Graph in AWS",children:(0,f.jsx)(je,{query:n,panelData:i,datasource:s})})})}));function ze(e){var t;let{refId:r,metricStat:n,datasource:i,disableExpressions:s=!1,onChange:a,onRunQuery:o}=e;const{region:l,namespace:c,metricName:d,dimensions:p}=n,m=Me(i),h=ke(i,l,c),g=qe(i,l,c,d,null!=p?p:{}),v=e=>{a(e),o()},y=async e=>{let{metricName:t,namespace:r,region:n}=e;return t?(await i.getMetrics(r,n).then((e=>{e.find((e=>e.value===t))||(t="")})),Object.assign({},e,{metricName:t})):e};return(0,f.jsxs)(de.EditorRows,{children:[(0,f.jsx)(de.EditorRow,{children:(0,f.jsxs)(de.EditorFieldGroup,{children:[(0,f.jsx)(de.EditorField,{label:"Namespace",width:26,children:(0,f.jsx)(u.Select,{"aria-label":"Namespace",value:n.namespace,allowCustomValue:!0,options:m,onChange:e=>{let{value:t}=e;t&&(async e=>{const t=await y(e);v(t)})(Object.assign({},n,{namespace:t}))}})}),(0,f.jsx)(de.EditorField,{label:"Metric name",width:16,children:(0,f.jsx)(u.Select,{"aria-label":"Metric name",value:n.metricName||null,allowCustomValue:!0,options:h,onChange:e=>{let{value:t}=e;t&&v(Object.assign({},n,{metricName:t}))}})}),(0,f.jsx)(de.EditorField,{label:"Statistic",width:16,children:(0,f.jsx)(u.Select,{inputId:`${r}-metric-stat-editor-select-statistic`,allowCustomValue:!0,value:me(null!==(t=n.statistic)&&void 0!==t?t:i.standardStatistics[0]),options:he(i,i.standardStatistics.filter((e=>e!==n.statistic)).map(me)),onChange:e=>{let{value:t}=e;t&&(i.standardStatistics.includes(t)||/^p\d{2}(?:\.\d{1,2})?$/.test(t)||t.startsWith("$"))&&v(Object.assign({},n,{statistic:t}))}})})]})}),(0,f.jsx)(de.EditorRow,{children:(0,f.jsx)(de.EditorField,{label:"Dimensions",children:(0,f.jsx)(ye,{metricStat:n,onChange:e=>v(Object.assign({},n,{dimensions:e})),dimensionKeys:g,disableExpressions:s,datasource:i})})}),!s&&(0,f.jsx)(de.EditorRow,{children:(0,f.jsx)(de.EditorField,{label:"Match exact",optional:!0,tooltip:"Only show metrics that exactly match all defined dimension names.",children:(0,f.jsx)(de.EditorSwitch,{id:`${r}-cloudwatch-match-exact`,value:!!n.matchExact,onChange:e=>{v(Object.assign({},n,{matchExact:e.currentTarget.checked}))}})})})]})}var He=r("./public/app/features/templating/template_srv.ts");let Xe,Ye;!function(e){e.String="string"}(Xe||(Xe={})),function(e){e.Property="property",e.Operator="operator",e.Or="or",e.And="and",e.GroupBy="groupBy",e.Function="function",e.FunctionParameter="functionParameter"}(Ye||(Ye={}));class Je{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,He.J)();this.templateSrv=e,this.templateSrv=e}expressionToSqlQuery(e){var t,r,n;let{select:i,from:s,where:a,groupBy:o,orderBy:l,orderByDirection:u,limit:c}=e;if(!s||null==i||!i.name||null==i||null===(t=i.parameters)||void 0===t||!t.length)return;let d=[];return this.appendSelect(i,d),this.appendFrom(s,d),this.appendWhere(a,d,!0,null!==(r=null==a||null===(n=a.expressions)||void 0===n?void 0:n.length)&&void 0!==r?r:0),this.appendGroupBy(o,d),this.appendOrderBy(l,u,d),this.appendLimit(c,d),d.join(" ")}appendSelect(e,t){t.push("SELECT"),this.appendFunction(e,t)}appendFrom(e,t){var r,n;t.push("FROM"),(null==e?void 0:e.type)===Ye.Function?this.appendFunction(e,t):t.push(this.formatValue(null!==(r=null==e||null===(n=e.property)||void 0===n?void 0:n.name)&&void 0!==r?r:""))}appendWhere(e,t,r,n){if(!e)return;const i="expressions"in e&&e.expressions.length>0;if(r&&i&&t.push("WHERE"),e.type===Ye.And){const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,n))),0===i.length)return;const s=i.join(" AND "),a=!r&&n>1&&i.length>1;return t.push(a?`(${s})`:s)}if(e.type!==Ye.Or)return e.type===Ye.Operator?this.appendOperator(e,t):void 0;{const i=[];if(e.expressions.map((e=>this.appendWhere(e,i,!1,n))),0===i.length)return;const s=i.join(" OR "),a=!r&&n>1&&i.length>1;t.push(a?`(${s})`:s)}}appendGroupBy(e,t){const r=[];for(const t of null!==(n=null==e?void 0:e.expressions)&&void 0!==n?n:[]){var n;(null==t?void 0:t.type)===Ye.GroupBy&&t.property.name&&r.push(this.formatValue(t.property.name))}r.length>0&&t.push(`GROUP BY ${r.join(", ")}`)}appendOrderBy(e,t,r){e&&(r.push("ORDER BY"),this.appendFunction(e,r),r.push(null!=t?t:"ASC"))}appendLimit(e,t){e&&t.push(`LIMIT ${e}`)}appendOperator(e,t,r){const{property:n,operator:i}=e;n.name&&i.name&&i.value&&t.push(`${this.formatValue(n.name)} ${i.name} '${i.value}'`)}appendFunction(e,t){var r;if(null==e||!e.name)return;const n=(null!==(r=e.parameters)&&void 0!==r?r:[]).map((e=>e.name&&this.formatValue(e.name))).filter(Boolean).join(", ");t.push(`${e.name}(${n})`)}formatValue(e){const t=this.templateSrv.replace(e,{},"raw");return/[/\s\.-]/.test(t)?`"${e}"`:e}}var Ze=r("./public/app/plugins/datasource/cloudwatch/cloudwatch-sql/language.ts");function et(e){var t;return null==e||null===(t=e.parameters)||void 0===t?void 0:t[0].name}function tt(e){return(null==e?void 0:e.type)===Ye.Property?e.property.name:(null==e?void 0:e.type)===Ye.Function?null===(t=e.parameters)||void 0===t?void 0:t[0].name:void 0;var t}function rt(e){var t,r,n;const i=null===(t=e.property)||void 0===t?void 0:t.name,s=null===(r=e.operator)||void 0===r?void 0:r.value,a=null===(n=e.operator)||void 0===n?void 0:n.name;if(i&&s&&a)return{type:Ye.Operator,property:{type:Xe.String,name:i},operator:{value:s,name:a}}}function nt(e){return e.flatMap((e=>e.type===Ye.Operator?e:e.type===Ye.And||e.type===Ye.Or?nt(e.expressions):[]))}function it(e){var t;const r=e.where;return nt(null!==(t=null==r?void 0:r.expressions)&&void 0!==t?t:[])}function st(e){var t;const r=e.groupBy;return(null!==(t=null==r?void 0:r.expressions)&&void 0!==t?t:[]).flatMap((e=>e.type===Ye.GroupBy?e:[]))}function at(e,t){var r;return Object.assign({},e,{sql:Object.assign({},null!==(r=e.sql)&&void 0!==r?r:{},t)})}function ot(e,t){var r,n;return at(e,{select:Object.assign({type:Ye.Function},null!==(r=null===(n=e.sql)||void 0===n?void 0:n.select)&&void 0!==r?r:{},{name:t})})}const lt=Ze.STATISTICS.map(s.toOption),ut=e=>{var t,r;let{datasource:n,query:i,onQueryChange:o}=e;const l=null!==(t=i.sql)&&void 0!==t?t:{},c=null===(r=l.select)||void 0===r?void 0:r.name;(0,a.useEffect)((()=>{c||o(ot(i,Ze.STATISTICS[0]))}),[c,o,i]);const d=et(l.select),p=tt(l.from),m=function(e){var t;if((null==e?void 0:e.type)===Ye.Function&&null!=e&&null!==(t=e.parameters)&&void 0!==t&&t.length){var r;return(null==e||null===(r=e.parameters)||void 0===r?void 0:r.length)<=1?[]:(null==e?void 0:e.parameters.slice(1)).reduce(((e,t)=>t.name?[...e,t.name]:e),[])}}(l.from),h=(null==(g=l.from)?void 0:g.type)===Ye.Function&&g.name===Ze.SCHEMA;var g;const v=Me(n),y=ke(n,i.region,p),b=(0,a.useMemo)((()=>(null!=m?m:[]).reduce(((e,t)=>t?Object.assign({},e,{[t]:null}):e),{})),[m]),x=qe(n,i.region,p,d,b),S=(0,a.useMemo)((()=>null!=m&&m.length?[...x,...m.map(s.toOption)]:x),[x,m]),w=async e=>{let{region:t,sql:r}=e;return await n.getMetrics(e.namespace,t).then((t=>{t.some((e=>e.value===d))||(r=function(e){var t,r;const n=Object.assign({},e);return null===(t=n.sql)||void 0===t||null===(r=t.select)||void 0===r||delete r.parameters,n}(e).sql)})),Object.assign({},e,{sql:r})};return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsxs)(de.EditorFieldGroup,{children:[(0,f.jsx)(de.EditorField,{label:"Namespace",width:16,children:(0,f.jsx)(u.Select,{"aria-label":"Namespace",value:p?(0,s.toOption)(p):null,inputId:`${i.refId}-cloudwatch-sql-namespace`,options:v,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&(async e=>{const t=await w(e);o(t)})(function(e,t){var r;const n=null!==(r=e.sql)&&void 0!==r?r:{};if(e.namespace=t||"",void 0===t)return at(e,{from:void 0});if(!n.from||n.from.type===Ye.Property)return at(e,{from:{type:Ye.Property,property:{type:Xe.String,name:t}}});if(n.from.type===Ye.Function){var i;const r={type:Ye.FunctionParameter,name:t},s=(null!==(i=n.from.parameters)&&void 0!==i?i:[]).slice(1);return at(e,{from:{type:Ye.Function,name:Ze.SCHEMA,parameters:[r,...s]}})}return e}(i,t))}})}),(0,f.jsx)(de.EditorField,{label:"With schema",children:(0,f.jsx)(de.EditorSwitch,{id:`${i.refId}-cloudwatch-sql-withSchema`,value:h,onChange:e=>e.target instanceof HTMLInputElement&&o(function(e,t){var r;const n=tt((null!==(r=e.sql)&&void 0!==r?r:{}).from);if(t){const t={type:Ye.FunctionParameter,name:n};return at(e,{from:{type:Ye.Function,name:Ze.SCHEMA,parameters:[t]}})}return at(e,{from:{type:Ye.Property,property:{type:Xe.String,name:n}}})}(i,e.target.checked))})}),h&&(0,f.jsx)(de.EditorField,{label:"Schema labels",disabled:!p,children:(0,f.jsx)(u.Select,{id:`${i.refId}-cloudwatch-sql-schema-label-keys`,width:"auto",isMulti:!0,value:m?m.map(s.toOption):null,options:S,allowCustomValue:!0,onChange:e=>e&&o(function(e,t){var r,n,i;const s=null!==(r=e.sql)&&void 0!==r?r:{};if(t=Array.isArray(t)?t.map((e=>e.value)):[t.value],(null===(n=s.from)||void 0===n?void 0:n.type)===Ye.Function&&null!==(i=s.from.parameters)&&void 0!==i&&i.length){var a,o;const r=(null!==(a=t)&&void 0!==a?a:[]).map((e=>({type:Ye.FunctionParameter,name:e}))),n=(null!==(o=s.from.parameters)&&void 0!==o?o:[])[0];return at(e,{from:{type:Ye.Function,name:Ze.SCHEMA,parameters:[n,...r]}})}return e}(i,e))})})]}),(0,f.jsxs)(de.EditorFieldGroup,{children:[(0,f.jsx)(de.EditorField,{label:"Metric name",width:16,children:(0,f.jsx)(u.Select,{"aria-label":"Metric name",value:d?(0,s.toOption)(d):null,options:y,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&o(function(e,t){var r,n;const i={type:Ye.FunctionParameter,name:t};return at(e,{select:Object.assign({type:Ye.Function},null!==(r=null===(n=e.sql)||void 0===n?void 0:n.select)&&void 0!==r?r:{},{parameters:[i]})})}(i,t))}})}),(0,f.jsx)(de.EditorField,{label:"Aggregation",width:16,children:(0,f.jsx)(u.Select,{"aria-label":"Aggregation",value:c?(0,s.toOption)(c):null,options:he(n,lt),onChange:e=>{let{value:t}=e;return t&&o(ot(i,t))}})})]})]})},ct=Ze.COMPARISON_OPERATORS.map(s.toOption);function dt(e,t){return function(r,n,i){return(0,f.jsx)(mt,{datasource:e,query:t,filter:r,onChange:n,onDelete:i})}}const pt=e=>{let{query:t,onQueryChange:r,datasource:n}=e;const i=(0,a.useMemo)((()=>{var e;return it(null!==(e=t.sql)&&void 0!==e?e:{})}),[t.sql]),[s,o]=(0,a.useState)(i);return(0,f.jsx)(de.EditorList,{items:s,onChange:e=>{const n=e.map((e=>{var t,r;return{type:Ye.Operator,property:null!==(t=e.property)&&void 0!==t?t:{type:Xe.String},operator:null!==(r=e.operator)&&void 0!==r?r:{name:Ze.EQUALS}}}));o(n);const i=[];for(const e of n){const t=rt(e);t&&i.push(t)}const s=i.length?{type:Ye.And,expressions:i}:void 0;r(at(t,{where:s}))},renderItem:dt(n,t)})},mt=e=>{var t,r,n,i,a,o,l,c;const{datasource:d,query:p,filter:m,onChange:h,onDelete:g}=e,v=null!==(t=p.sql)&&void 0!==t?t:{},y=tt(v.from),b=et(v.select),x=qe(d,p.region,y,b),[S,w]=(0,pe.Z)((async()=>{var e;return null!==(e=m.property)&&void 0!==e&&e.name?d.getDimensionValues(p.region,y,b,m.property.name,{}).then((e=>he(d,e))):[]}),[p.region,y,b,null===(r=m.property)||void 0===r?void 0:r.name]);return(0,f.jsxs)(de.InputGroup,{children:[(0,f.jsx)(u.Select,{width:"auto",value:null!==(n=m.property)&&void 0!==n&&n.name?(0,s.toOption)(null===(i=m.property)||void 0===i?void 0:i.name):null,options:x,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&h((r=m,n=t,{type:Ye.Operator,property:{type:Xe.String,name:n},operator:null!==(i=r.operator)&&void 0!==i?i:{}}));var r,n,i}}),(0,f.jsx)(u.Select,{width:"auto",value:(null===(a=m.operator)||void 0===a?void 0:a.name)&&(0,s.toOption)(m.operator.name),options:ct,onChange:e=>{let{value:t}=e;return t&&h((r=m,n=t,{type:Ye.Operator,property:null!==(i=r.property)&&void 0!==i?i:{type:Xe.String},operator:Object.assign({},r.operator,{name:n})}));var r,n,i}}),(0,f.jsx)(u.Select,{width:"auto",isLoading:S.loading,value:null!==(o=m.operator)&&void 0!==o&&o.value&&"string"==typeof(null===(l=m.operator)||void 0===l?void 0:l.value)?(0,s.toOption)(null===(c=m.operator)||void 0===c?void 0:c.value):null,options:S.value,allowCustomValue:!0,onOpenMenu:w,onChange:e=>{let{value:t}=e;return t&&h(function(e,t){var r;return{type:Ye.Operator,property:null!==(r=e.property)&&void 0!==r?r:{type:Xe.String},operator:Object.assign({},e.operator,{value:t})}}(m,t))}}),(0,f.jsx)(de.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:g})]})};function ht(e){return function(t,r,n){return(0,f.jsx)(gt,{options:e,item:t,onChange:r,onDelete:n})}}const gt=e=>{var t;const{options:r,item:n,onChange:i,onDelete:a}=e,o=null===(t=n.property)||void 0===t?void 0:t.name;return(0,f.jsxs)(de.InputGroup,{children:[(0,f.jsx)(u.Select,{"aria-label":`Group by ${null!=o?o:"filter key"}`,width:"auto",value:o?(0,s.toOption)(o):null,options:r,allowCustomValue:!0,onChange:e=>{let{value:t}=e;return t&&i((r=t,{type:Ye.GroupBy,property:{type:Xe.String,name:r}}));var r}}),(0,f.jsx)(de.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:a})]})},ft=e=>{var t;let{query:r,datasource:n,onQueryChange:i}=e;const s=null!==(t=r.sql)&&void 0!==t?t:{},o=(0,a.useMemo)((()=>{var e;return st(null!==(e=r.sql)&&void 0!==e?e:{})}),[r.sql]),[l,u]=(0,a.useState)(o),c=tt(s.from),d=et(s.select),p=qe(n,r.region,c,d),m=(0,a.useMemo)((()=>p.filter((e=>!o.some((t=>t.property.name===e.value))))),[p,o]);return(0,f.jsx)(de.EditorList,{items:l,onChange:e=>{const t=e.map((e=>{var t;return{type:Ye.GroupBy,property:{type:Xe.String,name:null===(t=e.property)||void 0===t?void 0:t.name}}}));u(t);const n=t.filter((e=>{var t;return null===(t=e.property)||void 0===t?void 0:t.name})),s=n.length?{type:Ye.And,expressions:n}:void 0;i(at(r,{groupBy:s}))},renderItem:ht(m)})},vt=[{label:Ze.ASC,value:Ze.ASC},{label:Ze.DESC,value:Ze.DESC}],yt=e=>{var t,r;let{query:n,onQueryChange:i,datasource:a}=e;const o=null!==(t=n.sql)&&void 0!==t?t:{},l=null===(r=o.orderBy)||void 0===r?void 0:r.name,c=o.orderByDirection;return(0,f.jsxs)(de.EditorFieldGroup,{children:[(0,f.jsx)(de.EditorField,{label:"Order by",optional:!0,width:16,children:(0,f.jsxs)(de.InputGroup,{children:[(0,f.jsx)(u.Select,{"aria-label":"Order by",onChange:e=>{let{value:t}=e;return t&&i(function(e,t){return at(e,{orderBy:{type:Ye.Function,name:t}})}(n,t))},options:he(a,Ze.STATISTICS.map(s.toOption)),value:l?(0,s.toOption)(l):null}),l&&(0,f.jsx)(de.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>i(at(n,{orderBy:void 0}))})]})}),(0,f.jsx)(de.EditorField,{label:"Direction",disabled:!l,width:16,children:(0,f.jsx)(u.Select,{"aria-label":"Direction",inputId:"cloudwatch-sql-order-by-direction",value:c?(0,s.toOption)(c):vt[0],options:he(a,vt),onChange:e=>e&&i(at(n,{orderByDirection:e.value}))})})]})};function bt(e){var t;let{query:r,datasource:n,onChange:i,onRunQuery:s}=e;const o=null!==(t=r.sql)&&void 0!==t?t:{},l=(0,a.useCallback)((e=>{var t;const r=(new Je).expressionToSqlQuery(null!==(t=e.sql)&&void 0!==t?t:{}),n=Object.assign({},e,{sqlExpression:r});i(n),s()}),[i,s]),[c,d]=(0,a.useState)();return(0,a.useEffect)((()=>{var e;const t=(new Je).expressionToSqlQuery(null!==(e=r.sql)&&void 0!==e?e:{});c!==t&&d(t)}),[r,c,d]),(0,f.jsxs)(de.EditorRows,{children:[(0,f.jsx)(de.EditorRow,{children:(0,f.jsx)(ut,{query:r,onQueryChange:l,datasource:n})}),(0,f.jsx)(de.EditorRow,{children:(0,f.jsx)(de.EditorField,{label:"Filter",optional:!0,children:(0,f.jsx)(pt,{query:r,onQueryChange:l,datasource:n})})}),(0,f.jsxs)(de.EditorRow,{children:[(0,f.jsx)(de.EditorField,{label:"Group by",optional:!0,children:(0,f.jsx)(ft,{query:r,onQueryChange:l,datasource:n})}),(0,f.jsx)(yt,{query:r,onQueryChange:l,datasource:n}),(0,f.jsx)(de.EditorField,{label:"Limit",optional:!0,children:(0,f.jsx)(u.Input,{id:`${r.refId}-cloudwatch-sql-builder-editor-limit`,value:o.limit,onChange:e=>{const t=e.currentTarget.valueAsNumber;l(at(r,{limit:isNaN(t)?void 0:t}))},type:"number",min:1})})]}),c&&(0,f.jsxs)(de.EditorRow,{children:[!1,(0,f.jsx)("pre",{children:null!=c?c:""})]})]})}const xt={id:"cloudwatch-MetricMath",extensions:[],aliases:[],mimetypes:[],loader:()=>Promise.resolve().then(r.bind(r,"./public/app/plugins/datasource/cloudwatch/metric-math/language.ts"))},St={id:"editor.action.triggerSuggest",title:""},wt=(e,t,r)=>{const{id:n,loader:i}=t;e.languages.getLanguages().find((e=>e.id===n))||(e.languages.register({id:n}),i().then((i=>{e.languages.setMonarchTokensProvider(n,i.language),e.languages.setLanguageConfiguration(n,i.conf),e.languages.registerCompletionItemProvider(n,r.getCompletionProvider(e,t))})))};function jt(e){let{expression:t,onChange:r,onRunQuery:n,datasource:i}=e;const s=(0,a.useRef)(null),o=(0,a.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(St.id,St.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();r(t),n()}));const i=()=>{const t=s.current;if(null!==t&&e.getContentHeight()<200){const r=e.getContentHeight();t.style.height=`${r}px`,t.style.width="100%";const n=t.clientWidth;e.layout({width:n,height:r})}};e.onDidContentSizeChange(i),i()}),[r,n]);return(0,f.jsx)("div",{ref:s,children:(0,f.jsx)(u.CodeEditor,{monacoOptions:{scrollBeyondLastLine:!1,fontSize:14,lineNumbers:"off",renderLineHighlight:"none",scrollbar:{vertical:"hidden",horizontal:"hidden"},suggestFontSize:12,wordWrap:"on"},language:xt.id,value:t,onBlur:e=>{e!==t&&(r(e),n())},onBeforeEditorMount:e=>wt(e,xt,i.metricMathCompletionItemProvider),onEditorDidMount:o})})}const Ct={id:"cloudwatch-sql",extensions:[".cloudwatchSql"],aliases:["CloudWatch","cloudwatch","CloudWatchSQL"],mimetypes:[],loader:()=>Promise.resolve().then(r.bind(r,"./public/app/plugins/datasource/cloudwatch/cloudwatch-sql/language.ts"))},Tt=e=>{let{region:t,sql:r,onChange:n,onRunQuery:i,datasource:s}=e;(0,a.useEffect)((()=>{s.sqlCompletionItemProvider.setRegion(t)}),[t,s]);const o=(0,a.useCallback)(((e,t)=>{e.onDidFocusEditorText((()=>e.trigger(St.id,St.id,{}))),e.addCommand(t.KeyMod.Shift|t.KeyCode.Enter,(()=>{const t=e.getValue();n(t),i()}))}),[n,i]);return(0,f.jsx)(u.CodeEditor,{height:"150px",language:Ct.id,value:r,onBlur:e=>{e!==r&&n(e)},showMiniMap:!1,showLineNumbers:!0,onBeforeEditorMount:e=>wt(e,Ct,s.sqlCompletionItemProvider),onEditorDidMount:o})},It=e=>{let{value:t="",onChange:r,id:n}=e;const[i,s]=(0,a.useState)(t),o=(0,oe.debounce)(r,1500);return r=e=>{s(e.target.value),o(e.target.value)},(0,f.jsx)(u.Input,{id:n,type:"text",value:i,onChange:r,"aria-label":"Optional alias"})};var Rt=r("./.yarn/cache/fast-deep-equal-npm-3.1.3-790edcfcf5-e21a9d8d84.zip/node_modules/fast-deep-equal/index.js"),At=r.n(Rt);function Et(e){const t=function(e){if(g.config.featureToggles.cloudWatchDynamicLabels&&!e.hasOwnProperty("label")){var t,r;const n=/{{\s*(.+?)\s*}}/g;e.label=null!==(t=null===(r=e.alias)||void 0===r?void 0:r.replace(n,((e,t)=>Ot.hasOwnProperty(t)?`\${${Ot[t]}}`:`\${PROP('Dim.${t}')}`)))&&void 0!==t?t:""}return e}(e);return t}const Ot={metric:"PROP('MetricName')",namespace:"PROP('Namespace')",period:"PROP('Period')",region:"PROP('Region')",stat:"PROP('Stat')",label:"LABEL"};const Ft={queryMode:"Metrics",namespace:"",metricName:"",expression:"",dimensions:{},region:"default",id:"",statistic:"Average",period:"",metricQueryType:Pe.$5.Search,metricEditorMode:Pe.MQ.Builder,sqlExpression:"",matchExact:!0},Mt=(e,t)=>{const r=(0,a.useMemo)((()=>(e=>{const t=Et(Object.assign({},Ft,e));return At()(t,e)?e:t})(e)),[e]);return(0,a.useEffect)((()=>{r!==e&&t(r)}),[r,e,t]),r};var kt,qt;const Nt=e=>{var t,r,n,i;const{query:s,onRunQuery:o,datasource:l}=e,[c,d]=(0,a.useState)(!1),p=Mt(s,e.onChange),m=t=>{const{onChange:r,onRunQuery:n}=e;r(t),n()};return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(_e,{query:s,onRunQuery:o,datasource:l,onChange:e=>{ue(e)&&e.metricEditorMode!==s.metricEditorMode&&d(!1),m(e)},sqlCodeEditorIsDirty:c}),kt||(kt=(0,f.jsx)(de.Space,{v:.5})),s.metricQueryType===Pe.$5.Search&&(0,f.jsxs)(f.Fragment,{children:[s.metricEditorMode===Pe.MQ.Builder&&(0,f.jsx)(ze,Object.assign({},e,{refId:s.refId,metricStat:s,onChange:t=>e.onChange(Object.assign({},s,t))})),s.metricEditorMode===Pe.MQ.Code&&(0,f.jsx)(jt,{onRunQuery:o,expression:null!==(t=s.expression)&&void 0!==t?t:"",onChange:t=>e.onChange(Object.assign({},s,{expression:t})),datasource:l})]}),s.metricQueryType===Pe.$5.Query&&(0,f.jsxs)(f.Fragment,{children:[s.metricEditorMode===Pe.MQ.Code&&(0,f.jsx)(Tt,{region:s.region,sql:null!==(r=s.sqlExpression)&&void 0!==r?r:"",onChange:t=>{c||d(!0),e.onChange(Object.assign({},p,{sqlExpression:t}))},onRunQuery:o,datasource:l}),s.metricEditorMode===Pe.MQ.Builder&&(0,f.jsx)(f.Fragment,{children:(0,f.jsx)(bt,{query:s,onChange:e.onChange,onRunQuery:o,datasource:l})})]}),qt||(qt=(0,f.jsx)(de.Space,{v:.5})),(0,f.jsxs)(de.EditorRow,{children:[(0,f.jsx)(de.EditorField,{label:"ID",width:26,optional:!0,tooltip:"ID can be used to reference other queries in math expressions. The ID can include numbers, letters, and underscore, and must start with a lowercase letter.",invalid:!!s.id&&!/^$|^[a-z][a-zA-Z0-9_]*$/.test(s.id),children:(0,f.jsx)(u.Input,{id:`${s.refId}-cloudwatch-metric-query-editor-id`,onBlur:o,onChange:e=>m(Object.assign({},p,{id:e.target.value})),type:"text",value:s.id})}),(0,f.jsx)(de.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,f.jsx)(u.Input,{id:`${s.refId}-cloudwatch-metric-query-editor-period`,value:s.period||"",placeholder:"auto",onBlur:o,onChange:e=>m(Object.assign({},p,{period:e.target.value}))})}),g.config.featureToggles.cloudWatchDynamicLabels?(0,f.jsx)(de.EditorField,{label:"Label",width:26,optional:!0,tooltip:"Change time series legend name using Dynamic labels. See documentation for details.",children:(0,f.jsx)(u.Input,{id:`${s.refId}-cloudwatch-metric-query-editor-label`,placeholder:"auto",onBlur:o,value:null!==(n=p.label)&&void 0!==n?n:"",onChange:e=>m(Object.assign({},p,{label:e.target.value}))})}):(0,f.jsx)(de.EditorField,{label:"Alias",width:26,optional:!0,tooltip:"Change time series legend name using this field. See documentation for replacement variable formats.",children:(0,f.jsx)(It,{id:`${s.refId}-cloudwatch-metric-query-editor-alias`,value:null!==(i=p.alias)&&void 0!==i?i:"",onChange:e=>m(Object.assign({},p,{alias:e}))})})]})]})};class Pt extends a.PureComponent{render(){const{query:e}=this.props;return(0,f.jsx)(f.Fragment,{children:ue(e)?(0,f.jsx)(Nt,Object.assign({},this.props,{query:e})):(0,f.jsx)(Ue,Object.assign({},this.props,{allowCustomValue:!0}))})}}var Dt,Lt,Kt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/of.js"),Qt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/from.js"),_t=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/lastValueFrom.js"),Vt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/merge.js"),Gt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/zip.js"),$t=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/observable/throwError.js"),Bt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/Observable.js"),Wt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/mergeMap.js"),Ut=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/map.js"),zt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/concatMap.js"),Ht=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/repeat.js"),Xt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/share.js"),Yt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/scan.js"),Jt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/tap.js"),Zt=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/takeWhile.js"),er=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/finalize.js"),tr=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/operators/catchError.js"),rr=r("./public/app/features/dashboard/services/TimeSrv.ts"),nr=r("./public/app/types/index.ts"),ir=r("./public/app/core/config.ts");const sr={prepareAnnotation:e=>(e=>{var t;return"Annotations"===(null===(t=e.target)||void 0===t?void 0:t.queryMode)})(e)?e:{datasource:e.datasource,enable:e.enable,iconColor:e.iconColor,name:e.name,builtIn:e.builtIn,hide:e.hide,target:Object.assign({},e.target,e,{statistic:e.statistic||"Average",region:e.region||"default",queryMode:"Annotations",refId:e.refId||"annotationQuery"})},prepareQuery:e=>{if(!e.target)return;const{prefixMatching:t,actionPrefix:r,alarmNamePrefix:n,statistic:i,namespace:s,metricName:a,dimensions:o={}}=e.target,l=!!t&&!!r&&!!n,u=!(t||!s||!a||!i||!Object.values(o).length);return l||u?e.target:void 0},QueryEditor:e=>{const{query:t,onChange:r,datasource:n}=e,[i,s]=Fe(n);return ce(t)?(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(de.EditorHeader,{children:(0,f.jsx)(de.InlineSelect,{label:"Region",value:i.find((e=>e.value===t.region)),placeholder:"Select region",allowCustomValue:!0,onChange:e=>{let{value:n}=e;return n&&r(Object.assign({},t,{region:n}))},options:i,isLoading:s})}),Dt||(Dt=(0,f.jsx)(de.Space,{v:.5})),(0,f.jsx)(ze,Object.assign({},e,{refId:t.refId,metricStat:t,disableExpressions:!0,onChange:e=>r(Object.assign({},t,e)),onRunQuery:()=>{}})),Lt||(Lt=(0,f.jsx)(de.Space,{v:.5})),(0,f.jsxs)(de.EditorRow,{children:[(0,f.jsx)(de.EditorField,{label:"Period",width:26,tooltip:"Minimum interval between points in seconds.",children:(0,f.jsx)(u.Input,{value:t.period||"",placeholder:"auto",onChange:e=>r(Object.assign({},t,{period:e.target.value}))})}),(0,f.jsx)(de.EditorField,{label:"Enable Prefix Matching",optional:!0,children:(0,f.jsx)(de.EditorSwitch,{value:t.prefixMatching,onChange:e=>{r(Object.assign({},t,{prefixMatching:e.currentTarget.checked}))}})}),(0,f.jsx)(de.EditorField,{label:"Action",optional:!0,disabled:!t.prefixMatching,children:(0,f.jsx)(u.Input,{value:t.actionPrefix||"",onChange:e=>r(Object.assign({},t,{actionPrefix:e.target.value}))})}),(0,f.jsx)(de.EditorField,{label:"Alarm Name",optional:!0,disabled:!t.prefixMatching,children:(0,f.jsx)(u.Input,{value:t.alarmNamePrefix||"",onChange:e=>r(Object.assign({},t,{alarmNamePrefix:e.target.value}))})})]})]}):(0,f.jsx)(u.Alert,{severity:"error",title:"Invalid annotation query",topSpacing:2,children:JSON.stringify(t,null,4)})}};class ar{constructor(e,t,r,n,i,s){this.type=e,this.value=t,this.range=r,this.previous=n,this.next=i,this.tokenTypes=s,this.type=e,this.value=t,this.range=r,this.previous=n,this.next=i,this.tokenTypes=s}isKeyword(){return this.type===this.tokenTypes.Keyword}isWhiteSpace(){return this.type===this.tokenTypes.Whitespace}isParenthesis(){return this.type===this.tokenTypes.Parenthesis}isIdentifier(){return this.type===this.tokenTypes.Identifier}isString(){return this.type===this.tokenTypes.String}isDoubleQuotedString(){return this.type===this.tokenTypes.Type}isVariable(){return this.type===this.tokenTypes.Variable}isFunction(){return this.type===this.tokenTypes.Function}isNumber(){return this.type===this.tokenTypes.Number}is(e,t){const r=this.type===e;return void 0!==t?r&&this.value===t:r}endsWith(e){return this.value===e||this.value[this.value.length-1]===e}getPreviousNonWhiteSpaceToken(){let e=this.previous;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.previous}return null}getPreviousOfType(e,t){let r=this.previous;for(;null!=r;){const n=r.type===e;if(void 0!==t?n&&r.value===t:n)return r;r=r.previous}return null}getPreviousUntil(e,t,r){let n=[],i=this.previous;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.previous;continue}const s=i.type===e;if(void 0!==r?s&&i.value===r:s)return n;i.isWhiteSpace()||n.push(i),i=i.previous}return n}getNextUntil(e,t,r){let n=[],i=this.next;for(;null!=i;){if(t.some((e=>{var t;return e===(null===(t=i)||void 0===t?void 0:t.type)}))){i=i.next;continue}const s=i.type===e;if(void 0!==r?s&&i.value===r:s)return n;i.isWhiteSpace()||n.push(i),i=i.next}return n}getPreviousKeyword(){let e=this.previous;for(;null!=e;){if(e.isKeyword())return e;e=e.previous}return null}getNextNonWhiteSpaceToken(){let e=this.next;for(;null!=e;){if(!e.isWhiteSpace())return e;e=e.next}return null}getNextOfType(e,t){let r=this.next;for(;null!=r;){const n=r.type===e;if(void 0!==t?n&&r.value===t:n)return r;r=r.next}return null}}let or,lr,ur;function cr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}!function(e){e[e.Unknown=0]="Unknown",e[e.SelectKeyword=1]="SelectKeyword",e[e.AfterSelectKeyword=2]="AfterSelectKeyword",e[e.AfterSelectFuncFirstArgument=3]="AfterSelectFuncFirstArgument",e[e.AfterFromKeyword=4]="AfterFromKeyword",e[e.SchemaFuncFirstArgument=5]="SchemaFuncFirstArgument",e[e.SchemaFuncExtraArgument=6]="SchemaFuncExtraArgument",e[e.FromKeyword=7]="FromKeyword",e[e.AfterFrom=8]="AfterFrom",e[e.WhereKey=9]="WhereKey",e[e.WhereComparisonOperator=10]="WhereComparisonOperator",e[e.WhereValue=11]="WhereValue",e[e.AfterWhereValue=12]="AfterWhereValue",e[e.AfterGroupByKeywords=13]="AfterGroupByKeywords",e[e.AfterGroupBy=14]="AfterGroupBy",e[e.AfterOrderByKeywords=15]="AfterOrderByKeywords",e[e.AfterOrderByFunction=16]="AfterOrderByFunction",e[e.AfterOrderByDirection=17]="AfterOrderByDirection",e[e.PredefinedFunction=18]="PredefinedFunction",e[e.SearchFuncSecondArg=19]="SearchFuncSecondArg",e[e.SearchFuncThirdArg=20]="SearchFuncThirdArg",e[e.PredefinedFuncSecondArg=21]="PredefinedFuncSecondArg",e[e.AfterFunction=22]="AfterFunction",e[e.WithinString=23]="WithinString"}(or||(or={})),function(e){e[e.SelectKeyword=0]="SelectKeyword",e[e.FunctionsWithArguments=1]="FunctionsWithArguments",e[e.Metrics=2]="Metrics",e[e.FromKeyword=3]="FromKeyword",e[e.SchemaKeyword=4]="SchemaKeyword",e[e.Namespaces=5]="Namespaces",e[e.LabelKeys=6]="LabelKeys",e[e.WhereKeyword=7]="WhereKeyword",e[e.GroupByKeywords=8]="GroupByKeywords",e[e.OrderByKeywords=9]="OrderByKeywords",e[e.FunctionsWithoutArguments=10]="FunctionsWithoutArguments",e[e.LimitKeyword=11]="LimitKeyword",e[e.SortOrderDirectionKeyword=12]="SortOrderDirectionKeyword",e[e.ComparisonOperators=13]="ComparisonOperators",e[e.LabelValues=14]="LabelValues",e[e.LogicalOperators=15]="LogicalOperators",e[e.KeywordArguments=16]="KeywordArguments",e[e.Operators=17]="Operators",e[e.Statistic=18]="Statistic",e[e.Period=19]="Period"}(lr||(lr={})),function(e){e.High="a",e.MediumHigh="d",e.Medium="g",e.MediumLow="k",e.Low="q"}(ur||(ur={}));class dr{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.getTemplateSrv)();cr(this,"templateVariables",void 0),cr(this,"datasource",void 0),cr(this,"templateSrv",void 0),cr(this,"tokenTypes",void 0),this.datasource=e,this.templateSrv=t,this.templateVariables=this.datasource.getVariables(),this.templateSrv=t,this.tokenTypes={Parenthesis:"delimiter.parenthesis",Whitespace:"white",Keyword:"keyword",Delimiter:"delimiter",Operator:"operator",Identifier:"identifier",Type:"type",Function:"predefined",Number:"number",String:"string",Variable:"variable"}}getStatementPosition(e){return or.Unknown}getSuggestionKinds(e){return[]}getSuggestions(e,t,r,n,i){return Promise.reject([])}getCompletionProvider(e,t){return{triggerCharacters:[" ","$",",","(","'"],provideCompletionItems:async(r,n)=>{const i=function(e,t,r,n,i){var s;let a=null,o=null;const l=e.editor.tokenize(null!==(s=r.getValue())&&void 0!==s?s:"",t.id);for(let s=0;s<l.length;s++){const u=l[s];if(!u.length&&o){const e={offset:0,type:i.Whitespace,language:t.id,_tokenBrand:void 0};u.push(e)}for(let t=0;t<u.length;t++){const l=u[t];let c=u.length>t+1?u[t+1].offset+1:r.getLineLength(s+1)+1;const d={startLineNumber:s+1,startColumn:0===l.offset?0:l.offset+1,endLineNumber:s+1,endColumn:c},p=r.getValueInRange(d),m=new ar(l.type,p,d,o,null,i);e.Range.containsPosition(d,n)&&(a=m),o&&(o.next=m),o=m}}return a}(e,t,r,n,this.tokenTypes),s=this.getStatementPosition(i),a=this.getSuggestionKinds(s);return{suggestions:await this.getSuggestions(e,i,a,s,n)}}}}}const pr={Parenthesis:"delimiter.parenthesis.sql",Whitespace:"white.sql",Keyword:"keyword.sql",Delimiter:"delimiter.sql",Operator:"operator.sql",Identifier:"identifier.sql",Type:"type.sql",Function:"predefined.sql",Number:"number.sql",String:"string.sql",Variable:"variable.sql"};function mr(e){var t,r,n,i,s,a;const o=null==e?void 0:e.getPreviousNonWhiteSpaceToken(),l=null==e?void 0:e.getPreviousKeyword(),u=null==e||null===(t=e.getPreviousNonWhiteSpaceToken())||void 0===t?void 0:t.is(pr.Operator,"/");return null===e||e.isWhiteSpace()&&null===e.previous||e.is(pr.Keyword,Ze.SELECT)&&null===e.previous||u||e.isIdentifier()&&(u||null===(null==e?void 0:e.previous))?or.SelectKeyword:(null==o?void 0:o.value)===Ze.SELECT?or.AfterSelectKeyword:(null!=o&&o.is(pr.Parenthesis,"(")||null!=e&&e.is(pr.Parenthesis,"()"))&&(null==l?void 0:l.value)===Ze.SELECT?or.AfterSelectFuncFirstArgument:(null==l?void 0:l.value)===Ze.SELECT&&null!=o&&o.isParenthesis()?or.FromKeyword:(null==o?void 0:o.value)===Ze.FROM?or.AfterFromKeyword:(null!=o&&o.is(pr.Parenthesis,"(")||null!=e&&e.is(pr.Parenthesis,"()"))&&(null==l?void 0:l.value)===Ze.SCHEMA?or.SchemaFuncFirstArgument:(null==l?void 0:l.value)===Ze.SCHEMA&&null!=o&&o.is(pr.Delimiter,",")?or.SchemaFuncExtraArgument:(null==l?void 0:l.value)===Ze.FROM&&null!=o&&o.isDoubleQuotedString()||(null==l?void 0:l.value)===Ze.FROM&&null!=o&&o.isVariable()||(null==l?void 0:l.value)===Ze.SCHEMA&&null!=o&&o.is(pr.Parenthesis,")")?or.AfterFrom:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isKeyword()||null!=o&&o.is(pr.Parenthesis,"(")||null!=o&&o.is(pr.Operator,Ze.AND))?or.WhereKey:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?or.WhereComparisonOperator:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.is(pr.Operator,Ze.EQUALS)||null!=o&&o.is(pr.Operator,Ze.NOT_EQUALS))?or.WhereValue:(null==l?void 0:l.value)===Ze.WHERE&&(null!=o&&o.isString()||null!=o&&o.is(pr.Parenthesis,")"))?or.AfterWhereValue:null!=l&&l.is(pr.Keyword,Ze.BY)&&null!=l&&null!==(r=l.getPreviousKeyword())&&void 0!==r&&r.is(pr.Keyword,Ze.GROUP)&&(null!=o&&o.is(pr.Keyword,Ze.BY)||null!=o&&o.is(pr.Delimiter,","))?or.AfterGroupByKeywords:null!=l&&l.is(pr.Keyword,Ze.BY)&&null!=l&&null!==(n=l.getPreviousKeyword())&&void 0!==n&&n.is(pr.Keyword,Ze.GROUP)&&(null!=o&&o.isIdentifier()||null!=o&&o.isDoubleQuotedString())?or.AfterGroupBy:null!=o&&o.is(pr.Keyword,Ze.BY)&&null!=o&&null!==(i=o.getPreviousKeyword())&&void 0!==i&&i.is(pr.Keyword,Ze.ORDER)?or.AfterOrderByKeywords:null!=l&&l.is(pr.Keyword,Ze.BY)&&null!=l&&null!==(s=l.getPreviousKeyword())&&void 0!==s&&s.is(pr.Keyword,Ze.ORDER)&&null!=o&&o.is(pr.Parenthesis)&&null!=o&&null!==(a=o.getPreviousNonWhiteSpaceToken())&&void 0!==a&&a.is(pr.Function)?or.AfterOrderByFunction:null!=l&&l.is(pr.Keyword,Ze.DESC)||null!=l&&l.is(pr.Keyword,Ze.ASC)?or.AfterOrderByDirection:or.Unknown}function hr(e){switch(e){case or.SelectKeyword:return[lr.SelectKeyword];case or.AfterSelectKeyword:return[lr.FunctionsWithArguments];case or.AfterSelectFuncFirstArgument:return[lr.Metrics];case or.AfterFromKeyword:return[lr.Namespaces,lr.SchemaKeyword];case or.SchemaFuncFirstArgument:return[lr.Namespaces];case or.SchemaFuncExtraArgument:return[lr.LabelKeys];case or.FromKeyword:return[lr.FromKeyword];case or.AfterFrom:return[lr.WhereKeyword,lr.GroupByKeywords,lr.OrderByKeywords,lr.LimitKeyword];case or.WhereKey:return[lr.LabelKeys];case or.WhereComparisonOperator:return[lr.ComparisonOperators];case or.WhereValue:return[lr.LabelValues];case or.AfterWhereValue:return[lr.LogicalOperators,lr.GroupByKeywords,lr.OrderByKeywords,lr.LimitKeyword];case or.AfterGroupByKeywords:return[lr.LabelKeys];case or.AfterGroupBy:return[lr.OrderByKeywords,lr.LimitKeyword];case or.AfterOrderByKeywords:return[lr.FunctionsWithoutArguments];case or.AfterOrderByFunction:return[lr.SortOrderDirectionKeyword,lr.LimitKeyword];case or.AfterOrderByDirection:return[lr.LimitKeyword]}return[]}const gr=e=>{var t;return null!==(t=null==e?void 0:e.getPreviousOfType(pr.Keyword,Ze.SELECT))&&void 0!==t?t:null},fr=e=>{var t,r;const n=null===(t=(e=>{var t;const r=null===(t=gr(e))||void 0===t?void 0:t.getNextNonWhiteSpaceToken();return null!=r&&r.isVariable()||null!=r&&r.isFunction()?r:null})(e))||void 0===t||null===(r=t.next)||void 0===r?void 0:r.next;return null!=n&&n.isVariable()||null!=n&&n.isIdentifier()?n:null},vr=e=>{var t;const r=(e=>{const t=gr(e);return null==t?void 0:t.getNextOfType(pr.Keyword,Ze.FROM)})(e),n=null==r?void 0:r.getNextNonWhiteSpaceToken();if(null!=n&&n.isDoubleQuotedString()||null!=n&&n.isVariable()&&(null==n?void 0:n.value.toUpperCase())!==Ze.SCHEMA)return n;if(null!=n&&n.isKeyword()&&null!==(t=n.next)&&void 0!==t&&t.is(pr.Parenthesis,"(")){var i;const e=null===(i=n.next)||void 0===i?void 0:i.next;if(null!=e&&e.isDoubleQuotedString()||null!=e&&e.isVariable())return e}return null};class yr extends dr{constructor(e){var t,r,n;super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.getTemplateSrv)()),n=void 0,(r="region")in(t=this)?Object.defineProperty(t,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[r]=n,this.region=e.getActualRegion(),this.getStatementPosition=mr,this.getSuggestionKinds=hr,this.tokenTypes=pr}setRegion(e){this.region=e}async getSuggestions(e,t,r,n,i){let s=[];const a=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:a,sortText:ur.Medium},r);return n};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s=[...s,o(e,t)]}for(const i of r)switch(i){case lr.SelectKeyword:l(Ze.SELECT,{insertText:`${Ze.SELECT} $0`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,kind:e.languages.CompletionItemKind.Keyword,command:St});break;case lr.FunctionsWithArguments:Ze.STATISTICS.map((t=>l(t,{insertText:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case lr.FunctionsWithoutArguments:Ze.STATISTICS.map((t=>l(t,{insertText:`${t}() `,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case lr.Metrics:{const e=vr(t);if(null!=e&&e.value){(await this.datasource.getMetrics(this.templateSrv.replace(null==e?void 0:e.value.replace(/\"/g,"")),this.templateSrv.replace(this.region))).map((e=>l(e.value)))}else{const e=await this.datasource.getAllMetrics(this.templateSrv.replace(this.region));(0,oe.uniq)(e.map((e=>e.metricName))).map((e=>l(e,{insertText:e})))}}break;case lr.FromKeyword:l(Ze.FROM,{insertText:`${Ze.FROM} `,command:St});break;case lr.SchemaKeyword:l(Ze.SCHEMA,{sortText:ur.High,insertText:`${Ze.SCHEMA}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function});break;case lr.Namespaces:const r=fr(t);let i=[];if(null!=r&&r.value){const e=await this.datasource.getAllMetrics(this.region),t=this.templateSrv.replace(r.value);i=e.filter((e=>e.metricName===t)).map((e=>e.namespace))}else{i=(await this.datasource.getNamespaces()).map((e=>e.value))}i.map((e=>l(`"${e}"`,{insertText:`"${e}"`})));break;case lr.LabelKeys:{const e=fr(t),r=vr(t);if(null!=r&&r.value){var u;let i,s={};n===or.SchemaFuncExtraArgument?i=null==r?void 0:r.getNextUntil(this.tokenTypes.Parenthesis,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace]):n===or.AfterGroupByKeywords&&(i=null==t?void 0:t.getPreviousUntil(this.tokenTypes.Keyword,[this.tokenTypes.Delimiter,this.tokenTypes.Whitespace])),s=(i||[]).reduce(((e,t)=>Object.assign({},e,{[t.value]:null})),{});(await this.datasource.getDimensionKeys(this.templateSrv.replace(r.value.replace(/\"/g,"")),this.templateSrv.replace(this.region),s,null!==(u=null==e?void 0:e.value)&&void 0!==u?u:"")).map((e=>{l(/[\s\.-]/.test(e.value)?`"${e.value}"`:e.value)}))}}break;case lr.LabelValues:{var c;const e=vr(t),r=fr(t),n=null==t||null===(c=t.getPreviousNonWhiteSpaceToken())||void 0===c?void 0:c.getPreviousNonWhiteSpaceToken();if(null!=e&&e.value&&null!=n&&n.value&&null!=r&&r.value){(await this.datasource.getDimensionValues(this.templateSrv.replace(this.region),this.templateSrv.replace(e.value.replace(/\"/g,"")),this.templateSrv.replace(r.value),this.templateSrv.replace(n.value),{})).map((e=>l(`'${e.value}'`,{insertText:`'${e.value}' `,command:St})))}}break;case lr.LogicalOperators:Ze.LOGICAL_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:St,sortText:ur.MediumHigh})));break;case lr.WhereKeyword:l(`${Ze.WHERE}`,{insertText:`${Ze.WHERE} `,command:St,sortText:ur.High});break;case lr.ComparisonOperators:Ze.COMPARISON_OPERATORS.map((e=>l(`${e}`,{insertText:`${e} `,command:St})));break;case lr.GroupByKeywords:l(`${Ze.GROUP} ${Ze.BY}`,{insertText:`${Ze.GROUP} ${Ze.BY} `,command:St,sortText:ur.MediumHigh});break;case lr.OrderByKeywords:l(`${Ze.ORDER} ${Ze.BY}`,{insertText:`${Ze.ORDER} ${Ze.BY} `,command:St,sortText:ur.Medium});break;case lr.LimitKeyword:l(Ze.LIMIT,{insertText:`${Ze.LIMIT} `,sortText:ur.MediumLow});break;case lr.SortOrderDirectionKeyword:[Ze.ASC,Ze.DESC].map((e=>l(e,{insertText:`${e} `,command:St})))}return this.templateVariables.map((t=>{l(t,{range:a,label:t,insertText:t,kind:e.languages.CompletionItemKind.Variable,sortText:ur.Low})})),s}}var br;const xr=e=>{let{region:t}=e;return(0,f.jsxs)("p",{children:["Please visit the ",(0,f.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:`https://${t}.console.aws.amazon.com/servicequotas/home?region=${t}#!/services/monitoring/quotas/L-5E141212`,children:"AWS Service Quotas console"})," to request a quota increase or see our ",br||(br=(0,f.jsx)("a",{target:"_blank",rel:"noreferrer",className:"text-link",href:"https://grafana.com/docs/grafana/latest/datasources/cloudwatch/#service-quotas",children:"documentation"}))," to learn more."]})};function Sr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class wr extends s.LanguageProvider{constructor(e,t){super(),Sr(this,"started",!1),Sr(this,"datasource",void 0),Sr(this,"cleanText",(e=>e.replace(/[()]/g,"").trim())),Sr(this,"request",((e,t)=>(0,_t.n)(this.datasource.awsRequest(e,t)))),Sr(this,"start",(()=>(this.startTask||(this.startTask=Promise.resolve().then((()=>(this.started=!0,[])))),this.startTask))),Sr(this,"fetchedFieldsCache",void 0),Sr(this,"fetchFields",(async(e,t)=>{if(this.fetchedFieldsCache&&Date.now()-this.fetchedFieldsCache.time<3e4&&(0,oe.sortedUniq)(this.fetchedFieldsCache.logGroups).join("|")===(0,oe.sortedUniq)(e).join("|"))return this.fetchedFieldsCache.fields;const r=await Promise.all(e.map((e=>this.datasource.getLogGroupFields({logGroupName:e,region:t})))),n=[...new Set(r.reduce(((e,t)=>{var r;return e.concat(null===(r=t.logGroupFields)||void 0===r?void 0:r.map((e=>e.name)))}),[])).values()];return this.fetchedFieldsCache={time:Date.now(),logGroups:e,fields:n},n})),Sr(this,"handleKeyword",(async e=>{var t;const r=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),n=[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Functions",items:B.concat(W,U)}];return r.suggestions.push(...n),r})),Sr(this,"handleCommand",(async(e,t,r)=>{var n;const i=e.content.toLowerCase(),s=jr(t),a=s===e;if("sort"===i)return this.handleSortCommand(a,t,r);var o;if("parse"===i&&a)return await this.getFieldCompletionItems(null!==(o=null==r?void 0:r.logGroupNames)&&void 0!==o?o:[],(null==r?void 0:r.region)||"default");const l=Tr(e.next,"whitespace")&&!(null!==(n=e.next)&&void 0!==n&&n.next),u=l||function(e){let t=e;for(;t.next;){if(!t.next.types.includes("whitespace"))return t.next;t=t.next}return null}(e)===t,c=Tr(t,"punctuation",","),d=c||Tr(s,"punctuation",",");if(!u&&!d)return{suggestions:[]};if(["display","fields"].includes(i)){var p;const e=await this.getFieldCompletionItems(null!==(p=null==r?void 0:r.logGroupNames)&&void 0!==p?p:[],(null==r?void 0:r.region)||"default");return e.suggestions.push(...this.getFieldAndFilterFunctionCompletionItems().suggestions),e}if("stats"===i){const e=this.getStatsAggCompletionItems();return(c||l)&&(null==e||e.suggestions.forEach((e=>{e.skipFilter=!0}))),e}if("filter"===i&&a){var m;const e=await this.getFieldCompletionItems(null!==(m=null==r?void 0:r.logGroupNames)&&void 0!==m?m:[],(null==r?void 0:r.region)||"default"),t=this.getBoolFuncCompletionItems();return e.suggestions.push(...t.suggestions),e}return{suggestions:[]}})),Sr(this,"handleComparison",(async e=>{var t;const r=await this.getFieldCompletionItems(null!==(t=null==e?void 0:e.logGroupNames)&&void 0!==t?t:[],(null==e?void 0:e.region)||"default"),n=this.getComparisonCompletionItems();return r.suggestions.push(...n.suggestions),r})),Sr(this,"getCommandCompletionItems",(()=>({suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Commands",items:G}]}))),Sr(this,"getFieldAndFilterFunctionCompletionItems",(()=>({suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Functions",items:Y}]}))),Sr(this,"getStatsAggCompletionItems",(()=>({suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Functions",items:H}]}))),Sr(this,"getBoolFuncCompletionItems",(()=>({suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Functions",items:z}]}))),Sr(this,"getComparisonCompletionItems",(()=>({suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Functions",items:$.concat(z)}]}))),Sr(this,"getFieldCompletionItems",(async(e,t)=>({suggestions:[{label:"Fields",items:(await this.fetchFields(e,t)).map((e=>({label:e,insertText:e.match(/@?[_a-zA-Z]+[_.0-9a-zA-Z]*/)?void 0:`\`${e}\``})))}]}))),this.datasource=e,Object.assign(this,t)}getSyntax(){return Z}isStatsQuery(e){var t;const r=this.getSyntax();return!!(null!==(t=_().tokenize(e,r))&&void 0!==t?t:[]).find((e=>"string"!=typeof e&&"stats"===e.content.toString().toLowerCase()&&"query-command"===e.type))}async provideCompletionItems(e,t){const{value:r}=e,n=null==r?void 0:r.data.get("tokens");if(!n||!n.length)return{suggestions:[]};const i=n.filter((e=>{var t,n,i,s;return e.offsets.start<=(null===(t=r.selection)||void 0===t||null===(n=t.start)||void 0===n?void 0:n.offset)&&e.offsets.end>=(null===(i=r.selection)||void 0===i||null===(s=i.start)||void 0===s?void 0:s.offset)}))[0],s=!i.prev,a=jr(i);if(s||!s&&(null==a?void 0:a.types.includes("command-separator")))return this.getCommandCompletionItems();var o;if(function(e){const t=jr(e);if(!t)return!1;const r="("===e.content?e:"("===t.content?t:void 0;if(r){const e=jr(r);if(e)return Cr.includes(e.content.toLowerCase())&&e.types.includes("function")}return!1}(i))return await this.getFieldCompletionItems(null!==(o=null==t?void 0:t.logGroupNames)&&void 0!==o?o:[],(null==t?void 0:t.region)||"default");if(function(e,t){const r=Ir(t,["whitespace","function","punctuation","field-name","number"]);if(Tr(r,"keyword","by")){const e=Ir(t,["whitespace"]);if(e===r||Tr(e,"punctuation",","))return!0}return!1}(0,i))return this.handleKeyword(t);if(null!=a&&a.types.includes("comparison-operator"))return this.handleComparison(t);const l=function(e){let t=e;for(;t.prev;)if(t=t.prev,t.types.includes("query-command")&&(!t.prev||Tr(jr(t),"command-separator")))return t;return null}(i);return l?await this.handleCommand(l,i,t):{suggestions:[]}}async handleSortCommand(e,t,r){var n;return e?await this.getFieldCompletionItems(null!==(n=null==r?void 0:r.logGroupNames)&&void 0!==n?n:[],(null==r?void 0:r.region)||"default"):Tr(jr(t),"field-name")?{suggestions:[{searchFunctionType:u.SearchFunctionType.Prefix,label:"Sort Order",items:[{label:"asc"},{label:"desc"}]}]}:{suggestions:[]}}}function jr(e){let t=e;for(;t.prev;){if(!Tr(t.prev,"whitespace"))return t.prev;t=t.prev}return null}const Cr=["avg","count","count_distinct","earliest","latest","sortsFirst","sortsLast","max","min","pct","stddev","ispresent","fromMillis","toMillis","isempty","isblank","isValidIp","isValidIpV4","isValidIpV6","isIpInSubnet","isIpv4InSubnet","isIpv6InSubnet"].map((e=>e.toLowerCase()));function Tr(e,t,r){return!(null==e||!e.types.includes(t))&&(!r||(null==e?void 0:e.content.toLowerCase())===r)}function Ir(e,t){let r=e.prev;e:for(;r;){for(const e of t)if("string"==typeof e){if(r.types.includes(e)){r=r.prev;continue e}}else if(r.types.includes(e.type)&&r.content.toLowerCase()===e.value){r=r.prev;continue e}break}return r}const Rr=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;const r=(0,oe.memoize)((function(){return(0,oe.debounce)(e,t,{leading:!0})}),(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return JSON.stringify(t)}));return function(){return r(...arguments)(...arguments)}};var Ar=r("./public/app/plugins/datasource/cloudwatch/metric-math/language.ts");const Er={Parenthesis:"delimiter.parenthesis.cloudwatch-MetricMath",Whitespace:"white.cloudwatch-MetricMath",Keyword:"keyword.cloudwatch-MetricMath",Delimiter:"delimiter.cloudwatch-MetricMath",Operator:"operator.cloudwatch-MetricMath",Identifier:"identifier.cloudwatch-MetricMath",Type:"type.cloudwatch-MetricMath",Function:"predefined.cloudwatch-MetricMath",Number:"number.cloudwatch-MetricMath",String:"string.cloudwatch-MetricMath",Variable:"variable.cloudwatch-MetricMath"};function Or(e){const t=null==e?void 0:e.getPreviousNonWhiteSpaceToken();if(e&&e.isString())return or.WithinString;if(e&&t){const r=e.getPreviousOfType(Er.Function),n=t.is(Er.Delimiter,","),i=r&&"SEARCH"===r.value,s=e.getPreviousUntil(Er.Function,[],"SEARCH")||[];if(i){if(1===s.filter((e=>{let{value:t}=e;return"'"===t})).length)return or.WithinString;const e=t.getPreviousOfType(Er.Delimiter,",");if(e){if(e.range.startColumn>r.range.startColumn&&e.range.startLineNumber>=r.range.startLineNumber)return or.SearchFuncThirdArg}return or.SearchFuncSecondArg}if(!i&&n)return or.PredefinedFuncSecondArg}return null!=t&&t.endsWith(")")?or.AfterFunction:e&&e.isString()?or.Unknown:or.PredefinedFunction}function Fr(e){switch(e){case or.PredefinedFunction:return[lr.FunctionsWithArguments];case or.PredefinedFuncSecondArg:return[lr.FunctionsWithArguments,lr.KeywordArguments];case or.AfterFunction:return[lr.Operators];case or.SearchFuncSecondArg:return[lr.Statistic];case or.SearchFuncThirdArg:return[lr.Period]}return[]}class Mr extends dr{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,g.getTemplateSrv)()),this.getStatementPosition=Or,this.getSuggestionKinds=Fr,this.tokenTypes=Er}async getSuggestions(e,t,r,n,i){let s=[];const a=(null==t?void 0:t.isWhiteSpace())||(null==t?void 0:t.isParenthesis())||null==t||!t.range?e.Range.fromPositions(i):null==t?void 0:t.range,o=function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=Object.assign({label:t,insertText:t,kind:e.languages.CompletionItemKind.Field,range:a,sortText:ur.Medium},r);return n};function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};s=[...s,o(e,t)]}for(const t of r)switch(t){case lr.FunctionsWithArguments:Ar.METRIC_MATH_FNS.map((t=>l(t,{insertText:"SEARCH"===t?`${t}('$0')`:`${t}($0)`,insertTextRules:e.languages.CompletionItemInsertTextRule.InsertAsSnippet,command:St,kind:e.languages.CompletionItemKind.Function})));break;case lr.KeywordArguments:Ar.METRIC_MATH_KEYWORDS.map((t=>l(t,{insertText:t,command:St,kind:e.languages.CompletionItemKind.Keyword,sortText:ur.MediumHigh})));break;case lr.Statistic:Ar.METRIC_MATH_STATISTIC_KEYWORD_STRINGS.map((e=>l(e,{insertText:`'${e}', `,command:St})));break;case lr.Operators:Ar.METRIC_MATH_OPERATORS.map((e=>l(e,{insertText:`${e} `,command:St})));break;case lr.Period:Ar.METRIC_MATH_PERIODS.map(((t,r)=>l(t.toString(),{kind:e.languages.CompletionItemKind.Value,sortText:String.fromCharCode(97+r)})))}return this.templateVariables.map((t=>{l(t,{range:a,label:t,insertText:t,kind:e.languages.CompletionItemKind.Variable,sortText:ur.Low})})),s}}async function kr(e,t){let r;try{r=await(0,g.getDataSourceSrv)().get(e)}catch(e){return void console.error("Could not load linked xray data source, it was probably deleted after it was linked",e)}return{title:r.name,url:"",internal:{query:{query:"${__value.raw}",queryType:"getTrace",region:t},datasourceUid:e,datasourceName:r.name}}}function qr(e,t,r,n){var i,s;const a=e.expression?n(e.expression):"",o=null!==(i=null===(s=e.logGroupNames)||void 0===s?void 0:s.map((e=>n(e,"log groups"))))&&void 0!==i?i:[];return{url:Se({end:t.to.toISOString(),start:t.from.toISOString(),timeType:"ABSOLUTE",tz:"UTC",editorString:a,isLiveTail:!1,source:o},r),title:"View in CloudWatch console",targetBlank:!0}}function Nr(e,t,r){const n=new Date;let i,s,a=0,o={};return new Bt.y((l=>(function t(u){s=e(u).subscribe({next(e){const t=(0,g.toDataQueryResponse)({data:{results:o}}).data||[];l.next({frames:[...t,...e]}),l.complete()},error(e){if("string"==typeof e)return void l.error(e);const s=function(e){var t;const r=null===(t=e.data)||void 0===t?void 0:t.results;if(!r)return;return Object.keys(r).reduce(((t,n)=>{var i;return null!==(i=r[n].error)&&void 0!==i&&i.startsWith("LimitExceededException")?(t.errorMessage=r[n].error,t.errors.push(e.config.data.queries.find((e=>e.refId===n)))):t.good[n]=r[n],t}),{errors:[],good:{},errorMessage:""})}(e);var u;if(s)if(s.errors.length)if(r(a,n.valueOf()))if(Object.keys(o).length||Object.keys(s.good).length){var c,d,p;const e=(0,g.toDataQueryResponse)({data:{results:Object.assign({},null!==(c=s.good)&&void 0!==c?c:{},null!==(d=o)&&void 0!==d?d:{})}});e.error=Object.assign({},null!==(p=e.error)&&void 0!==p?p:{},{message:`Some queries timed out: ${s.errorMessage}`}),l.next({error:e.error,frames:e.data}),l.complete()}else{var m,h;const t=(0,g.toDataQueryResponse)({data:{results:null!==(m=null===(h=e.data)||void 0===h?void 0:h.results)&&void 0!==m?m:{}}});l.error(t.error)}else o=Object.assign({},o,s.good),i=setTimeout((()=>{a++,t(s.errors)}),(u=a+1,1e3*Math.pow(2,u)+100*Math.random()));else l.error(e);else l.error(e)}})}(t),()=>{clearTimeout(i),s.unsubscribe()})))}var Pr=r("./.yarn/cache/rxjs-npm-7.5.5-d0546b1ccb-e034f60805.zip/node_modules/rxjs/dist/esm5/internal/scheduler/async.js");function Dr(e){if(!e)return;const{subscriber:t,counter:r,period:n,step:i,endPeriod:s}=e;t.next(r);const a=Math.min(n+i,s);this.schedule({subscriber:t,counter:r+1,period:a,step:i,endPeriod:s},a)}function Lr(e){if(function(e){return"string"!=typeof e&&"string"!=typeof e.ec2Filters&&"string"!=typeof e.tags}(e))return e;if("string"!=typeof e){const t=(0,oe.omit)(e,["ec2Filters","tags"]);if(t.ec2Filters={},t.tags={},""!==e.ec2Filters)try{t.ec2Filters=JSON.parse(e.ec2Filters)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.ec2Filters}`)}if(""!==e.tags)try{t.tags=JSON.parse(e.tags)}catch{throw new Error(`unable to migrate poorly formed filters: ${e.tags}`)}return t}const t={refId:"CloudWatchVariableQueryEditor-VariableQuery",queryType:Pe.wf.Regions,namespace:"",region:"",metricName:"",dimensionKey:"",dimensionFilters:{},ec2Filters:{},instanceID:"",attributeName:"",resourceType:"",tags:{}};if(""===e)return t;if(e.match(/^regions\(\)/))return t;if(e.match(/^namespaces\(\)/))return t.queryType=Pe.wf.Namespaces,t;const r=e.match(/^metrics\(([^\)]+?)(,\s?([^,]+?))?\)/);if(r)return t.queryType=Pe.wf.Metrics,t.namespace=r[1],t.region=r[3]||"",t;const n=e.match(/^dimension_keys\(([^\)]+?)(,\s?([^,]+?))?\)/);if(n)return t.queryType=Pe.wf.DimensionKeys,t.namespace=n[1],t.region=n[3]||"",t;const i=e.match(/^dimension_values\(([^,]+?),\s?([^,]+?),\s?([^,]+?),\s?([^,]+?)(,\s?(.+))?\)/);if(i){if(t.queryType=Pe.wf.DimensionValues,t.region=i[1],t.namespace=i[2],t.metricName=i[3],t.dimensionKey=i[4],t.dimensionFilters={},i[6])try{t.dimensionFilters=JSON.parse(i[6])}catch{throw new Error(`unable to migrate poorly formed filters: ${i[6]}`)}return t}const s=e.match(/^ebs_volume_ids\(([^,]+?),\s?([^,]+?)\)/);if(s)return t.queryType=Pe.wf.EBSVolumeIDs,t.region=s[1],t.instanceID=s[2],t;const a=e.match(/^ec2_instance_attribute\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(a){if(t.queryType=Pe.wf.EC2InstanceAttributes,t.region=a[1],t.attributeName=a[2],a[3])try{t.ec2Filters=JSON.parse(a[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${a[3]}`)}return t}const o=e.match(/^resource_arns\(([^,]+?),\s?([^,]+?),\s?(.+?)\)/);if(o){if(t.queryType=Pe.wf.ResourceArns,t.region=o[1],t.resourceType=o[2],o[3])try{t.tags=JSON.parse(o[3])}catch{throw new Error(`unable to migrate poorly formed filters: ${o[3]}`)}return t}if(e.match(/^statistics\(\)/))return t.queryType=Pe.wf.Statistics,t;throw new Error("unable to parse old variable query")}const Kr=e=>{var t;let{filter:r,onChange:n,onDelete:i,keyPlaceholder:s}=e;const[o,l]=(0,a.useState)(r.key||""),[c,d]=(0,a.useState)((null===(t=r.value)||void 0===t?void 0:t.join(", "))||""),p=(0,u.useTheme2)(),m=Qr(p);return(0,f.jsx)("div",{"data-testid":"cloudwatch-multifilter-item",children:(0,f.jsxs)(de.InputGroup,{children:[(0,f.jsx)(u.Input,{"data-testid":"cloudwatch-multifilter-item-key","aria-label":"Filter key",value:o,placeholder:null!=s?s:"key",onChange:e=>l(e.currentTarget.value),onBlur:()=>{o&&o!==r.key&&n(Object.assign({},r,{key:o}))}}),(0,f.jsx)("span",{className:(0,h.cx)(m.root),children:"="}),(0,f.jsx)(u.Input,{"data-testid":"cloudwatch-multifilter-item-value","aria-label":"Filter value",value:c,placeholder:"value1, value2,...",onChange:e=>d(e.currentTarget.value),onBlur:()=>{const e=c.split(",").map((e=>e.trim()));c&&e!==r.value&&n(Object.assign({},r,{value:e})),d(e.join(", "))}}),(0,f.jsx)(de.AccessoryButton,{"aria-label":"remove",icon:"times",variant:"secondary",onClick:i,type:"button"})]})})},Qr=(0,u.stylesFactory)((e=>({root:(0,h.css)({padding:e.spacing(0,1),alignSelf:"center"})}))),_r=e=>{let{filters:t,onChange:r,keyPlaceholder:n}=e;const[i,s]=(0,a.useState)([]);(0,a.useEffect)((()=>s(t?(e=>Object.keys(e).map((t=>({key:t,value:e[t],operator:"="}))))(t):[])),[t]);return(0,f.jsx)(de.EditorList,{items:i,onChange:e=>{s(e);const n=(e=>{const t={};return e.forEach((e=>{let{key:r,value:n}=e;r&&n&&(t[r]=n)})),t})(e);(0,oe.isEqual)(n,t)||r(n)},renderItem:Vr(n)})};function Vr(e){return function(t,r,n){return(0,f.jsx)(Kr,{filter:t,onChange:e=>r(e),onDelete:n,keyPlaceholder:e})}}const Gr=e=>{let{label:t,onChange:r,value:n,options:i,allowCustomValue:s=!1,isLoading:a=!1,inputId:o=t}=e;return(0,f.jsx)(u.InlineField,{label:t,labelWidth:20,htmlFor:o,children:(0,f.jsx)(u.Select,{"aria-label":t,width:25,allowCustomValue:s,value:n,onChange:e=>{let{value:t}=e;return r(t)},options:i,isLoading:a,inputId:o})})},$r=e=>{let{interactive:t,label:r,onBlur:n,placeholder:i,value:s,tooltip:o}=e;const[l,c]=(0,a.useState)(s);return(0,f.jsx)(u.InlineField,{interactive:t,label:r,labelWidth:20,tooltip:o,grow:!0,children:(0,f.jsx)(u.Input,{"aria-label":r,placeholder:i,value:l,onChange:e=>c(e.currentTarget.value),onBlur:()=>n(l)})})};var Br,Wr;const Ur=[{value:Pe.wf.Regions,label:"Regions"},{value:Pe.wf.Namespaces,label:"Namespaces"},{value:Pe.wf.Metrics,label:"Metrics"},{value:Pe.wf.DimensionKeys,label:"Dimension Keys"},{value:Pe.wf.DimensionValues,label:"Dimension Values"},{value:Pe.wf.EBSVolumeIDs,label:"EBS Volume IDs"},{value:Pe.wf.EC2InstanceAttributes,label:"EC2 Instance Attributes"},{value:Pe.wf.ResourceArns,label:"Resource ARNs"},{value:Pe.wf.Statistics,label:"Statistics"}],zr=e=>{let{query:t,datasource:r,onChange:n}=e;const i=Lr(t),{region:s,namespace:a,metricName:o,dimensionKey:l,dimensionFilters:c}=i,[d,p]=Fe(r),m=Me(r),h=ke(r,s,a),g=qe(r,s,a,o),v=qe(r,s,a,o,null!=c?c:{}),y=e=>{n(Object.assign({},e,{refId:"CloudWatchVariableQueryEditor-VariableQuery"}))},b=async e=>{let{metricName:t,dimensionKey:n,dimensionFilters:i,namespace:s,region:a}=e;return t&&await r.getMetrics(s,a).then((e=>{e.find((e=>e.value===t))||(t="")})),n&&await r.getDimensionKeys(s,a).then((e=>{e.find((e=>e.value===n))||(n="",i={})})),Object.assign({},e,{metricName:t,dimensionKey:n,dimensionFilters:i})},x=[Pe.wf.Metrics,Pe.wf.DimensionKeys,Pe.wf.DimensionValues,Pe.wf.EBSVolumeIDs,Pe.wf.EC2InstanceAttributes,Pe.wf.ResourceArns].includes(i.queryType),S=[Pe.wf.Metrics,Pe.wf.DimensionKeys,Pe.wf.DimensionValues].includes(i.queryType);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Gr,{value:i.queryType,options:Ur,onChange:e=>y(Object.assign({},i,{queryType:e})),label:"Query Type",inputId:`variable-query-type-${t.refId}`}),x&&(0,f.jsx)(Gr,{value:s,options:d,onChange:e=>(async e=>{const t=await b(Object.assign({},i,{region:e}));y(t)})(e),label:"Region",isLoading:p,inputId:`variable-query-region-${t.refId}`}),S&&(0,f.jsx)(Gr,{value:a,options:m,onChange:e=>(async e=>{const t=await b(Object.assign({},i,{namespace:e}));y(t)})(e),label:"Namespace",inputId:`variable-query-namespace-${t.refId}`}),i.queryType===Pe.wf.DimensionValues&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(Gr,{value:o||null,options:h,onChange:e=>y(Object.assign({},i,{metricName:e})),label:"Metric",inputId:`variable-query-metric-${t.refId}`}),(0,f.jsx)(Gr,{value:l||null,options:g,onChange:e=>y(Object.assign({},i,{dimensionKey:e})),label:"Dimension Key",inputId:`variable-query-dimension-key-${t.refId}`}),(0,f.jsx)(u.InlineField,{label:"Dimensions",labelWidth:20,tooltip:"Dimensions to filter the returned values on",children:(0,f.jsx)(ye,{metricStat:Object.assign({},i,{dimensions:i.dimensionFilters}),onChange:e=>{n(Object.assign({},i,{dimensionFilters:e}))},dimensionKeys:v,disableExpressions:!0,datasource:r})})]}),i.queryType===Pe.wf.EBSVolumeIDs&&(0,f.jsx)($r,{value:t.instanceID,placeholder:"i-XXXXXXXXXXXXXXXXX",onBlur:e=>y(Object.assign({},i,{instanceID:e})),label:"Instance ID"}),i.queryType===Pe.wf.EC2InstanceAttributes&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)($r,{value:i.attributeName,placeholder:"attribute name",onBlur:e=>y(Object.assign({},i,{attributeName:e})),label:"Attribute Name",interactive:!0,tooltip:(0,f.jsxs)(f.Fragment,{children:['Attribute or tag to query on. Tags should be formatted "Tags.<name>". ',Br||(Br=(0,f.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"See the documentation for more details"}))]})}),(0,f.jsx)(u.InlineField,{label:"Filters",labelWidth:20,tooltip:(0,f.jsxs)(f.Fragment,{children:[Wr||(Wr=(0,f.jsx)("a",{href:"https://grafana.com/docs/grafana/latest/datasources/aws-cloudwatch/template-queries-cloudwatch/#selecting-attributes",target:"_blank",rel:"noreferrer",children:"Pre-defined ec2:DescribeInstances filters/tags"}))," and the values to filter on. Tags should be formatted tag:<name>."]}),children:(0,f.jsx)(_r,{filters:i.ec2Filters,onChange:e=>{n(Object.assign({},i,{ec2Filters:e}))},keyPlaceholder:"filter/tag"})})]}),i.queryType===Pe.wf.ResourceArns&&(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)($r,{value:i.resourceType,placeholder:"resource type",onBlur:e=>y(Object.assign({},i,{resourceType:e})),label:"Resource Type"}),(0,f.jsx)(u.InlineField,{label:"Tags",labelWidth:20,tooltip:"Tags to filter the returned values on.",children:(0,f.jsx)(_r,{filters:i.tags,onChange:e=>{n(Object.assign({},i,{tags:e}))},keyPlaceholder:"tag"})})]})]})};function Hr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class Xr extends s.CustomVariableSupport{constructor(e){super(),Hr(this,"datasource",void 0),Hr(this,"editor",zr),this.datasource=e,this.query=this.query.bind(this)}query(e){const t=Lr(e.targets[0]);return(0,Qt.D)(this.execute(t)).pipe((0,Ut.U)((e=>({data:e}))))}async execute(e){try{switch(e.queryType){case Pe.wf.Regions:return this.handleRegionsQuery();case Pe.wf.Namespaces:return this.handleNamespacesQuery();case Pe.wf.Metrics:return this.handleMetricsQuery(e);case Pe.wf.DimensionKeys:return this.handleDimensionKeysQuery(e);case Pe.wf.DimensionValues:return this.handleDimensionValuesQuery(e);case Pe.wf.EBSVolumeIDs:return this.handleEbsVolumeIdsQuery(e);case Pe.wf.EC2InstanceAttributes:return this.handleEc2InstanceAttributeQuery(e);case Pe.wf.ResourceArns:return this.handleResourceARNsQuery(e);case Pe.wf.Statistics:return this.handleStatisticsQuery()}}catch(t){return console.error(`Could not run CloudWatchMetricFindQuery ${e}`,t),[]}}async handleRegionsQuery(){return(await this.datasource.getRegions()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleNamespacesQuery(){return(await this.datasource.getNamespaces()).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleMetricsQuery(e){let{namespace:t,region:r}=e;return(await this.datasource.getMetrics(t,r)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionKeysQuery(e){let{namespace:t,region:r}=e;return(await this.datasource.getDimensionKeys(t,r)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleDimensionValuesQuery(e){let{namespace:t,region:r,dimensionKey:n,metricName:i,dimensionFilters:s}=e;if(!n||!i)return[];return(await this.datasource.getDimensionValues(r,t,i,n,null!=s?s:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEbsVolumeIdsQuery(e){let{region:t,instanceID:r}=e;if(!r)return[];return(await this.datasource.getEbsVolumeIds(t,r)).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleEc2InstanceAttributeQuery(e){let{region:t,attributeName:r,ec2Filters:n}=e;if(!r)return[];return(await this.datasource.getEc2InstanceAttribute(t,r,null!=n?n:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleResourceARNsQuery(e){let{region:t,resourceType:r,tags:n}=e;if(!r)return[];return(await this.datasource.getResourceARNs(t,r,null!=n?n:{})).map((e=>({text:e.label,value:e.value,expandable:!0})))}async handleStatisticsQuery(){return this.datasource.standardStatistics.map((e=>({text:e,value:e,expandable:!0})))}}function Yr(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const Jr="/api/ds/query",Zr="__log__grafana_internal__",en="__logstream__grafana_internal__",tn=(e,t)=>m.h.dispatch((0,c.$l)((0,d.t_)(`CloudWatch request limit reached in ${t} for data source ${e}`,"",void 0,a.createElement(xr,{region:t},null)))),rn=(e,t)=>m.h.dispatch((0,c.$l)((0,d.t_)(e,t)));class nn extends g.DataSourceWithBackend{constructor(e){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:(0,He.J)(),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(0,rr.$t)();super(e),t=this,this.templateSrv=r,this.timeSrv=n,Yr(this,"proxyUrl",void 0),Yr(this,"defaultRegion",void 0),Yr(this,"datasourceName",void 0),Yr(this,"languageProvider",void 0),Yr(this,"sqlCompletionItemProvider",void 0),Yr(this,"metricMathCompletionItemProvider",void 0),Yr(this,"tracingDataSourceUid",void 0),Yr(this,"logsTimeout",void 0),Yr(this,"type","cloudwatch"),Yr(this,"standardStatistics",["Average","Maximum","Minimum","Sum","SampleCount"]),Yr(this,"debouncedAlert",Rr(tn,nr.bd.Error)),Yr(this,"debouncedCustomAlert",Rr(rn,nr.bd.Error)),Yr(this,"logQueries",{}),Yr(this,"handleLogQueries",((e,t)=>{const r=e.filter((e=>{var t;return null===(t=e.logGroupNames)||void 0===t?void 0:t.length}));if(e.length>r.length)return(0,Kt.of)({data:[],error:{message:"Log group is required"}});if((0,oe.isEmpty)(r))return(0,Kt.of)({data:[],state:s.LoadingState.Done});const n=e.map((e=>({queryString:e.expression||"",refId:e.refId,logGroupNames:e.logGroupNames,region:this.replace(this.getActualRegion(e.region),t.scopedVars,!0,"region")}))),i=new Date,a=()=>Date.now()>=i.valueOf()+s.rangeUtil.intervalToMs(this.logsTimeout);return Nr((e=>this.makeLogActionRequest("StartQuery",e,{makeReplacements:!0,scopedVars:t.scopedVars,skipCache:!0})),n,a).pipe((0,Wt.z)((t=>{let{frames:r,error:n}=t;return this.logsQuery(r.map((t=>{var r,n,i;return{queryId:t.fields[0].values.get(0),region:null!==(r=null===(n=t.meta)||void 0===n||null===(i=n.custom)||void 0===i?void 0:i.Region)&&void 0!==r?r:"default",refId:t.refId,statsGroups:e.find((e=>e.refId===t.refId)).statsGroups}})),a).pipe((0,Ut.U)((e=>(!e.error&&n&&(e.error=n),e))))})),(0,Wt.z)((e=>(0,Qt.D)((async()=>(await async function(e,t,r,n,i,s){const a=(e,r)=>n(e,t.scopedVars,!0,r);for(const n of e.data){var o;const e=t.targets.find((e=>e.refId===n.refId)),u=i(a(null!==(o=e.region)&&void 0!==o?o:"","region"));for(const t of n.fields)if("@xrayTraceId"===t.name&&s){var l;i(a(null!==(l=e.region)&&void 0!==l?l:"","region"));const r=await kr(s,u);r&&(t.config.links=[r])}else t.config.links=[qr(e,r,u,a)]}}(e,t,this.timeSrv.timeRange(),this.replace.bind(this),this.getActualRegion.bind(this),this.tracingDataSourceUid),e))()))))})),Yr(this,"handleMetricQueries",((e,t)=>{var r,n;const i=e.filter(this.filterQuery).map((e=>{const r=Et(e),n=this.replaceMetricQueryVars(r,t);return Object.assign({intervalMs:t.intervalMs,maxDataPoints:t.maxDataPoints},n,{type:"timeSeriesQuery",datasource:this.getRef()})}));if((0,oe.isEmpty)(i))return(0,Kt.of)({data:[]});const s={from:null==t||null===(r=t.range)||void 0===r?void 0:r.from.valueOf().toString(),to:null==t||null===(n=t.range)||void 0===n?void 0:n.to.valueOf().toString(),queries:i};return this.performTimeSeriesQuery(s,t.range)})),Yr(this,"getLogRowContext",(async function(e){let{limit:r=10,direction:n="BACKWARD"}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=null,s=null;for(const t of e.dataFrame.fields)if(t.name===en){if(i=t,null!==s)break}else if(t.name===Zr&&(s=t,null!==i))break;const a={limit:r,startFromHead:"BACKWARD"!==n,logGroupName:sn(s.values.get(e.rowIndex)),logStreamName:i.values.get(e.rowIndex)};"BACKWARD"===n?a.endTime=e.timeEpochMs:a.startTime=e.timeEpochMs;const o=await(0,_t.n)(t.makeLogActionRequest("GetLogEvents",[a]));return{data:o}})),Yr(this,"getTargetsByQueryMode",(e=>{const t=[],r=[],n=[];return e.forEach((e=>{ce(e)?n.push(e):le(e)?t.push(e):r.push(e)})),{logQueries:t,metricsQueries:r,annotationQueries:n}})),this.templateSrv=r,this.timeSrv=n,this.proxyUrl=e.url,this.defaultRegion=e.jsonData.defaultRegion,this.datasourceName=e.name,this.languageProvider=new wr(this),this.tracingDataSourceUid=e.jsonData.tracingDatasourceUid,this.logsTimeout=e.jsonData.logsTimeout||"15m",this.sqlCompletionItemProvider=new yr(this,this.templateSrv),this.metricMathCompletionItemProvider=new Mr(this,this.templateSrv),this.variables=new Xr(this),this.annotations=sr}query(e){let t=(e=(0,oe.cloneDeep)(e)).targets.filter((e=>!0!==e.hide));const{logQueries:r,metricsQueries:n,annotationQueries:i}=this.getTargetsByQueryMode(t),a=[];return r.length>0&&a.push(this.handleLogQueries(r,e)),n.length>0&&a.push(this.handleMetricQueries(n,e)),i.length>0&&a.push(this.handleAnnotationQuery(i,e)),(0,oe.isEmpty)(a)?(0,Kt.of)({data:[],state:s.LoadingState.Done}):(0,Vt.T)(...a)}filterQuery(e){var t;if(le(e))return!(null===(t=e.logGroupNames)||void 0===t||!t.length);if(ce(e))return!0;const{region:r,metricQueryType:n,metricEditorMode:i,expression:s,metricName:a,namespace:o,sqlExpression:l,statistic:u}=e;if(!r)return!1;if(n===Pe.$5.Search&&i===Pe.MQ.Builder)return!!o&&!!a&&!!u;if(n===Pe.$5.Search&&i===Pe.MQ.Code)return!!s;if(n===Pe.$5.Query)return!!l;throw new Error("invalid metric editor mode")}replaceMetricQueryVars(e,t){var r;return e.region=this.templateSrv.replace(this.getActualRegion(e.region),t.scopedVars),e.namespace=this.replace(e.namespace,t.scopedVars,!0,"namespace"),e.metricName=this.replace(e.metricName,t.scopedVars,!0,"metric name"),e.dimensions=this.convertDimensionFormat(null!==(r=e.dimensions)&&void 0!==r?r:{},t.scopedVars),e.statistic=this.templateSrv.replace(e.statistic,t.scopedVars),e.period=String(this.getPeriod(e,t)),e.id=this.templateSrv.replace(e.id,t.scopedVars),e.expression=this.templateSrv.replace(e.expression,t.scopedVars),e.sqlExpression=this.templateSrv.replace(e.sqlExpression,t.scopedVars,"raw"),e}handleAnnotationQuery(e,t){return this.awsRequest(Jr,{from:t.range.from.valueOf().toString(),to:t.range.to.valueOf().toString(),queries:e.map((e=>{var t,r,n;return Object.assign({},e,{statistic:this.templateSrv.replace(e.statistic),region:this.templateSrv.replace(this.getActualRegion(e.region)),namespace:this.templateSrv.replace(e.namespace),metricName:this.templateSrv.replace(e.metricName),dimensions:this.convertDimensionFormat(null!==(t=e.dimensions)&&void 0!==t?t:{},{}),period:e.period?parseInt(e.period,10):300,actionPrefix:null!==(r=e.actionPrefix)&&void 0!==r?r:"",alarmNamePrefix:null!==(n=e.alarmNamePrefix)&&void 0!==n?n:"",type:"annotationQuery",datasource:this.getRef()})}))}).pipe((0,Ut.U)((e=>({data:(0,g.toDataQueryResponse)({data:e}).data}))))}logsQuery(e,t){this.logQueries={},e.forEach((e=>{var t,r,n;this.logQueries[e.refId]={id:e.queryId,region:e.region,statsQuery:null!==(t=(null!==(r=null===(n=e.statsGroups)||void 0===n?void 0:n.length)&&void 0!==r?r:0)>0)&&void 0!==t&&t}}));const r=function(e){let{startPeriod:t=0,endPeriod:r=5e3,step:n=1e3}=e,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Pr.z;return new Bt.y((e=>{const s={subscriber:e,counter:0,period:t,step:n,endPeriod:r};return e.add(i.schedule(Dr,t,s)),e}))}({startPeriod:100,endPeriod:1e3,step:300}).pipe((0,zt.b)((t=>this.makeLogActionRequest("GetQueryResults",e,{skipCache:!0}))),(0,Ht.r)(),(0,Xt.B)()),n=r.pipe((0,Yt.R)(((e,t)=>{let{failures:r,prevRecordsMatched:n}=e;r++;for(const e of t){var i,s,a,o;const t=null===(i=e.meta)||void 0===i||null===(s=i.stats)||void 0===s||null===(a=s.find((e=>"Records scanned"===e.displayName)))||void 0===a?void 0:a.value;t>(null!==(o=n[e.refId])&&void 0!==o?o:0)&&(r=0),n[e.refId]=t}return{failures:r,prevRecordsMatched:n}}),{failures:0,prevRecordsMatched:{}}),(0,Ut.U)((e=>{let{failures:t}=e;return t})),(0,Xt.B)()),i=(0,Gt.$)(r,n).pipe((0,Jt.b)((e=>{let[t]=e;for(const e of t){var r,n;[Pe.KB.Complete,Pe.KB.Cancelled,Pe.KB.Failed].includes(null===(r=e.meta)||void 0===r||null===(n=r.custom)||void 0===n?void 0:n.Status)&&this.logQueries.hasOwnProperty(e.refId)&&delete this.logQueries[e.refId]}})),(0,Ut.U)((e=>{let[r,n]=e;if(t())for(const e of r)(0,oe.set)(e,"meta.custom.Status",Pe.KB.Cancelled);return{data:r,key:"test-key",state:r.every((e=>{var t,r;return[Pe.KB.Complete,Pe.KB.Cancelled,Pe.KB.Failed].includes(null===(t=e.meta)||void 0===t||null===(r=t.custom)||void 0===r?void 0:r.Status)}))?s.LoadingState.Done:s.LoadingState.Loading,error:t()?{message:`error: query timed out after ${n} attempts`,type:s.DataQueryErrorType.Timeout}:void 0}})),(0,Zt.o)((e=>{let{state:t}=e;return t!==s.LoadingState.Error&&t!==s.LoadingState.Done}),!0));return a=i,o=()=>this.stopQueries(),new Bt.y((e=>{const t=a.subscribe({next:t=>e.next(t),error:t=>e.next(t),complete:()=>e.complete()});return()=>{t.unsubscribe(),o()}}));var a,o}stopQueries(){Object.keys(this.logQueries).length>0&&this.makeLogActionRequest("StopQuery",Object.values(this.logQueries).map((e=>({queryId:e.id,region:e.region}))),{makeReplacements:!1,skipCache:!0}).pipe((0,er.x)((()=>{this.logQueries={}})))}async describeLogGroups(e){var t,r,n;return null!==(t=null===(r=(await(0,_t.n)(this.makeLogActionRequest("DescribeLogGroups",[e])))[0])||void 0===r||null===(n=r.fields[0])||void 0===n?void 0:n.values.toArray())&&void 0!==t?t:[]}async getLogGroupFields(e){var t;const r=await(0,_t.n)(this.makeLogActionRequest("GetLogGroupFields",[e])),n=r[0].fields[0].values.toArray(),i=r[0].fields[1].values.toArray();return{logGroupFields:null!==(t=n.map(((e,t)=>({name:e,percent:i[t]}))))&&void 0!==t?t:[]}}getVariables(){return this.templateSrv.getVariables().map((e=>`$${e.name}`))}getPeriod(e,t){let r=this.templateSrv.replace(e.period,t.scopedVars);return r&&"auto"!==r.toLowerCase()&&(r=/^\d+$/.test(r)?parseInt(r,10):s.rangeUtil.intervalToSeconds(r),r<1&&(r=1)),r||""}performTimeSeriesQuery(e,t){let{from:r,to:n}=t;return this.awsRequest(Jr,e).pipe((0,Ut.U)((e=>{const t=(0,g.toDataQueryResponse)({data:e}).data;if(!t||t.length<=0)return{data:[]};const r=(0,oe.findLast)(e.results,(e=>!!e.error));return t.forEach((e=>{e.fields.forEach((t=>{var r,n;t.type===s.FieldType.time&&(t.config.interval=1e3*(null===(r=e.meta)||void 0===r||null===(n=r.custom)||void 0===n?void 0:n.period))}))})),{data:t,error:r?{message:r.error}:null}})),(0,tr.K)((t=>{if(!t.data.results&&t.data&&"Metric request error"===t.data.message&&t.data.error)return t.message=t.data.error,(0,$t._)((()=>t));const r=Object.values(t.data.results),n=r.find((e=>e.error));if(n&&(t.message=n.error),r.some((e=>e.error&&/^Throttling:.*/.test(e.error)))){const r=Object.keys(t.data.results);Object.values(e.queries).reduce(((e,t)=>{let{refId:n,region:i}=t;return n&&!r.includes(n)||e.includes(i)?e:[...e,i]}),[]).forEach((e=>{const t=this.getActualRegion(e);t&&this.debouncedAlert(this.datasourceName,t)}))}return(0,$t._)((()=>t))})))}doMetricResourceRequest(e,t){return this.getResource(e,t)}makeLogActionRequest(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{makeReplacements:!0,skipCache:!1};const n=this.timeSrv.timeRange(),i={from:n.from.valueOf().toString(),to:n.to.valueOf().toString(),queries:t.map((t=>Object.assign({refId:t.refId||"A",intervalMs:1,maxDataPoints:1,datasource:this.getRef(),type:"logAction",subtype:e},t)))};r.makeReplacements&&i.queries.forEach((e=>{const t=["queryString","logGroupNames","logGroupName","logGroupNamePrefix"],n=e;for(const i of t)e.hasOwnProperty(i)&&(Array.isArray(n[i])?n[i]=n[i].map((e=>this.replace(e,r.scopedVars,!0,i))):n[i]=this.replace(n[i],r.scopedVars,!0,i));n.region&&(n.region=this.replace(n.region,r.scopedVars,!0,"region"),n.region=this.getActualRegion(n.region))}));let s={};return r.skipCache&&(s={"X-Cache-Skip":!0}),this.awsRequest(Jr,i,s).pipe((0,Ut.U)((e=>{return t={data:e},(0,g.toDataQueryResponse)(t).data||[];var t})),(0,tr.K)((e=>{var t,r;if(ir.ZP.featureToggles.datasourceQueryMultiStatus&&207===e.status)throw e;if(400===e.status)throw e;if(null!==(t=e.data)&&void 0!==t&&t.error)throw e.data.error;if(null!==(r=e.data)&&void 0!==r&&r.message)throw e.data.message;throw e})))}getRegions(){return this.doMetricResourceRequest("regions").then((e=>[{label:"default",value:"default",text:"default"},...e]))}getNamespaces(){return this.doMetricResourceRequest("namespaces")}async getMetrics(e,t){return e?this.doMetricResourceRequest("metrics",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e)}):[]}async getAllMetrics(e){return(await this.doMetricResourceRequest("all-metrics",{region:this.templateSrv.replace(this.getActualRegion(e))})).map((e=>({metricName:e.value,namespace:e.text})))}async getDimensionKeys(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";return e?this.doMetricResourceRequest("dimension-keys",{region:this.templateSrv.replace(this.getActualRegion(t)),namespace:this.templateSrv.replace(e),dimensionFilters:JSON.stringify(this.convertDimensionFormat(r,{})),metricName:n}):[]}async getDimensionValues(e,t,r,n,i){if(!t||!r)return[];return await this.doMetricResourceRequest("dimension-values",{region:this.templateSrv.replace(this.getActualRegion(e)),namespace:this.templateSrv.replace(t),metricName:this.templateSrv.replace(r.trim()),dimensionKey:this.templateSrv.replace(n),dimensions:JSON.stringify(this.convertDimensionFormat(i,{}))})}getEbsVolumeIds(e,t){return this.doMetricResourceRequest("ebs-volume-ids",{region:this.templateSrv.replace(this.getActualRegion(e)),instanceId:this.templateSrv.replace(t)})}getEc2InstanceAttribute(e,t,r){return this.doMetricResourceRequest("ec2-instance-attribute",{region:this.templateSrv.replace(this.getActualRegion(e)),attributeName:this.templateSrv.replace(t),filters:JSON.stringify(this.convertMultiFilterFormat(r,"filter key"))})}getResourceARNs(e,t,r){return this.doMetricResourceRequest("resource-arns",{region:this.templateSrv.replace(this.getActualRegion(e)),resourceType:this.templateSrv.replace(t),tags:JSON.stringify(this.convertMultiFilterFormat(r,"tag name"))})}targetContainsTemplate(e){var t;return this.templateSrv.containsTemplate(e.region)||this.templateSrv.containsTemplate(e.namespace)||this.templateSrv.containsTemplate(e.metricName)||this.templateSrv.containsTemplate(e.expression)||(null===(t=e.logGroupNames)||void 0===t?void 0:t.some((e=>this.templateSrv.containsTemplate(e))))||(0,oe.find)(e.dimensions,((e,t)=>this.templateSrv.containsTemplate(t)||this.templateSrv.containsTemplate(e)))}awsRequest(e,t){const r={method:"POST",url:e,data:t,headers:arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}};return(0,g.getBackendSrv)().fetch(r).pipe((0,Ut.U)((e=>e.data)))}getDefaultRegion(){return this.defaultRegion}getActualRegion(e){return"default"===e||void 0===e||""===e?this.getDefaultRegion():e}showContextToggle(){return!0}convertToCloudWatchTime(e,t){return(0,oe.isString)(e)&&(e=s.dateMath.parse(e,t)),Math.round(e.valueOf()/1e3)}convertDimensionFormat(e,t){return Object.entries(e).reduce(((e,r)=>{let[n,i]=r;if(n=this.replace(n,t,!0,"dimension keys"),Array.isArray(i))return Object.assign({},e,{[n]:i});if(!i)return Object.assign({},e,{[n]:null});const s=this.getVariableValue(i,t);return Object.assign({},e,{[n]:s})}),{})}getVariableValue(e,t){const r=this.templateSrv.getVariableName(e),n=this.templateSrv.getVariables().find((e=>{let{name:t}=e;return t===r}));if(r&&n){if(n.multi){return this.templateSrv.replace("$"+r,t,"pipe").split("|")}return[this.templateSrv.replace(e,t)]}return[e]}convertMultiFilterFormat(e,t){return Object.entries(e).reduce(((e,r)=>{let[n,i]=r;if(n=this.replace(n,{},!0,t),!i)return Object.assign({},e,{[n]:null});const s=i.reduce(((e,t)=>[...e,...this.getVariableValue(t,{})]),[]);return Object.assign({},e,{[n]:s})}),{})}replace(e,t,r,n){if(r&&e){const t=this.templateSrv.getVariables().find((t=>{let{name:r}=t;return r===this.templateSrv.getVariableName(e)}));t&&t.multi&&this.debouncedCustomAlert("CloudWatch templating error",`Multi template variables are not supported for ${n||e}`)}return this.templateSrv.replace(e,t)}getQueryDisplayText(e){var t;return"Logs"===e.queryMode?null!==(t=e.expression)&&void 0!==t?t:"":JSON.stringify(e)}interpolateVariablesInQueries(e,t){return e.length?e.map((e=>Object.assign({},e,{region:this.getActualRegion(this.replace(e.region,t))},ue(e)&&this.interpolateMetricsQueryVariables(e,t)))):e}interpolateMetricsQueryVariables(e,t){var r;return{alias:this.replace(e.alias,t),metricName:this.replace(e.metricName,t),namespace:this.replace(e.namespace,t),period:this.replace(e.period,t),sqlExpression:this.replace(e.sqlExpression,t),dimensions:Object.entries(null!==(r=e.dimensions)&&void 0!==r?r:{}).reduce(((e,r)=>{let[n,i]=r;return Array.isArray(i)?Object.assign({},e,{[n]:i}):Object.assign({},e,{[this.replace(n,t)]:this.replace(i,t)})}),{})}}}function sn(e){const t=e.lastIndexOf(":");return e.slice(t+1)}const an=new s.DataSourcePlugin(nn).setQueryEditorHelp(se).setConfigEditor((e=>{const{options:t}=e,r=function(e){const[t,r]=(0,a.useState)();return(0,a.useEffect)((()=>{(0,p.ak)().loadDatasource(e).then((e=>{r(e)}))}),[e]),t}(t.name);!function(e){const t=e=>{m.h.dispatch((0,c.$l)((0,d.ZR)("CloudWatch Authentication",e)))};(0,a.useEffect)((()=>{"arn"===e.authType?t('Since grafana 7.3 authentication type "arn" is deprecated, falling back to default SDK provider'):"credentials"!==e.authType||e.profile||e.database||t('As of grafana 7.3 authentication type "credentials" should be used only for shared file credentials.              If you don\'t have a credentials file, switch to the default SDK provider for extracting credentials              from environment variables or IAM roles')}),[e.authType,e.database,e.profile])}(t.jsonData);const n=function(e){const[t,r]=(0,a.useState)(void 0);return(0,o.Z)((()=>{if(e)try{s.rangeUtil.describeInterval(e),r(void 0)}catch(e){r(e.toString())}else r(void 0)}),350,[e]),t}(e.options.jsonData.logsTimeout);return(0,f.jsxs)(f.Fragment,{children:[(0,f.jsx)(l.ConnectionConfig,Object.assign({},e,{loadRegions:r&&(()=>r.getRegions().then((e=>e.filter((e=>"default"!==e.value)).map((e=>e.value))))),children:(0,f.jsx)(u.InlineField,{label:"Namespaces of Custom Metrics",labelWidth:28,tooltip:"Namespaces of Custom Metrics.",children:(0,f.jsx)(u.Input,{width:60,placeholder:"Namespace1,Namespace2",value:t.jsonData.customMetricsNamespaces||"",onChange:(0,s.onUpdateDatasourceJsonDataOption)(e,"customMetricsNamespaces")})})})),x||(x=(0,f.jsx)("h3",{className:"page-heading",children:"CloudWatch Logs"})),(0,f.jsx)("div",{className:"gf-form-group",children:(0,f.jsx)(u.InlineField,{label:"Timeout",labelWidth:28,tooltip:'Custom timout for CloudWatch Logs insights queries which have max concurrency limits. Default is 15 minutes. Must be a valid duration string, such as "15m" "30s" "2000ms" etc.',invalid:Boolean(n),children:(0,f.jsx)(u.Input,{width:60,placeholder:"15m",value:t.jsonData.logsTimeout||"",onChange:(0,s.onUpdateDatasourceJsonDataOption)(e,"logsTimeout"),title:'The timeout must be a valid duration string, such as "15m" "30s" "2000ms" etc.'})})}),(0,f.jsx)(b,{onChange:t=>(0,s.updateDatasourcePluginJsonDataOption)(e,"tracingDatasourceUid",t),datasourceUid:t.jsonData.tracingDatasourceUid})]})})).setQueryEditor(Pt).setMetadataInspector((function(e){let{data:t=[]}=e;const r=(0,a.useMemo)((()=>(0,oe.groupBy)(t,"refId")),[t]);return(0,f.jsx)(f.Fragment,{children:(0,f.jsxs)("table",{className:"filter-table form-inline",children:[ae||(ae=(0,f.jsx)("thead",{children:(0,f.jsxs)("tr",{children:[(0,f.jsx)("th",{children:"RefId"}),(0,f.jsx)("th",{children:"Metric Data Query ID"}),(0,f.jsx)("th",{children:"Metric Data Query Expression"}),(0,f.jsx)("th",{children:"Period"}),(0,f.jsx)("th",{})]})})),Object.entries(r).map(((e,t)=>{var r,n;let[i,s]=e;if(!s.length)return null;const a=s[0],o=null===(r=a.meta)||void 0===r?void 0:r.custom;return o?(0,f.jsx)("tbody",{children:(0,f.jsxs)("tr",{children:[(0,f.jsx)("td",{children:i}),(0,f.jsx)("td",{children:o.id}),(0,f.jsx)("td",{children:null===(n=a.meta)||void 0===n?void 0:n.executedQueryString}),(0,f.jsx)("td",{children:o.period})]})},t):null}))]})})}))},"./.yarn/cache/fast-deep-equal-npm-3.1.3-790edcfcf5-e21a9d8d84.zip/node_modules/fast-deep-equal/react.js":e=>{"use strict";e.exports=function e(t,r){if(t===r)return!0;if(t&&r&&"object"==typeof t&&"object"==typeof r){if(t.constructor!==r.constructor)return!1;var n,i,s;if(Array.isArray(t)){if((n=t.length)!=r.length)return!1;for(i=n;0!=i--;)if(!e(t[i],r[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if((n=(s=Object.keys(t)).length)!==Object.keys(r).length)return!1;for(i=n;0!=i--;)if(!Object.prototype.hasOwnProperty.call(r,s[i]))return!1;for(i=n;0!=i--;){var a=s[i];if(("_owner"!==a||!t.$$typeof)&&!e(t[a],r[a]))return!1}return!0}return t!=t&&r!=r}},"./.yarn/cache/jsurl-npm-0.1.5-9e17f93783-50b614908d.zip/node_modules/jsurl/index.js":(e,t,r)=>{e.exports=r("./.yarn/cache/jsurl-npm-0.1.5-9e17f93783-50b614908d.zip/node_modules/jsurl/lib/jsurl.js")},"./.yarn/cache/jsurl-npm-0.1.5-9e17f93783-50b614908d.zip/node_modules/jsurl/lib/jsurl.js":(e,t)=>{!function(e){"use strict";e.stringify=function e(t){function r(e){return/[^\w-.]/.test(e)?e.replace(/[^\w-.]/g,(function(e){return"$"===e?"!":(e=e.charCodeAt(0))<256?"*"+("00"+e.toString(16)).slice(-2):"**"+("0000"+e.toString(16)).slice(-4)})):e}var n;switch(typeof t){case"number":return isFinite(t)?"~"+t:"~null";case"boolean":return"~"+t;case"string":return"~'"+r(t);case"object":if(!t)return"~null";if(n=[],Array.isArray(t)){for(var i=0;i<t.length;i++)n[i]=e(t[i])||"~null";return"~("+(n.join("")||"~")+")"}for(var s in t)if(t.hasOwnProperty(s)){var a=e(t[s]);a&&n.push(r(s)+a)}return"~("+n.join("~")+")";default:return}};var t={true:!0,false:!1,null:null};e.parse=function(e){if(!e)return e;e=e.replace(/%(25)*27/g,"'");var r=0,n=e.length;function i(t){if(e.charAt(r)!==t)throw new Error("bad JSURL syntax: expected "+t+", got "+(e&&e.charAt(r)));r++}function s(){for(var t,i=r,s="";r<n&&"~"!==(t=e.charAt(r))&&")"!==t;)switch(t){case"*":i<r&&(s+=e.substring(i,r)),"*"===e.charAt(r+1)?(s+=String.fromCharCode(parseInt(e.substring(r+2,r+6),16)),i=r+=6):(s+=String.fromCharCode(parseInt(e.substring(r+1,r+3),16)),i=r+=3);break;case"!":i<r&&(s+=e.substring(i,r)),s+="$",i=++r;break;default:r++}return s+e.substring(i,r)}return function a(){var o,l,u;switch(i("~"),l=e.charAt(r)){case"(":if(r++,"~"===e.charAt(r))if(o=[],")"===e.charAt(r+1))r++;else do{o.push(a())}while("~"===e.charAt(r));else if(o={},")"!==e.charAt(r))do{o[s()]=a()}while("~"===e.charAt(r)&&++r);i(")");break;case"'":r++,o=s();break;default:for(u=r++;r<n&&/[^)~]/.test(e.charAt(r));)r++;var c=e.substring(u,r);if(/[\d\-]/.test(l))o=parseFloat(c);else if(void 0===(o=t[c]))throw new Error("bad value keyword: "+c)}return o}()},e.tryParse=function(t,r){try{return e.parse(t)}catch(e){return r}}}(t)}}]);