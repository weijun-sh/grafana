"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[2651],{"./public/app/core/hooks/useNavModel.ts":(e,t,n)=>{n.d(t,{q:()=>l});var a=n("./.yarn/__virtual__/react-redux-virtual-7ad20a440e/0/cache/react-redux-npm-7.2.6-134f5ed64d-0bf142ce0d.zip/node_modules/react-redux/es/index.js"),s=n("./public/app/core/selectors/navModel.ts");const l=e=>{const t=(0,a.useSelector)(e=>e.navIndex);return(0,s.h)(t,e)}},"./public/app/features/live/pages/PipelineAdminPage.tsx":(e,t,n)=>{n.r(t),n.d(t,{default:()=>(function(){const[e,t]=(0,a.useState)([]),[n,o]=(0,a.useState)([]),[c,u]=(0,a.useState)(),v=(0,i.q)("live-pipeline"),[h,g]=(0,a.useState)(),m=()=>{(0,s.getBackendSrv)().get("api/live/channel-rules").then(e=>{var n,a;t(null!==(n=e.rules)&&void 0!==n?n:[]),o(null!==(a=e.rules)&&void 0!==a?a:[])}).catch(e=>{e.data&&g(JSON.stringify(e.data,null,2))})};(0,a.useEffect)(()=>{m()},[]);return(0,d.jsx)(r.Z,{navModel:v,children:(0,d.jsxs)(r.Z.Contents,{children:[h&&(0,d.jsx)("pre",{children:h}),(0,d.jsx)("div",{className:"page-action-bar",children:(0,d.jsx)("div",{className:"gf-form gf-form--grow",children:(0,d.jsx)(l.Input,{placeholder:"Search pattern...",onChange:a=>{a.target.value?t(e.filter(e=>e.pattern.toLowerCase().includes(a.target.value.toLowerCase()))):t(n)}})})}),(0,d.jsx)(N,{rules:e,onRuleChanged:m,selectRule:c}),(0,d.jsx)(p,{onRuleAdded:t=>{console.log("GOT",t,"vs",e[0]),u(t),m()}})]})})})});var a=n("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),s=n("./packages/grafana-runtime/src/index.ts"),l=n("./packages/grafana-ui/src/index.ts"),r=n("./public/app/core/components/Page/Page.tsx"),i=n("./public/app/core/hooks/useNavModel.ts"),o=n("./packages/grafana-data/src/index.ts"),c=n("./public/app/core/copy/appNotification.ts"),d=n("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const u=[{label:"Data source",description:"Configure a channel scoped to a data source instance",value:"ds"},{label:"Any",description:"Enter an arbitray channel pattern",value:"any"}];function p(e){let{onRuleAdded:t}=e;const[n,r]=(0,a.useState)(),[i,p]=(0,a.useState)(),[v,h]=(0,a.useState)(""),[g,m]=(0,a.useState)(),x=(0,c.iG)(),j=()=>{i?"ds"!==n||v.length?(0,s.getBackendSrv)().post("api/live/channel-rules",{pattern:v+i,settings:{converter:{type:"jsonAuto"},frameOutputs:[{type:"managedStream"}]}}).then(e=>{console.log("ADDED",e),p(void 0),r(void 0),t(e.rule)}).catch(e=>{x.error("Error adding rule",e),e.isHandled=!0}):x.error("Select datasource"):x.error("Enter path")};return n?(0,d.jsx)("div",{children:(0,d.jsxs)(l.HorizontalGroup,{children:["any"===n&&(0,d.jsx)(l.Field,{label:"Pattern",children:(0,d.jsx)(l.Input,{value:null!==i&&void 0!==i?i:"",onChange:e=>p(e.currentTarget.value),placeholder:"scope/namespace/path"})}),"ds"===n&&(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(l.Field,{label:"Data source",children:(0,d.jsx)(s.DataSourcePicker,{current:g,onChange:e=>{m(e),h(`${o.LiveChannelScope.DataSource}/${e.uid}/`)}})}),(0,d.jsx)(l.Field,{label:"Path",children:(0,d.jsx)(l.Input,{value:null!==i&&void 0!==i?i:"",onChange:e=>p(e.currentTarget.value),placeholder:"path"})})]}),(0,d.jsx)(l.Field,{label:"",children:(0,d.jsx)(l.Button,{onClick:j,variant:null!==i&&void 0!==i&&i.length?"primary":"secondary",children:"Add"})}),(0,d.jsx)(l.Field,{label:"",children:(0,d.jsx)(l.Button,{variant:"secondary",onClick:()=>r(void 0),children:"Cancel"})})]})}):(0,d.jsx)("div",{children:(0,d.jsx)(l.ValuePicker,{label:"Add channel rule",variant:"secondary",size:"md",icon:"plus",menuPlacement:"auto",isFullWidth:!1,options:u,onChange:e=>r(e.value)})})}var v=n("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/0/cache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),h=n("./public/app/features/plugins/datasource_srv.ts");const g=e=>{var t;let{onChange:n,value:a,ruleType:s,entitiesInfo:r}=e;return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(l.Select,{options:r[s],placeholder:"Select an option",value:null!==(t=null===a||void 0===a?void 0:a.type)&&void 0!==t?t:"",onChange:e=>{const t=e.value;n({type:t,[t]:r.getExample(s,t)})}},s),(0,d.jsx)(l.CodeEditor,{height:"50vh",value:a?JSON.stringify(a[a.type],null,"\t"):"",showLineNumbers:!0,readOnly:!1,language:"json",showMiniMap:!1,onBlur:e=>{const t=JSON.parse(e);n({type:a.type,[a.type]:t})}})]})},m=e=>{let{onChange:t,value:n,ruleType:s,entitiesInfo:r}=e;const[i,o]=(0,a.useState)(0),c=null!==n&&void 0!==n?n:[];let u=[];for(let e=0;e<=c.length;e++)u.push({label:`${s}: ${e}`,value:e});return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(l.Select,{placeholder:"Select an index",options:u,value:i,onChange:e=>{o(e.value)}}),(0,d.jsx)(g,{onChange:e=>{if(n){const a=[...n];a[i]=e,t(a)}else t([e])},value:c[i],ruleType:s,entitiesInfo:r})]})},x=e=>{const[t,n]=(0,a.useState)(),[r,i]=(0,a.useState)(),c=(0,l.useStyles)(j);return(0,d.jsxs)("div",{children:[(0,d.jsx)(l.CodeEditor,{height:100,value:"",showLineNumbers:!0,readOnly:!1,language:"json",showMiniMap:!1,onBlur:e=>{i(e)}}),(0,d.jsx)(l.Button,{onClick:()=>{(0,s.getBackendSrv)().post("api/live/pipeline-convert-test",{channelRules:[e.rule],channel:e.rule.pattern,data:r}).then(e=>{const t=e.channelFrames;t&&n(t.map(e=>{const t=(0,o.dataFrameFromJSON)(e.frame);for(const e of t.fields)e.display=(0,o.getDisplayProcessor)({field:e,theme:s.config.theme2});return{channel:e.channel,frame:t}}))}).catch(e=>{n(e)})},className:c.margin,children:"Test"}),(null===t||void 0===t?void 0:t.length)&&t.map(e=>(0,d.jsx)(l.Field,{label:e.channel,children:(0,d.jsx)(l.Table,{data:e.frame,width:700,height:Math.min(10*e.frame.length+10,150),showTypeIcons:!0})},e.channel))]})},j=e=>({margin:v.css`
      margin-bottom: 15px;
    `});function f(e,t){return Array.isArray(e)?e.map(e=>({label:e[t],value:e[t]})):e[t].map(e=>({label:e.type,value:e.type}))}const y=[{label:"Converter",type:"converter",isConverter:!0},{label:"Processors",type:"frameProcessors"},{label:"Outputs",type:"frameOutputs"},{label:"Test",isTest:!0,icon:"flask"}],b=e=>{var t;const{isOpen:n,onClose:r,clickColumn:i}=e,[o,c]=(0,a.useState)(e.rule),[u,p]=(0,a.useState)(y.find(e=>e.type===i)),[v,h]=(0,a.useState)(!1),[j,b]=(0,a.useState)(null!==u&&void 0!==u&&u.type?null===o||void 0===o?void 0:null===(t=o.settings)||void 0===t?void 0:t[u.type]:void 0),[C,k]=(0,a.useState)(),O=(0,l.useStyles)(S),T=e=>{h(!0),null!==u&&void 0!==u&&u.type&&c(Object.assign({},o,{settings:Object.assign({},o.settings,{[null===u||void 0===u?void 0:u.type]:e})})),b(e)};(0,a.useMemo)(()=>{(async function(){return await(0,s.getBackendSrv)().get("api/live/pipeline-entities").then(e=>({converter:f(e,"converters"),frameProcessors:f(e,"frameProcessors"),frameOutputs:f(e,"frameOutputs"),getExample:(t,n)=>{var a,s,l;return null===(a=e[`${t}s`])||void 0===a?void 0:null===(s=a.filter(e=>e.type===n))||void 0===s?void 0:null===(l=s[0])||void 0===l?void 0:l.example}}))})().then(e=>{k(e)})},[]);return(0,d.jsxs)(l.Modal,{isOpen:n,title:o.pattern,onDismiss:r,closeOnEscape:!0,children:[(0,d.jsx)(l.TabsBar,{children:y.map((e,t)=>(0,d.jsx)(l.Tab,{label:e.label,active:e===u,icon:e.icon,onChangeTab:()=>{var t;(p(e),e.type)&&b(null===o||void 0===o?void 0:null===(t=o.settings)||void 0===t?void 0:t[e.type])}},t))}),(0,d.jsxs)(l.TabContent,{children:[C&&o&&u&&(0,d.jsxs)(d.Fragment,{children:[(null===u||void 0===u?void 0:u.isTest)&&(0,d.jsx)(x,{rule:o}),u.isConverter&&(0,d.jsx)(g,{onChange:T,value:j,ruleType:"converter",entitiesInfo:C}),!u.isConverter&&u.type&&(0,d.jsx)(m,{onChange:T,value:j,ruleType:u.type,entitiesInfo:C})]}),(0,d.jsx)(l.Button,{onClick:()=>{(0,s.getBackendSrv)().put("api/live/channel-rules",o).then(()=>{h(!1),r()}).catch(e=>console.error(e))},className:O.save,variant:v?"primary":"secondary",children:"Save"})]})]})},S=e=>({save:v.css`
      margin-top: 5px;
    `});var C,k,O,T;const N=e=>{const{rules:t}=e,[n,r]=(0,a.useState)(!1),[i,o]=(0,a.useState)(),[c,u]=(0,a.useState)("converter"),p=(0,l.useStyles)(P),v=(e,t)=>{var n;if(!e)return;let a=null===t||void 0===t?void 0:null===(n=t.target)||void 0===n?void 0:n.getAttribute("data-column");a&&"pattern"!==a||(a="converter"),u(a),o(e),r(!0)};(0,a.useEffect)(()=>{e.selectRule&&v(e.selectRule)},[e.selectRule]);return(0,d.jsxs)("div",{children:[(0,d.jsx)("div",{className:"admin-list-table",children:(0,d.jsxs)("table",{className:"filter-table filter-table--hover form-inline",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[C||(C=(0,d.jsx)("th",{children:"Channel"})),k||(k=(0,d.jsx)("th",{children:"Converter"})),O||(O=(0,d.jsx)("th",{children:"Processor"})),T||(T=(0,d.jsx)("th",{children:"Output"})),(0,d.jsx)("th",{style:{width:10},children:" "})]})}),(0,d.jsx)("tbody",{children:t.map(t=>{var n,a,r,i,o,c;return(0,d.jsxs)("tr",{onClick:e=>v(t,e),className:p.row,children:[(0,d.jsx)("td",{"data-pattern":t.pattern,"data-column":"pattern",children:(e=>{if(e.startsWith("ds/")){const t=e.indexOf("/",4);if(t>3){const n=e.substring(3,t),a=(0,h.ak)().getInstanceSettings(n);if(a)return(0,d.jsxs)("div",{children:[(0,d.jsx)(l.Tag,{name:a.name,colorIndex:1}),"  ",(0,d.jsx)("span",{children:e.substring(t+1)})]})}}return e})(t.pattern)}),(0,d.jsx)("td",{"data-pattern":t.pattern,"data-column":"converter",children:null===(n=t.settings)||void 0===n?void 0:null===(a=n.converter)||void 0===a?void 0:a.type}),(0,d.jsx)("td",{"data-pattern":t.pattern,"data-column":"processor",children:null===(r=t.settings)||void 0===r?void 0:null===(i=r.frameProcessors)||void 0===i?void 0:i.map(e=>(0,d.jsx)("span",{children:e.type},t.pattern+e.type))}),(0,d.jsx)("td",{"data-pattern":t.pattern,"data-column":"output",children:null===(o=t.settings)||void 0===o?void 0:null===(c=o.frameOutputs)||void 0===c?void 0:c.map(e=>(0,d.jsx)("span",{children:function(e,t){return null!==t&&void 0!==t&&t.type?(0,d.jsx)(l.Tag,{name:t.type},e):null}("out",e)},t.pattern+e.type))}),(0,d.jsx)("td",{children:(0,d.jsx)(l.IconButton,{name:"trash-alt",onClick:n=>{n.stopPropagation(),(t=>{(0,s.getBackendSrv)().delete("api/live/channel-rules",JSON.stringify({pattern:t})).catch(e=>console.error(e)).finally(()=>{e.onRuleChanged()})})(t.pattern)}})})]},t.pattern)})})]})}),n&&i&&(0,d.jsx)(b,{rule:i,isOpen:n,onClose:()=>{r(!1)},clickColumn:c})]})},P=e=>({row:v.css`
      cursor: pointer;
    `})}}]);