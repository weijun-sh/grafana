(self["webpackChunkgrafana"] = self["webpackChunkgrafana"] || []).push([["_yarn_cache_brace-npm-0_11_1-a66ecae2b2-def78159ab_zip_node_modules_brace_ext_language_tools_js"],{

/***/ "./.yarn/cache/brace-npm-0.11.1-a66ecae2b2-def78159ab.zip/node_modules/brace/ext/language_tools.js":
/***/ (() => {

ace.define("ace/snippets",["require","exports","module","ace/lib/oop","ace/lib/event_emitter","ace/lib/lang","ace/range","ace/anchor","ace/keyboard/hash_handler","ace/tokenizer","ace/lib/dom","ace/editor"], function(acequire, exports, module) {
"use strict";
var oop = acequire("./lib/oop");
var EventEmitter = acequire("./lib/event_emitter").EventEmitter;
var lang = acequire("./lib/lang");
var Range = acequire("./range").Range;
var Anchor = acequire("./anchor").Anchor;
var HashHandler = acequire("./keyboard/hash_handler").HashHandler;
var Tokenizer = acequire("./tokenizer").Tokenizer;
var comparePoints = Range.comparePoints;

var SnippetManager = function() {
    this.snippetMap = {};
    this.snippetNameMap = {};
};

(function() {
    oop.implement(this, EventEmitter);
    
    this.getTokenizer = function() {
        function TabstopToken(str, _, stack) {
            str = str.substr(1);
            if (/^\d+$/.test(str) && !stack.inFormatString)
                return [{tabstopId: parseInt(str, 10)}];
            return [{text: str}];
        }
        function escape(ch) {
            return "(?:[^\\\\" + ch + "]|\\\\.)";
        }
        SnippetManager.$tokenizer = new Tokenizer({
            start: [
                {regex: /:/, onMatch: function(val, state, stack) {
                    if (stack.length && stack[0].expectIf) {
                        stack[0].expectIf = false;
                        stack[0].elseBranch = stack[0];
                        return [stack[0]];
                    }
                    return ":";
                }},
                {regex: /\\./, onMatch: function(val, state, stack) {
                    var ch = val[1];
                    if (ch == "}" && stack.length) {
                        val = ch;
                    }else if ("`$\\".indexOf(ch) != -1) {
                        val = ch;
                    } else if (stack.inFormatString) {
                        if (ch == "n")
                            val = "\n";
                        else if (ch == "t")
                            val = "\n";
                        else if ("ulULE".indexOf(ch) != -1) {
                            val = {changeCase: ch, local: ch > "a"};
                        }
                    }

                    return [val];
                }},
                {regex: /}/, onMatch: function(val, state, stack) {
                    return [stack.length ? stack.shift() : val];
                }},
                {regex: /\$(?:\d+|\w+)/, onMatch: TabstopToken},
                {regex: /\$\{[\dA-Z_a-z]+/, onMatch: function(str, state, stack) {
                    var t = TabstopToken(str.substr(1), state, stack);
                    stack.unshift(t[0]);
                    return t;
                }, next: "snippetVar"},
                {regex: /\n/, token: "newline", merge: false}
            ],
            snippetVar: [
                {regex: "\\|" + escape("\\|") + "*\\|", onMatch: function(val, state, stack) {
                    stack[0].choices = val.slice(1, -1).split(",");
                }, next: "start"},
                {regex: "/(" + escape("/") + "+)/(?:(" + escape("/") + "*)/)(\\w*):?",
                 onMatch: function(val, state, stack) {
                    var ts = stack[0];
                    ts.fmtString = val;

                    val = this.splitRegex.exec(val);
                    ts.guard = val[1];
                    ts.fmt = val[2];
                    ts.flag = val[3];
                    return "";
                }, next: "start"},
                {regex: "`" + escape("`") + "*`", onMatch: function(val, state, stack) {
                    stack[0].code = val.splice(1, -1);
                    return "";
                }, next: "start"},
                {regex: "\\?", onMatch: function(val, state, stack) {
                    if (stack[0])
                        stack[0].expectIf = true;
                }, next: "start"},
                {regex: "([^:}\\\\]|\\\\.)*:?", token: "", next: "start"}
            ],
            formatString: [
                {regex: "/(" + escape("/") + "+)/", token: "regex"},
                {regex: "", onMatch: function(val, state, stack) {
                    stack.inFormatString = true;
                }, next: "start"}
            ]
        });
        SnippetManager.prototype.getTokenizer = function() {
            return SnippetManager.$tokenizer;
        };
        return SnippetManager.$tokenizer;
    };

    this.tokenizeTmSnippet = function(str, startState) {
        return this.getTokenizer().getLineTokens(str, startState).tokens.map(function(x) {
            return x.value || x;
        });
    };

    this.$getDefaultValue = function(editor, name) {
        if (/^[A-Z]\d+$/.test(name)) {
            var i = name.substr(1);
            return (this.variables[name[0] + "__"] || {})[i];
        }
        if (/^\d+$/.test(name)) {
            return (this.variables.__ || {})[name];
        }
        name = name.replace(/^TM_/, "");

        if (!editor)
            return;
        var s = editor.session;
        switch(name) {
            case "CURRENT_WORD":
                var r = s.getWordRange();
            case "SELECTION":
            case "SELECTED_TEXT":
                return s.getTextRange(r);
            case "CURRENT_LINE":
                return s.getLine(editor.getCursorPosition().row);
            case "PREV_LINE": // not possible in textmate
                return s.getLine(editor.getCursorPosition().row - 1);
            case "LINE_INDEX":
                return editor.getCursorPosition().column;
            case "LINE_NUMBER":
                return editor.getCursorPosition().row + 1;
            case "SOFT_TABS":
                return s.getUseSoftTabs() ? "YES" : "NO";
            case "TAB_SIZE":
                return s.getTabSize();
            case "FILENAME":
            case "FILEPATH":
                return "";
            case "FULLNAME":
                return "Ace";
        }
    };
    this.variables = {};
    this.getVariableValue = function(editor, varName) {
        if (this.variables.hasOwnProperty(varName))
            return this.variables[varName](editor, varName) || "";
        return this.$getDefaultValue(editor, varName) || "";
    };
    this.tmStrFormat = function(str, ch, editor) {
        var flag = ch.flag || "";
        var re = ch.guard;
        re = new RegExp(re, flag.replace(/[^gi]/, ""));
        var fmtTokens = this.tokenizeTmSnippet(ch.fmt, "formatString");
        var _self = this;
        var formatted = str.replace(re, function() {
            _self.variables.__ = arguments;
            var fmtParts = _self.resolveVariables(fmtTokens, editor);
            var gChangeCase = "E";
            for (var i  = 0; i < fmtParts.length; i++) {
                var ch = fmtParts[i];
                if (typeof ch == "object") {
                    fmtParts[i] = "";
                    if (ch.changeCase && ch.local) {
                        var next = fmtParts[i + 1];
                        if (next && typeof next == "string") {
                            if (ch.changeCase == "u")
                                fmtParts[i] = next[0].toUpperCase();
                            else
                                fmtParts[i] = next[0].toLowerCase();
                            fmtParts[i + 1] = next.substr(1);
                        }
                    } else if (ch.changeCase) {
                        gChangeCase = ch.changeCase;
                    }
                } else if (gChangeCase == "U") {
                    fmtParts[i] = ch.toUpperCase();
                } else if (gChangeCase == "L") {
                    fmtParts[i] = ch.toLowerCase();
                }
            }
            return fmtParts.join("");
        });
        this.variables.__ = null;
        return formatted;
    };

    this.resolveVariables = function(snippet, editor) {
        var result = [];
        for (var i = 0; i < snippet.length; i++) {
            var ch = snippet[i];
            if (typeof ch == "string") {
                result.push(ch);
            } else if (typeof ch != "object") {
                continue;
            } else if (ch.skip) {
                gotoNext(ch);
            } else if (ch.processed < i) {
                continue;
            } else if (ch.text) {
                var value = this.getVariableValue(editor, ch.text);
                if (value && ch.fmtString)
                    value = this.tmStrFormat(value, ch);
                ch.processed = i;
                if (ch.expectIf == null) {
                    if (value) {
                        result.push(value);
                        gotoNext(ch);
                    }
                } else {
                    if (value) {
                        ch.skip = ch.elseBranch;
                    } else
                        gotoNext(ch);
                }
            } else if (ch.tabstopId != null) {
                result.push(ch);
            } else if (ch.changeCase != null) {
                result.push(ch);
            }
        }
        function gotoNext(ch) {
            var i1 = snippet.indexOf(ch, i + 1);
            if (i1 != -1)
                i = i1;
        }
        return result;
    };

    this.insertSnippetForSelection = function(editor, snippetText) {
        var cursor = editor.getCursorPosition();
        var line = editor.session.getLine(cursor.row);
        var tabString = editor.session.getTabString();
        var indentString = line.match(/^\s*/)[0];
        
        if (cursor.column < indentString.length)
            indentString = indentString.slice(0, cursor.column);

        snippetText = snippetText.replace(/\r/g, "");
        var tokens = this.tokenizeTmSnippet(snippetText);
        tokens = this.resolveVariables(tokens, editor);
        tokens = tokens.map(function(x) {
            if (x == "\n")
                return x + indentString;
            if (typeof x == "string")
                return x.replace(/\t/g, tabString);
            return x;
        });
        var tabstops = [];
        tokens.forEach(function(p, i) {
            if (typeof p != "object")
                return;
            var id = p.tabstopId;
            var ts = tabstops[id];
            if (!ts) {
                ts = tabstops[id] = [];
                ts.index = id;
                ts.value = "";
            }
            if (ts.indexOf(p) !== -1)
                return;
            ts.push(p);
            var i1 = tokens.indexOf(p, i + 1);
            if (i1 === -1)
                return;

            var value = tokens.slice(i + 1, i1);
            var isNested = value.some(function(t) {return typeof t === "object";});
            if (isNested && !ts.value) {
                ts.value = value;
            } else if (value.length && (!ts.value || typeof ts.value !== "string")) {
                ts.value = value.join("");
            }
        });
        tabstops.forEach(function(ts) {ts.length = 0;});
        var expanding = {};
        function copyValue(val) {
            var copy = [];
            for (var i = 0; i < val.length; i++) {
                var p = val[i];
                if (typeof p == "object") {
                    if (expanding[p.tabstopId])
                        continue;
                    var j = val.lastIndexOf(p, i - 1);
                    p = copy[j] || {tabstopId: p.tabstopId};
                }
                copy[i] = p;
            }
            return copy;
        }
        for (var i = 0; i < tokens.length; i++) {
            var p = tokens[i];
            if (typeof p != "object")
                continue;
            var id = p.tabstopId;
            var i1 = tokens.indexOf(p, i + 1);
            if (expanding[id]) {
                if (expanding[id] === p)
                    expanding[id] = null;
                continue;
            }
            
            var ts = tabstops[id];
            var arg = typeof ts.value == "string" ? [ts.value] : copyValue(ts.value);
            arg.unshift(i + 1, Math.max(0, i1 - i));
            arg.push(p);
            expanding[id] = p;
            tokens.splice.apply(tokens, arg);

            if (ts.indexOf(p) === -1)
                ts.push(p);
        }
        var row = 0, column = 0;
        var text = "";
        tokens.forEach(function(t) {
            if (typeof t === "string") {
                var lines = t.split("\n");
                if (lines.length > 1){
                    column = lines[lines.length - 1].length;
                    row += lines.length - 1;
                } else
                    column += t.length;
                text += t;
            } else {
                if (!t.start)
                    t.start = {row: row, column: column};
                else
                    t.end = {row: row, column: column};
            }
        });
        var range = editor.getSelectionRange();
        var end = editor.session.replace(range, text);

        var tabstopManager = new TabstopManager(editor);
        var selectionId = editor.inVirtualSelectionMode && editor.selection.index;
        tabstopManager.addTabstops(tabstops, range.start, end, selectionId);
    };
    
    this.insertSnippet = function(editor, snippetText) {
        var self = this;
        if (editor.inVirtualSelectionMode)
            return self.insertSnippetForSelection(editor, snippetText);
        
        editor.forEachSelection(function() {
            self.insertSnippetForSelection(editor, snippetText);
        }, null, {keepOrder: true});
        
        if (editor.tabstopManager)
            editor.tabstopManager.tabNext();
    };

    this.$getScope = function(editor) {
        var scope = editor.session.$mode.$id || "";
        scope = scope.split("/").pop();
        if (scope === "html" || scope === "php") {
            if (scope === "php" && !editor.session.$mode.inlinePhp) 
                scope = "html";
            var c = editor.getCursorPosition();
            var state = editor.session.getState(c.row);
            if (typeof state === "object") {
                state = state[0];
            }
            if (state.substring) {
                if (state.substring(0, 3) == "js-")
                    scope = "javascript";
                else if (state.substring(0, 4) == "css-")
                    scope = "css";
                else if (state.substring(0, 4) == "php-")
                    scope = "php";
            }
        }
        
        return scope;
    };

    this.getActiveScopes = function(editor) {
        var scope = this.$getScope(editor);
        var scopes = [scope];
        var snippetMap = this.snippetMap;
        if (snippetMap[scope] && snippetMap[scope].includeScopes) {
            scopes.push.apply(scopes, snippetMap[scope].includeScopes);
        }
        scopes.push("_");
        return scopes;
    };

    this.expandWithTab = function(editor, options) {
        var self = this;
        var result = editor.forEachSelection(function() {
            return self.expandSnippetForSelection(editor, options);
        }, null, {keepOrder: true});
        if (result && editor.tabstopManager)
            editor.tabstopManager.tabNext();
        return result;
    };
    
    this.expandSnippetForSelection = function(editor, options) {
        var cursor = editor.getCursorPosition();
        var line = editor.session.getLine(cursor.row);
        var before = line.substring(0, cursor.column);
        var after = line.substr(cursor.column);

        var snippetMap = this.snippetMap;
        var snippet;
        this.getActiveScopes(editor).some(function(scope) {
            var snippets = snippetMap[scope];
            if (snippets)
                snippet = this.findMatchingSnippet(snippets, before, after);
            return !!snippet;
        }, this);
        if (!snippet)
            return false;
        if (options && options.dryRun)
            return true;
        editor.session.doc.removeInLine(cursor.row,
            cursor.column - snippet.replaceBefore.length,
            cursor.column + snippet.replaceAfter.length
        );

        this.variables.M__ = snippet.matchBefore;
        this.variables.T__ = snippet.matchAfter;
        this.insertSnippetForSelection(editor, snippet.content);

        this.variables.M__ = this.variables.T__ = null;
        return true;
    };

    this.findMatchingSnippet = function(snippetList, before, after) {
        for (var i = snippetList.length; i--;) {
            var s = snippetList[i];
            if (s.startRe && !s.startRe.test(before))
                continue;
            if (s.endRe && !s.endRe.test(after))
                continue;
            if (!s.startRe && !s.endRe)
                continue;

            s.matchBefore = s.startRe ? s.startRe.exec(before) : [""];
            s.matchAfter = s.endRe ? s.endRe.exec(after) : [""];
            s.replaceBefore = s.triggerRe ? s.triggerRe.exec(before)[0] : "";
            s.replaceAfter = s.endTriggerRe ? s.endTriggerRe.exec(after)[0] : "";
            return s;
        }
    };

    this.snippetMap = {};
    this.snippetNameMap = {};
    this.register = function(snippets, scope) {
        var snippetMap = this.snippetMap;
        var snippetNameMap = this.snippetNameMap;
        var self = this;
        
        if (!snippets) 
            snippets = [];
        
        function wrapRegexp(src) {
            if (src && !/^\^?\(.*\)\$?$|^\\b$/.test(src))
                src = "(?:" + src + ")";

            return src || "";
        }
        function guardedRegexp(re, guard, opening) {
            re = wrapRegexp(re);
            guard = wrapRegexp(guard);
            if (opening) {
                re = guard + re;
                if (re && re[re.length - 1] != "$")
                    re = re + "$";
            } else {
                re = re + guard;
                if (re && re[0] != "^")
                    re = "^" + re;
            }
            return new RegExp(re);
        }

        function addSnippet(s) {
            if (!s.scope)
                s.scope = scope || "_";
            scope = s.scope;
            if (!snippetMap[scope]) {
                snippetMap[scope] = [];
                snippetNameMap[scope] = {};
            }

            var map = snippetNameMap[scope];
            if (s.name) {
                var old = map[s.name];
                if (old)
                    self.unregister(old);
                map[s.name] = s;
            }
            snippetMap[scope].push(s);

            if (s.tabTrigger && !s.trigger) {
                if (!s.guard && /^\w/.test(s.tabTrigger))
                    s.guard = "\\b";
                s.trigger = lang.escapeRegExp(s.tabTrigger);
            }
            
            if (!s.trigger && !s.guard && !s.endTrigger && !s.endGuard)
                return;
            
            s.startRe = guardedRegexp(s.trigger, s.guard, true);
            s.triggerRe = new RegExp(s.trigger, "", true);

            s.endRe = guardedRegexp(s.endTrigger, s.endGuard, true);
            s.endTriggerRe = new RegExp(s.endTrigger, "", true);
        }

        if (snippets && snippets.content)
            addSnippet(snippets);
        else if (Array.isArray(snippets))
            snippets.forEach(addSnippet);
        
        this._signal("registerSnippets", {scope: scope});
    };
    this.unregister = function(snippets, scope) {
        var snippetMap = this.snippetMap;
        var snippetNameMap = this.snippetNameMap;

        function removeSnippet(s) {
            var nameMap = snippetNameMap[s.scope||scope];
            if (nameMap && nameMap[s.name]) {
                delete nameMap[s.name];
                var map = snippetMap[s.scope||scope];
                var i = map && map.indexOf(s);
                if (i >= 0)
                    map.splice(i, 1);
            }
        }
        if (snippets.content)
            removeSnippet(snippets);
        else if (Array.isArray(snippets))
            snippets.forEach(removeSnippet);
    };
    this.parseSnippetFile = function(str) {
        str = str.replace(/\r/g, "");
        var list = [], snippet = {};
        var re = /^#.*|^({[\s\S]*})\s*$|^(\S+) (.*)$|^((?:\n*\t.*)+)/gm;
        var m;
        while (m = re.exec(str)) {
            if (m[1]) {
                try {
                    snippet = JSON.parse(m[1]);
                    list.push(snippet);
                } catch (e) {}
            } if (m[4]) {
                snippet.content = m[4].replace(/^\t/gm, "");
                list.push(snippet);
                snippet = {};
            } else {
                var key = m[2], val = m[3];
                if (key == "regex") {
                    var guardRe = /\/((?:[^\/\\]|\\.)*)|$/g;
                    snippet.guard = guardRe.exec(val)[1];
                    snippet.trigger = guardRe.exec(val)[1];
                    snippet.endTrigger = guardRe.exec(val)[1];
                    snippet.endGuard = guardRe.exec(val)[1];
                } else if (key == "snippet") {
                    snippet.tabTrigger = val.match(/^\S*/)[0];
                    if (!snippet.name)
                        snippet.name = val;
                } else {
                    snippet[key] = val;
                }
            }
        }
        return list;
    };
    this.getSnippetByName = function(name, editor) {
        var snippetMap = this.snippetNameMap;
        var snippet;
        this.getActiveScopes(editor).some(function(scope) {
            var snippets = snippetMap[scope];
            if (snippets)
                snippet = snippets[name];
            return !!snippet;
        }, this);
        return snippet;
    };

}).call(SnippetManager.prototype);


var TabstopManager = function(editor) {
    if (editor.tabstopManager)
        return editor.tabstopManager;
    editor.tabstopManager = this;
    this.$onChange = this.onChange.bind(this);
    this.$onChangeSelection = lang.delayedCall(this.onChangeSelection.bind(this)).schedule;
    this.$onChangeSession = this.onChangeSession.bind(this);
    this.$onAfterExec = this.onAfterExec.bind(this);
    this.attach(editor);
};
(function() {
    this.attach = function(editor) {
        this.index = 0;
        this.ranges = [];
        this.tabstops = [];
        this.$openTabstops = null;
        this.selectedTabstop = null;

        this.editor = editor;
        this.editor.on("change", this.$onChange);
        this.editor.on("changeSelection", this.$onChangeSelection);
        this.editor.on("changeSession", this.$onChangeSession);
        this.editor.commands.on("afterExec", this.$onAfterExec);
        this.editor.keyBinding.addKeyboardHandler(this.keyboardHandler);
    };
    this.detach = function() {
        this.tabstops.forEach(this.removeTabstopMarkers, this);
        this.ranges = null;
        this.tabstops = null;
        this.selectedTabstop = null;
        this.editor.removeListener("change", this.$onChange);
        this.editor.removeListener("changeSelection", this.$onChangeSelection);
        this.editor.removeListener("changeSession", this.$onChangeSession);
        this.editor.commands.removeListener("afterExec", this.$onAfterExec);
        this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);
        this.editor.tabstopManager = null;
        this.editor = null;
    };

    this.onChange = function(delta) {
        var changeRange = delta;
        var isRemove = delta.action[0] == "r";
        var start = delta.start;
        var end = delta.end;
        var startRow = start.row;
        var endRow = end.row;
        var lineDif = endRow - startRow;
        var colDiff = end.column - start.column;

        if (isRemove) {
            lineDif = -lineDif;
            colDiff = -colDiff;
        }
        if (!this.$inChange && isRemove) {
            var ts = this.selectedTabstop;
            var changedOutside = ts && !ts.some(function(r) {
                return comparePoints(r.start, start) <= 0 && comparePoints(r.end, end) >= 0;
            });
            if (changedOutside)
                return this.detach();
        }
        var ranges = this.ranges;
        for (var i = 0; i < ranges.length; i++) {
            var r = ranges[i];
            if (r.end.row < start.row)
                continue;

            if (isRemove && comparePoints(start, r.start) < 0 && comparePoints(end, r.end) > 0) {
                this.removeRange(r);
                i--;
                continue;
            }

            if (r.start.row == startRow && r.start.column > start.column)
                r.start.column += colDiff;
            if (r.end.row == startRow && r.end.column >= start.column)
                r.end.column += colDiff;
            if (r.start.row >= startRow)
                r.start.row += lineDif;
            if (r.end.row >= startRow)
                r.end.row += lineDif;

            if (comparePoints(r.start, r.end) > 0)
                this.removeRange(r);
        }
        if (!ranges.length)
            this.detach();
    };
    this.updateLinkedFields = function() {
        var ts = this.selectedTabstop;
        if (!ts || !ts.hasLinkedRanges)
            return;
        this.$inChange = true;
        var session = this.editor.session;
        var text = session.getTextRange(ts.firstNonLinked);
        for (var i = ts.length; i--;) {
            var range = ts[i];
            if (!range.linked)
                continue;
            var fmt = exports.snippetManager.tmStrFormat(text, range.original);
            session.replace(range, fmt);
        }
        this.$inChange = false;
    };
    this.onAfterExec = function(e) {
        if (e.command && !e.command.readOnly)
            this.updateLinkedFields();
    };
    this.onChangeSelection = function() {
        if (!this.editor)
            return;
        var lead = this.editor.selection.lead;
        var anchor = this.editor.selection.anchor;
        var isEmpty = this.editor.selection.isEmpty();
        for (var i = this.ranges.length; i--;) {
            if (this.ranges[i].linked)
                continue;
            var containsLead = this.ranges[i].contains(lead.row, lead.column);
            var containsAnchor = isEmpty || this.ranges[i].contains(anchor.row, anchor.column);
            if (containsLead && containsAnchor)
                return;
        }
        this.detach();
    };
    this.onChangeSession = function() {
        this.detach();
    };
    this.tabNext = function(dir) {
        var max = this.tabstops.length;
        var index = this.index + (dir || 1);
        index = Math.min(Math.max(index, 1), max);
        if (index == max)
            index = 0;
        this.selectTabstop(index);
        if (index === 0)
            this.detach();
    };
    this.selectTabstop = function(index) {
        this.$openTabstops = null;
        var ts = this.tabstops[this.index];
        if (ts)
            this.addTabstopMarkers(ts);
        this.index = index;
        ts = this.tabstops[this.index];
        if (!ts || !ts.length)
            return;
        
        this.selectedTabstop = ts;
        if (!this.editor.inVirtualSelectionMode) {        
            var sel = this.editor.multiSelect;
            sel.toSingleRange(ts.firstNonLinked.clone());
            for (var i = ts.length; i--;) {
                if (ts.hasLinkedRanges && ts[i].linked)
                    continue;
                sel.addRange(ts[i].clone(), true);
            }
            if (sel.ranges[0])
                sel.addRange(sel.ranges[0].clone());
        } else {
            this.editor.selection.setRange(ts.firstNonLinked);
        }
        
        this.editor.keyBinding.addKeyboardHandler(this.keyboardHandler);
    };
    this.addTabstops = function(tabstops, start, end) {
        if (!this.$openTabstops)
            this.$openTabstops = [];
        if (!tabstops[0]) {
            var p = Range.fromPoints(end, end);
            moveRelative(p.start, start);
            moveRelative(p.end, start);
            tabstops[0] = [p];
            tabstops[0].index = 0;
        }

        var i = this.index;
        var arg = [i + 1, 0];
        var ranges = this.ranges;
        tabstops.forEach(function(ts, index) {
            var dest = this.$openTabstops[index] || ts;
                
            for (var i = ts.length; i--;) {
                var p = ts[i];
                var range = Range.fromPoints(p.start, p.end || p.start);
                movePoint(range.start, start);
                movePoint(range.end, start);
                range.original = p;
                range.tabstop = dest;
                ranges.push(range);
                if (dest != ts)
                    dest.unshift(range);
                else
                    dest[i] = range;
                if (p.fmtString) {
                    range.linked = true;
                    dest.hasLinkedRanges = true;
                } else if (!dest.firstNonLinked)
                    dest.firstNonLinked = range;
            }
            if (!dest.firstNonLinked)
                dest.hasLinkedRanges = false;
            if (dest === ts) {
                arg.push(dest);
                this.$openTabstops[index] = dest;
            }
            this.addTabstopMarkers(dest);
        }, this);
        
        if (arg.length > 2) {
            if (this.tabstops.length)
                arg.push(arg.splice(2, 1)[0]);
            this.tabstops.splice.apply(this.tabstops, arg);
        }
    };

    this.addTabstopMarkers = function(ts) {
        var session = this.editor.session;
        ts.forEach(function(range) {
            if  (!range.markerId)
                range.markerId = session.addMarker(range, "ace_snippet-marker", "text");
        });
    };
    this.removeTabstopMarkers = function(ts) {
        var session = this.editor.session;
        ts.forEach(function(range) {
            session.removeMarker(range.markerId);
            range.markerId = null;
        });
    };
    this.removeRange = function(range) {
        var i = range.tabstop.indexOf(range);
        range.tabstop.splice(i, 1);
        i = this.ranges.indexOf(range);
        this.ranges.splice(i, 1);
        this.editor.session.removeMarker(range.markerId);
        if (!range.tabstop.length) {
            i = this.tabstops.indexOf(range.tabstop);
            if (i != -1)
                this.tabstops.splice(i, 1);
            if (!this.tabstops.length)
                this.detach();
        }
    };

    this.keyboardHandler = new HashHandler();
    this.keyboardHandler.bindKeys({
        "Tab": function(ed) {
            if (exports.snippetManager && exports.snippetManager.expandWithTab(ed)) {
                return;
            }

            ed.tabstopManager.tabNext(1);
        },
        "Shift-Tab": function(ed) {
            ed.tabstopManager.tabNext(-1);
        },
        "Esc": function(ed) {
            ed.tabstopManager.detach();
        },
        "Return": function(ed) {
            return false;
        }
    });
}).call(TabstopManager.prototype);



var changeTracker = {};
changeTracker.onChange = Anchor.prototype.onChange;
changeTracker.setPosition = function(row, column) {
    this.pos.row = row;
    this.pos.column = column;
};
changeTracker.update = function(pos, delta, $insertRight) {
    this.$insertRight = $insertRight;
    this.pos = pos; 
    this.onChange(delta);
};

var movePoint = function(point, diff) {
    if (point.row == 0)
        point.column += diff.column;
    point.row += diff.row;
};

var moveRelative = function(point, start) {
    if (point.row == start.row)
        point.column -= start.column;
    point.row -= start.row;
};


acequire("./lib/dom").importCssString("\
.ace_snippet-marker {\
    -moz-box-sizing: border-box;\
    box-sizing: border-box;\
    background: rgba(194, 193, 208, 0.09);\
    border: 1px dotted rgba(211, 208, 235, 0.62);\
    position: absolute;\
}");

exports.snippetManager = new SnippetManager();


var Editor = acequire("./editor").Editor;
(function() {
    this.insertSnippet = function(content, options) {
        return exports.snippetManager.insertSnippet(this, content, options);
    };
    this.expandSnippet = function(options) {
        return exports.snippetManager.expandWithTab(this, options);
    };
}).call(Editor.prototype);

});

ace.define("ace/autocomplete/popup",["require","exports","module","ace/virtual_renderer","ace/editor","ace/range","ace/lib/event","ace/lib/lang","ace/lib/dom"], function(acequire, exports, module) {
"use strict";

var Renderer = acequire("../virtual_renderer").VirtualRenderer;
var Editor = acequire("../editor").Editor;
var Range = acequire("../range").Range;
var event = acequire("../lib/event");
var lang = acequire("../lib/lang");
var dom = acequire("../lib/dom");

var $singleLineEditor = function(el) {
    var renderer = new Renderer(el);

    renderer.$maxLines = 4;

    var editor = new Editor(renderer);

    editor.setHighlightActiveLine(false);
    editor.setShowPrintMargin(false);
    editor.renderer.setShowGutter(false);
    editor.renderer.setHighlightGutterLine(false);

    editor.$mouseHandler.$focusWaitTimout = 0;
    editor.$highlightTagPending = true;

    return editor;
};

var AcePopup = function(parentNode) {
    var el = dom.createElement("div");
    var popup = new $singleLineEditor(el);

    if (parentNode)
        parentNode.appendChild(el);
    el.style.display = "none";
    popup.renderer.content.style.cursor = "default";
    popup.renderer.setStyle("ace_autocomplete");

    popup.setOption("displayIndentGuides", false);
    popup.setOption("dragDelay", 150);

    var noop = function(){};

    popup.focus = noop;
    popup.$isFocused = true;

    popup.renderer.$cursorLayer.restartTimer = noop;
    popup.renderer.$cursorLayer.element.style.opacity = 0;

    popup.renderer.$maxLines = 8;
    popup.renderer.$keepTextAreaAtCursor = false;

    popup.setHighlightActiveLine(false);
    popup.session.highlight("");
    popup.session.$searchHighlight.clazz = "ace_highlight-marker";

    popup.on("mousedown", function(e) {
        var pos = e.getDocumentPosition();
        popup.selection.moveToPosition(pos);
        selectionMarker.start.row = selectionMarker.end.row = pos.row;
        e.stop();
    });

    var lastMouseEvent;
    var hoverMarker = new Range(-1,0,-1,Infinity);
    var selectionMarker = new Range(-1,0,-1,Infinity);
    selectionMarker.id = popup.session.addMarker(selectionMarker, "ace_active-line", "fullLine");
    popup.setSelectOnHover = function(val) {
        if (!val) {
            hoverMarker.id = popup.session.addMarker(hoverMarker, "ace_line-hover", "fullLine");
        } else if (hoverMarker.id) {
            popup.session.removeMarker(hoverMarker.id);
            hoverMarker.id = null;
        }
    };
    popup.setSelectOnHover(false);
    popup.on("mousemove", function(e) {
        if (!lastMouseEvent) {
            lastMouseEvent = e;
            return;
        }
        if (lastMouseEvent.x == e.x && lastMouseEvent.y == e.y) {
            return;
        }
        lastMouseEvent = e;
        lastMouseEvent.scrollTop = popup.renderer.scrollTop;
        var row = lastMouseEvent.getDocumentPosition().row;
        if (hoverMarker.start.row != row) {
            if (!hoverMarker.id)
                popup.setRow(row);
            setHoverMarker(row);
        }
    });
    popup.renderer.on("beforeRender", function() {
        if (lastMouseEvent && hoverMarker.start.row != -1) {
            lastMouseEvent.$pos = null;
            var row = lastMouseEvent.getDocumentPosition().row;
            if (!hoverMarker.id)
                popup.setRow(row);
            setHoverMarker(row, true);
        }
    });
    popup.renderer.on("afterRender", function() {
        var row = popup.getRow();
        var t = popup.renderer.$textLayer;
        var selected = t.element.childNodes[row - t.config.firstRow];
        if (selected == t.selectedNode)
            return;
        if (t.selectedNode)
            dom.removeCssClass(t.selectedNode, "ace_selected");
        t.selectedNode = selected;
        if (selected)
            dom.addCssClass(selected, "ace_selected");
    });
    var hideHoverMarker = function() { setHoverMarker(-1); };
    var setHoverMarker = function(row, suppressRedraw) {
        if (row !== hoverMarker.start.row) {
            hoverMarker.start.row = hoverMarker.end.row = row;
            if (!suppressRedraw)
                popup.session._emit("changeBackMarker");
            popup._emit("changeHoverMarker");
        }
    };
    popup.getHoveredRow = function() {
        return hoverMarker.start.row;
    };

    event.addListener(popup.container, "mouseout", hideHoverMarker);
    popup.on("hide", hideHoverMarker);
    popup.on("changeSelection", hideHoverMarker);

    popup.session.doc.getLength = function() {
        return popup.data.length;
    };
    popup.session.doc.getLine = function(i) {
        var data = popup.data[i];
        if (typeof data == "string")
            return data;
        return (data && data.value) || "";
    };

    var bgTokenizer = popup.session.bgTokenizer;
    bgTokenizer.$tokenizeRow = function(row) {
        var data = popup.data[row];
        var tokens = [];
        if (!data)
            return tokens;
        if (typeof data == "string")
            data = {value: data};
        if (!data.caption)
            data.caption = data.value || data.name;

        var last = -1;
        var flag, c;
        for (var i = 0; i < data.caption.length; i++) {
            c = data.caption[i];
            flag = data.matchMask & (1 << i) ? 1 : 0;
            if (last !== flag) {
                tokens.push({type: data.className || "" + ( flag ? "completion-highlight" : ""), value: c});
                last = flag;
            } else {
                tokens[tokens.length - 1].value += c;
            }
        }

        if (data.meta) {
            var maxW = popup.renderer.$size.scrollerWidth / popup.renderer.layerConfig.characterWidth;
            var metaData = data.meta;
            if (metaData.length + data.caption.length > maxW - 2) {
                metaData = metaData.substr(0, maxW - data.caption.length - 3) + "\u2026";
            }
            tokens.push({type: "rightAlignedText", value: metaData});
        }
        return tokens;
    };
    bgTokenizer.$updateOnChange = noop;
    bgTokenizer.start = noop;

    popup.session.$computeWidth = function() {
        return this.screenWidth = 0;
    };

    popup.$blockScrolling = Infinity;
    popup.isOpen = false;
    popup.isTopdown = false;
    popup.autoSelect = true;

    popup.data = [];
    popup.setData = function(list) {
        popup.setValue(lang.stringRepeat("\n", list.length), -1);
        popup.data = list || [];
        popup.setRow(0);
    };
    popup.getData = function(row) {
        return popup.data[row];
    };

    popup.getRow = function() {
        return selectionMarker.start.row;
    };
    popup.setRow = function(line) {
        line = Math.max(this.autoSelect ? 0 : -1, Math.min(this.data.length, line));
        if (selectionMarker.start.row != line) {
            popup.selection.clearSelection();
            selectionMarker.start.row = selectionMarker.end.row = line || 0;
            popup.session._emit("changeBackMarker");
            popup.moveCursorTo(line || 0, 0);
            if (popup.isOpen)
                popup._signal("select");
        }
    };

    popup.on("changeSelection", function() {
        if (popup.isOpen)
            popup.setRow(popup.selection.lead.row);
        popup.renderer.scrollCursorIntoView();
    });

    popup.hide = function() {
        this.container.style.display = "none";
        this._signal("hide");
        popup.isOpen = false;
    };
    popup.show = function(pos, lineHeight, topdownOnly) {
        var el = this.container;
        var screenHeight = window.innerHeight;
        var screenWidth = window.innerWidth;
        var renderer = this.renderer;
        var maxH = renderer.$maxLines * lineHeight * 1.4;
        var top = pos.top + this.$borderSize;
        var allowTopdown = top > screenHeight / 2 && !topdownOnly;
        if (allowTopdown && top + lineHeight + maxH > screenHeight) {
            renderer.$maxPixelHeight = top - 2 * this.$borderSize;
            el.style.top = "";
            el.style.bottom = screenHeight - top + "px";
            popup.isTopdown = false;
        } else {
            top += lineHeight;
            renderer.$maxPixelHeight = screenHeight - top - 0.2 * lineHeight;
            el.style.top = top + "px";
            el.style.bottom = "";
            popup.isTopdown = true;
        }

        el.style.display = "";
        this.renderer.$textLayer.checkForSizeChanges();

        var left = pos.left;
        if (left + el.offsetWidth > screenWidth)
            left = screenWidth - el.offsetWidth;

        el.style.left = left + "px";

        this._signal("show");
        lastMouseEvent = null;
        popup.isOpen = true;
    };

    popup.getTextLeftOffset = function() {
        return this.$borderSize + this.renderer.$padding + this.$imageSize;
    };

    popup.$imageSize = 0;
    popup.$borderSize = 1;

    return popup;
};

dom.importCssString("\
.ace_editor.ace_autocomplete .ace_marker-layer .ace_active-line {\
    background-color: #CAD6FA;\
    z-index: 1;\
}\
.ace_editor.ace_autocomplete .ace_line-hover {\
    border: 1px solid #abbffe;\
    margin-top: -1px;\
    background: rgba(233,233,253,0.4);\
}\
.ace_editor.ace_autocomplete .ace_line-hover {\
    position: absolute;\
    z-index: 2;\
}\
.ace_editor.ace_autocomplete .ace_scroller {\
   background: none;\
   border: none;\
   box-shadow: none;\
}\
.ace_rightAlignedText {\
    color: gray;\
    display: inline-block;\
    position: absolute;\
    right: 4px;\
    text-align: right;\
    z-index: -1;\
}\
.ace_editor.ace_autocomplete .ace_completion-highlight{\
    color: #000;\
    text-shadow: 0 0 0.01em;\
}\
.ace_editor.ace_autocomplete {\
    width: 280px;\
    z-index: 200000;\
    background: #fbfbfb;\
    color: #444;\
    border: 1px lightgray solid;\
    position: fixed;\
    box-shadow: 2px 3px 5px rgba(0,0,0,.2);\
    line-height: 1.4;\
}");

exports.AcePopup = AcePopup;

});

ace.define("ace/autocomplete/util",["require","exports","module"], function(acequire, exports, module) {
"use strict";

exports.parForEach = function(array, fn, callback) {
    var completed = 0;
    var arLength = array.length;
    if (arLength === 0)
        callback();
    for (var i = 0; i < arLength; i++) {
        fn(array[i], function(result, err) {
            completed++;
            if (completed === arLength)
                callback(result, err);
        });
    }
};

var ID_REGEX = /[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/;

exports.retrievePrecedingIdentifier = function(text, pos, regex) {
    regex = regex || ID_REGEX;
    var buf = [];
    for (var i = pos-1; i >= 0; i--) {
        if (regex.test(text[i]))
            buf.push(text[i]);
        else
            break;
    }
    return buf.reverse().join("");
};

exports.retrieveFollowingIdentifier = function(text, pos, regex) {
    regex = regex || ID_REGEX;
    var buf = [];
    for (var i = pos; i < text.length; i++) {
        if (regex.test(text[i]))
            buf.push(text[i]);
        else
            break;
    }
    return buf;
};

exports.getCompletionPrefix = function (editor) {
    var pos = editor.getCursorPosition();
    var line = editor.session.getLine(pos.row);
    var prefix;
    editor.completers.forEach(function(completer) {
        if (completer.identifierRegexps) {
            completer.identifierRegexps.forEach(function(identifierRegex) {
                if (!prefix && identifierRegex)
                    prefix = this.retrievePrecedingIdentifier(line, pos.column, identifierRegex);
            }.bind(this));
        }
    }.bind(this));
    return prefix || this.retrievePrecedingIdentifier(line, pos.column);
};

});

ace.define("ace/autocomplete",["require","exports","module","ace/keyboard/hash_handler","ace/autocomplete/popup","ace/autocomplete/util","ace/lib/event","ace/lib/lang","ace/lib/dom","ace/snippets"], function(acequire, exports, module) {
"use strict";

var HashHandler = acequire("./keyboard/hash_handler").HashHandler;
var AcePopup = acequire("./autocomplete/popup").AcePopup;
var util = acequire("./autocomplete/util");
var event = acequire("./lib/event");
var lang = acequire("./lib/lang");
var dom = acequire("./lib/dom");
var snippetManager = acequire("./snippets").snippetManager;

var Autocomplete = function() {
    this.autoInsert = false;
    this.autoSelect = true;
    this.exactMatch = false;
    this.gatherCompletionsId = 0;
    this.keyboardHandler = new HashHandler();
    this.keyboardHandler.bindKeys(this.commands);

    this.blurListener = this.blurListener.bind(this);
    this.changeListener = this.changeListener.bind(this);
    this.mousedownListener = this.mousedownListener.bind(this);
    this.mousewheelListener = this.mousewheelListener.bind(this);

    this.changeTimer = lang.delayedCall(function() {
        this.updateCompletions(true);
    }.bind(this));

    this.tooltipTimer = lang.delayedCall(this.updateDocTooltip.bind(this), 50);
};

(function() {

    this.$init = function() {
        this.popup = new AcePopup(document.body || document.documentElement);
        this.popup.on("click", function(e) {
            this.insertMatch();
            e.stop();
        }.bind(this));
        this.popup.focus = this.editor.focus.bind(this.editor);
        this.popup.on("show", this.tooltipTimer.bind(null, null));
        this.popup.on("select", this.tooltipTimer.bind(null, null));
        this.popup.on("changeHoverMarker", this.tooltipTimer.bind(null, null));
        return this.popup;
    };

    this.getPopup = function() {
        return this.popup || this.$init();
    };

    this.openPopup = function(editor, prefix, keepPopupPosition) {
        if (!this.popup)
            this.$init();

	this.popup.autoSelect = this.autoSelect;

        this.popup.setData(this.completions.filtered);

        editor.keyBinding.addKeyboardHandler(this.keyboardHandler);
        
        var renderer = editor.renderer;
        this.popup.setRow(this.autoSelect ? 0 : -1);
        if (!keepPopupPosition) {
            this.popup.setTheme(editor.getTheme());
            this.popup.setFontSize(editor.getFontSize());

            var lineHeight = renderer.layerConfig.lineHeight;

            var pos = renderer.$cursorLayer.getPixelPosition(this.base, true);
            pos.left -= this.popup.getTextLeftOffset();

            var rect = editor.container.getBoundingClientRect();
            pos.top += rect.top - renderer.layerConfig.offset;
            pos.left += rect.left - editor.renderer.scrollLeft;
            pos.left += renderer.gutterWidth;

            this.popup.show(pos, lineHeight);
        } else if (keepPopupPosition && !prefix) {
            this.detach();
        }
    };

    this.detach = function() {
        this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);
        this.editor.off("changeSelection", this.changeListener);
        this.editor.off("blur", this.blurListener);
        this.editor.off("mousedown", this.mousedownListener);
        this.editor.off("mousewheel", this.mousewheelListener);
        this.changeTimer.cancel();
        this.hideDocTooltip();

        this.gatherCompletionsId += 1;
        if (this.popup && this.popup.isOpen)
            this.popup.hide();

        if (this.base)
            this.base.detach();
        this.activated = false;
        this.completions = this.base = null;
    };

    this.changeListener = function(e) {
        var cursor = this.editor.selection.lead;
        if (cursor.row != this.base.row || cursor.column < this.base.column) {
            this.detach();
        }
        if (this.activated)
            this.changeTimer.schedule();
        else
            this.detach();
    };

    this.blurListener = function(e) {
        var el = document.activeElement;
        var text = this.editor.textInput.getElement();
        var fromTooltip = e.relatedTarget && this.tooltipNode && this.tooltipNode.contains(e.relatedTarget);
        var container = this.popup && this.popup.container;
        if (el != text && el.parentNode != container && !fromTooltip
            && el != this.tooltipNode && e.relatedTarget != text
        ) {
            this.detach();
        }
    };

    this.mousedownListener = function(e) {
        this.detach();
    };

    this.mousewheelListener = function(e) {
        this.detach();
    };

    this.goTo = function(where) {
        var row = this.popup.getRow();
        var max = this.popup.session.getLength() - 1;

        switch(where) {
            case "up": row = row <= 0 ? max : row - 1; break;
            case "down": row = row >= max ? -1 : row + 1; break;
            case "start": row = 0; break;
            case "end": row = max; break;
        }

        this.popup.setRow(row);
    };

    this.insertMatch = function(data, options) {
        if (!data)
            data = this.popup.getData(this.popup.getRow());
        if (!data)
            return false;

        if (data.completer && data.completer.insertMatch) {
            data.completer.insertMatch(this.editor, data);
        } else {
            if (this.completions.filterText) {
                var ranges = this.editor.selection.getAllRanges();
                for (var i = 0, range; range = ranges[i]; i++) {
                    range.start.column -= this.completions.filterText.length;
                    this.editor.session.remove(range);
                }
            }
            if (data.snippet)
                snippetManager.insertSnippet(this.editor, data.snippet);
            else
                this.editor.execCommand("insertstring", data.value || data);
        }
        this.detach();
    };


    this.commands = {
        "Up": function(editor) { editor.completer.goTo("up"); },
        "Down": function(editor) { editor.completer.goTo("down"); },
        "Ctrl-Up|Ctrl-Home": function(editor) { editor.completer.goTo("start"); },
        "Ctrl-Down|Ctrl-End": function(editor) { editor.completer.goTo("end"); },

        "Esc": function(editor) { editor.completer.detach(); },
        "Return": function(editor) { return editor.completer.insertMatch(); },
        "Shift-Return": function(editor) { editor.completer.insertMatch(null, {deleteSuffix: true}); },
        "Tab": function(editor) {
            var result = editor.completer.insertMatch();
            if (!result && !editor.tabstopManager)
                editor.completer.goTo("down");
            else
                return result;
        },

        "PageUp": function(editor) { editor.completer.popup.gotoPageUp(); },
        "PageDown": function(editor) { editor.completer.popup.gotoPageDown(); }
    };

    this.gatherCompletions = function(editor, callback) {
        var session = editor.getSession();
        var pos = editor.getCursorPosition();

        var prefix = util.getCompletionPrefix(editor);

        this.base = session.doc.createAnchor(pos.row, pos.column - prefix.length);
        this.base.$insertRight = true;

        var matches = [];
        var total = editor.completers.length;
        editor.completers.forEach(function(completer, i) {
            completer.getCompletions(editor, session, pos, prefix, function(err, results) {
                if (!err && results)
                    matches = matches.concat(results);
                callback(null, {
                    prefix: util.getCompletionPrefix(editor),
                    matches: matches,
                    finished: (--total === 0)
                });
            });
        });
        return true;
    };

    this.showPopup = function(editor) {
        if (this.editor)
            this.detach();

        this.activated = true;

        this.editor = editor;
        if (editor.completer != this) {
            if (editor.completer)
                editor.completer.detach();
            editor.completer = this;
        }

        editor.on("changeSelection", this.changeListener);
        editor.on("blur", this.blurListener);
        editor.on("mousedown", this.mousedownListener);
        editor.on("mousewheel", this.mousewheelListener);

        this.updateCompletions();
    };

    this.updateCompletions = function(keepPopupPosition) {
        if (keepPopupPosition && this.base && this.completions) {
            var pos = this.editor.getCursorPosition();
            var prefix = this.editor.session.getTextRange({start: this.base, end: pos});
            if (prefix == this.completions.filterText)
                return;
            this.completions.setFilter(prefix);
            if (!this.completions.filtered.length)
                return this.detach();
            if (this.completions.filtered.length == 1
            && this.completions.filtered[0].value == prefix
            && !this.completions.filtered[0].snippet)
                return this.detach();
            this.openPopup(this.editor, prefix, keepPopupPosition);
            return;
        }
        var _id = this.gatherCompletionsId;
        this.gatherCompletions(this.editor, function(err, results) {
            var detachIfFinished = function() {
                if (!results.finished) return;
                return this.detach();
            }.bind(this);

            var prefix = results.prefix;
            var matches = results && results.matches;

            if (!matches || !matches.length)
                return detachIfFinished();
            if (prefix.indexOf(results.prefix) !== 0 || _id != this.gatherCompletionsId)
                return;

            this.completions = new FilteredList(matches);

            if (this.exactMatch)
                this.completions.exactMatch = true;

            this.completions.setFilter(prefix);
            var filtered = this.completions.filtered;
            if (!filtered.length)
                return detachIfFinished();
            if (filtered.length == 1 && filtered[0].value == prefix && !filtered[0].snippet)
                return detachIfFinished();
            if (this.autoInsert && filtered.length == 1 && results.finished)
                return this.insertMatch(filtered[0]);

            this.openPopup(this.editor, prefix, keepPopupPosition);
        }.bind(this));
    };

    this.cancelContextMenu = function() {
        this.editor.$mouseHandler.cancelContextMenu();
    };

    this.updateDocTooltip = function() {
        var popup = this.popup;
        var all = popup.data;
        var selected = all && (all[popup.getHoveredRow()] || all[popup.getRow()]);
        var doc = null;
        if (!selected || !this.editor || !this.popup.isOpen)
            return this.hideDocTooltip();
        this.editor.completers.some(function(completer) {
            if (completer.getDocTooltip)
                doc = completer.getDocTooltip(selected);
            return doc;
        });
        if (!doc)
            doc = selected;

        if (typeof doc == "string")
            doc = {docText: doc};
        if (!doc || !(doc.docHTML || doc.docText))
            return this.hideDocTooltip();
        this.showDocTooltip(doc);
    };

    this.showDocTooltip = function(item) {
        if (!this.tooltipNode) {
            this.tooltipNode = dom.createElement("div");
            this.tooltipNode.className = "ace_tooltip ace_doc-tooltip";
            this.tooltipNode.style.margin = 0;
            this.tooltipNode.style.pointerEvents = "auto";
            this.tooltipNode.tabIndex = -1;
            this.tooltipNode.onblur = this.blurListener.bind(this);
            this.tooltipNode.onclick = this.onTooltipClick.bind(this);
        }

        var tooltipNode = this.tooltipNode;
        if (item.docHTML) {
            tooltipNode.innerHTML = item.docHTML;
        } else if (item.docText) {
            tooltipNode.textContent = item.docText;
        }

        if (!tooltipNode.parentNode)
            document.body.appendChild(tooltipNode);
        var popup = this.popup;
        var rect = popup.container.getBoundingClientRect();
        tooltipNode.style.top = popup.container.style.top;
        tooltipNode.style.bottom = popup.container.style.bottom;

        if (window.innerWidth - rect.right < 320) {
            tooltipNode.style.right = window.innerWidth - rect.left + "px";
            tooltipNode.style.left = "";
        } else {
            tooltipNode.style.left = (rect.right + 1) + "px";
            tooltipNode.style.right = "";
        }
        tooltipNode.style.display = "block";
    };

    this.hideDocTooltip = function() {
        this.tooltipTimer.cancel();
        if (!this.tooltipNode) return;
        var el = this.tooltipNode;
        if (!this.editor.isFocused() && document.activeElement == el)
            this.editor.focus();
        this.tooltipNode = null;
        if (el.parentNode)
            el.parentNode.removeChild(el);
    };

    this.onTooltipClick = function(e) {
        var a = e.target;
        while (a && a != this.tooltipNode) {
            if (a.nodeName == "A" && a.href) {
                a.rel = "noreferrer";
                a.target = "_blank";
                break;
            }
            a = a.parentNode;
        }
    };

}).call(Autocomplete.prototype);

Autocomplete.startCommand = {
    name: "startAutocomplete",
    exec: function(editor) {
        if (!editor.completer)
            editor.completer = new Autocomplete();
        editor.completer.autoInsert = false;
        editor.completer.autoSelect = true;
        editor.completer.showPopup(editor);
        editor.completer.cancelContextMenu();
    },
    bindKey: "Ctrl-Space|Ctrl-Shift-Space|Alt-Space"
};

var FilteredList = function(array, filterText) {
    this.all = array;
    this.filtered = array;
    this.filterText = filterText || "";
    this.exactMatch = false;
};
(function(){
    this.setFilter = function(str) {
        if (str.length > this.filterText && str.lastIndexOf(this.filterText, 0) === 0)
            var matches = this.filtered;
        else
            var matches = this.all;

        this.filterText = str;
        matches = this.filterCompletions(matches, this.filterText);
        matches = matches.sort(function(a, b) {
            return b.exactMatch - a.exactMatch || b.score - a.score;
        });
        var prev = null;
        matches = matches.filter(function(item){
            var caption = item.snippet || item.caption || item.value;
            if (caption === prev) return false;
            prev = caption;
            return true;
        });

        this.filtered = matches;
    };
    this.filterCompletions = function(items, needle) {
        var results = [];
        var upper = needle.toUpperCase();
        var lower = needle.toLowerCase();
        loop: for (var i = 0, item; item = items[i]; i++) {
            var caption = item.value || item.caption || item.snippet;
            if (!caption) continue;
            var lastIndex = -1;
            var matchMask = 0;
            var penalty = 0;
            var index, distance;

            if (this.exactMatch) {
                if (needle !== caption.substr(0, needle.length))
                    continue loop;
            }else{
                for (var j = 0; j < needle.length; j++) {
                    var i1 = caption.indexOf(lower[j], lastIndex + 1);
                    var i2 = caption.indexOf(upper[j], lastIndex + 1);
                    index = (i1 >= 0) ? ((i2 < 0 || i1 < i2) ? i1 : i2) : i2;
                    if (index < 0)
                        continue loop;
                    distance = index - lastIndex - 1;
                    if (distance > 0) {
                        if (lastIndex === -1)
                            penalty += 10;
                        penalty += distance;
                    }
                    matchMask = matchMask | (1 << index);
                    lastIndex = index;
                }
            }
            item.matchMask = matchMask;
            item.exactMatch = penalty ? 0 : 1;
            item.score = (item.score || 0) - penalty;
            results.push(item);
        }
        return results;
    };
}).call(FilteredList.prototype);

exports.Autocomplete = Autocomplete;
exports.FilteredList = FilteredList;

});

ace.define("ace/autocomplete/text_completer",["require","exports","module","ace/range"], function(acequire, exports, module) {
    var Range = acequire("../range").Range;
    
    var splitRegex = /[^a-zA-Z_0-9\$\-\u00C0-\u1FFF\u2C00-\uD7FF\w]+/;

    function getWordIndex(doc, pos) {
        var textBefore = doc.getTextRange(Range.fromPoints({row: 0, column:0}, pos));
        return textBefore.split(splitRegex).length - 1;
    }
    function wordDistance(doc, pos) {
        var prefixPos = getWordIndex(doc, pos);
        var words = doc.getValue().split(splitRegex);
        var wordScores = Object.create(null);
        
        var currentWord = words[prefixPos];

        words.forEach(function(word, idx) {
            if (!word || word === currentWord) return;

            var distance = Math.abs(prefixPos - idx);
            var score = words.length - distance;
            if (wordScores[word]) {
                wordScores[word] = Math.max(score, wordScores[word]);
            } else {
                wordScores[word] = score;
            }
        });
        return wordScores;
    }

    exports.getCompletions = function(editor, session, pos, prefix, callback) {
        var wordScore = wordDistance(session, pos, prefix);
        var wordList = Object.keys(wordScore);
        callback(null, wordList.map(function(word) {
            return {
                caption: word,
                value: word,
                score: wordScore[word],
                meta: "local"
            };
        }));
    };
});

ace.define("ace/ext/language_tools",["require","exports","module","ace/snippets","ace/autocomplete","ace/config","ace/lib/lang","ace/autocomplete/util","ace/autocomplete/text_completer","ace/editor","ace/config"], function(acequire, exports, module) {
"use strict";

var snippetManager = acequire("../snippets").snippetManager;
var Autocomplete = acequire("../autocomplete").Autocomplete;
var config = acequire("../config");
var lang = acequire("../lib/lang");
var util = acequire("../autocomplete/util");

var textCompleter = acequire("../autocomplete/text_completer");
var keyWordCompleter = {
    getCompletions: function(editor, session, pos, prefix, callback) {
        if (session.$mode.completer) {
            return session.$mode.completer.getCompletions(editor, session, pos, prefix, callback);
        }
        var state = editor.session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
};

var snippetCompleter = {
    getCompletions: function(editor, session, pos, prefix, callback) {
        var snippetMap = snippetManager.snippetMap;
        var completions = [];
        snippetManager.getActiveScopes(editor).forEach(function(scope) {
            var snippets = snippetMap[scope] || [];
            for (var i = snippets.length; i--;) {
                var s = snippets[i];
                var caption = s.name || s.tabTrigger;
                if (!caption)
                    continue;
                completions.push({
                    caption: caption,
                    snippet: s.content,
                    meta: s.tabTrigger && !s.name ? s.tabTrigger + "\u21E5 " : "snippet",
                    type: "snippet"
                });
            }
        }, this);
        callback(null, completions);
    },
    getDocTooltip: function(item) {
        if (item.type == "snippet" && !item.docHTML) {
            item.docHTML = [
                "<b>", lang.escapeHTML(item.caption), "</b>", "<hr></hr>",
                lang.escapeHTML(item.snippet)
            ].join("");
        }
    }
};

var completers = [snippetCompleter, textCompleter, keyWordCompleter];
exports.setCompleters = function(val) {
    completers.length = 0;
    if (val) completers.push.apply(completers, val);
};
exports.addCompleter = function(completer) {
    completers.push(completer);
};
exports.textCompleter = textCompleter;
exports.keyWordCompleter = keyWordCompleter;
exports.snippetCompleter = snippetCompleter;

var expandSnippet = {
    name: "expandSnippet",
    exec: function(editor) {
        return snippetManager.expandWithTab(editor);
    },
    bindKey: "Tab"
};

var onChangeMode = function(e, editor) {
    loadSnippetsForMode(editor.session.$mode);
};

var loadSnippetsForMode = function(mode) {
    var id = mode.$id;
    if (!snippetManager.files)
        snippetManager.files = {};
    loadSnippetFile(id);
    if (mode.modes)
        mode.modes.forEach(loadSnippetsForMode);
};

var loadSnippetFile = function(id) {
    if (!id || snippetManager.files[id])
        return;
    var snippetFilePath = id.replace("mode", "snippets");
    snippetManager.files[id] = {};
    config.loadModule(snippetFilePath, function(m) {
        if (m) {
            snippetManager.files[id] = m;
            if (!m.snippets && m.snippetText)
                m.snippets = snippetManager.parseSnippetFile(m.snippetText);
            snippetManager.register(m.snippets || [], m.scope);
            if (m.includeScopes) {
                snippetManager.snippetMap[m.scope].includeScopes = m.includeScopes;
                m.includeScopes.forEach(function(x) {
                    loadSnippetFile("ace/mode/" + x);
                });
            }
        }
    });
};

var doLiveAutocomplete = function(e) {
    var editor = e.editor;
    var hasCompleter = editor.completer && editor.completer.activated;
    if (e.command.name === "backspace") {
        if (hasCompleter && !util.getCompletionPrefix(editor))
            editor.completer.detach();
    }
    else if (e.command.name === "insertstring") {
        var prefix = util.getCompletionPrefix(editor);
        if (prefix && !hasCompleter) {
            if (!editor.completer) {
                editor.completer = new Autocomplete();
            }
            editor.completer.autoInsert = false;
            editor.completer.showPopup(editor);
        }
    }
};

var Editor = acequire("../editor").Editor;
acequire("../config").defineOptions(Editor.prototype, "editor", {
    enableBasicAutocompletion: {
        set: function(val) {
            if (val) {
                if (!this.completers)
                    this.completers = Array.isArray(val)? val: completers;
                this.commands.addCommand(Autocomplete.startCommand);
            } else {
                this.commands.removeCommand(Autocomplete.startCommand);
            }
        },
        value: false
    },
    enableLiveAutocompletion: {
        set: function(val) {
            if (val) {
                if (!this.completers)
                    this.completers = Array.isArray(val)? val: completers;
                this.commands.on('afterExec', doLiveAutocomplete);
            } else {
                this.commands.removeListener('afterExec', doLiveAutocomplete);
            }
        },
        value: false
    },
    enableSnippets: {
        set: function(val) {
            if (val) {
                this.commands.addCommand(expandSnippet);
                this.on("changeMode", onChangeMode);
                onChangeMode(null, this);
            } else {
                this.commands.removeCommand(expandSnippet);
                this.off("changeMode", onChangeMode);
            }
        },
        value: false
    }
});
});
                (function() {
                    ace.acequire(["ace/ext/language_tools"], function() {});
                })();
            

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiX3lhcm5fY2FjaGVfYnJhY2UtbnBtLTBfMTFfMS1hNjZlY2FlMmIyLWRlZjc4MTU5YWJfemlwX25vZGVfbW9kdWxlc19icmFjZV9leHRfbGFuZ3VhZ2VfdG9vbHNfanMuanMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5Qiw2QkFBNkI7QUFDdEQscUJBQXFCLFVBQVU7QUFDL0I7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtCQUFrQjtBQUNsQixpQkFBaUI7QUFDakI7QUFDQSxnQ0FBZ0M7QUFDaEM7QUFDQSxxQkFBcUI7QUFDckI7QUFDQSxzQkFBc0I7QUFDdEI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLG1DQUFtQztBQUNuQztBQUNBOztBQUVBO0FBQ0Esa0JBQWtCO0FBQ2xCLGlCQUFpQixTQUFTO0FBQzFCO0FBQ0Esa0JBQWtCO0FBQ2xCLGlCQUFpQiw4Q0FBOEM7QUFDL0QsaUJBQWlCLFlBQVk7QUFDN0I7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLHFCQUFxQjtBQUN0QyxpQkFBaUI7QUFDakI7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGlCQUFpQixnQkFBZ0I7QUFDakMsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCLGdCQUFnQjtBQUNqQyxpQkFBaUI7QUFDakI7QUFDQTtBQUNBLGlCQUFpQixnQkFBZ0I7QUFDakMsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxpQkFBaUIsZ0JBQWdCO0FBQ2pDLGlCQUFpQixhQUFhO0FBQzlCO0FBQ0E7QUFDQSxpQkFBaUIsa0RBQWtEO0FBQ25FLGlCQUFpQjtBQUNqQjtB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QTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQSx5Q0FBeUMsSUFBSTtBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMENBQTBDLGFBQWE7QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsMEJBQTBCLFFBQVE7QUFDbEM7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0JBQWtCO0FBQ2xCLGNBQWM7QUFDZDtBQUNBO0FBQ0E7QUFDQSxjQUFjO0FBQ2Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrQkFBa0I7QUFDbEI7QUFDQTtBQUNBO0FBQ0Esa0JBQWtCO0FBQ2xCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTs7QUFFQSxDQUFDOzs7QUFHRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsbUJBQW1CO0FBQzNDO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxnQ0FBZ0MsSUFBSTtBQUNwQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSx5Q0FBeUMsSUFBSTtBQUM3QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxvQ0FBb0MsSUFBSTtBQUN4QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxVQUFVO0FBQ1Y7QUFDQTtBQUNBO0FBQ0E7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QUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTs7QUFFQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSx3QkFBd0IsUUFBUTtBQUNoQztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQSxzQkFBc0IsaUJBQWlCO0FBQ3ZDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGFBQWE7QUFDYjtBQUNBLEtBQUs7QUFDTDtBQUNBOztBQUVBLENBQUM7O0FBRUQ7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0EsS0FBSzs7QUFFTDtBQUNBOztBQUVBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBLFVBQVU7QUFDVjtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBOztBQUVBO0FBQ0EsdURBQXVEO0FBQ3ZELDBEQUEwRDtBQUMxRCxt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Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGNBQWM7QUFDZDtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxDQUFDOztBQUVEO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxJQUFJO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLFNBQVM7QUFDVDtBQUNBLEtBQUs7QUFDTDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEtBQUs7QUFDTDtBQUNBOztBQUVBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0EsS0FBSztBQUNMOztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQSxLQUFLO0FBQ0w7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsY0FBYztBQUNkO0FBQ0E7QUFDQTtBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0EsQ0FBQztBQUNELENBQUM7QUFDRDtBQUNBLDBFQUEwRTtBQUMxRSxpQkFBaUI7QUFDakIiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9ncmFmYW5hLy4vLnlhcm4vY2FjaGUvYnJhY2UtbnBtLTAuMTEuMS1hNjZlY2FlMmIyLWRlZjc4MTU5YWIuemlwL25vZGVfbW9kdWxlcy9icmFjZS9leHQvbGFuZ3VhZ2VfdG9vbHMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiYWNlLmRlZmluZShcImFjZS9zbmlwcGV0c1wiLFtcInJlcXVpcmVcIixcImV4cG9ydHNcIixcIm1vZHVsZVwiLFwiYWNlL2xpYi9vb3BcIixcImFjZS9saWIvZXZlbnRfZW1pdHRlclwiLFwiYWNlL2xpYi9sYW5nXCIsXCJhY2UvcmFuZ2VcIixcImFjZS9hbmNob3JcIixcImFjZS9rZXlib2FyZC9oYXNoX2hhbmRsZXJcIixcImFjZS90b2tlbml6ZXJcIixcImFjZS9saWIvZG9tXCIsXCJhY2UvZWRpdG9yXCJdLCBmdW5jdGlvbihhY2VxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7XG5cInVzZSBzdHJpY3RcIjtcbnZhciBvb3AgPSBhY2VxdWlyZShcIi4vbGliL29vcFwiKTtcbnZhciBFdmVudEVtaXR0ZXIgPSBhY2VxdWlyZShcIi4vbGliL2V2ZW50X2VtaXR0ZXJcIikuRXZlbnRFbWl0dGVyO1xudmFyIGxhbmcgPSBhY2VxdWlyZShcIi4vbGliL2xhbmdcIik7XG52YXIgUmFuZ2UgPSBhY2VxdWlyZShcIi4vcmFuZ2VcIikuUmFuZ2U7XG52YXIgQW5jaG9yID0gYWNlcXVpcmUoXCIuL2FuY2hvclwiKS5BbmNob3I7XG52YXIgSGFzaEhhbmRsZXIgPSBhY2VxdWlyZShcIi4va2V5Ym9hcmQvaGFzaF9oYW5kbGVyXCIpLkhhc2hIYW5kbGVyO1xudmFyIFRva2VuaXplciA9IGFjZXF1aXJlKFwiLi90b2tlbml6ZXJcIikuVG9rZW5pemVyO1xudmFyIGNvbXBhcmVQb2ludHMgPSBSYW5nZS5jb21wYXJlUG9pbnRzO1xuXG52YXIgU25pcHBldE1hbmFnZXIgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnNuaXBwZXRNYXAgPSB7fTtcbiAgICB0aGlzLnNuaXBwZXROYW1lTWFwID0ge307XG59O1xuXG4oZnVuY3Rpb24oKSB7XG4gICAgb29wLmltcGxlbWVudCh0aGlzLCBFdmVudEVtaXR0ZXIpO1xuICAgIFxuICAgIHRoaXMuZ2V0VG9rZW5pemVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGZ1bmN0aW9uIFRhYnN0b3BUb2tlbihzdHIsIF8sIHN0YWNrKSB7XG4gICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKDEpO1xuICAgICAgICAgICAgaWYgKC9eXFxkKyQvLnRlc3Qoc3RyKSAmJiAhc3RhY2suaW5Gb3JtYXRTdHJpbmcpXG4gICAgICAgICAgICAgICAgcmV0dXJuIFt7dGFic3RvcElkOiBwYXJzZUludChzdHIsIDEwKX1dO1xuICAgICAgICAgICAgcmV0dXJuIFt7dGV4dDogc3RyfV07XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gZXNjYXBlKGNoKSB7XG4gICAgICAgICAgICByZXR1cm4gXCIoPzpbXlxcXFxcXFxcXCIgKyBjaCArIFwiXXxcXFxcXFxcXC4pXCI7XG4gICAgICAgIH1cbiAgICAgICAgU25pcHBldE1hbmFnZXIuJHRva2VuaXplciA9IG5ldyBUb2tlbml6ZXIoe1xuICAgICAgICAgICAgc3RhcnQ6IFtcbiAgICAgICAgICAgICAgICB7cmVnZXg6IC86Lywgb25NYXRjaDogZnVuY3Rpb24odmFsLCBzdGF0ZSwgc3RhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YWNrLmxlbmd0aCAmJiBzdGFja1swXS5leHBlY3RJZikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhY2tbMF0uZXhwZWN0SWYgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrWzBdLmVsc2VCcmFuY2ggPSBzdGFja1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbc3RhY2tbMF1dO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcIjpcIjtcbiAgICAgICAgICAgICAgICB9fSxcbiAgICAgICAgICAgICAgICB7cmVnZXg6IC9cXFxcLi8sIG9uTWF0Y2g6IGZ1bmN0aW9uKHZhbCwgc3RhdGUsIHN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjaCA9IHZhbFsxXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09IFwifVwiICYmIHN0YWNrLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gY2g7XG4gICAgICAgICAgICAgICAgICAgIH1lbHNlIGlmIChcImAkXFxcXFwiLmluZGV4T2YoY2gpICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBjaDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFjay5pbkZvcm1hdFN0cmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoID09IFwiblwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IFwiXFxuXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjaCA9PSBcInRcIilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBcIlxcblwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoXCJ1bFVMRVwiLmluZGV4T2YoY2gpICE9IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0ge2NoYW5nZUNhc2U6IGNoLCBsb2NhbDogY2ggPiBcImFcIn07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW3ZhbF07XG4gICAgICAgICAgICAgICAgfX0sXG4gICAgICAgICAgICAgICAge3JlZ2V4OiAvfS8sIG9uTWF0Y2g6IGZ1bmN0aW9uKHZhbCwgc3RhdGUsIHN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBbc3RhY2subGVuZ3RoID8gc3RhY2suc2hpZnQoKSA6IHZhbF07XG4gICAgICAgICAgICAgICAgfX0sXG4gICAgICAgICAgICAgICAge3JlZ2V4OiAvXFwkKD86XFxkK3xcXHcrKS8sIG9uTWF0Y2g6IFRhYnN0b3BUb2tlbn0sXG4gICAgICAgICAgICAgICAge3JlZ2V4OiAvXFwkXFx7W1xcZEEtWl9hLXpdKy8sIG9uTWF0Y2g6IGZ1bmN0aW9uKHN0ciwgc3RhdGUsIHN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ID0gVGFic3RvcFRva2VuKHN0ci5zdWJzdHIoMSksIHN0YXRlLCBzdGFjayk7XG4gICAgICAgICAgICAgICAgICAgIHN0YWNrLnVuc2hpZnQodFswXSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0O1xuICAgICAgICAgICAgICAgIH0sIG5leHQ6IFwic25pcHBldFZhclwifSxcbiAgICAgICAgICAgICAgICB7cmVnZXg6IC9cXG4vLCB0b2tlbjogXCJuZXdsaW5lXCIsIG1lcmdlOiBmYWxzZX1cbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICBzbmlwcGV0VmFyOiBbXG4gICAgICAgICAgICAgICAge3JlZ2V4OiBcIlxcXFx8XCIgKyBlc2NhcGUoXCJcXFxcfFwiKSArIFwiKlxcXFx8XCIsIG9uTWF0Y2g6IGZ1bmN0aW9uKHZhbCwgc3RhdGUsIHN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YWNrWzBdLmNob2ljZXMgPSB2YWwuc2xpY2UoMSwgLTEpLnNwbGl0KFwiLFwiKTtcbiAgICAgICAgICAgICAgICB9LCBuZXh0OiBcInN0YXJ0XCJ9LFxuICAgICAgICAgICAgICAgIHtyZWdleDogXCIvKFwiICsgZXNjYXBlKFwiL1wiKSArIFwiKykvKD86KFwiICsgZXNjYXBlKFwiL1wiKSArIFwiKikvKShcXFxcdyopOj9cIixcbiAgICAgICAgICAgICAgICAgb25NYXRjaDogZnVuY3Rpb24odmFsLCBzdGF0ZSwgc3RhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRzID0gc3RhY2tbMF07XG4gICAgICAgICAgICAgICAgICAgIHRzLmZtdFN0cmluZyA9IHZhbDtcblxuICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnNwbGl0UmVnZXguZXhlYyh2YWwpO1xuICAgICAgICAgICAgICAgICAgICB0cy5ndWFyZCA9IHZhbFsxXTtcbiAgICAgICAgICAgICAgICAgICAgdHMuZm10ID0gdmFsWzJdO1xuICAgICAgICAgICAgICAgICAgICB0cy5mbGFnID0gdmFsWzNdO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJcIjtcbiAgICAgICAgICAgICAgICB9LCBuZXh0OiBcInN0YXJ0XCJ9LFxuICAgICAgICAgICAgICAgIHtyZWdleDogXCJgXCIgKyBlc2NhcGUoXCJgXCIpICsgXCIqYFwiLCBvbk1hdGNoOiBmdW5jdGlvbih2YWwsIHN0YXRlLCBzdGFjaykge1xuICAgICAgICAgICAgICAgICAgICBzdGFja1swXS5jb2RlID0gdmFsLnNwbGljZSgxLCAtMSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICAgICAgICAgIH0sIG5leHQ6IFwic3RhcnRcIn0sXG4gICAgICAgICAgICAgICAge3JlZ2V4OiBcIlxcXFw/XCIsIG9uTWF0Y2g6IGZ1bmN0aW9uKHZhbCwgc3RhdGUsIHN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFja1swXSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YWNrWzBdLmV4cGVjdElmID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9LCBuZXh0OiBcInN0YXJ0XCJ9LFxuICAgICAgICAgICAgICAgIHtyZWdleDogXCIoW146fVxcXFxcXFxcXXxcXFxcXFxcXC4pKjo/XCIsIHRva2VuOiBcIlwiLCBuZXh0OiBcInN0YXJ0XCJ9XG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgZm9ybWF0U3RyaW5nOiBbXG4gICAgICAgICAgICAgICAge3JlZ2V4OiBcIi8oXCIgKyBlc2NhcGUoXCIvXCIpICsgXCIrKS9cIiwgdG9rZW46IFwicmVnZXhcIn0sXG4gICAgICAgICAgICAgICAge3JlZ2V4OiBcIlwiLCBvbk1hdGNoOiBmdW5jdGlvbih2YWwsIHN0YXRlLCBzdGFjaykge1xuICAgICAgICAgICAgICAgICAgICBzdGFjay5pbkZvcm1hdFN0cmluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSwgbmV4dDogXCJzdGFydFwifVxuICAgICAgICAgICAgXVxuICAgICAgICB9KTtcbiAgICAgICAgU25pcHBldE1hbmFnZXIucHJvdG90eXBlLmdldFRva2VuaXplciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgcmV0dXJuIFNuaXBwZXRNYW5hZ2VyLiR0b2tlbml6ZXI7XG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBTbmlwcGV0TWFuYWdlci4kdG9rZW5pemVyO1xuICAgIH07XG5cbiAgICB0aGlzLnRva2VuaXplVG1TbmlwcGV0ID0gZnVuY3Rpb24oc3RyLCBzdGFydFN0YXRlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFRva2VuaXplcigpLmdldExpbmVUb2tlbnMoc3RyLCBzdGFydFN0YXRlKS50b2tlbnMubWFwKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIHJldHVybiB4LnZhbHVlIHx8IHg7XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICB0aGlzLiRnZXREZWZhdWx0VmFsdWUgPSBmdW5jdGlvbihlZGl0b3IsIG5hbWUpIHtcbiAgICAgICAgaWYgKC9eW0EtWl1cXGQrJC8udGVzdChuYW1lKSkge1xuICAgICAgICAgICAgdmFyIGkgPSBuYW1lLnN1YnN0cigxKTtcbiAgICAgICAgICAgIHJldHVybiAodGhpcy52YXJpYWJsZXNbbmFtZVswXSArIFwiX19cIl0gfHwge30pW2ldO1xuICAgICAgICB9XG4gICAgICAgIGlmICgvXlxcZCskLy50ZXN0KG5hbWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gKHRoaXMudmFyaWFibGVzLl9fIHx8IHt9KVtuYW1lXTtcbiAgICAgICAgfVxuICAgICAgICBuYW1lID0gbmFtZS5yZXBsYWNlKC9eVE1fLywgXCJcIik7XG5cbiAgICAgICAgaWYgKCFlZGl0b3IpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIHZhciBzID0gZWRpdG9yLnNlc3Npb247XG4gICAgICAgIHN3aXRjaChuYW1lKSB7XG4gICAgICAgICAgICBjYXNlIFwiQ1VSUkVOVF9XT1JEXCI6XG4gICAgICAgICAgICAgICAgdmFyIHIgPSBzLmdldFdvcmRSYW5nZSgpO1xuICAgICAgICAgICAgY2FzZSBcIlNFTEVDVElPTlwiOlxuICAgICAgICAgICAgY2FzZSBcIlNFTEVDVEVEX1RFWFRcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gcy5nZXRUZXh0UmFuZ2Uocik7XG4gICAgICAgICAgICBjYXNlIFwiQ1VSUkVOVF9MSU5FXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHMuZ2V0TGluZShlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKS5yb3cpO1xuICAgICAgICAgICAgY2FzZSBcIlBSRVZfTElORVwiOiAvLyBub3QgcG9zc2libGUgaW4gdGV4dG1hdGVcbiAgICAgICAgICAgICAgICByZXR1cm4gcy5nZXRMaW5lKGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpLnJvdyAtIDEpO1xuICAgICAgICAgICAgY2FzZSBcIkxJTkVfSU5ERVhcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCkuY29sdW1uO1xuICAgICAgICAgICAgY2FzZSBcIkxJTkVfTlVNQkVSXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpLnJvdyArIDE7XG4gICAgICAgICAgICBjYXNlIFwiU09GVF9UQUJTXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHMuZ2V0VXNlU29mdFRhYnMoKSA/IFwiWUVTXCIgOiBcIk5PXCI7XG4gICAgICAgICAgICBjYXNlIFwiVEFCX1NJWkVcIjpcbiAgICAgICAgICAgICAgICByZXR1cm4gcy5nZXRUYWJTaXplKCk7XG4gICAgICAgICAgICBjYXNlIFwiRklMRU5BTUVcIjpcbiAgICAgICAgICAgIGNhc2UgXCJGSUxFUEFUSFwiOlxuICAgICAgICAgICAgICAgIHJldHVybiBcIlwiO1xuICAgICAgICAgICAgY2FzZSBcIkZVTExOQU1FXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiQWNlXCI7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMudmFyaWFibGVzID0ge307XG4gICAgdGhpcy5nZXRWYXJpYWJsZVZhbHVlID0gZnVuY3Rpb24oZWRpdG9yLCB2YXJOYW1lKSB7XG4gICAgICAgIGlmICh0aGlzLnZhcmlhYmxlcy5oYXNPd25Qcm9wZXJ0eSh2YXJOYW1lKSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnZhcmlhYmxlc1t2YXJOYW1lXShlZGl0b3IsIHZhck5hbWUpIHx8IFwiXCI7XG4gICAgICAgIHJldHVybiB0aGlzLiRnZXREZWZhdWx0VmFsdWUoZWRpdG9yLCB2YXJOYW1lKSB8fCBcIlwiO1xuICAgIH07XG4gICAgdGhpcy50bVN0ckZvcm1hdCA9IGZ1bmN0aW9uKHN0ciwgY2gsIGVkaXRvcikge1xuICAgICAgICB2YXIgZmxhZyA9IGNoLmZsYWcgfHwgXCJcIjtcbiAgICAgICAgdmFyIHJlID0gY2guZ3VhcmQ7XG4gICAgICAgIHJlID0gbmV3IFJlZ0V4cChyZSwgZmxhZy5yZXBsYWNlKC9bXmdpXS8sIFwiXCIpKTtcbiAgICAgICAgdmFyIGZtdFRva2VucyA9IHRoaXMudG9rZW5pemVUbVNuaXBwZXQoY2guZm10LCBcImZvcm1hdFN0cmluZ1wiKTtcbiAgICAgICAgdmFyIF9zZWxmID0gdGhpcztcbiAgICAgICAgdmFyIGZvcm1hdHRlZCA9IHN0ci5yZXBsYWNlKHJlLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIF9zZWxmLnZhcmlhYmxlcy5fXyA9IGFyZ3VtZW50cztcbiAgICAgICAgICAgIHZhciBmbXRQYXJ0cyA9IF9zZWxmLnJlc29sdmVWYXJpYWJsZXMoZm10VG9rZW5zLCBlZGl0b3IpO1xuICAgICAgICAgICAgdmFyIGdDaGFuZ2VDYXNlID0gXCJFXCI7XG4gICAgICAgICAgICBmb3IgKHZhciBpICA9IDA7IGkgPCBmbXRQYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBjaCA9IGZtdFBhcnRzW2ldO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2ggPT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgICAgICBmbXRQYXJ0c1tpXSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjaC5jaGFuZ2VDYXNlICYmIGNoLmxvY2FsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGZtdFBhcnRzW2kgKyAxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0ICYmIHR5cGVvZiBuZXh0ID09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2guY2hhbmdlQ2FzZSA9PSBcInVcIilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm10UGFydHNbaV0gPSBuZXh0WzBdLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbXRQYXJ0c1tpXSA9IG5leHRbMF0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbXRQYXJ0c1tpICsgMV0gPSBuZXh0LnN1YnN0cigxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaC5jaGFuZ2VDYXNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBnQ2hhbmdlQ2FzZSA9IGNoLmNoYW5nZUNhc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGdDaGFuZ2VDYXNlID09IFwiVVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGZtdFBhcnRzW2ldID0gY2gudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGdDaGFuZ2VDYXNlID09IFwiTFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIGZtdFBhcnRzW2ldID0gY2gudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZm10UGFydHMuam9pbihcIlwiKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudmFyaWFibGVzLl9fID0gbnVsbDtcbiAgICAgICAgcmV0dXJuIGZvcm1hdHRlZDtcbiAgICB9O1xuXG4gICAgdGhpcy5yZXNvbHZlVmFyaWFibGVzID0gZnVuY3Rpb24oc25pcHBldCwgZWRpdG9yKSB7XG4gICAgICAgIHZhciByZXN1bHQgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbmlwcGV0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgY2ggPSBzbmlwcGV0W2ldO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBjaCA9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY2gpO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY2ggIT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjaC5za2lwKSB7XG4gICAgICAgICAgICAgICAgZ290b05leHQoY2gpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjaC5wcm9jZXNzZWQgPCBpKSB7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNoLnRleHQpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmdldFZhcmlhYmxlVmFsdWUoZWRpdG9yLCBjaC50ZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgY2guZm10U3RyaW5nKVxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHRoaXMudG1TdHJGb3JtYXQodmFsdWUsIGNoKTtcbiAgICAgICAgICAgICAgICBjaC5wcm9jZXNzZWQgPSBpO1xuICAgICAgICAgICAgICAgIGlmIChjaC5leHBlY3RJZiA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ290b05leHQoY2gpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjaC5za2lwID0gY2guZWxzZUJyYW5jaDtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICBnb3RvTmV4dChjaCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChjaC50YWJzdG9wSWQgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNoKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoY2guY2hhbmdlQ2FzZSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY2gpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIGdvdG9OZXh0KGNoKSB7XG4gICAgICAgICAgICB2YXIgaTEgPSBzbmlwcGV0LmluZGV4T2YoY2gsIGkgKyAxKTtcbiAgICAgICAgICAgIGlmIChpMSAhPSAtMSlcbiAgICAgICAgICAgICAgICBpID0gaTE7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9O1xuXG4gICAgdGhpcy5pbnNlcnRTbmlwcGV0Rm9yU2VsZWN0aW9uID0gZnVuY3Rpb24oZWRpdG9yLCBzbmlwcGV0VGV4dCkge1xuICAgICAgICB2YXIgY3Vyc29yID0gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgIHZhciBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShjdXJzb3Iucm93KTtcbiAgICAgICAgdmFyIHRhYlN0cmluZyA9IGVkaXRvci5zZXNzaW9uLmdldFRhYlN0cmluZygpO1xuICAgICAgICB2YXIgaW5kZW50U3RyaW5nID0gbGluZS5tYXRjaCgvXlxccyovKVswXTtcbiAgICAgICAgXG4gICAgICAgIGlmIChjdXJzb3IuY29sdW1uIDwgaW5kZW50U3RyaW5nLmxlbmd0aClcbiAgICAgICAgICAgIGluZGVudFN0cmluZyA9IGluZGVudFN0cmluZy5zbGljZSgwLCBjdXJzb3IuY29sdW1uKTtcblxuICAgICAgICBzbmlwcGV0VGV4dCA9IHNuaXBwZXRUZXh0LnJlcGxhY2UoL1xcci9nLCBcIlwiKTtcbiAgICAgICAgdmFyIHRva2VucyA9IHRoaXMudG9rZW5pemVUbVNuaXBwZXQoc25pcHBldFRleHQpO1xuICAgICAgICB0b2tlbnMgPSB0aGlzLnJlc29sdmVWYXJpYWJsZXModG9rZW5zLCBlZGl0b3IpO1xuICAgICAgICB0b2tlbnMgPSB0b2tlbnMubWFwKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIGlmICh4ID09IFwiXFxuXCIpXG4gICAgICAgICAgICAgICAgcmV0dXJuIHggKyBpbmRlbnRTdHJpbmc7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHggPT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICByZXR1cm4geC5yZXBsYWNlKC9cXHQvZywgdGFiU3RyaW5nKTtcbiAgICAgICAgICAgIHJldHVybiB4O1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIHRhYnN0b3BzID0gW107XG4gICAgICAgIHRva2Vucy5mb3JFYWNoKGZ1bmN0aW9uKHAsIGkpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcCAhPSBcIm9iamVjdFwiKVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHZhciBpZCA9IHAudGFic3RvcElkO1xuICAgICAgICAgICAgdmFyIHRzID0gdGFic3RvcHNbaWRdO1xuICAgICAgICAgICAgaWYgKCF0cykge1xuICAgICAgICAgICAgICAgIHRzID0gdGFic3RvcHNbaWRdID0gW107XG4gICAgICAgICAgICAgICAgdHMuaW5kZXggPSBpZDtcbiAgICAgICAgICAgICAgICB0cy52YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHMuaW5kZXhPZihwKSAhPT0gLTEpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgdHMucHVzaChwKTtcbiAgICAgICAgICAgIHZhciBpMSA9IHRva2Vucy5pbmRleE9mKHAsIGkgKyAxKTtcbiAgICAgICAgICAgIGlmIChpMSA9PT0gLTEpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSB0b2tlbnMuc2xpY2UoaSArIDEsIGkxKTtcbiAgICAgICAgICAgIHZhciBpc05lc3RlZCA9IHZhbHVlLnNvbWUoZnVuY3Rpb24odCkge3JldHVybiB0eXBlb2YgdCA9PT0gXCJvYmplY3RcIjt9KTtcbiAgICAgICAgICAgIGlmIChpc05lc3RlZCAmJiAhdHMudmFsdWUpIHtcbiAgICAgICAgICAgICAgICB0cy52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZS5sZW5ndGggJiYgKCF0cy52YWx1ZSB8fCB0eXBlb2YgdHMudmFsdWUgIT09IFwic3RyaW5nXCIpKSB7XG4gICAgICAgICAgICAgICAgdHMudmFsdWUgPSB2YWx1ZS5qb2luKFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGFic3RvcHMuZm9yRWFjaChmdW5jdGlvbih0cykge3RzLmxlbmd0aCA9IDA7fSk7XG4gICAgICAgIHZhciBleHBhbmRpbmcgPSB7fTtcbiAgICAgICAgZnVuY3Rpb24gY29weVZhbHVlKHZhbCkge1xuICAgICAgICAgICAgdmFyIGNvcHkgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHAgPSB2YWxbaV07XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwID09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4cGFuZGluZ1twLnRhYnN0b3BJZF0pXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGogPSB2YWwubGFzdEluZGV4T2YocCwgaSAtIDEpO1xuICAgICAgICAgICAgICAgICAgICBwID0gY29weVtqXSB8fCB7dGFic3RvcElkOiBwLnRhYnN0b3BJZH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvcHlbaV0gPSBwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGNvcHk7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBwID0gdG9rZW5zW2ldO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBwICE9IFwib2JqZWN0XCIpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB2YXIgaWQgPSBwLnRhYnN0b3BJZDtcbiAgICAgICAgICAgIHZhciBpMSA9IHRva2Vucy5pbmRleE9mKHAsIGkgKyAxKTtcbiAgICAgICAgICAgIGlmIChleHBhbmRpbmdbaWRdKSB7XG4gICAgICAgICAgICAgICAgaWYgKGV4cGFuZGluZ1tpZF0gPT09IHApXG4gICAgICAgICAgICAgICAgICAgIGV4cGFuZGluZ1tpZF0gPSBudWxsO1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgdHMgPSB0YWJzdG9wc1tpZF07XG4gICAgICAgICAgICB2YXIgYXJnID0gdHlwZW9mIHRzLnZhbHVlID09IFwic3RyaW5nXCIgPyBbdHMudmFsdWVdIDogY29weVZhbHVlKHRzLnZhbHVlKTtcbiAgICAgICAgICAgIGFyZy51bnNoaWZ0KGkgKyAxLCBNYXRoLm1heCgwLCBpMSAtIGkpKTtcbiAgICAgICAgICAgIGFyZy5wdXNoKHApO1xuICAgICAgICAgICAgZXhwYW5kaW5nW2lkXSA9IHA7XG4gICAgICAgICAgICB0b2tlbnMuc3BsaWNlLmFwcGx5KHRva2VucywgYXJnKTtcblxuICAgICAgICAgICAgaWYgKHRzLmluZGV4T2YocCkgPT09IC0xKVxuICAgICAgICAgICAgICAgIHRzLnB1c2gocCk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHJvdyA9IDAsIGNvbHVtbiA9IDA7XG4gICAgICAgIHZhciB0ZXh0ID0gXCJcIjtcbiAgICAgICAgdG9rZW5zLmZvckVhY2goZnVuY3Rpb24odCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0ID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxpbmVzID0gdC5zcGxpdChcIlxcblwiKTtcbiAgICAgICAgICAgICAgICBpZiAobGluZXMubGVuZ3RoID4gMSl7XG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbiA9IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgcm93ICs9IGxpbmVzLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgfSBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbiArPSB0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICB0ZXh0ICs9IHQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghdC5zdGFydClcbiAgICAgICAgICAgICAgICAgICAgdC5zdGFydCA9IHtyb3c6IHJvdywgY29sdW1uOiBjb2x1bW59O1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgdC5lbmQgPSB7cm93OiByb3csIGNvbHVtbjogY29sdW1ufTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHZhciByYW5nZSA9IGVkaXRvci5nZXRTZWxlY3Rpb25SYW5nZSgpO1xuICAgICAgICB2YXIgZW5kID0gZWRpdG9yLnNlc3Npb24ucmVwbGFjZShyYW5nZSwgdGV4dCk7XG5cbiAgICAgICAgdmFyIHRhYnN0b3BNYW5hZ2VyID0gbmV3IFRhYnN0b3BNYW5hZ2VyKGVkaXRvcik7XG4gICAgICAgIHZhciBzZWxlY3Rpb25JZCA9IGVkaXRvci5pblZpcnR1YWxTZWxlY3Rpb25Nb2RlICYmIGVkaXRvci5zZWxlY3Rpb24uaW5kZXg7XG4gICAgICAgIHRhYnN0b3BNYW5hZ2VyLmFkZFRhYnN0b3BzKHRhYnN0b3BzLCByYW5nZS5zdGFydCwgZW5kLCBzZWxlY3Rpb25JZCk7XG4gICAgfTtcbiAgICBcbiAgICB0aGlzLmluc2VydFNuaXBwZXQgPSBmdW5jdGlvbihlZGl0b3IsIHNuaXBwZXRUZXh0KSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgaWYgKGVkaXRvci5pblZpcnR1YWxTZWxlY3Rpb25Nb2RlKVxuICAgICAgICAgICAgcmV0dXJuIHNlbGYuaW5zZXJ0U25pcHBldEZvclNlbGVjdGlvbihlZGl0b3IsIHNuaXBwZXRUZXh0KTtcbiAgICAgICAgXG4gICAgICAgIGVkaXRvci5mb3JFYWNoU2VsZWN0aW9uKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgc2VsZi5pbnNlcnRTbmlwcGV0Rm9yU2VsZWN0aW9uKGVkaXRvciwgc25pcHBldFRleHQpO1xuICAgICAgICB9LCBudWxsLCB7a2VlcE9yZGVyOiB0cnVlfSk7XG4gICAgICAgIFxuICAgICAgICBpZiAoZWRpdG9yLnRhYnN0b3BNYW5hZ2VyKVxuICAgICAgICAgICAgZWRpdG9yLnRhYnN0b3BNYW5hZ2VyLnRhYk5leHQoKTtcbiAgICB9O1xuXG4gICAgdGhpcy4kZ2V0U2NvcGUgPSBmdW5jdGlvbihlZGl0b3IpIHtcbiAgICAgICAgdmFyIHNjb3BlID0gZWRpdG9yLnNlc3Npb24uJG1vZGUuJGlkIHx8IFwiXCI7XG4gICAgICAgIHNjb3BlID0gc2NvcGUuc3BsaXQoXCIvXCIpLnBvcCgpO1xuICAgICAgICBpZiAoc2NvcGUgPT09IFwiaHRtbFwiIHx8IHNjb3BlID09PSBcInBocFwiKSB7XG4gICAgICAgICAgICBpZiAoc2NvcGUgPT09IFwicGhwXCIgJiYgIWVkaXRvci5zZXNzaW9uLiRtb2RlLmlubGluZVBocCkgXG4gICAgICAgICAgICAgICAgc2NvcGUgPSBcImh0bWxcIjtcbiAgICAgICAgICAgIHZhciBjID0gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgICAgICB2YXIgc3RhdGUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRTdGF0ZShjLnJvdyk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHN0YXRlID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUgPSBzdGF0ZVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzdGF0ZS5zdWJzdHJpbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAoc3RhdGUuc3Vic3RyaW5nKDAsIDMpID09IFwianMtXCIpXG4gICAgICAgICAgICAgICAgICAgIHNjb3BlID0gXCJqYXZhc2NyaXB0XCI7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGUuc3Vic3RyaW5nKDAsIDQpID09IFwiY3NzLVwiKVxuICAgICAgICAgICAgICAgICAgICBzY29wZSA9IFwiY3NzXCI7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGUuc3Vic3RyaW5nKDAsIDQpID09IFwicGhwLVwiKVxuICAgICAgICAgICAgICAgICAgICBzY29wZSA9IFwicGhwXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBzY29wZTtcbiAgICB9O1xuXG4gICAgdGhpcy5nZXRBY3RpdmVTY29wZXMgPSBmdW5jdGlvbihlZGl0b3IpIHtcbiAgICAgICAgdmFyIHNjb3BlID0gdGhpcy4kZ2V0U2NvcGUoZWRpdG9yKTtcbiAgICAgICAgdmFyIHNjb3BlcyA9IFtzY29wZV07XG4gICAgICAgIHZhciBzbmlwcGV0TWFwID0gdGhpcy5zbmlwcGV0TWFwO1xuICAgICAgICBpZiAoc25pcHBldE1hcFtzY29wZV0gJiYgc25pcHBldE1hcFtzY29wZV0uaW5jbHVkZVNjb3Blcykge1xuICAgICAgICAgICAgc2NvcGVzLnB1c2guYXBwbHkoc2NvcGVzLCBzbmlwcGV0TWFwW3Njb3BlXS5pbmNsdWRlU2NvcGVzKTtcbiAgICAgICAgfVxuICAgICAgICBzY29wZXMucHVzaChcIl9cIik7XG4gICAgICAgIHJldHVybiBzY29wZXM7XG4gICAgfTtcblxuICAgIHRoaXMuZXhwYW5kV2l0aFRhYiA9IGZ1bmN0aW9uKGVkaXRvciwgb3B0aW9ucykge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHZhciByZXN1bHQgPSBlZGl0b3IuZm9yRWFjaFNlbGVjdGlvbihmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBzZWxmLmV4cGFuZFNuaXBwZXRGb3JTZWxlY3Rpb24oZWRpdG9yLCBvcHRpb25zKTtcbiAgICAgICAgfSwgbnVsbCwge2tlZXBPcmRlcjogdHJ1ZX0pO1xuICAgICAgICBpZiAocmVzdWx0ICYmIGVkaXRvci50YWJzdG9wTWFuYWdlcilcbiAgICAgICAgICAgIGVkaXRvci50YWJzdG9wTWFuYWdlci50YWJOZXh0KCk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfTtcbiAgICBcbiAgICB0aGlzLmV4cGFuZFNuaXBwZXRGb3JTZWxlY3Rpb24gPSBmdW5jdGlvbihlZGl0b3IsIG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIGN1cnNvciA9IGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgICAgICB2YXIgbGluZSA9IGVkaXRvci5zZXNzaW9uLmdldExpbmUoY3Vyc29yLnJvdyk7XG4gICAgICAgIHZhciBiZWZvcmUgPSBsaW5lLnN1YnN0cmluZygwLCBjdXJzb3IuY29sdW1uKTtcbiAgICAgICAgdmFyIGFmdGVyID0gbGluZS5zdWJzdHIoY3Vyc29yLmNvbHVtbik7XG5cbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSB0aGlzLnNuaXBwZXRNYXA7XG4gICAgICAgIHZhciBzbmlwcGV0O1xuICAgICAgICB0aGlzLmdldEFjdGl2ZVNjb3BlcyhlZGl0b3IpLnNvbWUoZnVuY3Rpb24oc2NvcGUpIHtcbiAgICAgICAgICAgIHZhciBzbmlwcGV0cyA9IHNuaXBwZXRNYXBbc2NvcGVdO1xuICAgICAgICAgICAgaWYgKHNuaXBwZXRzKVxuICAgICAgICAgICAgICAgIHNuaXBwZXQgPSB0aGlzLmZpbmRNYXRjaGluZ1NuaXBwZXQoc25pcHBldHMsIGJlZm9yZSwgYWZ0ZXIpO1xuICAgICAgICAgICAgcmV0dXJuICEhc25pcHBldDtcbiAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIGlmICghc25pcHBldClcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5kcnlSdW4pXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgZWRpdG9yLnNlc3Npb24uZG9jLnJlbW92ZUluTGluZShjdXJzb3Iucm93LFxuICAgICAgICAgICAgY3Vyc29yLmNvbHVtbiAtIHNuaXBwZXQucmVwbGFjZUJlZm9yZS5sZW5ndGgsXG4gICAgICAgICAgICBjdXJzb3IuY29sdW1uICsgc25pcHBldC5yZXBsYWNlQWZ0ZXIubGVuZ3RoXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy52YXJpYWJsZXMuTV9fID0gc25pcHBldC5tYXRjaEJlZm9yZTtcbiAgICAgICAgdGhpcy52YXJpYWJsZXMuVF9fID0gc25pcHBldC5tYXRjaEFmdGVyO1xuICAgICAgICB0aGlzLmluc2VydFNuaXBwZXRGb3JTZWxlY3Rpb24oZWRpdG9yLCBzbmlwcGV0LmNvbnRlbnQpO1xuXG4gICAgICAgIHRoaXMudmFyaWFibGVzLk1fXyA9IHRoaXMudmFyaWFibGVzLlRfXyA9IG51bGw7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH07XG5cbiAgICB0aGlzLmZpbmRNYXRjaGluZ1NuaXBwZXQgPSBmdW5jdGlvbihzbmlwcGV0TGlzdCwgYmVmb3JlLCBhZnRlcikge1xuICAgICAgICBmb3IgKHZhciBpID0gc25pcHBldExpc3QubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICB2YXIgcyA9IHNuaXBwZXRMaXN0W2ldO1xuICAgICAgICAgICAgaWYgKHMuc3RhcnRSZSAmJiAhcy5zdGFydFJlLnRlc3QoYmVmb3JlKSlcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIGlmIChzLmVuZFJlICYmICFzLmVuZFJlLnRlc3QoYWZ0ZXIpKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgaWYgKCFzLnN0YXJ0UmUgJiYgIXMuZW5kUmUpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIHMubWF0Y2hCZWZvcmUgPSBzLnN0YXJ0UmUgPyBzLnN0YXJ0UmUuZXhlYyhiZWZvcmUpIDogW1wiXCJdO1xuICAgICAgICAgICAgcy5tYXRjaEFmdGVyID0gcy5lbmRSZSA/IHMuZW5kUmUuZXhlYyhhZnRlcikgOiBbXCJcIl07XG4gICAgICAgICAgICBzLnJlcGxhY2VCZWZvcmUgPSBzLnRyaWdnZXJSZSA/IHMudHJpZ2dlclJlLmV4ZWMoYmVmb3JlKVswXSA6IFwiXCI7XG4gICAgICAgICAgICBzLnJlcGxhY2VBZnRlciA9IHMuZW5kVHJpZ2dlclJlID8gcy5lbmRUcmlnZ2VyUmUuZXhlYyhhZnRlcilbMF0gOiBcIlwiO1xuICAgICAgICAgICAgcmV0dXJuIHM7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5zbmlwcGV0TWFwID0ge307XG4gICAgdGhpcy5zbmlwcGV0TmFtZU1hcCA9IHt9O1xuICAgIHRoaXMucmVnaXN0ZXIgPSBmdW5jdGlvbihzbmlwcGV0cywgc2NvcGUpIHtcbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSB0aGlzLnNuaXBwZXRNYXA7XG4gICAgICAgIHZhciBzbmlwcGV0TmFtZU1hcCA9IHRoaXMuc25pcHBldE5hbWVNYXA7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgIGlmICghc25pcHBldHMpIFxuICAgICAgICAgICAgc25pcHBldHMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGZ1bmN0aW9uIHdyYXBSZWdleHAoc3JjKSB7XG4gICAgICAgICAgICBpZiAoc3JjICYmICEvXlxcXj9cXCguKlxcKVxcJD8kfF5cXFxcYiQvLnRlc3Qoc3JjKSlcbiAgICAgICAgICAgICAgICBzcmMgPSBcIig/OlwiICsgc3JjICsgXCIpXCI7XG5cbiAgICAgICAgICAgIHJldHVybiBzcmMgfHwgXCJcIjtcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBndWFyZGVkUmVnZXhwKHJlLCBndWFyZCwgb3BlbmluZykge1xuICAgICAgICAgICAgcmUgPSB3cmFwUmVnZXhwKHJlKTtcbiAgICAgICAgICAgIGd1YXJkID0gd3JhcFJlZ2V4cChndWFyZCk7XG4gICAgICAgICAgICBpZiAob3BlbmluZykge1xuICAgICAgICAgICAgICAgIHJlID0gZ3VhcmQgKyByZTtcbiAgICAgICAgICAgICAgICBpZiAocmUgJiYgcmVbcmUubGVuZ3RoIC0gMV0gIT0gXCIkXCIpXG4gICAgICAgICAgICAgICAgICAgIHJlID0gcmUgKyBcIiRcIjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmUgPSByZSArIGd1YXJkO1xuICAgICAgICAgICAgICAgIGlmIChyZSAmJiByZVswXSAhPSBcIl5cIilcbiAgICAgICAgICAgICAgICAgICAgcmUgPSBcIl5cIiArIHJlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBSZWdFeHAocmUpO1xuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gYWRkU25pcHBldChzKSB7XG4gICAgICAgICAgICBpZiAoIXMuc2NvcGUpXG4gICAgICAgICAgICAgICAgcy5zY29wZSA9IHNjb3BlIHx8IFwiX1wiO1xuICAgICAgICAgICAgc2NvcGUgPSBzLnNjb3BlO1xuICAgICAgICAgICAgaWYgKCFzbmlwcGV0TWFwW3Njb3BlXSkge1xuICAgICAgICAgICAgICAgIHNuaXBwZXRNYXBbc2NvcGVdID0gW107XG4gICAgICAgICAgICAgICAgc25pcHBldE5hbWVNYXBbc2NvcGVdID0ge307XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBtYXAgPSBzbmlwcGV0TmFtZU1hcFtzY29wZV07XG4gICAgICAgICAgICBpZiAocy5uYW1lKSB7XG4gICAgICAgICAgICAgICAgdmFyIG9sZCA9IG1hcFtzLm5hbWVdO1xuICAgICAgICAgICAgICAgIGlmIChvbGQpXG4gICAgICAgICAgICAgICAgICAgIHNlbGYudW5yZWdpc3RlcihvbGQpO1xuICAgICAgICAgICAgICAgIG1hcFtzLm5hbWVdID0gcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNuaXBwZXRNYXBbc2NvcGVdLnB1c2gocyk7XG5cbiAgICAgICAgICAgIGlmIChzLnRhYlRyaWdnZXIgJiYgIXMudHJpZ2dlcikge1xuICAgICAgICAgICAgICAgIGlmICghcy5ndWFyZCAmJiAvXlxcdy8udGVzdChzLnRhYlRyaWdnZXIpKVxuICAgICAgICAgICAgICAgICAgICBzLmd1YXJkID0gXCJcXFxcYlwiO1xuICAgICAgICAgICAgICAgIHMudHJpZ2dlciA9IGxhbmcuZXNjYXBlUmVnRXhwKHMudGFiVHJpZ2dlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghcy50cmlnZ2VyICYmICFzLmd1YXJkICYmICFzLmVuZFRyaWdnZXIgJiYgIXMuZW5kR3VhcmQpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBzLnN0YXJ0UmUgPSBndWFyZGVkUmVnZXhwKHMudHJpZ2dlciwgcy5ndWFyZCwgdHJ1ZSk7XG4gICAgICAgICAgICBzLnRyaWdnZXJSZSA9IG5ldyBSZWdFeHAocy50cmlnZ2VyLCBcIlwiLCB0cnVlKTtcblxuICAgICAgICAgICAgcy5lbmRSZSA9IGd1YXJkZWRSZWdleHAocy5lbmRUcmlnZ2VyLCBzLmVuZEd1YXJkLCB0cnVlKTtcbiAgICAgICAgICAgIHMuZW5kVHJpZ2dlclJlID0gbmV3IFJlZ0V4cChzLmVuZFRyaWdnZXIsIFwiXCIsIHRydWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNuaXBwZXRzICYmIHNuaXBwZXRzLmNvbnRlbnQpXG4gICAgICAgICAgICBhZGRTbmlwcGV0KHNuaXBwZXRzKTtcbiAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzbmlwcGV0cykpXG4gICAgICAgICAgICBzbmlwcGV0cy5mb3JFYWNoKGFkZFNuaXBwZXQpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5fc2lnbmFsKFwicmVnaXN0ZXJTbmlwcGV0c1wiLCB7c2NvcGU6IHNjb3BlfSk7XG4gICAgfTtcbiAgICB0aGlzLnVucmVnaXN0ZXIgPSBmdW5jdGlvbihzbmlwcGV0cywgc2NvcGUpIHtcbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSB0aGlzLnNuaXBwZXRNYXA7XG4gICAgICAgIHZhciBzbmlwcGV0TmFtZU1hcCA9IHRoaXMuc25pcHBldE5hbWVNYXA7XG5cbiAgICAgICAgZnVuY3Rpb24gcmVtb3ZlU25pcHBldChzKSB7XG4gICAgICAgICAgICB2YXIgbmFtZU1hcCA9IHNuaXBwZXROYW1lTWFwW3Muc2NvcGV8fHNjb3BlXTtcbiAgICAgICAgICAgIGlmIChuYW1lTWFwICYmIG5hbWVNYXBbcy5uYW1lXSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBuYW1lTWFwW3MubmFtZV07XG4gICAgICAgICAgICAgICAgdmFyIG1hcCA9IHNuaXBwZXRNYXBbcy5zY29wZXx8c2NvcGVdO1xuICAgICAgICAgICAgICAgIHZhciBpID0gbWFwICYmIG1hcC5pbmRleE9mKHMpO1xuICAgICAgICAgICAgICAgIGlmIChpID49IDApXG4gICAgICAgICAgICAgICAgICAgIG1hcC5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNuaXBwZXRzLmNvbnRlbnQpXG4gICAgICAgICAgICByZW1vdmVTbmlwcGV0KHNuaXBwZXRzKTtcbiAgICAgICAgZWxzZSBpZiAoQXJyYXkuaXNBcnJheShzbmlwcGV0cykpXG4gICAgICAgICAgICBzbmlwcGV0cy5mb3JFYWNoKHJlbW92ZVNuaXBwZXQpO1xuICAgIH07XG4gICAgdGhpcy5wYXJzZVNuaXBwZXRGaWxlID0gZnVuY3Rpb24oc3RyKSB7XG4gICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKC9cXHIvZywgXCJcIik7XG4gICAgICAgIHZhciBsaXN0ID0gW10sIHNuaXBwZXQgPSB7fTtcbiAgICAgICAgdmFyIHJlID0gL14jLip8Xih7W1xcc1xcU10qfSlcXHMqJHxeKFxcUyspICguKikkfF4oKD86XFxuKlxcdC4qKSspL2dtO1xuICAgICAgICB2YXIgbTtcbiAgICAgICAgd2hpbGUgKG0gPSByZS5leGVjKHN0cikpIHtcbiAgICAgICAgICAgIGlmIChtWzFdKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldCA9IEpTT04ucGFyc2UobVsxXSk7XG4gICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChzbmlwcGV0KTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgICAgICAgICAgfSBpZiAobVs0XSkge1xuICAgICAgICAgICAgICAgIHNuaXBwZXQuY29udGVudCA9IG1bNF0ucmVwbGFjZSgvXlxcdC9nbSwgXCJcIik7XG4gICAgICAgICAgICAgICAgbGlzdC5wdXNoKHNuaXBwZXQpO1xuICAgICAgICAgICAgICAgIHNuaXBwZXQgPSB7fTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIGtleSA9IG1bMl0sIHZhbCA9IG1bM107XG4gICAgICAgICAgICAgICAgaWYgKGtleSA9PSBcInJlZ2V4XCIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGd1YXJkUmUgPSAvXFwvKCg/OlteXFwvXFxcXF18XFxcXC4pKil8JC9nO1xuICAgICAgICAgICAgICAgICAgICBzbmlwcGV0Lmd1YXJkID0gZ3VhcmRSZS5leGVjKHZhbClbMV07XG4gICAgICAgICAgICAgICAgICAgIHNuaXBwZXQudHJpZ2dlciA9IGd1YXJkUmUuZXhlYyh2YWwpWzFdO1xuICAgICAgICAgICAgICAgICAgICBzbmlwcGV0LmVuZFRyaWdnZXIgPSBndWFyZFJlLmV4ZWModmFsKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldC5lbmRHdWFyZCA9IGd1YXJkUmUuZXhlYyh2YWwpWzFdO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09IFwic25pcHBldFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHNuaXBwZXQudGFiVHJpZ2dlciA9IHZhbC5tYXRjaCgvXlxcUyovKVswXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzbmlwcGV0Lm5hbWUpXG4gICAgICAgICAgICAgICAgICAgICAgICBzbmlwcGV0Lm5hbWUgPSB2YWw7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldFtrZXldID0gdmFsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGlzdDtcbiAgICB9O1xuICAgIHRoaXMuZ2V0U25pcHBldEJ5TmFtZSA9IGZ1bmN0aW9uKG5hbWUsIGVkaXRvcikge1xuICAgICAgICB2YXIgc25pcHBldE1hcCA9IHRoaXMuc25pcHBldE5hbWVNYXA7XG4gICAgICAgIHZhciBzbmlwcGV0O1xuICAgICAgICB0aGlzLmdldEFjdGl2ZVNjb3BlcyhlZGl0b3IpLnNvbWUoZnVuY3Rpb24oc2NvcGUpIHtcbiAgICAgICAgICAgIHZhciBzbmlwcGV0cyA9IHNuaXBwZXRNYXBbc2NvcGVdO1xuICAgICAgICAgICAgaWYgKHNuaXBwZXRzKVxuICAgICAgICAgICAgICAgIHNuaXBwZXQgPSBzbmlwcGV0c1tuYW1lXTtcbiAgICAgICAgICAgIHJldHVybiAhIXNuaXBwZXQ7XG4gICAgICAgIH0sIHRoaXMpO1xuICAgICAgICByZXR1cm4gc25pcHBldDtcbiAgICB9O1xuXG59KS5jYWxsKFNuaXBwZXRNYW5hZ2VyLnByb3RvdHlwZSk7XG5cblxudmFyIFRhYnN0b3BNYW5hZ2VyID0gZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgaWYgKGVkaXRvci50YWJzdG9wTWFuYWdlcilcbiAgICAgICAgcmV0dXJuIGVkaXRvci50YWJzdG9wTWFuYWdlcjtcbiAgICBlZGl0b3IudGFic3RvcE1hbmFnZXIgPSB0aGlzO1xuICAgIHRoaXMuJG9uQ2hhbmdlID0gdGhpcy5vbkNoYW5nZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuJG9uQ2hhbmdlU2VsZWN0aW9uID0gbGFuZy5kZWxheWVkQ2FsbCh0aGlzLm9uQ2hhbmdlU2VsZWN0aW9uLmJpbmQodGhpcykpLnNjaGVkdWxlO1xuICAgIHRoaXMuJG9uQ2hhbmdlU2Vzc2lvbiA9IHRoaXMub25DaGFuZ2VTZXNzaW9uLmJpbmQodGhpcyk7XG4gICAgdGhpcy4kb25BZnRlckV4ZWMgPSB0aGlzLm9uQWZ0ZXJFeGVjLmJpbmQodGhpcyk7XG4gICAgdGhpcy5hdHRhY2goZWRpdG9yKTtcbn07XG4oZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5hdHRhY2ggPSBmdW5jdGlvbihlZGl0b3IpIHtcbiAgICAgICAgdGhpcy5pbmRleCA9IDA7XG4gICAgICAgIHRoaXMucmFuZ2VzID0gW107XG4gICAgICAgIHRoaXMudGFic3RvcHMgPSBbXTtcbiAgICAgICAgdGhpcy4kb3BlblRhYnN0b3BzID0gbnVsbDtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFRhYnN0b3AgPSBudWxsO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yO1xuICAgICAgICB0aGlzLmVkaXRvci5vbihcImNoYW5nZVwiLCB0aGlzLiRvbkNoYW5nZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9uKFwiY2hhbmdlU2VsZWN0aW9uXCIsIHRoaXMuJG9uQ2hhbmdlU2VsZWN0aW9uKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub24oXCJjaGFuZ2VTZXNzaW9uXCIsIHRoaXMuJG9uQ2hhbmdlU2Vzc2lvbik7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbW1hbmRzLm9uKFwiYWZ0ZXJFeGVjXCIsIHRoaXMuJG9uQWZ0ZXJFeGVjKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iua2V5QmluZGluZy5hZGRLZXlib2FyZEhhbmRsZXIodGhpcy5rZXlib2FyZEhhbmRsZXIpO1xuICAgIH07XG4gICAgdGhpcy5kZXRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy50YWJzdG9wcy5mb3JFYWNoKHRoaXMucmVtb3ZlVGFic3RvcE1hcmtlcnMsIHRoaXMpO1xuICAgICAgICB0aGlzLnJhbmdlcyA9IG51bGw7XG4gICAgICAgIHRoaXMudGFic3RvcHMgPSBudWxsO1xuICAgICAgICB0aGlzLnNlbGVjdGVkVGFic3RvcCA9IG51bGw7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbW92ZUxpc3RlbmVyKFwiY2hhbmdlXCIsIHRoaXMuJG9uQ2hhbmdlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IucmVtb3ZlTGlzdGVuZXIoXCJjaGFuZ2VTZWxlY3Rpb25cIiwgdGhpcy4kb25DaGFuZ2VTZWxlY3Rpb24pO1xuICAgICAgICB0aGlzLmVkaXRvci5yZW1vdmVMaXN0ZW5lcihcImNoYW5nZVNlc3Npb25cIiwgdGhpcy4kb25DaGFuZ2VTZXNzaW9uKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29tbWFuZHMucmVtb3ZlTGlzdGVuZXIoXCJhZnRlckV4ZWNcIiwgdGhpcy4kb25BZnRlckV4ZWMpO1xuICAgICAgICB0aGlzLmVkaXRvci5rZXlCaW5kaW5nLnJlbW92ZUtleWJvYXJkSGFuZGxlcih0aGlzLmtleWJvYXJkSGFuZGxlcik7XG4gICAgICAgIHRoaXMuZWRpdG9yLnRhYnN0b3BNYW5hZ2VyID0gbnVsbDtcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBudWxsO1xuICAgIH07XG5cbiAgICB0aGlzLm9uQ2hhbmdlID0gZnVuY3Rpb24oZGVsdGEpIHtcbiAgICAgICAgdmFyIGNoYW5nZVJhbmdlID0gZGVsdGE7XG4gICAgICAgIHZhciBpc1JlbW92ZSA9IGRlbHRhLmFjdGlvblswXSA9PSBcInJcIjtcbiAgICAgICAgdmFyIHN0YXJ0ID0gZGVsdGEuc3RhcnQ7XG4gICAgICAgIHZhciBlbmQgPSBkZWx0YS5lbmQ7XG4gICAgICAgIHZhciBzdGFydFJvdyA9IHN0YXJ0LnJvdztcbiAgICAgICAgdmFyIGVuZFJvdyA9IGVuZC5yb3c7XG4gICAgICAgIHZhciBsaW5lRGlmID0gZW5kUm93IC0gc3RhcnRSb3c7XG4gICAgICAgIHZhciBjb2xEaWZmID0gZW5kLmNvbHVtbiAtIHN0YXJ0LmNvbHVtbjtcblxuICAgICAgICBpZiAoaXNSZW1vdmUpIHtcbiAgICAgICAgICAgIGxpbmVEaWYgPSAtbGluZURpZjtcbiAgICAgICAgICAgIGNvbERpZmYgPSAtY29sRGlmZjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuJGluQ2hhbmdlICYmIGlzUmVtb3ZlKSB7XG4gICAgICAgICAgICB2YXIgdHMgPSB0aGlzLnNlbGVjdGVkVGFic3RvcDtcbiAgICAgICAgICAgIHZhciBjaGFuZ2VkT3V0c2lkZSA9IHRzICYmICF0cy5zb21lKGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29tcGFyZVBvaW50cyhyLnN0YXJ0LCBzdGFydCkgPD0gMCAmJiBjb21wYXJlUG9pbnRzKHIuZW5kLCBlbmQpID49IDA7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChjaGFuZ2VkT3V0c2lkZSlcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXRhY2goKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcmFuZ2VzID0gdGhpcy5yYW5nZXM7XG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmFuZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICB2YXIgciA9IHJhbmdlc1tpXTtcbiAgICAgICAgICAgIGlmIChyLmVuZC5yb3cgPCBzdGFydC5yb3cpXG4gICAgICAgICAgICAgICAgY29udGludWU7XG5cbiAgICAgICAgICAgIGlmIChpc1JlbW92ZSAmJiBjb21wYXJlUG9pbnRzKHN0YXJ0LCByLnN0YXJ0KSA8IDAgJiYgY29tcGFyZVBvaW50cyhlbmQsIHIuZW5kKSA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVJhbmdlKHIpO1xuICAgICAgICAgICAgICAgIGktLTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHIuc3RhcnQucm93ID09IHN0YXJ0Um93ICYmIHIuc3RhcnQuY29sdW1uID4gc3RhcnQuY29sdW1uKVxuICAgICAgICAgICAgICAgIHIuc3RhcnQuY29sdW1uICs9IGNvbERpZmY7XG4gICAgICAgICAgICBpZiAoci5lbmQucm93ID09IHN0YXJ0Um93ICYmIHIuZW5kLmNvbHVtbiA+PSBzdGFydC5jb2x1bW4pXG4gICAgICAgICAgICAgICAgci5lbmQuY29sdW1uICs9IGNvbERpZmY7XG4gICAgICAgICAgICBpZiAoci5zdGFydC5yb3cgPj0gc3RhcnRSb3cpXG4gICAgICAgICAgICAgICAgci5zdGFydC5yb3cgKz0gbGluZURpZjtcbiAgICAgICAgICAgIGlmIChyLmVuZC5yb3cgPj0gc3RhcnRSb3cpXG4gICAgICAgICAgICAgICAgci5lbmQucm93ICs9IGxpbmVEaWY7XG5cbiAgICAgICAgICAgIGlmIChjb21wYXJlUG9pbnRzKHIuc3RhcnQsIHIuZW5kKSA+IDApXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVSYW5nZShyKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXJhbmdlcy5sZW5ndGgpXG4gICAgICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH07XG4gICAgdGhpcy51cGRhdGVMaW5rZWRGaWVsZHMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHRzID0gdGhpcy5zZWxlY3RlZFRhYnN0b3A7XG4gICAgICAgIGlmICghdHMgfHwgIXRzLmhhc0xpbmtlZFJhbmdlcylcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdGhpcy4kaW5DaGFuZ2UgPSB0cnVlO1xuICAgICAgICB2YXIgc2Vzc2lvbiA9IHRoaXMuZWRpdG9yLnNlc3Npb247XG4gICAgICAgIHZhciB0ZXh0ID0gc2Vzc2lvbi5nZXRUZXh0UmFuZ2UodHMuZmlyc3ROb25MaW5rZWQpO1xuICAgICAgICBmb3IgKHZhciBpID0gdHMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSB0c1tpXTtcbiAgICAgICAgICAgIGlmICghcmFuZ2UubGlua2VkKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIGZtdCA9IGV4cG9ydHMuc25pcHBldE1hbmFnZXIudG1TdHJGb3JtYXQodGV4dCwgcmFuZ2Uub3JpZ2luYWwpO1xuICAgICAgICAgICAgc2Vzc2lvbi5yZXBsYWNlKHJhbmdlLCBmbXQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuJGluQ2hhbmdlID0gZmFsc2U7XG4gICAgfTtcbiAgICB0aGlzLm9uQWZ0ZXJFeGVjID0gZnVuY3Rpb24oZSkge1xuICAgICAgICBpZiAoZS5jb21tYW5kICYmICFlLmNvbW1hbmQucmVhZE9ubHkpXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUxpbmtlZEZpZWxkcygpO1xuICAgIH07XG4gICAgdGhpcy5vbkNoYW5nZVNlbGVjdGlvbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoIXRoaXMuZWRpdG9yKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB2YXIgbGVhZCA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5sZWFkO1xuICAgICAgICB2YXIgYW5jaG9yID0gdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLmFuY2hvcjtcbiAgICAgICAgdmFyIGlzRW1wdHkgPSB0aGlzLmVkaXRvci5zZWxlY3Rpb24uaXNFbXB0eSgpO1xuICAgICAgICBmb3IgKHZhciBpID0gdGhpcy5yYW5nZXMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5yYW5nZXNbaV0ubGlua2VkKVxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIGNvbnRhaW5zTGVhZCA9IHRoaXMucmFuZ2VzW2ldLmNvbnRhaW5zKGxlYWQucm93LCBsZWFkLmNvbHVtbik7XG4gICAgICAgICAgICB2YXIgY29udGFpbnNBbmNob3IgPSBpc0VtcHR5IHx8IHRoaXMucmFuZ2VzW2ldLmNvbnRhaW5zKGFuY2hvci5yb3csIGFuY2hvci5jb2x1bW4pO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5zTGVhZCAmJiBjb250YWluc0FuY2hvcilcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9O1xuICAgIHRoaXMub25DaGFuZ2VTZXNzaW9uID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgfTtcbiAgICB0aGlzLnRhYk5leHQgPSBmdW5jdGlvbihkaXIpIHtcbiAgICAgICAgdmFyIG1heCA9IHRoaXMudGFic3RvcHMubGVuZ3RoO1xuICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmluZGV4ICsgKGRpciB8fCAxKTtcbiAgICAgICAgaW5kZXggPSBNYXRoLm1pbihNYXRoLm1heChpbmRleCwgMSksIG1heCk7XG4gICAgICAgIGlmIChpbmRleCA9PSBtYXgpXG4gICAgICAgICAgICBpbmRleCA9IDA7XG4gICAgICAgIHRoaXMuc2VsZWN0VGFic3RvcChpbmRleCk7XG4gICAgICAgIGlmIChpbmRleCA9PT0gMClcbiAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgfTtcbiAgICB0aGlzLnNlbGVjdFRhYnN0b3AgPSBmdW5jdGlvbihpbmRleCkge1xuICAgICAgICB0aGlzLiRvcGVuVGFic3RvcHMgPSBudWxsO1xuICAgICAgICB2YXIgdHMgPSB0aGlzLnRhYnN0b3BzW3RoaXMuaW5kZXhdO1xuICAgICAgICBpZiAodHMpXG4gICAgICAgICAgICB0aGlzLmFkZFRhYnN0b3BNYXJrZXJzKHRzKTtcbiAgICAgICAgdGhpcy5pbmRleCA9IGluZGV4O1xuICAgICAgICB0cyA9IHRoaXMudGFic3RvcHNbdGhpcy5pbmRleF07XG4gICAgICAgIGlmICghdHMgfHwgIXRzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuc2VsZWN0ZWRUYWJzdG9wID0gdHM7XG4gICAgICAgIGlmICghdGhpcy5lZGl0b3IuaW5WaXJ0dWFsU2VsZWN0aW9uTW9kZSkgeyAgICAgICAgXG4gICAgICAgICAgICB2YXIgc2VsID0gdGhpcy5lZGl0b3IubXVsdGlTZWxlY3Q7XG4gICAgICAgICAgICBzZWwudG9TaW5nbGVSYW5nZSh0cy5maXJzdE5vbkxpbmtlZC5jbG9uZSgpKTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSB0cy5sZW5ndGg7IGktLTspIHtcbiAgICAgICAgICAgICAgICBpZiAodHMuaGFzTGlua2VkUmFuZ2VzICYmIHRzW2ldLmxpbmtlZClcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgc2VsLmFkZFJhbmdlKHRzW2ldLmNsb25lKCksIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHNlbC5yYW5nZXNbMF0pXG4gICAgICAgICAgICAgICAgc2VsLmFkZFJhbmdlKHNlbC5yYW5nZXNbMF0uY2xvbmUoKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zZWxlY3Rpb24uc2V0UmFuZ2UodHMuZmlyc3ROb25MaW5rZWQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLmVkaXRvci5rZXlCaW5kaW5nLmFkZEtleWJvYXJkSGFuZGxlcih0aGlzLmtleWJvYXJkSGFuZGxlcik7XG4gICAgfTtcbiAgICB0aGlzLmFkZFRhYnN0b3BzID0gZnVuY3Rpb24odGFic3RvcHMsIHN0YXJ0LCBlbmQpIHtcbiAgICAgICAgaWYgKCF0aGlzLiRvcGVuVGFic3RvcHMpXG4gICAgICAgICAgICB0aGlzLiRvcGVuVGFic3RvcHMgPSBbXTtcbiAgICAgICAgaWYgKCF0YWJzdG9wc1swXSkge1xuICAgICAgICAgICAgdmFyIHAgPSBSYW5nZS5mcm9tUG9pbnRzKGVuZCwgZW5kKTtcbiAgICAgICAgICAgIG1vdmVSZWxhdGl2ZShwLnN0YXJ0LCBzdGFydCk7XG4gICAgICAgICAgICBtb3ZlUmVsYXRpdmUocC5lbmQsIHN0YXJ0KTtcbiAgICAgICAgICAgIHRhYnN0b3BzWzBdID0gW3BdO1xuICAgICAgICAgICAgdGFic3RvcHNbMF0uaW5kZXggPSAwO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGkgPSB0aGlzLmluZGV4O1xuICAgICAgICB2YXIgYXJnID0gW2kgKyAxLCAwXTtcbiAgICAgICAgdmFyIHJhbmdlcyA9IHRoaXMucmFuZ2VzO1xuICAgICAgICB0YWJzdG9wcy5mb3JFYWNoKGZ1bmN0aW9uKHRzLCBpbmRleCkge1xuICAgICAgICAgICAgdmFyIGRlc3QgPSB0aGlzLiRvcGVuVGFic3RvcHNbaW5kZXhdIHx8IHRzO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IHRzLmxlbmd0aDsgaS0tOykge1xuICAgICAgICAgICAgICAgIHZhciBwID0gdHNbaV07XG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gUmFuZ2UuZnJvbVBvaW50cyhwLnN0YXJ0LCBwLmVuZCB8fCBwLnN0YXJ0KTtcbiAgICAgICAgICAgICAgICBtb3ZlUG9pbnQocmFuZ2Uuc3RhcnQsIHN0YXJ0KTtcbiAgICAgICAgICAgICAgICBtb3ZlUG9pbnQocmFuZ2UuZW5kLCBzdGFydCk7XG4gICAgICAgICAgICAgICAgcmFuZ2Uub3JpZ2luYWwgPSBwO1xuICAgICAgICAgICAgICAgIHJhbmdlLnRhYnN0b3AgPSBkZXN0O1xuICAgICAgICAgICAgICAgIHJhbmdlcy5wdXNoKHJhbmdlKTtcbiAgICAgICAgICAgICAgICBpZiAoZGVzdCAhPSB0cylcbiAgICAgICAgICAgICAgICAgICAgZGVzdC51bnNoaWZ0KHJhbmdlKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGRlc3RbaV0gPSByYW5nZTtcbiAgICAgICAgICAgICAgICBpZiAocC5mbXRTdHJpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2UubGlua2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgZGVzdC5oYXNMaW5rZWRSYW5nZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIWRlc3QuZmlyc3ROb25MaW5rZWQpXG4gICAgICAgICAgICAgICAgICAgIGRlc3QuZmlyc3ROb25MaW5rZWQgPSByYW5nZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZGVzdC5maXJzdE5vbkxpbmtlZClcbiAgICAgICAgICAgICAgICBkZXN0Lmhhc0xpbmtlZFJhbmdlcyA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGRlc3QgPT09IHRzKSB7XG4gICAgICAgICAgICAgICAgYXJnLnB1c2goZGVzdCk7XG4gICAgICAgICAgICAgICAgdGhpcy4kb3BlblRhYnN0b3BzW2luZGV4XSA9IGRlc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLmFkZFRhYnN0b3BNYXJrZXJzKGRlc3QpO1xuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChhcmcubGVuZ3RoID4gMikge1xuICAgICAgICAgICAgaWYgKHRoaXMudGFic3RvcHMubGVuZ3RoKVxuICAgICAgICAgICAgICAgIGFyZy5wdXNoKGFyZy5zcGxpY2UoMiwgMSlbMF0pO1xuICAgICAgICAgICAgdGhpcy50YWJzdG9wcy5zcGxpY2UuYXBwbHkodGhpcy50YWJzdG9wcywgYXJnKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLmFkZFRhYnN0b3BNYXJrZXJzID0gZnVuY3Rpb24odHMpIHtcbiAgICAgICAgdmFyIHNlc3Npb24gPSB0aGlzLmVkaXRvci5zZXNzaW9uO1xuICAgICAgICB0cy5mb3JFYWNoKGZ1bmN0aW9uKHJhbmdlKSB7XG4gICAgICAgICAgICBpZiAgKCFyYW5nZS5tYXJrZXJJZClcbiAgICAgICAgICAgICAgICByYW5nZS5tYXJrZXJJZCA9IHNlc3Npb24uYWRkTWFya2VyKHJhbmdlLCBcImFjZV9zbmlwcGV0LW1hcmtlclwiLCBcInRleHRcIik7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgdGhpcy5yZW1vdmVUYWJzdG9wTWFya2VycyA9IGZ1bmN0aW9uKHRzKSB7XG4gICAgICAgIHZhciBzZXNzaW9uID0gdGhpcy5lZGl0b3Iuc2Vzc2lvbjtcbiAgICAgICAgdHMuZm9yRWFjaChmdW5jdGlvbihyYW5nZSkge1xuICAgICAgICAgICAgc2Vzc2lvbi5yZW1vdmVNYXJrZXIocmFuZ2UubWFya2VySWQpO1xuICAgICAgICAgICAgcmFuZ2UubWFya2VySWQgPSBudWxsO1xuICAgICAgICB9KTtcbiAgICB9O1xuICAgIHRoaXMucmVtb3ZlUmFuZ2UgPSBmdW5jdGlvbihyYW5nZSkge1xuICAgICAgICB2YXIgaSA9IHJhbmdlLnRhYnN0b3AuaW5kZXhPZihyYW5nZSk7XG4gICAgICAgIHJhbmdlLnRhYnN0b3Auc3BsaWNlKGksIDEpO1xuICAgICAgICBpID0gdGhpcy5yYW5nZXMuaW5kZXhPZihyYW5nZSk7XG4gICAgICAgIHRoaXMucmFuZ2VzLnNwbGljZShpLCAxKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Vzc2lvbi5yZW1vdmVNYXJrZXIocmFuZ2UubWFya2VySWQpO1xuICAgICAgICBpZiAoIXJhbmdlLnRhYnN0b3AubGVuZ3RoKSB7XG4gICAgICAgICAgICBpID0gdGhpcy50YWJzdG9wcy5pbmRleE9mKHJhbmdlLnRhYnN0b3ApO1xuICAgICAgICAgICAgaWYgKGkgIT0gLTEpXG4gICAgICAgICAgICAgICAgdGhpcy50YWJzdG9wcy5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICBpZiAoIXRoaXMudGFic3RvcHMubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5rZXlib2FyZEhhbmRsZXIgPSBuZXcgSGFzaEhhbmRsZXIoKTtcbiAgICB0aGlzLmtleWJvYXJkSGFuZGxlci5iaW5kS2V5cyh7XG4gICAgICAgIFwiVGFiXCI6IGZ1bmN0aW9uKGVkKSB7XG4gICAgICAgICAgICBpZiAoZXhwb3J0cy5zbmlwcGV0TWFuYWdlciAmJiBleHBvcnRzLnNuaXBwZXRNYW5hZ2VyLmV4cGFuZFdpdGhUYWIoZWQpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBlZC50YWJzdG9wTWFuYWdlci50YWJOZXh0KDEpO1xuICAgICAgICB9LFxuICAgICAgICBcIlNoaWZ0LVRhYlwiOiBmdW5jdGlvbihlZCkge1xuICAgICAgICAgICAgZWQudGFic3RvcE1hbmFnZXIudGFiTmV4dCgtMSk7XG4gICAgICAgIH0sXG4gICAgICAgIFwiRXNjXCI6IGZ1bmN0aW9uKGVkKSB7XG4gICAgICAgICAgICBlZC50YWJzdG9wTWFuYWdlci5kZXRhY2goKTtcbiAgICAgICAgfSxcbiAgICAgICAgXCJSZXR1cm5cIjogZnVuY3Rpb24oZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH0pO1xufSkuY2FsbChUYWJzdG9wTWFuYWdlci5wcm90b3R5cGUpO1xuXG5cblxudmFyIGNoYW5nZVRyYWNrZXIgPSB7fTtcbmNoYW5nZVRyYWNrZXIub25DaGFuZ2UgPSBBbmNob3IucHJvdG90eXBlLm9uQ2hhbmdlO1xuY2hhbmdlVHJhY2tlci5zZXRQb3NpdGlvbiA9IGZ1bmN0aW9uKHJvdywgY29sdW1uKSB7XG4gICAgdGhpcy5wb3Mucm93ID0gcm93O1xuICAgIHRoaXMucG9zLmNvbHVtbiA9IGNvbHVtbjtcbn07XG5jaGFuZ2VUcmFja2VyLnVwZGF0ZSA9IGZ1bmN0aW9uKHBvcywgZGVsdGEsICRpbnNlcnRSaWdodCkge1xuICAgIHRoaXMuJGluc2VydFJpZ2h0ID0gJGluc2VydFJpZ2h0O1xuICAgIHRoaXMucG9zID0gcG9zOyBcbiAgICB0aGlzLm9uQ2hhbmdlKGRlbHRhKTtcbn07XG5cbnZhciBtb3ZlUG9pbnQgPSBmdW5jdGlvbihwb2ludCwgZGlmZikge1xuICAgIGlmIChwb2ludC5yb3cgPT0gMClcbiAgICAgICAgcG9pbnQuY29sdW1uICs9IGRpZmYuY29sdW1uO1xuICAgIHBvaW50LnJvdyArPSBkaWZmLnJvdztcbn07XG5cbnZhciBtb3ZlUmVsYXRpdmUgPSBmdW5jdGlvbihwb2ludCwgc3RhcnQpIHtcbiAgICBpZiAocG9pbnQucm93ID09IHN0YXJ0LnJvdylcbiAgICAgICAgcG9pbnQuY29sdW1uIC09IHN0YXJ0LmNvbHVtbjtcbiAgICBwb2ludC5yb3cgLT0gc3RhcnQucm93O1xufTtcblxuXG5hY2VxdWlyZShcIi4vbGliL2RvbVwiKS5pbXBvcnRDc3NTdHJpbmcoXCJcXFxuLmFjZV9zbmlwcGV0LW1hcmtlciB7XFxcbiAgICAtbW96LWJveC1zaXppbmc6IGJvcmRlci1ib3g7XFxcbiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94O1xcXG4gICAgYmFja2dyb3VuZDogcmdiYSgxOTQsIDE5MywgMjA4LCAwLjA5KTtcXFxuICAgIGJvcmRlcjogMXB4IGRvdHRlZCByZ2JhKDIxMSwgMjA4LCAyMzUsIDAuNjIpO1xcXG4gICAgcG9zaXRpb246IGFic29sdXRlO1xcXG59XCIpO1xuXG5leHBvcnRzLnNuaXBwZXRNYW5hZ2VyID0gbmV3IFNuaXBwZXRNYW5hZ2VyKCk7XG5cblxudmFyIEVkaXRvciA9IGFjZXF1aXJlKFwiLi9lZGl0b3JcIikuRWRpdG9yO1xuKGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuaW5zZXJ0U25pcHBldCA9IGZ1bmN0aW9uKGNvbnRlbnQsIG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGV4cG9ydHMuc25pcHBldE1hbmFnZXIuaW5zZXJ0U25pcHBldCh0aGlzLCBjb250ZW50LCBvcHRpb25zKTtcbiAgICB9O1xuICAgIHRoaXMuZXhwYW5kU25pcHBldCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIGV4cG9ydHMuc25pcHBldE1hbmFnZXIuZXhwYW5kV2l0aFRhYih0aGlzLCBvcHRpb25zKTtcbiAgICB9O1xufSkuY2FsbChFZGl0b3IucHJvdG90eXBlKTtcblxufSk7XG5cbmFjZS5kZWZpbmUoXCJhY2UvYXV0b2NvbXBsZXRlL3BvcHVwXCIsW1wicmVxdWlyZVwiLFwiZXhwb3J0c1wiLFwibW9kdWxlXCIsXCJhY2UvdmlydHVhbF9yZW5kZXJlclwiLFwiYWNlL2VkaXRvclwiLFwiYWNlL3JhbmdlXCIsXCJhY2UvbGliL2V2ZW50XCIsXCJhY2UvbGliL2xhbmdcIixcImFjZS9saWIvZG9tXCJdLCBmdW5jdGlvbihhY2VxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7XG5cInVzZSBzdHJpY3RcIjtcblxudmFyIFJlbmRlcmVyID0gYWNlcXVpcmUoXCIuLi92aXJ0dWFsX3JlbmRlcmVyXCIpLlZpcnR1YWxSZW5kZXJlcjtcbnZhciBFZGl0b3IgPSBhY2VxdWlyZShcIi4uL2VkaXRvclwiKS5FZGl0b3I7XG52YXIgUmFuZ2UgPSBhY2VxdWlyZShcIi4uL3JhbmdlXCIpLlJhbmdlO1xudmFyIGV2ZW50ID0gYWNlcXVpcmUoXCIuLi9saWIvZXZlbnRcIik7XG52YXIgbGFuZyA9IGFjZXF1aXJlKFwiLi4vbGliL2xhbmdcIik7XG52YXIgZG9tID0gYWNlcXVpcmUoXCIuLi9saWIvZG9tXCIpO1xuXG52YXIgJHNpbmdsZUxpbmVFZGl0b3IgPSBmdW5jdGlvbihlbCkge1xuICAgIHZhciByZW5kZXJlciA9IG5ldyBSZW5kZXJlcihlbCk7XG5cbiAgICByZW5kZXJlci4kbWF4TGluZXMgPSA0O1xuXG4gICAgdmFyIGVkaXRvciA9IG5ldyBFZGl0b3IocmVuZGVyZXIpO1xuXG4gICAgZWRpdG9yLnNldEhpZ2hsaWdodEFjdGl2ZUxpbmUoZmFsc2UpO1xuICAgIGVkaXRvci5zZXRTaG93UHJpbnRNYXJnaW4oZmFsc2UpO1xuICAgIGVkaXRvci5yZW5kZXJlci5zZXRTaG93R3V0dGVyKGZhbHNlKTtcbiAgICBlZGl0b3IucmVuZGVyZXIuc2V0SGlnaGxpZ2h0R3V0dGVyTGluZShmYWxzZSk7XG5cbiAgICBlZGl0b3IuJG1vdXNlSGFuZGxlci4kZm9jdXNXYWl0VGltb3V0ID0gMDtcbiAgICBlZGl0b3IuJGhpZ2hsaWdodFRhZ1BlbmRpbmcgPSB0cnVlO1xuXG4gICAgcmV0dXJuIGVkaXRvcjtcbn07XG5cbnZhciBBY2VQb3B1cCA9IGZ1bmN0aW9uKHBhcmVudE5vZGUpIHtcbiAgICB2YXIgZWwgPSBkb20uY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICB2YXIgcG9wdXAgPSBuZXcgJHNpbmdsZUxpbmVFZGl0b3IoZWwpO1xuXG4gICAgaWYgKHBhcmVudE5vZGUpXG4gICAgICAgIHBhcmVudE5vZGUuYXBwZW5kQ2hpbGQoZWwpO1xuICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICBwb3B1cC5yZW5kZXJlci5jb250ZW50LnN0eWxlLmN1cnNvciA9IFwiZGVmYXVsdFwiO1xuICAgIHBvcHVwLnJlbmRlcmVyLnNldFN0eWxlKFwiYWNlX2F1dG9jb21wbGV0ZVwiKTtcblxuICAgIHBvcHVwLnNldE9wdGlvbihcImRpc3BsYXlJbmRlbnRHdWlkZXNcIiwgZmFsc2UpO1xuICAgIHBvcHVwLnNldE9wdGlvbihcImRyYWdEZWxheVwiLCAxNTApO1xuXG4gICAgdmFyIG5vb3AgPSBmdW5jdGlvbigpe307XG5cbiAgICBwb3B1cC5mb2N1cyA9IG5vb3A7XG4gICAgcG9wdXAuJGlzRm9jdXNlZCA9IHRydWU7XG5cbiAgICBwb3B1cC5yZW5kZXJlci4kY3Vyc29yTGF5ZXIucmVzdGFydFRpbWVyID0gbm9vcDtcbiAgICBwb3B1cC5yZW5kZXJlci4kY3Vyc29yTGF5ZXIuZWxlbWVudC5zdHlsZS5vcGFjaXR5ID0gMDtcblxuICAgIHBvcHVwLnJlbmRlcmVyLiRtYXhMaW5lcyA9IDg7XG4gICAgcG9wdXAucmVuZGVyZXIuJGtlZXBUZXh0QXJlYUF0Q3Vyc29yID0gZmFsc2U7XG5cbiAgICBwb3B1cC5zZXRIaWdobGlnaHRBY3RpdmVMaW5lKGZhbHNlKTtcbiAgICBwb3B1cC5zZXNzaW9uLmhpZ2hsaWdodChcIlwiKTtcbiAgICBwb3B1cC5zZXNzaW9uLiRzZWFyY2hIaWdobGlnaHQuY2xhenogPSBcImFjZV9oaWdobGlnaHQtbWFya2VyXCI7XG5cbiAgICBwb3B1cC5vbihcIm1vdXNlZG93blwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgIHZhciBwb3MgPSBlLmdldERvY3VtZW50UG9zaXRpb24oKTtcbiAgICAgICAgcG9wdXAuc2VsZWN0aW9uLm1vdmVUb1Bvc2l0aW9uKHBvcyk7XG4gICAgICAgIHNlbGVjdGlvbk1hcmtlci5zdGFydC5yb3cgPSBzZWxlY3Rpb25NYXJrZXIuZW5kLnJvdyA9IHBvcy5yb3c7XG4gICAgICAgIGUuc3RvcCgpO1xuICAgIH0pO1xuXG4gICAgdmFyIGxhc3RNb3VzZUV2ZW50O1xuICAgIHZhciBob3Zlck1hcmtlciA9IG5ldyBSYW5nZSgtMSwwLC0xLEluZmluaXR5KTtcbiAgICB2YXIgc2VsZWN0aW9uTWFya2VyID0gbmV3IFJhbmdlKC0xLDAsLTEsSW5maW5pdHkpO1xuICAgIHNlbGVjdGlvbk1hcmtlci5pZCA9IHBvcHVwLnNlc3Npb24uYWRkTWFya2VyKHNlbGVjdGlvbk1hcmtlciwgXCJhY2VfYWN0aXZlLWxpbmVcIiwgXCJmdWxsTGluZVwiKTtcbiAgICBwb3B1cC5zZXRTZWxlY3RPbkhvdmVyID0gZnVuY3Rpb24odmFsKSB7XG4gICAgICAgIGlmICghdmFsKSB7XG4gICAgICAgICAgICBob3Zlck1hcmtlci5pZCA9IHBvcHVwLnNlc3Npb24uYWRkTWFya2VyKGhvdmVyTWFya2VyLCBcImFjZV9saW5lLWhvdmVyXCIsIFwiZnVsbExpbmVcIik7XG4gICAgICAgIH0gZWxzZSBpZiAoaG92ZXJNYXJrZXIuaWQpIHtcbiAgICAgICAgICAgIHBvcHVwLnNlc3Npb24ucmVtb3ZlTWFya2VyKGhvdmVyTWFya2VyLmlkKTtcbiAgICAgICAgICAgIGhvdmVyTWFya2VyLmlkID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH07XG4gICAgcG9wdXAuc2V0U2VsZWN0T25Ib3ZlcihmYWxzZSk7XG4gICAgcG9wdXAub24oXCJtb3VzZW1vdmVcIiwgZnVuY3Rpb24oZSkge1xuICAgICAgICBpZiAoIWxhc3RNb3VzZUV2ZW50KSB7XG4gICAgICAgICAgICBsYXN0TW91c2VFdmVudCA9IGU7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50LnggPT0gZS54ICYmIGxhc3RNb3VzZUV2ZW50LnkgPT0gZS55KSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgbGFzdE1vdXNlRXZlbnQgPSBlO1xuICAgICAgICBsYXN0TW91c2VFdmVudC5zY3JvbGxUb3AgPSBwb3B1cC5yZW5kZXJlci5zY3JvbGxUb3A7XG4gICAgICAgIHZhciByb3cgPSBsYXN0TW91c2VFdmVudC5nZXREb2N1bWVudFBvc2l0aW9uKCkucm93O1xuICAgICAgICBpZiAoaG92ZXJNYXJrZXIuc3RhcnQucm93ICE9IHJvdykge1xuICAgICAgICAgICAgaWYgKCFob3Zlck1hcmtlci5pZClcbiAgICAgICAgICAgICAgICBwb3B1cC5zZXRSb3cocm93KTtcbiAgICAgICAgICAgIHNldEhvdmVyTWFya2VyKHJvdyk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBwb3B1cC5yZW5kZXJlci5vbihcImJlZm9yZVJlbmRlclwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgaWYgKGxhc3RNb3VzZUV2ZW50ICYmIGhvdmVyTWFya2VyLnN0YXJ0LnJvdyAhPSAtMSkge1xuICAgICAgICAgICAgbGFzdE1vdXNlRXZlbnQuJHBvcyA9IG51bGw7XG4gICAgICAgICAgICB2YXIgcm93ID0gbGFzdE1vdXNlRXZlbnQuZ2V0RG9jdW1lbnRQb3NpdGlvbigpLnJvdztcbiAgICAgICAgICAgIGlmICghaG92ZXJNYXJrZXIuaWQpXG4gICAgICAgICAgICAgICAgcG9wdXAuc2V0Um93KHJvdyk7XG4gICAgICAgICAgICBzZXRIb3Zlck1hcmtlcihyb3csIHRydWUpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcG9wdXAucmVuZGVyZXIub24oXCJhZnRlclJlbmRlclwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIHJvdyA9IHBvcHVwLmdldFJvdygpO1xuICAgICAgICB2YXIgdCA9IHBvcHVwLnJlbmRlcmVyLiR0ZXh0TGF5ZXI7XG4gICAgICAgIHZhciBzZWxlY3RlZCA9IHQuZWxlbWVudC5jaGlsZE5vZGVzW3JvdyAtIHQuY29uZmlnLmZpcnN0Um93XTtcbiAgICAgICAgaWYgKHNlbGVjdGVkID09IHQuc2VsZWN0ZWROb2RlKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBpZiAodC5zZWxlY3RlZE5vZGUpXG4gICAgICAgICAgICBkb20ucmVtb3ZlQ3NzQ2xhc3ModC5zZWxlY3RlZE5vZGUsIFwiYWNlX3NlbGVjdGVkXCIpO1xuICAgICAgICB0LnNlbGVjdGVkTm9kZSA9IHNlbGVjdGVkO1xuICAgICAgICBpZiAoc2VsZWN0ZWQpXG4gICAgICAgICAgICBkb20uYWRkQ3NzQ2xhc3Moc2VsZWN0ZWQsIFwiYWNlX3NlbGVjdGVkXCIpO1xuICAgIH0pO1xuICAgIHZhciBoaWRlSG92ZXJNYXJrZXIgPSBmdW5jdGlvbigpIHsgc2V0SG92ZXJNYXJrZXIoLTEpOyB9O1xuICAgIHZhciBzZXRIb3Zlck1hcmtlciA9IGZ1bmN0aW9uKHJvdywgc3VwcHJlc3NSZWRyYXcpIHtcbiAgICAgICAgaWYgKHJvdyAhPT0gaG92ZXJNYXJrZXIuc3RhcnQucm93KSB7XG4gICAgICAgICAgICBob3Zlck1hcmtlci5zdGFydC5yb3cgPSBob3Zlck1hcmtlci5lbmQucm93ID0gcm93O1xuICAgICAgICAgICAgaWYgKCFzdXBwcmVzc1JlZHJhdylcbiAgICAgICAgICAgICAgICBwb3B1cC5zZXNzaW9uLl9lbWl0KFwiY2hhbmdlQmFja01hcmtlclwiKTtcbiAgICAgICAgICAgIHBvcHVwLl9lbWl0KFwiY2hhbmdlSG92ZXJNYXJrZXJcIik7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIHBvcHVwLmdldEhvdmVyZWRSb3cgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGhvdmVyTWFya2VyLnN0YXJ0LnJvdztcbiAgICB9O1xuXG4gICAgZXZlbnQuYWRkTGlzdGVuZXIocG9wdXAuY29udGFpbmVyLCBcIm1vdXNlb3V0XCIsIGhpZGVIb3Zlck1hcmtlcik7XG4gICAgcG9wdXAub24oXCJoaWRlXCIsIGhpZGVIb3Zlck1hcmtlcik7XG4gICAgcG9wdXAub24oXCJjaGFuZ2VTZWxlY3Rpb25cIiwgaGlkZUhvdmVyTWFya2VyKTtcblxuICAgIHBvcHVwLnNlc3Npb24uZG9jLmdldExlbmd0aCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gcG9wdXAuZGF0YS5sZW5ndGg7XG4gICAgfTtcbiAgICBwb3B1cC5zZXNzaW9uLmRvYy5nZXRMaW5lID0gZnVuY3Rpb24oaSkge1xuICAgICAgICB2YXIgZGF0YSA9IHBvcHVwLmRhdGFbaV07XG4gICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgIHJldHVybiAoZGF0YSAmJiBkYXRhLnZhbHVlKSB8fCBcIlwiO1xuICAgIH07XG5cbiAgICB2YXIgYmdUb2tlbml6ZXIgPSBwb3B1cC5zZXNzaW9uLmJnVG9rZW5pemVyO1xuICAgIGJnVG9rZW5pemVyLiR0b2tlbml6ZVJvdyA9IGZ1bmN0aW9uKHJvdykge1xuICAgICAgICB2YXIgZGF0YSA9IHBvcHVwLmRhdGFbcm93XTtcbiAgICAgICAgdmFyIHRva2VucyA9IFtdO1xuICAgICAgICBpZiAoIWRhdGEpXG4gICAgICAgICAgICByZXR1cm4gdG9rZW5zO1xuICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgIGRhdGEgPSB7dmFsdWU6IGRhdGF9O1xuICAgICAgICBpZiAoIWRhdGEuY2FwdGlvbilcbiAgICAgICAgICAgIGRhdGEuY2FwdGlvbiA9IGRhdGEudmFsdWUgfHwgZGF0YS5uYW1lO1xuXG4gICAgICAgIHZhciBsYXN0ID0gLTE7XG4gICAgICAgIHZhciBmbGFnLCBjO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGEuY2FwdGlvbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgYyA9IGRhdGEuY2FwdGlvbltpXTtcbiAgICAgICAgICAgIGZsYWcgPSBkYXRhLm1hdGNoTWFzayAmICgxIDw8IGkpID8gMSA6IDA7XG4gICAgICAgICAgICBpZiAobGFzdCAhPT0gZmxhZykge1xuICAgICAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBkYXRhLmNsYXNzTmFtZSB8fCBcIlwiICsgKCBmbGFnID8gXCJjb21wbGV0aW9uLWhpZ2hsaWdodFwiIDogXCJcIiksIHZhbHVlOiBjfSk7XG4gICAgICAgICAgICAgICAgbGFzdCA9IGZsYWc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRva2Vuc1t0b2tlbnMubGVuZ3RoIC0gMV0udmFsdWUgKz0gYztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChkYXRhLm1ldGEpIHtcbiAgICAgICAgICAgIHZhciBtYXhXID0gcG9wdXAucmVuZGVyZXIuJHNpemUuc2Nyb2xsZXJXaWR0aCAvIHBvcHVwLnJlbmRlcmVyLmxheWVyQ29uZmlnLmNoYXJhY3RlcldpZHRoO1xuICAgICAgICAgICAgdmFyIG1ldGFEYXRhID0gZGF0YS5tZXRhO1xuICAgICAgICAgICAgaWYgKG1ldGFEYXRhLmxlbmd0aCArIGRhdGEuY2FwdGlvbi5sZW5ndGggPiBtYXhXIC0gMikge1xuICAgICAgICAgICAgICAgIG1ldGFEYXRhID0gbWV0YURhdGEuc3Vic3RyKDAsIG1heFcgLSBkYXRhLmNhcHRpb24ubGVuZ3RoIC0gMykgKyBcIlxcdTIwMjZcIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRva2Vucy5wdXNoKHt0eXBlOiBcInJpZ2h0QWxpZ25lZFRleHRcIiwgdmFsdWU6IG1ldGFEYXRhfSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRva2VucztcbiAgICB9O1xuICAgIGJnVG9rZW5pemVyLiR1cGRhdGVPbkNoYW5nZSA9IG5vb3A7XG4gICAgYmdUb2tlbml6ZXIuc3RhcnQgPSBub29wO1xuXG4gICAgcG9wdXAuc2Vzc2lvbi4kY29tcHV0ZVdpZHRoID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNjcmVlbldpZHRoID0gMDtcbiAgICB9O1xuXG4gICAgcG9wdXAuJGJsb2NrU2Nyb2xsaW5nID0gSW5maW5pdHk7XG4gICAgcG9wdXAuaXNPcGVuID0gZmFsc2U7XG4gICAgcG9wdXAuaXNUb3Bkb3duID0gZmFsc2U7XG4gICAgcG9wdXAuYXV0b1NlbGVjdCA9IHRydWU7XG5cbiAgICBwb3B1cC5kYXRhID0gW107XG4gICAgcG9wdXAuc2V0RGF0YSA9IGZ1bmN0aW9uKGxpc3QpIHtcbiAgICAgICAgcG9wdXAuc2V0VmFsdWUobGFuZy5zdHJpbmdSZXBlYXQoXCJcXG5cIiwgbGlzdC5sZW5ndGgpLCAtMSk7XG4gICAgICAgIHBvcHVwLmRhdGEgPSBsaXN0IHx8IFtdO1xuICAgICAgICBwb3B1cC5zZXRSb3coMCk7XG4gICAgfTtcbiAgICBwb3B1cC5nZXREYXRhID0gZnVuY3Rpb24ocm93KSB7XG4gICAgICAgIHJldHVybiBwb3B1cC5kYXRhW3Jvd107XG4gICAgfTtcblxuICAgIHBvcHVwLmdldFJvdyA9IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gc2VsZWN0aW9uTWFya2VyLnN0YXJ0LnJvdztcbiAgICB9O1xuICAgIHBvcHVwLnNldFJvdyA9IGZ1bmN0aW9uKGxpbmUpIHtcbiAgICAgICAgbGluZSA9IE1hdGgubWF4KHRoaXMuYXV0b1NlbGVjdCA/IDAgOiAtMSwgTWF0aC5taW4odGhpcy5kYXRhLmxlbmd0aCwgbGluZSkpO1xuICAgICAgICBpZiAoc2VsZWN0aW9uTWFya2VyLnN0YXJ0LnJvdyAhPSBsaW5lKSB7XG4gICAgICAgICAgICBwb3B1cC5zZWxlY3Rpb24uY2xlYXJTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgIHNlbGVjdGlvbk1hcmtlci5zdGFydC5yb3cgPSBzZWxlY3Rpb25NYXJrZXIuZW5kLnJvdyA9IGxpbmUgfHwgMDtcbiAgICAgICAgICAgIHBvcHVwLnNlc3Npb24uX2VtaXQoXCJjaGFuZ2VCYWNrTWFya2VyXCIpO1xuICAgICAgICAgICAgcG9wdXAubW92ZUN1cnNvclRvKGxpbmUgfHwgMCwgMCk7XG4gICAgICAgICAgICBpZiAocG9wdXAuaXNPcGVuKVxuICAgICAgICAgICAgICAgIHBvcHVwLl9zaWduYWwoXCJzZWxlY3RcIik7XG4gICAgICAgIH1cbiAgICB9O1xuXG4gICAgcG9wdXAub24oXCJjaGFuZ2VTZWxlY3Rpb25cIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgIGlmIChwb3B1cC5pc09wZW4pXG4gICAgICAgICAgICBwb3B1cC5zZXRSb3cocG9wdXAuc2VsZWN0aW9uLmxlYWQucm93KTtcbiAgICAgICAgcG9wdXAucmVuZGVyZXIuc2Nyb2xsQ3Vyc29ySW50b1ZpZXcoKTtcbiAgICB9KTtcblxuICAgIHBvcHVwLmhpZGUgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5jb250YWluZXIuc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xuICAgICAgICB0aGlzLl9zaWduYWwoXCJoaWRlXCIpO1xuICAgICAgICBwb3B1cC5pc09wZW4gPSBmYWxzZTtcbiAgICB9O1xuICAgIHBvcHVwLnNob3cgPSBmdW5jdGlvbihwb3MsIGxpbmVIZWlnaHQsIHRvcGRvd25Pbmx5KSB7XG4gICAgICAgIHZhciBlbCA9IHRoaXMuY29udGFpbmVyO1xuICAgICAgICB2YXIgc2NyZWVuSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgICB2YXIgc2NyZWVuV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICAgICAgdmFyIHJlbmRlcmVyID0gdGhpcy5yZW5kZXJlcjtcbiAgICAgICAgdmFyIG1heEggPSByZW5kZXJlci4kbWF4TGluZXMgKiBsaW5lSGVpZ2h0ICogMS40O1xuICAgICAgICB2YXIgdG9wID0gcG9zLnRvcCArIHRoaXMuJGJvcmRlclNpemU7XG4gICAgICAgIHZhciBhbGxvd1RvcGRvd24gPSB0b3AgPiBzY3JlZW5IZWlnaHQgLyAyICYmICF0b3Bkb3duT25seTtcbiAgICAgICAgaWYgKGFsbG93VG9wZG93biAmJiB0b3AgKyBsaW5lSGVpZ2h0ICsgbWF4SCA+IHNjcmVlbkhlaWdodCkge1xuICAgICAgICAgICAgcmVuZGVyZXIuJG1heFBpeGVsSGVpZ2h0ID0gdG9wIC0gMiAqIHRoaXMuJGJvcmRlclNpemU7XG4gICAgICAgICAgICBlbC5zdHlsZS50b3AgPSBcIlwiO1xuICAgICAgICAgICAgZWwuc3R5bGUuYm90dG9tID0gc2NyZWVuSGVpZ2h0IC0gdG9wICsgXCJweFwiO1xuICAgICAgICAgICAgcG9wdXAuaXNUb3Bkb3duID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0b3AgKz0gbGluZUhlaWdodDtcbiAgICAgICAgICAgIHJlbmRlcmVyLiRtYXhQaXhlbEhlaWdodCA9IHNjcmVlbkhlaWdodCAtIHRvcCAtIDAuMiAqIGxpbmVIZWlnaHQ7XG4gICAgICAgICAgICBlbC5zdHlsZS50b3AgPSB0b3AgKyBcInB4XCI7XG4gICAgICAgICAgICBlbC5zdHlsZS5ib3R0b20gPSBcIlwiO1xuICAgICAgICAgICAgcG9wdXAuaXNUb3Bkb3duID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSBcIlwiO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLiR0ZXh0TGF5ZXIuY2hlY2tGb3JTaXplQ2hhbmdlcygpO1xuXG4gICAgICAgIHZhciBsZWZ0ID0gcG9zLmxlZnQ7XG4gICAgICAgIGlmIChsZWZ0ICsgZWwub2Zmc2V0V2lkdGggPiBzY3JlZW5XaWR0aClcbiAgICAgICAgICAgIGxlZnQgPSBzY3JlZW5XaWR0aCAtIGVsLm9mZnNldFdpZHRoO1xuXG4gICAgICAgIGVsLnN0eWxlLmxlZnQgPSBsZWZ0ICsgXCJweFwiO1xuXG4gICAgICAgIHRoaXMuX3NpZ25hbChcInNob3dcIik7XG4gICAgICAgIGxhc3RNb3VzZUV2ZW50ID0gbnVsbDtcbiAgICAgICAgcG9wdXAuaXNPcGVuID0gdHJ1ZTtcbiAgICB9O1xuXG4gICAgcG9wdXAuZ2V0VGV4dExlZnRPZmZzZXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGJvcmRlclNpemUgKyB0aGlzLnJlbmRlcmVyLiRwYWRkaW5nICsgdGhpcy4kaW1hZ2VTaXplO1xuICAgIH07XG5cbiAgICBwb3B1cC4kaW1hZ2VTaXplID0gMDtcbiAgICBwb3B1cC4kYm9yZGVyU2l6ZSA9IDE7XG5cbiAgICByZXR1cm4gcG9wdXA7XG59O1xuXG5kb20uaW1wb3J0Q3NzU3RyaW5nKFwiXFxcbi5hY2VfZWRpdG9yLmFjZV9hdXRvY29tcGxldGUgLmFjZV9tYXJrZXItbGF5ZXIgLmFjZV9hY3RpdmUtbGluZSB7XFxcbiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAjQ0FENkZBO1xcXG4gICAgei1pbmRleDogMTtcXFxufVxcXG4uYWNlX2VkaXRvci5hY2VfYXV0b2NvbXBsZXRlIC5hY2VfbGluZS1ob3ZlciB7XFxcbiAgICBib3JkZXI6IDFweCBzb2xpZCAjYWJiZmZlO1xcXG4gICAgbWFyZ2luLXRvcDogLTFweDtcXFxuICAgIGJhY2tncm91bmQ6IHJnYmEoMjMzLDIzMywyNTMsMC40KTtcXFxufVxcXG4uYWNlX2VkaXRvci5hY2VfYXV0b2NvbXBsZXRlIC5hY2VfbGluZS1ob3ZlciB7XFxcbiAgICBwb3NpdGlvbjogYWJzb2x1dGU7XFxcbiAgICB6LWluZGV4OiAyO1xcXG59XFxcbi5hY2VfZWRpdG9yLmFjZV9hdXRvY29tcGxldGUgLmFjZV9zY3JvbGxlciB7XFxcbiAgIGJhY2tncm91bmQ6IG5vbmU7XFxcbiAgIGJvcmRlcjogbm9uZTtcXFxuICAgYm94LXNoYWRvdzogbm9uZTtcXFxufVxcXG4uYWNlX3JpZ2h0QWxpZ25lZFRleHQge1xcXG4gICAgY29sb3I6IGdyYXk7XFxcbiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XFxcbiAgICBwb3NpdGlvbjogYWJzb2x1dGU7XFxcbiAgICByaWdodDogNHB4O1xcXG4gICAgdGV4dC1hbGlnbjogcmlnaHQ7XFxcbiAgICB6LWluZGV4OiAtMTtcXFxufVxcXG4uYWNlX2VkaXRvci5hY2VfYXV0b2NvbXBsZXRlIC5hY2VfY29tcGxldGlvbi1oaWdobGlnaHR7XFxcbiAgICBjb2xvcjogIzAwMDtcXFxuICAgIHRleHQtc2hhZG93OiAwIDAgMC4wMWVtO1xcXG59XFxcbi5hY2VfZWRpdG9yLmFjZV9hdXRvY29tcGxldGUge1xcXG4gICAgd2lkdGg6IDI4MHB4O1xcXG4gICAgei1pbmRleDogMjAwMDAwO1xcXG4gICAgYmFja2dyb3VuZDogI2ZiZmJmYjtcXFxuICAgIGNvbG9yOiAjNDQ0O1xcXG4gICAgYm9yZGVyOiAxcHggbGlnaHRncmF5IHNvbGlkO1xcXG4gICAgcG9zaXRpb246IGZpeGVkO1xcXG4gICAgYm94LXNoYWRvdzogMnB4IDNweCA1cHggcmdiYSgwLDAsMCwuMik7XFxcbiAgICBsaW5lLWhlaWdodDogMS40O1xcXG59XCIpO1xuXG5leHBvcnRzLkFjZVBvcHVwID0gQWNlUG9wdXA7XG5cbn0pO1xuXG5hY2UuZGVmaW5lKFwiYWNlL2F1dG9jb21wbGV0ZS91dGlsXCIsW1wicmVxdWlyZVwiLFwiZXhwb3J0c1wiLFwibW9kdWxlXCJdLCBmdW5jdGlvbihhY2VxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7XG5cInVzZSBzdHJpY3RcIjtcblxuZXhwb3J0cy5wYXJGb3JFYWNoID0gZnVuY3Rpb24oYXJyYXksIGZuLCBjYWxsYmFjaykge1xuICAgIHZhciBjb21wbGV0ZWQgPSAwO1xuICAgIHZhciBhckxlbmd0aCA9IGFycmF5Lmxlbmd0aDtcbiAgICBpZiAoYXJMZW5ndGggPT09IDApXG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhckxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGZuKGFycmF5W2ldLCBmdW5jdGlvbihyZXN1bHQsIGVycikge1xuICAgICAgICAgICAgY29tcGxldGVkKys7XG4gICAgICAgICAgICBpZiAoY29tcGxldGVkID09PSBhckxlbmd0aClcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhyZXN1bHQsIGVycik7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cbnZhciBJRF9SRUdFWCA9IC9bYS16QS1aXzAtOVxcJFxcLVxcdTAwQTItXFx1RkZGRl0vO1xuXG5leHBvcnRzLnJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllciA9IGZ1bmN0aW9uKHRleHQsIHBvcywgcmVnZXgpIHtcbiAgICByZWdleCA9IHJlZ2V4IHx8IElEX1JFR0VYO1xuICAgIHZhciBidWYgPSBbXTtcbiAgICBmb3IgKHZhciBpID0gcG9zLTE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGlmIChyZWdleC50ZXN0KHRleHRbaV0pKVxuICAgICAgICAgICAgYnVmLnB1c2godGV4dFtpXSk7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICByZXR1cm4gYnVmLnJldmVyc2UoKS5qb2luKFwiXCIpO1xufTtcblxuZXhwb3J0cy5yZXRyaWV2ZUZvbGxvd2luZ0lkZW50aWZpZXIgPSBmdW5jdGlvbih0ZXh0LCBwb3MsIHJlZ2V4KSB7XG4gICAgcmVnZXggPSByZWdleCB8fCBJRF9SRUdFWDtcbiAgICB2YXIgYnVmID0gW107XG4gICAgZm9yICh2YXIgaSA9IHBvczsgaSA8IHRleHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKHJlZ2V4LnRlc3QodGV4dFtpXSkpXG4gICAgICAgICAgICBidWYucHVzaCh0ZXh0W2ldKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiBidWY7XG59O1xuXG5leHBvcnRzLmdldENvbXBsZXRpb25QcmVmaXggPSBmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgdmFyIHBvcyA9IGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgIHZhciBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICB2YXIgcHJlZml4O1xuICAgIGVkaXRvci5jb21wbGV0ZXJzLmZvckVhY2goZnVuY3Rpb24oY29tcGxldGVyKSB7XG4gICAgICAgIGlmIChjb21wbGV0ZXIuaWRlbnRpZmllclJlZ2V4cHMpIHtcbiAgICAgICAgICAgIGNvbXBsZXRlci5pZGVudGlmaWVyUmVnZXhwcy5mb3JFYWNoKGZ1bmN0aW9uKGlkZW50aWZpZXJSZWdleCkge1xuICAgICAgICAgICAgICAgIGlmICghcHJlZml4ICYmIGlkZW50aWZpZXJSZWdleClcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gdGhpcy5yZXRyaWV2ZVByZWNlZGluZ0lkZW50aWZpZXIobGluZSwgcG9zLmNvbHVtbiwgaWRlbnRpZmllclJlZ2V4KTtcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgIH1cbiAgICB9LmJpbmQodGhpcykpO1xuICAgIHJldHVybiBwcmVmaXggfHwgdGhpcy5yZXRyaWV2ZVByZWNlZGluZ0lkZW50aWZpZXIobGluZSwgcG9zLmNvbHVtbik7XG59O1xuXG59KTtcblxuYWNlLmRlZmluZShcImFjZS9hdXRvY29tcGxldGVcIixbXCJyZXF1aXJlXCIsXCJleHBvcnRzXCIsXCJtb2R1bGVcIixcImFjZS9rZXlib2FyZC9oYXNoX2hhbmRsZXJcIixcImFjZS9hdXRvY29tcGxldGUvcG9wdXBcIixcImFjZS9hdXRvY29tcGxldGUvdXRpbFwiLFwiYWNlL2xpYi9ldmVudFwiLFwiYWNlL2xpYi9sYW5nXCIsXCJhY2UvbGliL2RvbVwiLFwiYWNlL3NuaXBwZXRzXCJdLCBmdW5jdGlvbihhY2VxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7XG5cInVzZSBzdHJpY3RcIjtcblxudmFyIEhhc2hIYW5kbGVyID0gYWNlcXVpcmUoXCIuL2tleWJvYXJkL2hhc2hfaGFuZGxlclwiKS5IYXNoSGFuZGxlcjtcbnZhciBBY2VQb3B1cCA9IGFjZXF1aXJlKFwiLi9hdXRvY29tcGxldGUvcG9wdXBcIikuQWNlUG9wdXA7XG52YXIgdXRpbCA9IGFjZXF1aXJlKFwiLi9hdXRvY29tcGxldGUvdXRpbFwiKTtcbnZhciBldmVudCA9IGFjZXF1aXJlKFwiLi9saWIvZXZlbnRcIik7XG52YXIgbGFuZyA9IGFjZXF1aXJlKFwiLi9saWIvbGFuZ1wiKTtcbnZhciBkb20gPSBhY2VxdWlyZShcIi4vbGliL2RvbVwiKTtcbnZhciBzbmlwcGV0TWFuYWdlciA9IGFjZXF1aXJlKFwiLi9zbmlwcGV0c1wiKS5zbmlwcGV0TWFuYWdlcjtcblxudmFyIEF1dG9jb21wbGV0ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuYXV0b0luc2VydCA9IGZhbHNlO1xuICAgIHRoaXMuYXV0b1NlbGVjdCA9IHRydWU7XG4gICAgdGhpcy5leGFjdE1hdGNoID0gZmFsc2U7XG4gICAgdGhpcy5nYXRoZXJDb21wbGV0aW9uc0lkID0gMDtcbiAgICB0aGlzLmtleWJvYXJkSGFuZGxlciA9IG5ldyBIYXNoSGFuZGxlcigpO1xuICAgIHRoaXMua2V5Ym9hcmRIYW5kbGVyLmJpbmRLZXlzKHRoaXMuY29tbWFuZHMpO1xuXG4gICAgdGhpcy5ibHVyTGlzdGVuZXIgPSB0aGlzLmJsdXJMaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgIHRoaXMuY2hhbmdlTGlzdGVuZXIgPSB0aGlzLmNoYW5nZUxpc3RlbmVyLmJpbmQodGhpcyk7XG4gICAgdGhpcy5tb3VzZWRvd25MaXN0ZW5lciA9IHRoaXMubW91c2Vkb3duTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lciA9IHRoaXMubW91c2V3aGVlbExpc3RlbmVyLmJpbmQodGhpcyk7XG5cbiAgICB0aGlzLmNoYW5nZVRpbWVyID0gbGFuZy5kZWxheWVkQ2FsbChmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy51cGRhdGVDb21wbGV0aW9ucyh0cnVlKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy50b29sdGlwVGltZXIgPSBsYW5nLmRlbGF5ZWRDYWxsKHRoaXMudXBkYXRlRG9jVG9vbHRpcC5iaW5kKHRoaXMpLCA1MCk7XG59O1xuXG4oZnVuY3Rpb24oKSB7XG5cbiAgICB0aGlzLiRpbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMucG9wdXAgPSBuZXcgQWNlUG9wdXAoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQpO1xuICAgICAgICB0aGlzLnBvcHVwLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRNYXRjaCgpO1xuICAgICAgICAgICAgZS5zdG9wKCk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgIHRoaXMucG9wdXAuZm9jdXMgPSB0aGlzLmVkaXRvci5mb2N1cy5iaW5kKHRoaXMuZWRpdG9yKTtcbiAgICAgICAgdGhpcy5wb3B1cC5vbihcInNob3dcIiwgdGhpcy50b29sdGlwVGltZXIuYmluZChudWxsLCBudWxsKSk7XG4gICAgICAgIHRoaXMucG9wdXAub24oXCJzZWxlY3RcIiwgdGhpcy50b29sdGlwVGltZXIuYmluZChudWxsLCBudWxsKSk7XG4gICAgICAgIHRoaXMucG9wdXAub24oXCJjaGFuZ2VIb3Zlck1hcmtlclwiLCB0aGlzLnRvb2x0aXBUaW1lci5iaW5kKG51bGwsIG51bGwpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9wdXA7XG4gICAgfTtcblxuICAgIHRoaXMuZ2V0UG9wdXAgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9wdXAgfHwgdGhpcy4kaW5pdCgpO1xuICAgIH07XG5cbiAgICB0aGlzLm9wZW5Qb3B1cCA9IGZ1bmN0aW9uKGVkaXRvciwgcHJlZml4LCBrZWVwUG9wdXBQb3NpdGlvbikge1xuICAgICAgICBpZiAoIXRoaXMucG9wdXApXG4gICAgICAgICAgICB0aGlzLiRpbml0KCk7XG5cblx0dGhpcy5wb3B1cC5hdXRvU2VsZWN0ID0gdGhpcy5hdXRvU2VsZWN0O1xuXG4gICAgICAgIHRoaXMucG9wdXAuc2V0RGF0YSh0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkKTtcblxuICAgICAgICBlZGl0b3Iua2V5QmluZGluZy5hZGRLZXlib2FyZEhhbmRsZXIodGhpcy5rZXlib2FyZEhhbmRsZXIpO1xuICAgICAgICBcbiAgICAgICAgdmFyIHJlbmRlcmVyID0gZWRpdG9yLnJlbmRlcmVyO1xuICAgICAgICB0aGlzLnBvcHVwLnNldFJvdyh0aGlzLmF1dG9TZWxlY3QgPyAwIDogLTEpO1xuICAgICAgICBpZiAoIWtlZXBQb3B1cFBvc2l0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwLnNldFRoZW1lKGVkaXRvci5nZXRUaGVtZSgpKTtcbiAgICAgICAgICAgIHRoaXMucG9wdXAuc2V0Rm9udFNpemUoZWRpdG9yLmdldEZvbnRTaXplKCkpO1xuXG4gICAgICAgICAgICB2YXIgbGluZUhlaWdodCA9IHJlbmRlcmVyLmxheWVyQ29uZmlnLmxpbmVIZWlnaHQ7XG5cbiAgICAgICAgICAgIHZhciBwb3MgPSByZW5kZXJlci4kY3Vyc29yTGF5ZXIuZ2V0UGl4ZWxQb3NpdGlvbih0aGlzLmJhc2UsIHRydWUpO1xuICAgICAgICAgICAgcG9zLmxlZnQgLT0gdGhpcy5wb3B1cC5nZXRUZXh0TGVmdE9mZnNldCgpO1xuXG4gICAgICAgICAgICB2YXIgcmVjdCA9IGVkaXRvci5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBwb3MudG9wICs9IHJlY3QudG9wIC0gcmVuZGVyZXIubGF5ZXJDb25maWcub2Zmc2V0O1xuICAgICAgICAgICAgcG9zLmxlZnQgKz0gcmVjdC5sZWZ0IC0gZWRpdG9yLnJlbmRlcmVyLnNjcm9sbExlZnQ7XG4gICAgICAgICAgICBwb3MubGVmdCArPSByZW5kZXJlci5ndXR0ZXJXaWR0aDtcblxuICAgICAgICAgICAgdGhpcy5wb3B1cC5zaG93KHBvcywgbGluZUhlaWdodCk7XG4gICAgICAgIH0gZWxzZSBpZiAoa2VlcFBvcHVwUG9zaXRpb24gJiYgIXByZWZpeCkge1xuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLmRldGFjaCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmVkaXRvci5rZXlCaW5kaW5nLnJlbW92ZUtleWJvYXJkSGFuZGxlcih0aGlzLmtleWJvYXJkSGFuZGxlcik7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9mZihcImNoYW5nZVNlbGVjdGlvblwiLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwiYmx1clwiLCB0aGlzLmJsdXJMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9mZihcIm1vdXNlZG93blwiLCB0aGlzLm1vdXNlZG93bkxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwibW91c2V3aGVlbFwiLCB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuY2hhbmdlVGltZXIuY2FuY2VsKCk7XG4gICAgICAgIHRoaXMuaGlkZURvY1Rvb2x0aXAoKTtcblxuICAgICAgICB0aGlzLmdhdGhlckNvbXBsZXRpb25zSWQgKz0gMTtcbiAgICAgICAgaWYgKHRoaXMucG9wdXAgJiYgdGhpcy5wb3B1cC5pc09wZW4pXG4gICAgICAgICAgICB0aGlzLnBvcHVwLmhpZGUoKTtcblxuICAgICAgICBpZiAodGhpcy5iYXNlKVxuICAgICAgICAgICAgdGhpcy5iYXNlLmRldGFjaCgpO1xuICAgICAgICB0aGlzLmFjdGl2YXRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbXBsZXRpb25zID0gdGhpcy5iYXNlID0gbnVsbDtcbiAgICB9O1xuXG4gICAgdGhpcy5jaGFuZ2VMaXN0ZW5lciA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5sZWFkO1xuICAgICAgICBpZiAoY3Vyc29yLnJvdyAhPSB0aGlzLmJhc2Uucm93IHx8IGN1cnNvci5jb2x1bW4gPCB0aGlzLmJhc2UuY29sdW1uKSB7XG4gICAgICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFjdGl2YXRlZClcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVGltZXIuc2NoZWR1bGUoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9O1xuXG4gICAgdGhpcy5ibHVyTGlzdGVuZXIgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG4gICAgICAgIHZhciB0ZXh0ID0gdGhpcy5lZGl0b3IudGV4dElucHV0LmdldEVsZW1lbnQoKTtcbiAgICAgICAgdmFyIGZyb21Ub29sdGlwID0gZS5yZWxhdGVkVGFyZ2V0ICYmIHRoaXMudG9vbHRpcE5vZGUgJiYgdGhpcy50b29sdGlwTm9kZS5jb250YWlucyhlLnJlbGF0ZWRUYXJnZXQpO1xuICAgICAgICB2YXIgY29udGFpbmVyID0gdGhpcy5wb3B1cCAmJiB0aGlzLnBvcHVwLmNvbnRhaW5lcjtcbiAgICAgICAgaWYgKGVsICE9IHRleHQgJiYgZWwucGFyZW50Tm9kZSAhPSBjb250YWluZXIgJiYgIWZyb21Ub29sdGlwXG4gICAgICAgICAgICAmJiBlbCAhPSB0aGlzLnRvb2x0aXBOb2RlICYmIGUucmVsYXRlZFRhcmdldCAhPSB0ZXh0XG4gICAgICAgICkge1xuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLm1vdXNlZG93bkxpc3RlbmVyID0gZnVuY3Rpb24oZSkge1xuICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH07XG5cbiAgICB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lciA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9O1xuXG4gICAgdGhpcy5nb1RvID0gZnVuY3Rpb24od2hlcmUpIHtcbiAgICAgICAgdmFyIHJvdyA9IHRoaXMucG9wdXAuZ2V0Um93KCk7XG4gICAgICAgIHZhciBtYXggPSB0aGlzLnBvcHVwLnNlc3Npb24uZ2V0TGVuZ3RoKCkgLSAxO1xuXG4gICAgICAgIHN3aXRjaCh3aGVyZSkge1xuICAgICAgICAgICAgY2FzZSBcInVwXCI6IHJvdyA9IHJvdyA8PSAwID8gbWF4IDogcm93IC0gMTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZG93blwiOiByb3cgPSByb3cgPj0gbWF4ID8gLTEgOiByb3cgKyAxOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJzdGFydFwiOiByb3cgPSAwOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJlbmRcIjogcm93ID0gbWF4OyBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9wdXAuc2V0Um93KHJvdyk7XG4gICAgfTtcblxuICAgIHRoaXMuaW5zZXJ0TWF0Y2ggPSBmdW5jdGlvbihkYXRhLCBvcHRpb25zKSB7XG4gICAgICAgIGlmICghZGF0YSlcbiAgICAgICAgICAgIGRhdGEgPSB0aGlzLnBvcHVwLmdldERhdGEodGhpcy5wb3B1cC5nZXRSb3coKSk7XG4gICAgICAgIGlmICghZGF0YSlcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgICAgICBpZiAoZGF0YS5jb21wbGV0ZXIgJiYgZGF0YS5jb21wbGV0ZXIuaW5zZXJ0TWF0Y2gpIHtcbiAgICAgICAgICAgIGRhdGEuY29tcGxldGVyLmluc2VydE1hdGNoKHRoaXMuZWRpdG9yLCBkYXRhKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbXBsZXRpb25zLmZpbHRlclRleHQpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2VzID0gdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLmdldEFsbFJhbmdlcygpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCByYW5nZTsgcmFuZ2UgPSByYW5nZXNbaV07IGkrKykge1xuICAgICAgICAgICAgICAgICAgICByYW5nZS5zdGFydC5jb2x1bW4gLT0gdGhpcy5jb21wbGV0aW9ucy5maWx0ZXJUZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc2Vzc2lvbi5yZW1vdmUocmFuZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkYXRhLnNuaXBwZXQpXG4gICAgICAgICAgICAgICAgc25pcHBldE1hbmFnZXIuaW5zZXJ0U25pcHBldCh0aGlzLmVkaXRvciwgZGF0YS5zbmlwcGV0KTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5leGVjQ29tbWFuZChcImluc2VydHN0cmluZ1wiLCBkYXRhLnZhbHVlIHx8IGRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgfTtcblxuXG4gICAgdGhpcy5jb21tYW5kcyA9IHtcbiAgICAgICAgXCJVcFwiOiBmdW5jdGlvbihlZGl0b3IpIHsgZWRpdG9yLmNvbXBsZXRlci5nb1RvKFwidXBcIik7IH0sXG4gICAgICAgIFwiRG93blwiOiBmdW5jdGlvbihlZGl0b3IpIHsgZWRpdG9yLmNvbXBsZXRlci5nb1RvKFwiZG93blwiKTsgfSxcbiAgICAgICAgXCJDdHJsLVVwfEN0cmwtSG9tZVwiOiBmdW5jdGlvbihlZGl0b3IpIHsgZWRpdG9yLmNvbXBsZXRlci5nb1RvKFwic3RhcnRcIik7IH0sXG4gICAgICAgIFwiQ3RybC1Eb3dufEN0cmwtRW5kXCI6IGZ1bmN0aW9uKGVkaXRvcikgeyBlZGl0b3IuY29tcGxldGVyLmdvVG8oXCJlbmRcIik7IH0sXG5cbiAgICAgICAgXCJFc2NcIjogZnVuY3Rpb24oZWRpdG9yKSB7IGVkaXRvci5jb21wbGV0ZXIuZGV0YWNoKCk7IH0sXG4gICAgICAgIFwiUmV0dXJuXCI6IGZ1bmN0aW9uKGVkaXRvcikgeyByZXR1cm4gZWRpdG9yLmNvbXBsZXRlci5pbnNlcnRNYXRjaCgpOyB9LFxuICAgICAgICBcIlNoaWZ0LVJldHVyblwiOiBmdW5jdGlvbihlZGl0b3IpIHsgZWRpdG9yLmNvbXBsZXRlci5pbnNlcnRNYXRjaChudWxsLCB7ZGVsZXRlU3VmZml4OiB0cnVlfSk7IH0sXG4gICAgICAgIFwiVGFiXCI6IGZ1bmN0aW9uKGVkaXRvcikge1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGVkaXRvci5jb21wbGV0ZXIuaW5zZXJ0TWF0Y2goKTtcbiAgICAgICAgICAgIGlmICghcmVzdWx0ICYmICFlZGl0b3IudGFic3RvcE1hbmFnZXIpXG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbXBsZXRlci5nb1RvKFwiZG93blwiKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9LFxuXG4gICAgICAgIFwiUGFnZVVwXCI6IGZ1bmN0aW9uKGVkaXRvcikgeyBlZGl0b3IuY29tcGxldGVyLnBvcHVwLmdvdG9QYWdlVXAoKTsgfSxcbiAgICAgICAgXCJQYWdlRG93blwiOiBmdW5jdGlvbihlZGl0b3IpIHsgZWRpdG9yLmNvbXBsZXRlci5wb3B1cC5nb3RvUGFnZURvd24oKTsgfVxuICAgIH07XG5cbiAgICB0aGlzLmdhdGhlckNvbXBsZXRpb25zID0gZnVuY3Rpb24oZWRpdG9yLCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgc2Vzc2lvbiA9IGVkaXRvci5nZXRTZXNzaW9uKCk7XG4gICAgICAgIHZhciBwb3MgPSBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKTtcblxuICAgICAgICB2YXIgcHJlZml4ID0gdXRpbC5nZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcik7XG5cbiAgICAgICAgdGhpcy5iYXNlID0gc2Vzc2lvbi5kb2MuY3JlYXRlQW5jaG9yKHBvcy5yb3csIHBvcy5jb2x1bW4gLSBwcmVmaXgubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5iYXNlLiRpbnNlcnRSaWdodCA9IHRydWU7XG5cbiAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTtcbiAgICAgICAgdmFyIHRvdGFsID0gZWRpdG9yLmNvbXBsZXRlcnMubGVuZ3RoO1xuICAgICAgICBlZGl0b3IuY29tcGxldGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbXBsZXRlciwgaSkge1xuICAgICAgICAgICAgY29tcGxldGVyLmdldENvbXBsZXRpb25zKGVkaXRvciwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgsIGZ1bmN0aW9uKGVyciwgcmVzdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICghZXJyICYmIHJlc3VsdHMpXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLmNvbmNhdChyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgICAgICAgICAgICAgIHByZWZpeDogdXRpbC5nZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvciksXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZXM6IG1hdGNoZXMsXG4gICAgICAgICAgICAgICAgICAgIGZpbmlzaGVkOiAoLS10b3RhbCA9PT0gMClcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfTtcblxuICAgIHRoaXMuc2hvd1BvcHVwID0gZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICAgIGlmICh0aGlzLmVkaXRvcilcbiAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7XG5cbiAgICAgICAgdGhpcy5hY3RpdmF0ZWQgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yID0gZWRpdG9yO1xuICAgICAgICBpZiAoZWRpdG9yLmNvbXBsZXRlciAhPSB0aGlzKSB7XG4gICAgICAgICAgICBpZiAoZWRpdG9yLmNvbXBsZXRlcilcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tcGxldGVyLmRldGFjaCgpO1xuICAgICAgICAgICAgZWRpdG9yLmNvbXBsZXRlciA9IHRoaXM7XG4gICAgICAgIH1cblxuICAgICAgICBlZGl0b3Iub24oXCJjaGFuZ2VTZWxlY3Rpb25cIiwgdGhpcy5jaGFuZ2VMaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcImJsdXJcIiwgdGhpcy5ibHVyTGlzdGVuZXIpO1xuICAgICAgICBlZGl0b3Iub24oXCJtb3VzZWRvd25cIiwgdGhpcy5tb3VzZWRvd25MaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcIm1vdXNld2hlZWxcIiwgdGhpcy5tb3VzZXdoZWVsTGlzdGVuZXIpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlQ29tcGxldGlvbnMoKTtcbiAgICB9O1xuXG4gICAgdGhpcy51cGRhdGVDb21wbGV0aW9ucyA9IGZ1bmN0aW9uKGtlZXBQb3B1cFBvc2l0aW9uKSB7XG4gICAgICAgIGlmIChrZWVwUG9wdXBQb3NpdGlvbiAmJiB0aGlzLmJhc2UgJiYgdGhpcy5jb21wbGV0aW9ucykge1xuICAgICAgICAgICAgdmFyIHBvcyA9IHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgICAgICB2YXIgcHJlZml4ID0gdGhpcy5lZGl0b3Iuc2Vzc2lvbi5nZXRUZXh0UmFuZ2Uoe3N0YXJ0OiB0aGlzLmJhc2UsIGVuZDogcG9zfSk7XG4gICAgICAgICAgICBpZiAocHJlZml4ID09IHRoaXMuY29tcGxldGlvbnMuZmlsdGVyVGV4dClcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB0aGlzLmNvbXBsZXRpb25zLnNldEZpbHRlcihwcmVmaXgpO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkLmxlbmd0aClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXRhY2goKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkLmxlbmd0aCA9PSAxXG4gICAgICAgICAgICAmJiB0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkWzBdLnZhbHVlID09IHByZWZpeFxuICAgICAgICAgICAgJiYgIXRoaXMuY29tcGxldGlvbnMuZmlsdGVyZWRbMF0uc25pcHBldClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXRhY2goKTtcbiAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKHRoaXMuZWRpdG9yLCBwcmVmaXgsIGtlZXBQb3B1cFBvc2l0aW9uKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB2YXIgX2lkID0gdGhpcy5nYXRoZXJDb21wbGV0aW9uc0lkO1xuICAgICAgICB0aGlzLmdhdGhlckNvbXBsZXRpb25zKHRoaXMuZWRpdG9yLCBmdW5jdGlvbihlcnIsIHJlc3VsdHMpIHtcbiAgICAgICAgICAgIHZhciBkZXRhY2hJZkZpbmlzaGVkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXN1bHRzLmZpbmlzaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgICAgIHZhciBwcmVmaXggPSByZXN1bHRzLnByZWZpeDtcbiAgICAgICAgICAgIHZhciBtYXRjaGVzID0gcmVzdWx0cyAmJiByZXN1bHRzLm1hdGNoZXM7XG5cbiAgICAgICAgICAgIGlmICghbWF0Y2hlcyB8fCAhbWF0Y2hlcy5sZW5ndGgpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICAgICAgICAgIGlmIChwcmVmaXguaW5kZXhPZihyZXN1bHRzLnByZWZpeCkgIT09IDAgfHwgX2lkICE9IHRoaXMuZ2F0aGVyQ29tcGxldGlvbnNJZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMgPSBuZXcgRmlsdGVyZWRMaXN0KG1hdGNoZXMpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5leGFjdE1hdGNoKVxuICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMuZXhhY3RNYXRjaCA9IHRydWU7XG5cbiAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMuc2V0RmlsdGVyKHByZWZpeCk7XG4gICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSB0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkO1xuICAgICAgICAgICAgaWYgKCFmaWx0ZXJlZC5sZW5ndGgpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICAgICAgICAgIGlmIChmaWx0ZXJlZC5sZW5ndGggPT0gMSAmJiBmaWx0ZXJlZFswXS52YWx1ZSA9PSBwcmVmaXggJiYgIWZpbHRlcmVkWzBdLnNuaXBwZXQpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICAgICAgICAgIGlmICh0aGlzLmF1dG9JbnNlcnQgJiYgZmlsdGVyZWQubGVuZ3RoID09IDEgJiYgcmVzdWx0cy5maW5pc2hlZClcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnNlcnRNYXRjaChmaWx0ZXJlZFswXSk7XG5cbiAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKHRoaXMuZWRpdG9yLCBwcmVmaXgsIGtlZXBQb3B1cFBvc2l0aW9uKTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9O1xuXG4gICAgdGhpcy5jYW5jZWxDb250ZXh0TWVudSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmVkaXRvci4kbW91c2VIYW5kbGVyLmNhbmNlbENvbnRleHRNZW51KCk7XG4gICAgfTtcblxuICAgIHRoaXMudXBkYXRlRG9jVG9vbHRpcCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgcG9wdXAgPSB0aGlzLnBvcHVwO1xuICAgICAgICB2YXIgYWxsID0gcG9wdXAuZGF0YTtcbiAgICAgICAgdmFyIHNlbGVjdGVkID0gYWxsICYmIChhbGxbcG9wdXAuZ2V0SG92ZXJlZFJvdygpXSB8fCBhbGxbcG9wdXAuZ2V0Um93KCldKTtcbiAgICAgICAgdmFyIGRvYyA9IG51bGw7XG4gICAgICAgIGlmICghc2VsZWN0ZWQgfHwgIXRoaXMuZWRpdG9yIHx8ICF0aGlzLnBvcHVwLmlzT3BlbilcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmhpZGVEb2NUb29sdGlwKCk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbXBsZXRlcnMuc29tZShmdW5jdGlvbihjb21wbGV0ZXIpIHtcbiAgICAgICAgICAgIGlmIChjb21wbGV0ZXIuZ2V0RG9jVG9vbHRpcClcbiAgICAgICAgICAgICAgICBkb2MgPSBjb21wbGV0ZXIuZ2V0RG9jVG9vbHRpcChzZWxlY3RlZCk7XG4gICAgICAgICAgICByZXR1cm4gZG9jO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFkb2MpXG4gICAgICAgICAgICBkb2MgPSBzZWxlY3RlZDtcblxuICAgICAgICBpZiAodHlwZW9mIGRvYyA9PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgZG9jID0ge2RvY1RleHQ6IGRvY307XG4gICAgICAgIGlmICghZG9jIHx8ICEoZG9jLmRvY0hUTUwgfHwgZG9jLmRvY1RleHQpKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGlkZURvY1Rvb2x0aXAoKTtcbiAgICAgICAgdGhpcy5zaG93RG9jVG9vbHRpcChkb2MpO1xuICAgIH07XG5cbiAgICB0aGlzLnNob3dEb2NUb29sdGlwID0gZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICBpZiAoIXRoaXMudG9vbHRpcE5vZGUpIHtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcE5vZGUgPSBkb20uY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcE5vZGUuY2xhc3NOYW1lID0gXCJhY2VfdG9vbHRpcCBhY2VfZG9jLXRvb2x0aXBcIjtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcE5vZGUuc3R5bGUubWFyZ2luID0gMDtcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcE5vZGUuc3R5bGUucG9pbnRlckV2ZW50cyA9IFwiYXV0b1wiO1xuICAgICAgICAgICAgdGhpcy50b29sdGlwTm9kZS50YWJJbmRleCA9IC0xO1xuICAgICAgICAgICAgdGhpcy50b29sdGlwTm9kZS5vbmJsdXIgPSB0aGlzLmJsdXJMaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgICAgICAgICAgdGhpcy50b29sdGlwTm9kZS5vbmNsaWNrID0gdGhpcy5vblRvb2x0aXBDbGljay5iaW5kKHRoaXMpO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHRvb2x0aXBOb2RlID0gdGhpcy50b29sdGlwTm9kZTtcbiAgICAgICAgaWYgKGl0ZW0uZG9jSFRNTCkge1xuICAgICAgICAgICAgdG9vbHRpcE5vZGUuaW5uZXJIVE1MID0gaXRlbS5kb2NIVE1MO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0uZG9jVGV4dCkge1xuICAgICAgICAgICAgdG9vbHRpcE5vZGUudGV4dENvbnRlbnQgPSBpdGVtLmRvY1RleHQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIXRvb2x0aXBOb2RlLnBhcmVudE5vZGUpXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRvb2x0aXBOb2RlKTtcbiAgICAgICAgdmFyIHBvcHVwID0gdGhpcy5wb3B1cDtcbiAgICAgICAgdmFyIHJlY3QgPSBwb3B1cC5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgIHRvb2x0aXBOb2RlLnN0eWxlLnRvcCA9IHBvcHVwLmNvbnRhaW5lci5zdHlsZS50b3A7XG4gICAgICAgIHRvb2x0aXBOb2RlLnN0eWxlLmJvdHRvbSA9IHBvcHVwLmNvbnRhaW5lci5zdHlsZS5ib3R0b207XG5cbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lcldpZHRoIC0gcmVjdC5yaWdodCA8IDMyMCkge1xuICAgICAgICAgICAgdG9vbHRpcE5vZGUuc3R5bGUucmlnaHQgPSB3aW5kb3cuaW5uZXJXaWR0aCAtIHJlY3QubGVmdCArIFwicHhcIjtcbiAgICAgICAgICAgIHRvb2x0aXBOb2RlLnN0eWxlLmxlZnQgPSBcIlwiO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdG9vbHRpcE5vZGUuc3R5bGUubGVmdCA9IChyZWN0LnJpZ2h0ICsgMSkgKyBcInB4XCI7XG4gICAgICAgICAgICB0b29sdGlwTm9kZS5zdHlsZS5yaWdodCA9IFwiXCI7XG4gICAgICAgIH1cbiAgICAgICAgdG9vbHRpcE5vZGUuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgICB9O1xuXG4gICAgdGhpcy5oaWRlRG9jVG9vbHRpcCA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnRvb2x0aXBUaW1lci5jYW5jZWwoKTtcbiAgICAgICAgaWYgKCF0aGlzLnRvb2x0aXBOb2RlKSByZXR1cm47XG4gICAgICAgIHZhciBlbCA9IHRoaXMudG9vbHRpcE5vZGU7XG4gICAgICAgIGlmICghdGhpcy5lZGl0b3IuaXNGb2N1c2VkKCkgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PSBlbClcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG4gICAgICAgIHRoaXMudG9vbHRpcE5vZGUgPSBudWxsO1xuICAgICAgICBpZiAoZWwucGFyZW50Tm9kZSlcbiAgICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpO1xuICAgIH07XG5cbiAgICB0aGlzLm9uVG9vbHRpcENsaWNrID0gZnVuY3Rpb24oZSkge1xuICAgICAgICB2YXIgYSA9IGUudGFyZ2V0O1xuICAgICAgICB3aGlsZSAoYSAmJiBhICE9IHRoaXMudG9vbHRpcE5vZGUpIHtcbiAgICAgICAgICAgIGlmIChhLm5vZGVOYW1lID09IFwiQVwiICYmIGEuaHJlZikge1xuICAgICAgICAgICAgICAgIGEucmVsID0gXCJub3JlZmVycmVyXCI7XG4gICAgICAgICAgICAgICAgYS50YXJnZXQgPSBcIl9ibGFua1wiO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYSA9IGEucGFyZW50Tm9kZTtcbiAgICAgICAgfVxuICAgIH07XG5cbn0pLmNhbGwoQXV0b2NvbXBsZXRlLnByb3RvdHlwZSk7XG5cbkF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQgPSB7XG4gICAgbmFtZTogXCJzdGFydEF1dG9jb21wbGV0ZVwiLFxuICAgIGV4ZWM6IGZ1bmN0aW9uKGVkaXRvcikge1xuICAgICAgICBpZiAoIWVkaXRvci5jb21wbGV0ZXIpXG4gICAgICAgICAgICBlZGl0b3IuY29tcGxldGVyID0gbmV3IEF1dG9jb21wbGV0ZSgpO1xuICAgICAgICBlZGl0b3IuY29tcGxldGVyLmF1dG9JbnNlcnQgPSBmYWxzZTtcbiAgICAgICAgZWRpdG9yLmNvbXBsZXRlci5hdXRvU2VsZWN0ID0gdHJ1ZTtcbiAgICAgICAgZWRpdG9yLmNvbXBsZXRlci5zaG93UG9wdXAoZWRpdG9yKTtcbiAgICAgICAgZWRpdG9yLmNvbXBsZXRlci5jYW5jZWxDb250ZXh0TWVudSgpO1xuICAgIH0sXG4gICAgYmluZEtleTogXCJDdHJsLVNwYWNlfEN0cmwtU2hpZnQtU3BhY2V8QWx0LVNwYWNlXCJcbn07XG5cbnZhciBGaWx0ZXJlZExpc3QgPSBmdW5jdGlvbihhcnJheSwgZmlsdGVyVGV4dCkge1xuICAgIHRoaXMuYWxsID0gYXJyYXk7XG4gICAgdGhpcy5maWx0ZXJlZCA9IGFycmF5O1xuICAgIHRoaXMuZmlsdGVyVGV4dCA9IGZpbHRlclRleHQgfHwgXCJcIjtcbiAgICB0aGlzLmV4YWN0TWF0Y2ggPSBmYWxzZTtcbn07XG4oZnVuY3Rpb24oKXtcbiAgICB0aGlzLnNldEZpbHRlciA9IGZ1bmN0aW9uKHN0cikge1xuICAgICAgICBpZiAoc3RyLmxlbmd0aCA+IHRoaXMuZmlsdGVyVGV4dCAmJiBzdHIubGFzdEluZGV4T2YodGhpcy5maWx0ZXJUZXh0LCAwKSA9PT0gMClcbiAgICAgICAgICAgIHZhciBtYXRjaGVzID0gdGhpcy5maWx0ZXJlZDtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSB0aGlzLmFsbDtcblxuICAgICAgICB0aGlzLmZpbHRlclRleHQgPSBzdHI7XG4gICAgICAgIG1hdGNoZXMgPSB0aGlzLmZpbHRlckNvbXBsZXRpb25zKG1hdGNoZXMsIHRoaXMuZmlsdGVyVGV4dCk7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLnNvcnQoZnVuY3Rpb24oYSwgYikge1xuICAgICAgICAgICAgcmV0dXJuIGIuZXhhY3RNYXRjaCAtIGEuZXhhY3RNYXRjaCB8fCBiLnNjb3JlIC0gYS5zY29yZTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciBwcmV2ID0gbnVsbDtcbiAgICAgICAgbWF0Y2hlcyA9IG1hdGNoZXMuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0pe1xuICAgICAgICAgICAgdmFyIGNhcHRpb24gPSBpdGVtLnNuaXBwZXQgfHwgaXRlbS5jYXB0aW9uIHx8IGl0ZW0udmFsdWU7XG4gICAgICAgICAgICBpZiAoY2FwdGlvbiA9PT0gcHJldikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgcHJldiA9IGNhcHRpb247XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5maWx0ZXJlZCA9IG1hdGNoZXM7XG4gICAgfTtcbiAgICB0aGlzLmZpbHRlckNvbXBsZXRpb25zID0gZnVuY3Rpb24oaXRlbXMsIG5lZWRsZSkge1xuICAgICAgICB2YXIgcmVzdWx0cyA9IFtdO1xuICAgICAgICB2YXIgdXBwZXIgPSBuZWVkbGUudG9VcHBlckNhc2UoKTtcbiAgICAgICAgdmFyIGxvd2VyID0gbmVlZGxlLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGxvb3A6IGZvciAodmFyIGkgPSAwLCBpdGVtOyBpdGVtID0gaXRlbXNbaV07IGkrKykge1xuICAgICAgICAgICAgdmFyIGNhcHRpb24gPSBpdGVtLnZhbHVlIHx8IGl0ZW0uY2FwdGlvbiB8fCBpdGVtLnNuaXBwZXQ7XG4gICAgICAgICAgICBpZiAoIWNhcHRpb24pIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIGxhc3RJbmRleCA9IC0xO1xuICAgICAgICAgICAgdmFyIG1hdGNoTWFzayA9IDA7XG4gICAgICAgICAgICB2YXIgcGVuYWx0eSA9IDA7XG4gICAgICAgICAgICB2YXIgaW5kZXgsIGRpc3RhbmNlO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5leGFjdE1hdGNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5lZWRsZSAhPT0gY2FwdGlvbi5zdWJzdHIoMCwgbmVlZGxlLmxlbmd0aCkpXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGxvb3A7XG4gICAgICAgICAgICB9ZWxzZXtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IG5lZWRsZS5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaTEgPSBjYXB0aW9uLmluZGV4T2YobG93ZXJbal0sIGxhc3RJbmRleCArIDEpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaTIgPSBjYXB0aW9uLmluZGV4T2YodXBwZXJbal0sIGxhc3RJbmRleCArIDEpO1xuICAgICAgICAgICAgICAgICAgICBpbmRleCA9IChpMSA+PSAwKSA/ICgoaTIgPCAwIHx8IGkxIDwgaTIpID8gaTEgOiBpMikgOiBpMjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMClcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGxvb3A7XG4gICAgICAgICAgICAgICAgICAgIGRpc3RhbmNlID0gaW5kZXggLSBsYXN0SW5kZXggLSAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEluZGV4ID09PSAtMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5hbHR5ICs9IDEwO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGVuYWx0eSArPSBkaXN0YW5jZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBtYXRjaE1hc2sgPSBtYXRjaE1hc2sgfCAoMSA8PCBpbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIGxhc3RJbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW0ubWF0Y2hNYXNrID0gbWF0Y2hNYXNrO1xuICAgICAgICAgICAgaXRlbS5leGFjdE1hdGNoID0gcGVuYWx0eSA/IDAgOiAxO1xuICAgICAgICAgICAgaXRlbS5zY29yZSA9IChpdGVtLnNjb3JlIHx8IDApIC0gcGVuYWx0eTtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9O1xufSkuY2FsbChGaWx0ZXJlZExpc3QucHJvdG90eXBlKTtcblxuZXhwb3J0cy5BdXRvY29tcGxldGUgPSBBdXRvY29tcGxldGU7XG5leHBvcnRzLkZpbHRlcmVkTGlzdCA9IEZpbHRlcmVkTGlzdDtcblxufSk7XG5cbmFjZS5kZWZpbmUoXCJhY2UvYXV0b2NvbXBsZXRlL3RleHRfY29tcGxldGVyXCIsW1wicmVxdWlyZVwiLFwiZXhwb3J0c1wiLFwibW9kdWxlXCIsXCJhY2UvcmFuZ2VcIl0sIGZ1bmN0aW9uKGFjZXF1aXJlLCBleHBvcnRzLCBtb2R1bGUpIHtcbiAgICB2YXIgUmFuZ2UgPSBhY2VxdWlyZShcIi4uL3JhbmdlXCIpLlJhbmdlO1xuICAgIFxuICAgIHZhciBzcGxpdFJlZ2V4ID0gL1teYS16QS1aXzAtOVxcJFxcLVxcdTAwQzAtXFx1MUZGRlxcdTJDMDAtXFx1RDdGRlxcd10rLztcblxuICAgIGZ1bmN0aW9uIGdldFdvcmRJbmRleChkb2MsIHBvcykge1xuICAgICAgICB2YXIgdGV4dEJlZm9yZSA9IGRvYy5nZXRUZXh0UmFuZ2UoUmFuZ2UuZnJvbVBvaW50cyh7cm93OiAwLCBjb2x1bW46MH0sIHBvcykpO1xuICAgICAgICByZXR1cm4gdGV4dEJlZm9yZS5zcGxpdChzcGxpdFJlZ2V4KS5sZW5ndGggLSAxO1xuICAgIH1cbiAgICBmdW5jdGlvbiB3b3JkRGlzdGFuY2UoZG9jLCBwb3MpIHtcbiAgICAgICAgdmFyIHByZWZpeFBvcyA9IGdldFdvcmRJbmRleChkb2MsIHBvcyk7XG4gICAgICAgIHZhciB3b3JkcyA9IGRvYy5nZXRWYWx1ZSgpLnNwbGl0KHNwbGl0UmVnZXgpO1xuICAgICAgICB2YXIgd29yZFNjb3JlcyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIFxuICAgICAgICB2YXIgY3VycmVudFdvcmQgPSB3b3Jkc1twcmVmaXhQb3NdO1xuXG4gICAgICAgIHdvcmRzLmZvckVhY2goZnVuY3Rpb24od29yZCwgaWR4KSB7XG4gICAgICAgICAgICBpZiAoIXdvcmQgfHwgd29yZCA9PT0gY3VycmVudFdvcmQpIHJldHVybjtcblxuICAgICAgICAgICAgdmFyIGRpc3RhbmNlID0gTWF0aC5hYnMocHJlZml4UG9zIC0gaWR4KTtcbiAgICAgICAgICAgIHZhciBzY29yZSA9IHdvcmRzLmxlbmd0aCAtIGRpc3RhbmNlO1xuICAgICAgICAgICAgaWYgKHdvcmRTY29yZXNbd29yZF0pIHtcbiAgICAgICAgICAgICAgICB3b3JkU2NvcmVzW3dvcmRdID0gTWF0aC5tYXgoc2NvcmUsIHdvcmRTY29yZXNbd29yZF0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB3b3JkU2NvcmVzW3dvcmRdID0gc2NvcmU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gd29yZFNjb3JlcztcbiAgICB9XG5cbiAgICBleHBvcnRzLmdldENvbXBsZXRpb25zID0gZnVuY3Rpb24oZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHdvcmRTY29yZSA9IHdvcmREaXN0YW5jZShzZXNzaW9uLCBwb3MsIHByZWZpeCk7XG4gICAgICAgIHZhciB3b3JkTGlzdCA9IE9iamVjdC5rZXlzKHdvcmRTY29yZSk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHdvcmRMaXN0Lm1hcChmdW5jdGlvbih3b3JkKSB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGNhcHRpb246IHdvcmQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHdvcmQsXG4gICAgICAgICAgICAgICAgc2NvcmU6IHdvcmRTY29yZVt3b3JkXSxcbiAgICAgICAgICAgICAgICBtZXRhOiBcImxvY2FsXCJcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pKTtcbiAgICB9O1xufSk7XG5cbmFjZS5kZWZpbmUoXCJhY2UvZXh0L2xhbmd1YWdlX3Rvb2xzXCIsW1wicmVxdWlyZVwiLFwiZXhwb3J0c1wiLFwibW9kdWxlXCIsXCJhY2Uvc25pcHBldHNcIixcImFjZS9hdXRvY29tcGxldGVcIixcImFjZS9jb25maWdcIixcImFjZS9saWIvbGFuZ1wiLFwiYWNlL2F1dG9jb21wbGV0ZS91dGlsXCIsXCJhY2UvYXV0b2NvbXBsZXRlL3RleHRfY29tcGxldGVyXCIsXCJhY2UvZWRpdG9yXCIsXCJhY2UvY29uZmlnXCJdLCBmdW5jdGlvbihhY2VxdWlyZSwgZXhwb3J0cywgbW9kdWxlKSB7XG5cInVzZSBzdHJpY3RcIjtcblxudmFyIHNuaXBwZXRNYW5hZ2VyID0gYWNlcXVpcmUoXCIuLi9zbmlwcGV0c1wiKS5zbmlwcGV0TWFuYWdlcjtcbnZhciBBdXRvY29tcGxldGUgPSBhY2VxdWlyZShcIi4uL2F1dG9jb21wbGV0ZVwiKS5BdXRvY29tcGxldGU7XG52YXIgY29uZmlnID0gYWNlcXVpcmUoXCIuLi9jb25maWdcIik7XG52YXIgbGFuZyA9IGFjZXF1aXJlKFwiLi4vbGliL2xhbmdcIik7XG52YXIgdXRpbCA9IGFjZXF1aXJlKFwiLi4vYXV0b2NvbXBsZXRlL3V0aWxcIik7XG5cbnZhciB0ZXh0Q29tcGxldGVyID0gYWNlcXVpcmUoXCIuLi9hdXRvY29tcGxldGUvdGV4dF9jb21wbGV0ZXJcIik7XG52YXIga2V5V29yZENvbXBsZXRlciA9IHtcbiAgICBnZXRDb21wbGV0aW9uczogZnVuY3Rpb24oZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgY2FsbGJhY2spIHtcbiAgICAgICAgaWYgKHNlc3Npb24uJG1vZGUuY29tcGxldGVyKSB7XG4gICAgICAgICAgICByZXR1cm4gc2Vzc2lvbi4kbW9kZS5jb21wbGV0ZXIuZ2V0Q29tcGxldGlvbnMoZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgY2FsbGJhY2spO1xuICAgICAgICB9XG4gICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5zZXNzaW9uLmdldFN0YXRlKHBvcy5yb3cpO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBzZXNzaW9uLiRtb2RlLmdldENvbXBsZXRpb25zKHN0YXRlLCBzZXNzaW9uLCBwb3MsIHByZWZpeCk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGNvbXBsZXRpb25zKTtcbiAgICB9XG59O1xuXG52YXIgc25pcHBldENvbXBsZXRlciA9IHtcbiAgICBnZXRDb21wbGV0aW9uczogZnVuY3Rpb24oZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSBzbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgc25pcHBldE1hbmFnZXIuZ2V0QWN0aXZlU2NvcGVzKGVkaXRvcikuZm9yRWFjaChmdW5jdGlvbihzY29wZSkge1xuICAgICAgICAgICAgdmFyIHNuaXBwZXRzID0gc25pcHBldE1hcFtzY29wZV0gfHwgW107XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gc25pcHBldHMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICAgICAgdmFyIHMgPSBzbmlwcGV0c1tpXTtcbiAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbiA9IHMubmFtZSB8fCBzLnRhYlRyaWdnZXI7XG4gICAgICAgICAgICAgICAgaWYgKCFjYXB0aW9uKVxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBjb21wbGV0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbjogY2FwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldDogcy5jb250ZW50LFxuICAgICAgICAgICAgICAgICAgICBtZXRhOiBzLnRhYlRyaWdnZXIgJiYgIXMubmFtZSA/IHMudGFiVHJpZ2dlciArIFwiXFx1MjFFNSBcIiA6IFwic25pcHBldFwiLFxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInNuaXBwZXRcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgY29tcGxldGlvbnMpO1xuICAgIH0sXG4gICAgZ2V0RG9jVG9vbHRpcDogZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICBpZiAoaXRlbS50eXBlID09IFwic25pcHBldFwiICYmICFpdGVtLmRvY0hUTUwpIHtcbiAgICAgICAgICAgIGl0ZW0uZG9jSFRNTCA9IFtcbiAgICAgICAgICAgICAgICBcIjxiPlwiLCBsYW5nLmVzY2FwZUhUTUwoaXRlbS5jYXB0aW9uKSwgXCI8L2I+XCIsIFwiPGhyPjwvaHI+XCIsXG4gICAgICAgICAgICAgICAgbGFuZy5lc2NhcGVIVE1MKGl0ZW0uc25pcHBldClcbiAgICAgICAgICAgIF0uam9pbihcIlwiKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbnZhciBjb21wbGV0ZXJzID0gW3NuaXBwZXRDb21wbGV0ZXIsIHRleHRDb21wbGV0ZXIsIGtleVdvcmRDb21wbGV0ZXJdO1xuZXhwb3J0cy5zZXRDb21wbGV0ZXJzID0gZnVuY3Rpb24odmFsKSB7XG4gICAgY29tcGxldGVycy5sZW5ndGggPSAwO1xuICAgIGlmICh2YWwpIGNvbXBsZXRlcnMucHVzaC5hcHBseShjb21wbGV0ZXJzLCB2YWwpO1xufTtcbmV4cG9ydHMuYWRkQ29tcGxldGVyID0gZnVuY3Rpb24oY29tcGxldGVyKSB7XG4gICAgY29tcGxldGVycy5wdXNoKGNvbXBsZXRlcik7XG59O1xuZXhwb3J0cy50ZXh0Q29tcGxldGVyID0gdGV4dENvbXBsZXRlcjtcbmV4cG9ydHMua2V5V29yZENvbXBsZXRlciA9IGtleVdvcmRDb21wbGV0ZXI7XG5leHBvcnRzLnNuaXBwZXRDb21wbGV0ZXIgPSBzbmlwcGV0Q29tcGxldGVyO1xuXG52YXIgZXhwYW5kU25pcHBldCA9IHtcbiAgICBuYW1lOiBcImV4cGFuZFNuaXBwZXRcIixcbiAgICBleGVjOiBmdW5jdGlvbihlZGl0b3IpIHtcbiAgICAgICAgcmV0dXJuIHNuaXBwZXRNYW5hZ2VyLmV4cGFuZFdpdGhUYWIoZWRpdG9yKTtcbiAgICB9LFxuICAgIGJpbmRLZXk6IFwiVGFiXCJcbn07XG5cbnZhciBvbkNoYW5nZU1vZGUgPSBmdW5jdGlvbihlLCBlZGl0b3IpIHtcbiAgICBsb2FkU25pcHBldHNGb3JNb2RlKGVkaXRvci5zZXNzaW9uLiRtb2RlKTtcbn07XG5cbnZhciBsb2FkU25pcHBldHNGb3JNb2RlID0gZnVuY3Rpb24obW9kZSkge1xuICAgIHZhciBpZCA9IG1vZGUuJGlkO1xuICAgIGlmICghc25pcHBldE1hbmFnZXIuZmlsZXMpXG4gICAgICAgIHNuaXBwZXRNYW5hZ2VyLmZpbGVzID0ge307XG4gICAgbG9hZFNuaXBwZXRGaWxlKGlkKTtcbiAgICBpZiAobW9kZS5tb2RlcylcbiAgICAgICAgbW9kZS5tb2Rlcy5mb3JFYWNoKGxvYWRTbmlwcGV0c0Zvck1vZGUpO1xufTtcblxudmFyIGxvYWRTbmlwcGV0RmlsZSA9IGZ1bmN0aW9uKGlkKSB7XG4gICAgaWYgKCFpZCB8fCBzbmlwcGV0TWFuYWdlci5maWxlc1tpZF0pXG4gICAgICAgIHJldHVybjtcbiAgICB2YXIgc25pcHBldEZpbGVQYXRoID0gaWQucmVwbGFjZShcIm1vZGVcIiwgXCJzbmlwcGV0c1wiKTtcbiAgICBzbmlwcGV0TWFuYWdlci5maWxlc1tpZF0gPSB7fTtcbiAgICBjb25maWcubG9hZE1vZHVsZShzbmlwcGV0RmlsZVBhdGgsIGZ1bmN0aW9uKG0pIHtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyLmZpbGVzW2lkXSA9IG07XG4gICAgICAgICAgICBpZiAoIW0uc25pcHBldHMgJiYgbS5zbmlwcGV0VGV4dClcbiAgICAgICAgICAgICAgICBtLnNuaXBwZXRzID0gc25pcHBldE1hbmFnZXIucGFyc2VTbmlwcGV0RmlsZShtLnNuaXBwZXRUZXh0KTtcbiAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyLnJlZ2lzdGVyKG0uc25pcHBldHMgfHwgW10sIG0uc2NvcGUpO1xuICAgICAgICAgICAgaWYgKG0uaW5jbHVkZVNjb3Blcykge1xuICAgICAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyLnNuaXBwZXRNYXBbbS5zY29wZV0uaW5jbHVkZVNjb3BlcyA9IG0uaW5jbHVkZVNjb3BlcztcbiAgICAgICAgICAgICAgICBtLmluY2x1ZGVTY29wZXMuZm9yRWFjaChmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRTbmlwcGV0RmlsZShcImFjZS9tb2RlL1wiICsgeCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbnZhciBkb0xpdmVBdXRvY29tcGxldGUgPSBmdW5jdGlvbihlKSB7XG4gICAgdmFyIGVkaXRvciA9IGUuZWRpdG9yO1xuICAgIHZhciBoYXNDb21wbGV0ZXIgPSBlZGl0b3IuY29tcGxldGVyICYmIGVkaXRvci5jb21wbGV0ZXIuYWN0aXZhdGVkO1xuICAgIGlmIChlLmNvbW1hbmQubmFtZSA9PT0gXCJiYWNrc3BhY2VcIikge1xuICAgICAgICBpZiAoaGFzQ29tcGxldGVyICYmICF1dGlsLmdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yKSlcbiAgICAgICAgICAgIGVkaXRvci5jb21wbGV0ZXIuZGV0YWNoKCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGUuY29tbWFuZC5uYW1lID09PSBcImluc2VydHN0cmluZ1wiKSB7XG4gICAgICAgIHZhciBwcmVmaXggPSB1dGlsLmdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yKTtcbiAgICAgICAgaWYgKHByZWZpeCAmJiAhaGFzQ29tcGxldGVyKSB7XG4gICAgICAgICAgICBpZiAoIWVkaXRvci5jb21wbGV0ZXIpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tcGxldGVyID0gbmV3IEF1dG9jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWRpdG9yLmNvbXBsZXRlci5hdXRvSW5zZXJ0ID0gZmFsc2U7XG4gICAgICAgICAgICBlZGl0b3IuY29tcGxldGVyLnNob3dQb3B1cChlZGl0b3IpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxudmFyIEVkaXRvciA9IGFjZXF1aXJlKFwiLi4vZWRpdG9yXCIpLkVkaXRvcjtcbmFjZXF1aXJlKFwiLi4vY29uZmlnXCIpLmRlZmluZU9wdGlvbnMoRWRpdG9yLnByb3RvdHlwZSwgXCJlZGl0b3JcIiwge1xuICAgIGVuYWJsZUJhc2ljQXV0b2NvbXBsZXRpb246IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY29tcGxldGVycylcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21wbGV0ZXJzID0gQXJyYXkuaXNBcnJheSh2YWwpPyB2YWw6IGNvbXBsZXRlcnM7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21tYW5kcy5hZGRDb21tYW5kKEF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRzLnJlbW92ZUNvbW1hbmQoQXV0b2NvbXBsZXRlLnN0YXJ0Q29tbWFuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH0sXG4gICAgZW5hYmxlTGl2ZUF1dG9jb21wbGV0aW9uOiB7XG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbXBsZXRlcnMpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGVycyA9IEFycmF5LmlzQXJyYXkodmFsKT8gdmFsOiBjb21wbGV0ZXJzO1xuICAgICAgICAgICAgICAgIHRoaXMuY29tbWFuZHMub24oJ2FmdGVyRXhlYycsIGRvTGl2ZUF1dG9jb21wbGV0ZSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlTGlzdGVuZXIoJ2FmdGVyRXhlYycsIGRvTGl2ZUF1dG9jb21wbGV0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH0sXG4gICAgZW5hYmxlU25pcHBldHM6IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRzLmFkZENvbW1hbmQoZXhwYW5kU25pcHBldCk7XG4gICAgICAgICAgICAgICAgdGhpcy5vbihcImNoYW5nZU1vZGVcIiwgb25DaGFuZ2VNb2RlKTtcbiAgICAgICAgICAgICAgICBvbkNoYW5nZU1vZGUobnVsbCwgdGhpcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuY29tbWFuZHMucmVtb3ZlQ29tbWFuZChleHBhbmRTbmlwcGV0KTtcbiAgICAgICAgICAgICAgICB0aGlzLm9mZihcImNoYW5nZU1vZGVcIiwgb25DaGFuZ2VNb2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdmFsdWU6IGZhbHNlXG4gICAgfVxufSk7XG59KTtcbiAgICAgICAgICAgICAgICAoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjZS5hY2VxdWlyZShbXCJhY2UvZXh0L2xhbmd1YWdlX3Rvb2xzXCJdLCBmdW5jdGlvbigpIHt9KTtcbiAgICAgICAgICAgICAgICB9KSgpO1xuICAgICAgICAgICAgIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9