"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3082],{"./public/app/features/api-keys/ApiKeysPage.tsx":(e,s,t)=>{t.r(s),t.d(s,{ApiKeysPageUnconnected:()=>X,default:()=>ee});var n=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),i=t("./.yarn/__virtual__/react-redux-virtual-7ad20a440e/0/cache/react-redux-npm-7.2.6-134f5ed64d-0bf142ce0d.zip/node_modules/react-redux/es/index.js"),a=t("./packages/grafana-data/src/index.ts"),o=t("./packages/grafana-ui/src/index.ts"),r=t("./public/app/core/app_events.ts"),l=t("./public/app/core/components/EmptyListCTA/EmptyListCTA.tsx"),c=t("./public/app/core/components/Page/Page.tsx"),d=t("./public/app/core/config.ts"),p=t("./public/app/core/core.ts"),u=t("./public/app/core/selectors/navModel.ts"),h=t("./public/app/features/profile/state/selectors.ts"),y=t("./public/app/types/index.ts"),x=t("./public/app/types/events.ts"),m=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const g=e=>{let{searchQuery:s,disabled:t,onAddClick:n,onSearchChange:i}=e;return(0,m.jsxs)("div",{className:"page-action-bar",children:[(0,m.jsx)("div",{className:"gf-form gf-form--grow",children:(0,m.jsx)(o.FilterInput,{placeholder:"Search keys",value:s,onChange:i})}),(0,m.jsx)(o.Button,{className:"pull-right",onClick:n,disabled:t,children:"Add API key"})]})};var b,f,j,v=t("./.yarn/__virtual__/@emotion-css-virtual-72c314ddb1/0/cache/@emotion-css-npm-11.7.1-25ff8755a7-ac1f56656f.zip/node_modules/@emotion/css/dist/emotion-css.esm.js"),A=t("./public/app/core/actions/index.ts"),k=t("./public/app/core/copy/appNotification.ts"),C=t("./public/app/store/store.ts");function K(e){let{onDismiss:s,apiKey:t,rootPath:i}=e;const a=(0,o.useStyles2)(I),r=(0,n.useCallback)((()=>t),[t]);return(0,m.jsxs)(o.Modal,{title:"API Key Created",onDismiss:s,onClickBackdrop:s,isOpen:!0,children:[(0,m.jsx)(o.Field,{label:"Key",children:(0,m.jsx)(o.Input,{id:"Key",value:t,readOnly:!0,addonAfter:(0,m.jsxs)(o.ClipboardButton,{variant:"primary",getText:r,onClipboardCopy:()=>{(0,C.WI)((0,A.$l)((0,k.AT)("Content copied to clipboard")))},children:[b||(b=(0,m.jsx)(o.Icon,{name:"copy"}))," Copy"]})})}),f||(f=(0,m.jsx)(o.Alert,{severity:"info",title:"You will only be able to view this key here once!",children:"It is not stored in this form, so be sure to copy it now."})),j||(j=(0,m.jsx)("p",{className:"text-muted",children:"You can authenticate a request using the Authorization HTTP header, example:"})),(0,m.jsxs)("pre",{className:a.small,children:['curl -H "Authorization: Bearer ',t,'" ',i,"/api/dashboards/home"]})]})}function I(e){return{label:v.css`
      padding: ${e.spacing(1)};
      background-color: ${e.colors.background.secondary};
      border-radius: ${e.shape.borderRadius()};
    `,small:v.css`
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.bodySmall.fontWeight};
    `}}const w=e=>{let{children:s}=e;const[t,i]=(0,n.useState)(!1),a=(0,n.useCallback)((()=>{i(!t)}),[t]);return s({isAdding:t,toggleIsAdding:a})};var E,P,S=t("./public/app/core/components/CloseButton/CloseButton.tsx"),N=t("./public/app/core/components/Animations/SlideDown.tsx");const{Input:T}=o.LegacyForms,D=Object.keys(y.B5).map((e=>({label:e,value:e})));function _(e){if(!e)return!0;try{return a.rangeUtil.intervalToSeconds(e),!0}catch{}return!1}const B={[o.EventsWithValidation.onBlur]:[{rule:_,errorMessage:"Not a valid duration"}]},F=e=>{let{show:s,onClose:t,onKeyAdded:i,disabled:a}=e;const[r,l]=(0,n.useState)(""),[c,d]=(0,n.useState)(y.B5.Viewer),[p,u]=(0,n.useState)("");(0,n.useEffect)((()=>{l(""),d(y.B5.Viewer),u("")}),[s]);return(0,m.jsx)(N.s,{in:s,children:(0,m.jsxs)("div",{className:"gf-form-inline cta-form",children:[(0,m.jsx)(S.P,{onClick:t}),(0,m.jsxs)("form",{className:"gf-form-group",onSubmit:e=>{e.preventDefault(),_(p)&&(i({name:r,role:c,secondsToLive:p}),t())},children:[E||(E=(0,m.jsx)("h5",{children:"Add API Key"})),(0,m.jsxs)("div",{className:"gf-form-inline",children:[(0,m.jsxs)("div",{className:"gf-form max-width-21",children:[P||(P=(0,m.jsx)("span",{className:"gf-form-label",children:"Key name"})),(0,m.jsx)(T,{type:"text",className:"gf-form-input",value:r,placeholder:"Name",onChange:e=>{l(e.currentTarget.value)}})]}),(0,m.jsx)("div",{className:"gf-form",children:(0,m.jsx)(o.InlineField,{label:"Role",children:(0,m.jsx)(o.Select,{inputId:"role-select",value:c,onChange:e=>{d(e.value)},options:D})})}),(0,m.jsx)("div",{className:"gf-form max-width-21",children:(0,m.jsx)(o.InlineField,{tooltip:"The API key life duration. For example, 1d if your key is going to last for one day. Supported units are: s,m,h,d,w,M,y",label:"Time to live",children:(0,m.jsx)(T,{id:"time-to-live-input",type:"text",placeholder:"1d",validationEvents:B,value:p,onChange:e=>{u(e.currentTarget.value)}})})}),(0,m.jsx)("div",{className:"gf-form",children:(0,m.jsx)(o.Button,{type:"submit",disabled:a,children:"Add"})})]})]})]})})};var Z,M,Q;const z=e=>{let{apiKeys:s,timeZone:t,onDelete:n}=e;const i=(0,o.useTheme2)(),a=L(i);return(0,m.jsxs)("table",{className:"filter-table",children:[(0,m.jsx)("thead",{children:(0,m.jsxs)("tr",{children:[Z||(Z=(0,m.jsx)("th",{children:"Name"})),M||(M=(0,m.jsx)("th",{children:"Role"})),Q||(Q=(0,m.jsx)("th",{children:"Expires"})),(0,m.jsx)("th",{style:{width:"34px"}})]})}),s.length>0?(0,m.jsx)("tbody",{children:s.map((e=>{const s=Boolean(e.expiration&&Date.now()>new Date(e.expiration).getTime());return(0,m.jsxs)("tr",{className:a.tableRow(s),children:[(0,m.jsx)("td",{children:e.name}),(0,m.jsx)("td",{children:e.role}),(0,m.jsxs)("td",{children:[$(e.expiration,t),s&&(0,m.jsx)("span",{className:a.tooltipContainer,children:(0,m.jsx)(o.Tooltip,{content:"This API key has expired.",children:(0,m.jsx)(o.Icon,{name:"exclamation-triangle"})})})]}),(0,m.jsx)("td",{children:(0,m.jsx)(o.DeleteButton,{"aria-label":"Delete API key",size:"sm",onConfirm:()=>n(e),disabled:!p.Vt.hasPermissionInMetadata(y.bW.ActionAPIKeysDelete,e)})})]},e.id)}))}):null]})};function $(e,s){return e?(0,a.dateTimeFormat)(e,{timeZone:s}):"No expiration date"}const L=e=>({tableRow:s=>v.css`
    color: ${s?e.colors.text.secondary:e.colors.text.primary};
  `,tooltipContainer:v.css`
    margin-left: ${e.spacing(1)};
  `});var R=t("./public/app/core/services/backend_srv.ts"),O=t("./public/app/features/api-keys/state/reducers.ts");function V(){return async e=>{e((0,O.dF)());const[s,t]=await Promise.all([(0,R.i)().get("/api/auth/keys?includeExpired=false&accesscontrol=true"),(0,R.i)().get("/api/auth/keys?includeExpired=true&accesscontrol=true")]);e((0,O.iK)({keys:s,keysIncludingExpired:t}))}}const W=e=>e.includeExpired?e.keysIncludingExpired.length:e.keys.length,U=e=>{const s=RegExp(e.searchQuery,"i");return(e.includeExpired?e.keysIncludingExpired:e.keys).filter((e=>s.test(e.name)||s.test(e.role)))},q=e=>e.includeExpired,Y=e=>0===e.keys.length&&e.keysIncludingExpired.length>0;function H(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}const G={loadApiKeys:V,deleteApiKey:function(e){return async s=>{(0,R.i)().delete(`/api/auth/keys/${e}`).then((()=>s(V())))}},setSearchQuery:O.ql,toggleIncludeExpired:function(){return e=>{e((0,O.j4)())}},addApiKey:function(e,s){return async t=>{const n=await(0,R.i)().post("/api/auth/keys",e);t((0,O.ql)("")),t(V()),s(n.key)}}},J=(0,i.connect)((function(e){const s=p.Vt.hasAccess(y.bW.ActionAPIKeysCreate,!0);return{navModel:(0,u.h)(e.navIndex,"apikeys"),apiKeys:U(e.apiKeys),searchQuery:e.apiKeys.searchQuery,apiKeysCount:W(e.apiKeys),hasFetched:e.apiKeys.hasFetched,timeZone:(0,h.Z)(e.user),includeExpired:q(e.apiKeys),includeExpiredDisabled:Y(e.apiKeys),canCreate:s}}),G);class X extends n.PureComponent{constructor(e){super(e),H(this,"onDeleteApiKey",(e=>{this.props.deleteApiKey(e.id)})),H(this,"onSearchQueryChange",(e=>{this.props.setSearchQuery(e)})),H(this,"onIncludeExpiredChange",(e=>{this.props.toggleIncludeExpired()})),H(this,"onAddApiKey",(e=>{const s=e=>{const s=window.location.origin+d.ZP.appSubUrl;r.Z.publish(new x.Dn({props:{apiKey:e,rootPath:s},component:K}))},t=e.secondsToLive;try{const n=t?a.rangeUtil.intervalToSeconds(t):null,i=Object.assign({},e,{secondsToLive:n});this.props.addApiKey(i,s),this.setState((e=>Object.assign({},e,{isAdding:!1})))}catch(e){}}))}componentDidMount(){this.fetchApiKeys()}async fetchApiKeys(){await this.props.loadApiKeys()}render(){const{hasFetched:e,navModel:s,apiKeysCount:t,apiKeys:n,searchQuery:i,timeZone:a,includeExpired:r,includeExpiredDisabled:d,canCreate:p}=this.props;return e?(0,m.jsx)(c.Z,{navModel:s,children:(0,m.jsx)(c.Z.Contents,{isLoading:!1,children:(0,m.jsx)(w,{children:e=>{let{isAdding:s,toggleIsAdding:c}=e;const u=!s&&0===t,h=t>0;return(0,m.jsxs)(m.Fragment,{children:[u?(0,m.jsx)(l.Z,{title:"You haven't added any API keys yet.",buttonIcon:"key-skeleton-alt",onClick:c,buttonTitle:"New API key",proTip:"Remember, you can provide view-only API access to other applications.",buttonDisabled:!p}):null,h?(0,m.jsx)(g,{searchQuery:i,disabled:s||!p,onAddClick:c,onSearchChange:this.onSearchQueryChange}):null,(0,m.jsx)(F,{show:s,onClose:c,onKeyAdded:this.onAddApiKey,disabled:!p}),h?(0,m.jsxs)(o.VerticalGroup,{children:[(0,m.jsx)(o.InlineField,{disabled:d,label:"Include expired keys",children:(0,m.jsx)(o.InlineSwitch,{id:"showExpired",value:r,onChange:this.onIncludeExpiredChange})}),(0,m.jsx)(z,{apiKeys:n,timeZone:a,onDelete:this.onDeleteApiKey})]}):null]})}})})}):(0,m.jsx)(c.Z,{navModel:s,children:(0,m.jsx)(c.Z.Contents,{isLoading:!0})})}}const ee=J(X)}}]);