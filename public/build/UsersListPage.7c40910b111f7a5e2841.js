"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8039],{"./public/app/features/users/UsersListPage.tsx":(e,s,t)=>{t.r(s),t.d(s,{UsersListPage:()=>Q,default:()=>W});var n=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),r=t("./.yarn/__virtual__/react-redux-virtual-7ad20a440e/0/cache/react-redux-npm-7.2.6-134f5ed64d-0bf142ce0d.zip/node_modules/react-redux/es/index.js"),a=t("./packages/grafana-data/src/index.ts"),i=t("./packages/grafana-ui/src/index.ts"),c=t("./public/app/core/components/Page/Page.tsx"),l=t("./public/app/core/selectors/navModel.ts"),o=t("./public/app/features/invites/state/actions.ts"),d=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const u={revokeInvite:o.GY},h=(0,r.connect)(null,u);const p=h(class extends n.PureComponent{render(){const{invitee:e,revokeInvite:s}=this.props;return(0,d.jsxs)("tr",{children:[(0,d.jsx)("td",{children:e.email}),(0,d.jsx)("td",{children:e.name}),(0,d.jsxs)("td",{className:"text-right",children:[(0,d.jsx)(i.ClipboardButton,{variant:"secondary",size:"sm",getText:()=>e.url,children:"Copy Invite"}),"Â "]}),(0,d.jsx)("td",{children:(0,d.jsx)(i.Button,{variant:"destructive",size:"sm",icon:"times",onClick:()=>s(e.code)})})]})}});var x,m,g;class v extends n.PureComponent{render(){const{invitees:e}=this.props;return(0,d.jsxs)("table",{className:"filter-table form-inline",children:[(0,d.jsx)("thead",{children:(0,d.jsxs)("tr",{children:[x||(x=(0,d.jsx)("th",{children:"Email"})),m||(m=(0,d.jsx)("th",{children:"Name"})),g||(g=(0,d.jsx)("th",{})),(0,d.jsx)("th",{style:{width:"34px"}})]})}),(0,d.jsx)("tbody",{children:e.map((e,s)=>(0,d.jsx)(p,{invitee:e},`${e.id}-${s}`))})]})}}var j=t("./.yarn/cache/reselect-npm-4.1.5-bc046e41ae-54c13c1e79.zip/node_modules/reselect/es/index.js"),b=t("./public/app/features/invites/state/reducers.ts");const{selectAll:f,selectById:I,selectTotal:U}=b.wl,y=(0,j.P1)([f,(e,s)=>s],(e,s)=>{const t=new RegExp(s,"i");return e.filter(e=>t.test(e.name)||t.test(e.email))});var w=t("./public/app/core/core.ts"),P=t("./public/app/types/index.ts"),k=t("./public/app/features/users/state/reducers.ts");const C=e=>{const s=new RegExp(e.searchQuery,"i");return e.users.filter(e=>s.test(e.login)||s.test(e.email)||s.test(e.name))},R=e=>e.searchQuery,M=e=>e.searchPage;var N;const S={setUsersSearchQuery:k.oX},L=(0,r.connect)(function(e){return{searchQuery:R(e.users),pendingInvitesCount:U(e.invites),externalUserMngLinkName:e.users.externalUserMngLinkName,externalUserMngLinkUrl:e.users.externalUserMngLinkUrl,canInvite:e.users.canInvite}},S)(class extends n.PureComponent{render(){const{canInvite:e,externalUserMngLinkName:s,externalUserMngLinkUrl:t,searchQuery:n,pendingInvitesCount:r,setUsersSearchQuery:a,onShowInvites:c,showInvites:l}=this.props,o=[{label:"Users",value:"users"},{label:`Pending Invites (${r})`,value:"invites"}],u=w.Vt.hasAccess(P.bW.UsersCreate,e);return(0,d.jsxs)("div",{className:"page-action-bar",children:[(0,d.jsx)("div",{className:"gf-form gf-form--grow",children:(0,d.jsx)(i.FilterInput,{value:n,onChange:a,placeholder:"Search user by login, email or name"})}),r>0&&(0,d.jsx)("div",{style:{marginLeft:"1rem"},children:(0,d.jsx)(i.RadioButtonGroup,{value:l?"invites":"users",options:o,onChange:c})}),u&&(N||(N=(0,d.jsx)(i.LinkButton,{href:"org/users/invite",children:"Invite"}))),t&&(0,d.jsx)(i.LinkButton,{href:t,target:"_blank",rel:"noopener",children:s})]})}});var _=t("./public/app/features/users/UsersTable.tsx"),B=t("./packages/grafana-runtime/src/index.ts"),z=t("./public/app/core/utils/accessControl.ts");function A(){return async e=>{const s=await(0,B.getBackendSrv)().get("/api/org/users",(0,z.y)());e((0,k.eT)(s))}}function T(e,s,t){return s in e?Object.defineProperty(e,s,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[s]=t,e}const V={loadUsers:A,fetchInvitees:o.nW,setUsersSearchQuery:k.oX,setUsersSearchPage:k.TQ,updateUser:function(e){return async s=>{await(0,B.getBackendSrv)().patch(`/api/org/users/${e.userId}`,{role:e.role}),s(A())}},removeUser:function(e){return async s=>{await(0,B.getBackendSrv)().delete(`/api/org/users/${e}`),s(A())}}},E=(0,r.connect)(function(e){const s=R(e.users);return{navModel:(0,l.h)(e.navIndex,"users"),users:C(e.users),searchQuery:R(e.users),searchPage:M(e.users),invitees:y(e.invites,s),externalUserMngInfo:e.users.externalUserMngInfo,hasFetched:e.users.hasFetched}},V),O=30;class Q extends n.PureComponent{constructor(e){super(e),T(this,"onRoleChange",(e,s)=>{const t=Object.assign({},s,{role:e});this.props.updateUser(t)}),T(this,"onShowInvites",()=>{this.setState(e=>({showInvites:!e.showInvites}))}),T(this,"getPaginatedUsers",e=>{const s=(this.props.searchPage-1)*O;return e.slice(s,s+O)}),this.props.externalUserMngInfo&&(this.externalUserMngInfoHtml=(0,a.renderMarkdown)(this.props.externalUserMngInfo)),this.state={showInvites:!1}}componentDidMount(){this.fetchUsers(),this.fetchInvitees()}async fetchUsers(){return await this.props.loadUsers()}async fetchInvitees(){return await this.props.fetchInvitees()}renderTable(){const{invitees:e,users:s,setUsersSearchPage:t}=this.props,n=this.getPaginatedUsers(s),r=Math.ceil(s.length/O);return this.state.showInvites?(0,d.jsx)(v,{invitees:e}):(0,d.jsxs)(i.VerticalGroup,{spacing:"md",children:[(0,d.jsx)(_.Z,{users:n,onRoleChange:(e,s)=>this.onRoleChange(e,s),onRemoveUser:e=>this.props.removeUser(e.userId)}),(0,d.jsx)(i.HorizontalGroup,{justify:"flex-end",children:(0,d.jsx)(i.Pagination,{onNavigate:t,currentPage:this.props.searchPage,numberOfPages:r,hideWhenSinglePage:!0})})]})}render(){const{navModel:e,hasFetched:s}=this.props,t=this.externalUserMngInfoHtml;return(0,d.jsx)(c.Z,{navModel:e,children:(0,d.jsx)(c.Z.Contents,{isLoading:!s,children:(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(L,{onShowInvites:this.onShowInvites,showInvites:this.state.showInvites}),t&&(0,d.jsx)("div",{className:"grafana-info-box",dangerouslySetInnerHTML:{__html:t}}),s&&this.renderTable()]})})})}}const W=E(Q)},"./public/app/features/users/UsersTable.tsx":(e,s,t)=>{t.d(s,{Z:()=>v});var n,r,a,i,c,l,o=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/index.js"),d=t("./packages/grafana-ui/src/index.ts"),u=t("./public/app/core/components/RolePicker/UserRolePicker.tsx"),h=t("./public/app/core/components/RolePicker/api.ts"),p=t("./public/app/core/core.ts"),x=t("./public/app/types/index.ts"),m=t("./public/app/features/admin/OrgRolePicker.tsx"),g=t("./.yarn/cache/react-npm-17.0.2-99ba37d931-b254cc17ce.zip/node_modules/react/jsx-runtime.js");const v=e=>{const{users:s,orgId:t,onRoleChange:v,onRemoveUser:j}=e,[b,f]=(0,o.useState)(null),[I,U]=(0,o.useState)([]),[y,w]=(0,o.useState)({});return(0,o.useEffect)(()=>{p.Vt.licensedAccessControlEnabled()&&async function(){try{if(p.Vt.hasPermission(x.bW.ActionRolesList)){let e=await(0,h.ul)(t);U(e)}if(!p.Vt.accessControlBuiltinRefactorEnabled()&&p.Vt.hasPermission(x.bW.ActionBuiltinRolesList)){const e=await(0,h.fh)(t);w(e)}}catch(e){console.error("Error loading options")}}()},[t]),(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("table",{className:"filter-table form-inline",children:[(0,g.jsx)("thead",{children:(0,g.jsxs)("tr",{children:[n||(n=(0,g.jsx)("th",{})),r||(r=(0,g.jsx)("th",{children:"Login"})),a||(a=(0,g.jsx)("th",{children:"Email"})),i||(i=(0,g.jsx)("th",{children:"Name"})),c||(c=(0,g.jsx)("th",{children:"Seen"})),l||(l=(0,g.jsx)("th",{children:"Role"})),(0,g.jsx)("th",{style:{width:"34px"}})]})}),(0,g.jsx)("tbody",{children:s.map((e,s)=>(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{className:"width-2 text-center",children:(0,g.jsx)("img",{className:"filter-table__avatar",src:e.avatarUrl,alt:"User avatar"})}),(0,g.jsx)("td",{className:"max-width-6",children:(0,g.jsx)("span",{className:"ellipsis",title:e.login,children:e.login})}),(0,g.jsx)("td",{className:"max-width-5",children:(0,g.jsx)("span",{className:"ellipsis",title:e.email,children:e.email})}),(0,g.jsx)("td",{className:"max-width-5",children:(0,g.jsx)("span",{className:"ellipsis",title:e.name,children:e.name})}),(0,g.jsx)("td",{className:"width-1",children:e.lastSeenAtAge}),(0,g.jsx)("td",{className:"width-8",children:p.Vt.licensedAccessControlEnabled()?(0,g.jsx)(u.R,{userId:e.userId,orgId:t,builtInRole:e.role,onBuiltinRoleChange:s=>v(s,e),roleOptions:I,builtInRoles:y,disabled:!p.Vt.hasPermissionInMetadata(x.bW.OrgUsersRoleUpdate,e)}):(0,g.jsx)(m.A,{"aria-label":"Role",value:e.role,disabled:!p.Vt.hasPermissionInMetadata(x.bW.OrgUsersRoleUpdate,e),onChange:s=>v(s,e)})}),p.Vt.hasPermissionInMetadata(x.bW.OrgUsersRemove,e)&&(0,g.jsx)("td",{children:(0,g.jsx)(d.Button,{size:"sm",variant:"destructive",onClick:()=>{f(e)},icon:"times","aria-label":"Delete user"})})]},`${e.userId}-${s}`))})]}),Boolean(b)&&(0,g.jsx)(d.ConfirmModal,{body:`Are you sure you want to delete user ${null===b||void 0===b?void 0:b.login}?`,confirmText:"Delete",title:"Delete",onDismiss:()=>{f(null)},isOpen:!0,onConfirm:()=>{b&&(j(b),f(null))}})]})}}}]);